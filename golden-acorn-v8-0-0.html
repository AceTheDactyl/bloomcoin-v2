<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ° Golden Acorn v8.0.0 | HonkFire Quantum Tarot</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --void: #0a0a0f;
      --void-deep: #050508;
      --bg-panel: #12121f;
      --bg-card: #0d0d14;
      --gold: #d4af37;
      --gold-bright: #ffd700;
      --silver: #c0c0c0;
      --text-primary: #f0ebe0;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --border-glow: rgba(212, 175, 55, 0.4);
      --spades: #4a5a6a;
      --hearts: #c53030;
      --diamonds: #3b7dd8;
      --clubs: #2d7a4a;
      --garden: #50a878;
      --cosmic: #ffd700;
      --abyss: #9070a8;
      --squirrel: #9d4edd;
      --font-display: 'Cinzel Decorative', serif;
      --font-heading: 'Cinzel', serif;
      --font-body: 'EB Garamond', Georgia, serif;
      --font-mono: 'Space Mono', monospace;
      --font-tech: 'Orbitron', sans-serif;
      
      /* Neon Palette (Division Hierarchy) */
      --n1: #ffb3ba; --n2: #ffdfba; --n3: #ffffba; --n4: #baffc9; --n5: #bae1ff;
      --n6: #a0c4ff; --n7: #bdb2ff; --n8: #ffc6ff; --n9: #ffffff;
      
      /* Global Deck Colors (Animation System) */
      --c1: var(--gold); --c2: var(--garden); --c3: var(--squirrel);
    }

    [data-theme="parchment"] {
      --void: #f4ead5;
      --void-deep: #e8dcc4;
      --bg-panel: rgba(255,255,255,0.9);
      --bg-card: #f8f4e8;
      --text-primary: #2d2418;
      --text-secondary: #5a4a3a;
      --text-muted: #8a7a6a;
      --border-glow: rgba(139, 90, 43, 0.3);
      --gold: #8b5a2b;
      --gold-bright: #a0703a;
    }

    [data-theme="neon"] {
      --void: #0a0012;
      --void-deep: #050008;
      --bg-panel: #120820;
      --bg-card: #0a0015;
      --text-primary: #fff;
      --text-secondary: #e0d0ff;
      --text-muted: #8060a0;
      --gold: #ff00ff;
      --gold-bright: #00ffff;
      --border-glow: rgba(255, 0, 255, 0.6);
    }

    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: var(--gold) var(--void-deep);
    }

    body {
      background: var(--void);
      min-height: 100vh;
      font-family: var(--font-body);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
    }

    /* Themed scrollbars (Webkit) */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    ::-webkit-scrollbar-track {
      background: var(--void-deep);
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--gold), color-mix(in srgb, var(--gold) 60%, var(--void)));
      border-radius: 5px;
      border: 2px solid var(--void-deep);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, var(--gold-bright), var(--gold));
    }
    ::-webkit-scrollbar-corner {
      background: var(--void-deep);
    }

    .bg-field {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }

    .bg-field::before {
      content: '';
      position: absolute;
      inset: -50%;
      background: radial-gradient(ellipse at 30% 30%, rgba(212,175,55,0.04) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 70%, rgba(80,168,120,0.04) 0%, transparent 50%);
      animation: fieldRotate 120s linear infinite;
    }

    @keyframes fieldRotate { to { transform: rotate(360deg); } }
    [data-theme="parchment"] .bg-field { display: none; }

    .header {
      text-align: center;
      padding: 8px;
      background: linear-gradient(180deg, rgba(212,175,55,0.08) 0%, transparent 100%);
      border-bottom: 2px solid var(--gold);
    }

    .header-title {
      font-family: var(--font-display);
      font-size: clamp(14px, 3vw, 20px);
      background: linear-gradient(135deg, var(--gold), var(--gold-bright));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-sub {
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-muted);
      letter-spacing: 0.1em;
    }

    .deck-tabs {
      display: flex;
      justify-content: center;
      gap: 4px;
      padding: 8px;
      background: var(--void-deep);
      border-bottom: 1px solid rgba(212,175,55,0.3);
      flex-wrap: wrap;
    }

    .deck-tab {
      padding: 6px 14px;
      border: 2px solid var(--gold);
      border-radius: 4px 4px 0 0;
      background: transparent;
      font-family: var(--font-heading);
      font-size: 12px;
      color: var(--gold);
      cursor: pointer;
      transition: all 0.2s;
    }

    .deck-tab:hover { background: rgba(212,175,55,0.15); }
    .deck-tab.active { background: var(--gold); color: var(--void); }

    .theme-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      flex-wrap: wrap;
      align-items: center;
    }

    .theme-btn, .btn {
      padding: 5px 12px;
      border: 2px solid var(--gold);
      border-radius: 4px;
      background: transparent;
      color: var(--gold);
      font-family: var(--font-tech);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-btn:hover, .btn:hover { background: rgba(212,175,55,0.15); }
    .theme-btn.active, .btn.primary { background: var(--gold); color: var(--void); }
    .btn.sm { padding: 4px 8px; font-size: 10px; }

    .app-container {
      display: grid;
      grid-template-columns: 240px 1fr;
      flex: 1;
      overflow: hidden;
    }

    @media (max-width: 800px) { .app-container { grid-template-columns: 1fr; } }

    .control-panel {
      background: var(--void-deep);
      border-right: 1px solid rgba(212,175,55,0.3);
      padding: 10px;
      overflow-y: auto;
      height: 100%;
    }

    .panel-section {
      background: var(--bg-panel);
      border: 2px solid rgba(212,175,55,0.25);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }

    .panel-section h3 {
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--gold);
      letter-spacing: 0.08em;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 2px solid rgba(212,175,55,0.3);
    }

    label {
      display: block;
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 3px;
      margin-top: 6px;
    }

    label:first-child { margin-top: 0; }

    select, input[type="text"], textarea {
      width: 100%;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      padding: 6px 8px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 11px;
      margin-bottom: 4px;
    }
    
    textarea {
      line-height: 1.4;
      resize: vertical;
      min-height: 50px;
    }
    
    textarea::placeholder {
      color: rgba(255,255,255,0.35);
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    input[type="range"] { flex: 1; accent-color: var(--gold); height: 6px; }
    .slider-val { font-family: var(--font-tech); font-size: 10px; color: var(--squirrel); min-width: 20px; text-align: right; }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 4px 0;
    }

    .toggle-label { font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary); }

    .toggle {
      width: 36px;
      height: 20px;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
    }

    .toggle::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--text-muted);
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: all 0.2s;
    }

    .toggle.active { background: var(--garden); border-color: var(--garden); }
    .toggle.active::after { left: 18px; background: #fff; }

    .color-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .color-row input[type="color"] {
      flex: 1;
      height: 28px;
      border-radius: 4px;
      border: 2px solid rgba(255,255,255,0.15);
      cursor: pointer;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      margin-bottom: 6px;
    }

    .preset-chip {
      padding: 6px 4px;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      background: var(--void);
      color: var(--text-secondary);
      font-size: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-chip:hover { border-color: var(--gold); }
    .preset-chip.active { border-color: var(--gold); background: rgba(212,175,55,0.2); color: var(--gold); }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 6px;
    }

    .filter-btn {
      padding: 8px 4px;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      background: var(--void);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
    }

    .filter-btn:hover { border-color: var(--gold); }
    .filter-btn.active { border-color: var(--gold); background: rgba(212,175,55,0.2); color: var(--gold); }

    .preview-area { padding: 12px; overflow-y: auto; height: 100%; }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(212,175,55,0.4);
      flex-wrap: wrap;
      gap: 8px;
    }

    .preview-title { font-family: var(--font-display); font-size: 16px; color: var(--gold); }

    .view-toggle { display: flex; gap: 4px; }

    .view-btn {
      padding: 5px 10px;
      border: 2px solid rgba(255,255,255,0.2);
      background: var(--void);
      color: var(--text-secondary);
      font-family: var(--font-tech);
      font-size: 10px;
      cursor: pointer;
      border-radius: 4px;
    }

    .view-btn:hover { border-color: var(--gold); }
    .view-btn.active { background: var(--gold); color: var(--void); border-color: var(--gold); }

    .stat-chip {
      padding: 4px 10px;
      background: var(--bg-panel);
      border: 2px solid rgba(212,175,55,0.25);
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 10px;
    }

    .stat-chip .lbl { color: var(--text-muted); }
    .stat-chip .val { color: var(--squirrel); margin-left: 4px; }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
      gap: 12px;
      justify-items: center;
    }

    .card-grid.both-view { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }

    .card-container {
      cursor: pointer;
      position: relative;
      z-index: 1;
    }

    .card-container:hover { 
      z-index: 1001;
    }

    /* Hover preview - overlapping card with offset */
    .card-container .hover-preview {
      position: absolute;
      top: -8px;
      left: 12px;
      transform: scale(0.95);
      transform-origin: top left;
      background: var(--bg-panel);
      border: 2px solid var(--gold);
      border-radius: 8px;
      padding: 8px 10px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.15s ease;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0,0,0,0.7), 0 0 20px var(--border-glow);
      pointer-events: none;
    }
    .card-container:hover .hover-preview {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }
    .hover-preview-label {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }
    .hover-preview .card-svg {
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }

    .card-container::before {
      content: 'âœ';
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: var(--gold);
      color: var(--void);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card-container:hover::before { opacity: 1; }

    .card-container.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 4px;
      left: 4px;
      width: 16px;
      height: 16px;
      background: var(--gold);
      color: var(--void);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      z-index: 10;
    }

    .card-svg {
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transition: box-shadow 0.3s;
    }

    .card-container:hover .card-svg { box-shadow: 0 6px 20px var(--border-glow); }

    /* Echoed card state (HonkFire reversed) */
    .card-container.echoed .card-svg {
      box-shadow: 0 0 15px rgba(255, 102, 204, 0.4), 0 4px 12px rgba(0,0,0,0.5);
    }
    .card-container.echoed::after {
      content: 'ğŸŒ‘';
      position: absolute;
      bottom: 4px;
      left: 4px;
      width: 16px;
      height: 16px;
      background: #ff66cc;
      color: #0a0a0f;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      z-index: 10;
    }
    .card-container.echoed:hover .card-svg { 
      box-shadow: 0 0 25px rgba(255, 102, 204, 0.6), 0 6px 20px var(--border-glow); 
    }

    .card-svg.playing { width: 85px; height: 119px; }
    .card-svg.tarot { width: 85px; height: 145px; }

    .card-pair { display: flex; gap: 8px; align-items: flex-start; }

    .batch-bar {
      position: fixed;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-panel);
      border: 2px solid var(--gold);
      border-radius: 6px;
      padding: 10px 16px;
      display: flex;
      gap: 16px;
      align-items: center;
      z-index: 100;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.5);
      transition: bottom 0.3s;
    }

    .batch-bar.active { bottom: 16px; }
    .batch-info { font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary); }
    .batch-actions { display: flex; gap: 8px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FULLSCREEN EDITOR MODAL
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .editor-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--void-deep);
      z-index: 5000;
      overflow: hidden;
    }

    .editor-modal.active { display: flex; flex-direction: column; }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: linear-gradient(180deg, rgba(212,175,55,0.1) 0%, transparent 100%);
      border-bottom: 2px solid var(--gold);
    }

    .editor-header h2 {
      font-family: var(--font-display);
      font-size: 18px;
      color: var(--gold);
    }

    .editor-header-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .editor-close {
      width: 36px;
      height: 36px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .editor-close:hover { background: var(--gold); color: var(--void); }

    .editor-body {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      gap: 0;
      overflow: hidden;
    }

    @media (max-width: 1000px) { 
      .editor-body { grid-template-columns: 1fr; }
      .editor-left, .editor-right { display: none; }
    }

    .editor-left, .editor-right {
      background: var(--bg-panel);
      border-right: 1px solid rgba(212,175,55,0.3);
      overflow-y: auto;
      padding: 16px;
    }

    .editor-right {
      border-right: none;
      border-left: 1px solid rgba(212,175,55,0.3);
    }

    .editor-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: radial-gradient(ellipse at center, rgba(212,175,55,0.05) 0%, transparent 70%);
      overflow-y: auto;
    }

    .editor-section {
      margin-bottom: 20px;
    }

    .editor-section h4 {
      font-family: var(--font-tech);
      font-size: 12px;
      color: var(--gold);
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid rgba(212,175,55,0.35);
      letter-spacing: 0.1em;
    }

    .editor-group { margin-bottom: 14px; }
    .editor-group label { margin-top: 0; margin-bottom: 5px; font-size: 10px; }
    .editor-row { display: flex; flex-wrap: wrap; gap: 5px; }

    .editor-mini-btn {
      padding: 8px 12px;
      border: 2px solid rgba(255,255,255,0.15);
      background: var(--void);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }

    .editor-mini-btn:hover { border-color: var(--gold); background: rgba(212,175,55,0.1); }
    .editor-mini-btn.active { background: var(--gold); color: var(--void); border-color: var(--gold); }
    .editor-mini-btn.toggle-btn { min-width: 36px; text-align: center; }

    /* Live preview cards */
    .preview-stage {
      display: flex;
      gap: 30px;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .preview-card-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .preview-card-frame {
      padding: 16px;
      background: rgba(0,0,0,0.4);
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 0 60px rgba(212,175,55,0.03);
    }

    .preview-card-frame .card-svg.playing { width: 200px; height: 280px; }
    .preview-card-frame .card-svg.tarot { width: 200px; height: 340px; }

    .preview-card-label {
      margin-top: 10px;
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.15em;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(80,168,120,0.2);
      border: 1px solid var(--garden);
      border-radius: 20px;
      font-family: var(--font-tech);
      font-size: 10px;
      color: var(--garden);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--garden);
      border-radius: 50%;
      animation: livePulse 1.5s ease-in-out infinite;
    }

    @keyframes livePulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .card-nav {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .card-nav-btn {
      width: 44px;
      height: 44px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .card-nav-btn:hover { background: var(--gold); color: var(--void); }

    .card-counter {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--text-secondary);
    }

    .card-counter b { color: var(--gold); }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .action-buttons .btn {
      padding: 10px 20px;
      font-size: 12px;
    }

    .card-info-box {
      margin-top: 16px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.6;
      max-width: 300px;
    }

    .card-info-box b { color: var(--gold); }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
      margin-bottom: 8px;
    }

    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      min-height: 24px;
    }

    .color-swatch:hover { border-color: #fff; transform: scale(1.1); }
    .color-swatch.active { border-color: #fff; box-shadow: 0 0 8px rgba(255,255,255,0.5); }

    .sigil-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
    }

    .sigil-btn {
      padding: 6px 4px;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      text-align: center;
      transition: all 0.2s;
      color: var(--text-primary);
    }

    .sigil-btn:hover { border-color: var(--gold); background: rgba(212,175,55,0.2); }
    .sigil-btn.active { background: var(--gold); border-color: var(--gold); }

    .glow-preset-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      margin-bottom: 8px;
    }

    .glow-preset {
      padding: 6px 4px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 4px;
      background: var(--void);
      color: var(--text-secondary);
      font-size: 9px;
      text-align: center;
      cursor: pointer;
    }

    .glow-preset:hover { border-color: var(--gold); }
    .glow-preset.active { border-color: var(--gold); background: rgba(212,175,55,0.25); color: var(--gold); }

    .footer {
      text-align: center;
      padding: 10px;
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      border-top: 1px solid rgba(212,175,55,0.2);
    }

    .toast {
      position: fixed;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gold);
      color: var(--void);
      padding: 10px 20px;
      border-radius: 6px;
      font-family: var(--font-tech);
      font-size: 12px;
      z-index: 9999;
      transition: bottom 0.3s;
    }

    .toast.show { bottom: 20px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VAULT MODAL - Deck Storage
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .vault-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      z-index: 6000;
      align-items: center;
      justify-content: center;
    }
    .vault-modal.active { display: flex; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       Lâ‚„ READING MODAL - Quantum Tarot Spread Interface
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .reading-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(5,5,10,0.95);
      backdrop-filter: blur(12px);
      z-index: 6000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
      padding: 20px;
    }
    .reading-modal.active { display: flex; }
    
    .reading-container {
      background: linear-gradient(135deg, #12121a 0%, #0a0a12 100%);
      border: 2px solid var(--gold);
      border-radius: 16px;
      width: 95%;
      max-width: 1000px;
      max-height: 95vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 80px rgba(212,175,55,0.15), 0 0 40px rgba(157,78,221,0.1);
      overflow: hidden;
    }
    
    .reading-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      border-bottom: 2px solid var(--gold);
      background: linear-gradient(180deg, rgba(212,175,55,0.12) 0%, transparent 100%);
    }
    .reading-header h2 {
      font-family: var(--font-display);
      font-size: 20px;
      background: linear-gradient(135deg, var(--gold), #ff66cc, var(--gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .reading-close {
      width: 36px; height: 36px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }
    .reading-close:hover { background: var(--gold); color: #0a0a12; }
    
    /* Quantum State Display */
    .quantum-state-display {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 12px 24px;
      background: rgba(0,0,0,0.4);
      border-bottom: 1px solid rgba(157,78,221,0.3);
      font-family: var(--font-mono);
      font-size: 12px;
      flex-wrap: wrap;
    }
    .quantum-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .quantum-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #9d4edd;
      animation: quantumPulse 1.5s ease-in-out infinite;
    }
    .quantum-dot.locked {
      background: var(--gold);
      animation: none;
      box-shadow: 0 0 12px var(--gold);
    }
    @keyframes quantumPulse {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    .quantum-coords {
      color: var(--text-muted);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .quantum-coords span { color: var(--text-main); }
    .quantum-coords .sigma { color: #ff66cc; text-shadow: 0 0 8px rgba(255,102,204,0.5); }
    .threshold-display {
      color: #9d4edd;
      font-weight: 600;
    }
    #quantumPhase {
      color: #9d4edd;
      font-weight: 600;
      letter-spacing: 0.1em;
    }
    #quantumPhase.collapsed { color: var(--gold); }
    
    /* Intent Input Section */
    .reading-intent {
      padding: 16px 24px;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .intent-row {
      margin-bottom: 12px;
    }
    .intent-row:last-child { margin-bottom: 0; }
    .intent-row label {
      display: block;
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .intent-hint { color: #9d4edd; font-size: 10px; }
    .intent-row input, .intent-row textarea {
      width: 100%;
      padding: 10px 12px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: var(--text-main);
      font-family: var(--font-body);
      font-size: 14px;
    }
    .intent-row input:focus, .intent-row textarea:focus {
      border-color: var(--gold);
      outline: none;
    }
    
    /* Spread Type Selection */
    .spread-type-row {
      display: flex;
      gap: 8px;
      padding: 12px 24px;
      background: rgba(0,0,0,0.15);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .spread-type-btn {
      flex: 1;
      padding: 10px 16px;
      background: rgba(157,78,221,0.1);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: var(--font-tech);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .spread-type-btn:hover {
      background: rgba(157,78,221,0.2);
      border-color: rgba(157,78,221,0.5);
    }
    .spread-type-btn.active {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
      color: var(--gold);
    }
    
    /* Deck Selector */
    .deck-selector-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .deck-selector-label {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .deck-preset-btns {
      display: flex;
      gap: 8px;
      flex: 1;
    }
    .deck-preset-btn {
      flex: 1;
      padding: 10px 16px;
      background: rgba(100,100,120,0.15);
      border: 1px solid rgba(100,100,120,0.3);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: var(--font-tech);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .deck-preset-btn:hover {
      background: rgba(100,100,120,0.25);
      border-color: rgba(100,100,120,0.5);
    }
    .deck-preset-btn.active {
      background: rgba(212,175,55,0.15);
      border-color: var(--gold);
      color: var(--gold);
    }
    .deck-preset-btn.honkfire {
      background: linear-gradient(135deg, rgba(157,78,221,0.15), rgba(255,107,26,0.1));
      border-color: rgba(157,78,221,0.4);
    }
    .deck-preset-btn.honkfire:hover {
      background: linear-gradient(135deg, rgba(157,78,221,0.25), rgba(255,107,26,0.15));
    }
    .deck-preset-btn.honkfire.active {
      background: linear-gradient(135deg, rgba(157,78,221,0.35), rgba(255,107,26,0.25));
      border-color: #ff6b1a;
      color: #ffd700;
      box-shadow: 0 0 15px rgba(157,78,221,0.3);
    }
    
    /* Draw Actions */
    .reading-actions {
      display: flex;
      gap: 12px;
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .draw-btn {
      flex: 2;
      padding: 14px 24px;
      font-size: 14px;
      background: linear-gradient(135deg, rgba(157,78,221,0.3), rgba(255,107,26,0.2));
      border: 2px solid var(--gold);
    }
    .draw-btn:hover {
      background: linear-gradient(135deg, rgba(157,78,221,0.5), rgba(255,107,26,0.3));
      box-shadow: 0 0 30px rgba(212,175,55,0.3);
    }
    .draw-btn-raw {
      flex: 1;
      background: rgba(255,102,204,0.15);
      border: 1px solid rgba(255,102,204,0.4);
      color: #ff66cc;
    }
    .draw-btn-raw:hover {
      background: rgba(255,102,204,0.25);
    }
    
    /* Spread Container */
    .spread-container {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      min-height: 300px;
    }
    .spread-grid {
      display: grid;
      gap: 16px;
      justify-content: center;
    }
    .spread-grid.three-card { grid-template-columns: repeat(3, 120px); }
    .spread-grid.nine-card { grid-template-columns: repeat(3, 120px); }
    .spread-grid.celtic { grid-template-columns: repeat(4, 100px); }
    
    /* Spread Card Panel */
    .spread-panel {
      background: linear-gradient(135deg, #1a1a24 0%, #12121a 100%);
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 10px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    .spread-panel:hover {
      transform: translateY(-4px);
      border-color: var(--gold);
      box-shadow: 0 12px 30px rgba(212,175,55,0.2);
    }
    .spread-panel.row-past { border-top: 3px solid #9d4edd; }
    .spread-panel.row-present { border-top: 3px solid #ffd700; }
    .spread-panel.row-future { border-top: 3px solid #1a7a6c; }
    
    /* Echoed (Reversed) State */
    .spread-panel.echoed {
      border-color: #ff66cc;
      box-shadow: 0 0 20px rgba(255,102,204,0.3), inset 0 0 15px rgba(255,102,204,0.08);
    }
    .spread-panel.echoed::before {
      content: 'ğŸŒ‘ ECHOED';
      position: absolute;
      top: -10px;
      right: -5px;
      background: #ff66cc;
      color: #0a0a0f;
      font-size: 8px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      z-index: 10;
      letter-spacing: 0.05em;
    }
    .spread-panel.echoed .spread-card-svg {
      transform: rotate(180deg);
    }
    
    .spread-position {
      font-family: var(--font-tech);
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    .spread-card-svg {
      width: 80px;
      height: 112px;
      transition: transform 0.3s;
    }
    .spread-card-title {
      font-family: var(--font-display);
      font-size: 10px;
      color: var(--gold);
      text-align: center;
      margin-top: 6px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .spread-card-greek {
      font-family: 'Times New Roman', serif;
      font-size: 11px;
      color: #9d4edd;
      letter-spacing: 0.15em;
    }
    .spread-panel.echoed .spread-card-greek {
      color: #ff66cc;
      text-shadow: 0 0 8px rgba(255,102,204,0.5);
    }
    
    /* Reading Info */
    .reading-info {
      padding: 12px 24px;
      background: rgba(0,0,0,0.3);
      border-top: 1px solid rgba(255,255,255,0.05);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }
    .reading-info-row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .reading-info .formula {
      color: #9d4edd;
      font-size: 12px;
    }
    
    /* Empty State */
    .spread-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 60px 20px;
    }
    .spread-empty-sigil {
      font-size: 4rem;
      opacity: 0.3;
      margin-bottom: 16px;
    }
    .spread-empty p {
      font-size: 14px;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.6;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARD DETAIL MODAL - Reading Card Meaning Display
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .card-detail-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(5,5,10,0.92);
      backdrop-filter: blur(8px);
      z-index: 7000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .card-detail-modal.active { display: flex; }
    
    .card-detail-container {
      background: linear-gradient(135deg, #16161e 0%, #0c0c14 100%);
      border: 2px solid var(--gold);
      border-radius: 16px;
      width: 95%;
      max-width: 600px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px rgba(212,175,55,0.2), 0 0 30px rgba(157,78,221,0.15);
      overflow: hidden;
    }
    .card-detail-container.echoed {
      border-color: #ff66cc;
      box-shadow: 0 0 60px rgba(255,102,204,0.25), 0 0 30px rgba(255,102,204,0.15);
    }
    
    .card-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      background: linear-gradient(180deg, rgba(212,175,55,0.08) 0%, transparent 100%);
    }
    .card-detail-container.echoed .card-detail-header {
      border-bottom-color: rgba(255,102,204,0.4);
      background: linear-gradient(180deg, rgba(255,102,204,0.1) 0%, transparent 100%);
    }
    
    .card-detail-position {
      font-family: var(--font-tech);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .card-detail-title {
      font-family: var(--font-display);
      font-size: 22px;
      color: var(--gold);
      margin: 0;
    }
    .card-detail-container.echoed .card-detail-title {
      color: #ff66cc;
    }
    .card-detail-subtitle {
      font-family: var(--font-body);
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .card-detail-close {
      width: 36px; height: 36px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .card-detail-close:hover { background: var(--gold); color: #0a0a12; }
    .card-detail-container.echoed .card-detail-close {
      border-color: #ff66cc;
      color: #ff66cc;
    }
    .card-detail-container.echoed .card-detail-close:hover {
      background: #ff66cc;
      color: #0a0a12;
    }
    
    .card-detail-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .card-detail-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card-detail-visual {
      flex-shrink: 0;
      width: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .card-detail-svg {
      width: 100px;
      height: 140px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .card-detail-svg.echoed {
      transform: rotate(180deg);
      box-shadow: 0 -8px 24px rgba(255,102,204,0.3);
    }
    .card-detail-greek {
      font-family: var(--font-mono);
      font-size: 14px;
      color: #9d4edd;
      letter-spacing: 0.2em;
      text-align: center;
    }
    .card-detail-container.echoed .card-detail-greek {
      color: #ff66cc;
      text-shadow: 0 0 10px rgba(255,102,204,0.5);
    }
    
    .card-detail-info {
      flex: 1;
    }
    
    .card-detail-state-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-family: var(--font-tech);
      font-size: 10px;
      font-weight: bold;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
    }
    .card-detail-state-badge.upright {
      background: rgba(212,175,55,0.15);
      color: var(--gold);
      border: 1px solid var(--gold);
    }
    .card-detail-state-badge.echoed {
      background: rgba(255,102,204,0.2);
      color: #ff66cc;
      border: 1px solid #ff66cc;
    }
    
    .card-detail-section {
      margin-bottom: 16px;
    }
    .card-detail-section-title {
      font-family: var(--font-tech);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-detail-section-title.echo-title {
      color: #ff66cc;
    }
    .card-detail-meaning {
      font-family: var(--font-body);
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-main);
    }
    .card-detail-meaning.echo-meaning {
      color: #ffaadd;
      font-style: italic;
    }
    
    .card-detail-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .card-detail-keyword {
      padding: 4px 10px;
      background: rgba(157,78,221,0.15);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 4px;
      font-family: var(--font-tech);
      font-size: 10px;
      color: #c77dff;
    }
    .card-detail-keyword.echo-keyword {
      background: rgba(255,102,204,0.15);
      border-color: rgba(255,102,204,0.4);
      color: #ff66cc;
    }
    
    .card-detail-entity {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      margin-top: 12px;
    }
    .card-detail-entity-icon {
      font-size: 24px;
    }
    .card-detail-entity-info {
      flex: 1;
    }
    .card-detail-entity-name {
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .card-detail-entity-lore {
      font-family: var(--font-body);
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
      line-height: 1.4;
    }
    
    .card-detail-z-coord {
      margin-top: 12px;
      padding: 8px 12px;
      background: rgba(157,78,221,0.1);
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: #9d4edd;
      display: flex;
      justify-content: space-between;
    }
    .card-detail-container.echoed .card-detail-z-coord {
      background: rgba(255,102,204,0.1);
      color: #ff66cc;
    }
    
    .vault-container {
      background: var(--bg-panel);
      border: 2px solid var(--gold);
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      height: 90vh;
      max-height: none;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px rgba(212,175,55,0.2);
      overflow: hidden;
    }
    
    .vault-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 2px solid var(--gold);
      background: linear-gradient(180deg, rgba(212,175,55,0.15) 0%, transparent 100%);
    }
    
    .vault-header h2 {
      font-family: var(--font-display);
      font-size: 18px;
      color: var(--gold);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .vault-close {
      width: 32px;
      height: 32px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }
    .vault-close:hover { background: var(--gold); color: var(--void); }
    
    .vault-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .vault-tab-content .vault-body {
      flex: 1;
      overflow-y: auto;
    }
    
    .vault-section {
      margin-bottom: 20px;
    }
    
    .vault-section-title {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .vault-save-row {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .vault-save-row input {
      flex: 1;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 13px;
    }
    .vault-save-row input:focus {
      outline: none;
      border-color: var(--gold);
    }
    .vault-save-row input::placeholder {
      color: var(--text-muted);
    }
    
    .vault-save-btn {
      background: var(--gold);
      color: var(--void);
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-family: var(--font-tech);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .vault-save-btn:hover { filter: brightness(1.1); }
    
    .vault-deck-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .vault-deck-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      transition: all 0.2s;
    }
    .vault-deck-item:hover {
      border-color: var(--gold);
      background: rgba(212,175,55,0.05);
    }
    
    .vault-deck-icon {
      font-size: 24px;
      opacity: 0.8;
    }
    
    .vault-deck-info {
      flex: 1;
      min-width: 0;
    }
    
    .vault-deck-name {
      font-family: var(--font-tech);
      font-size: 14px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .vault-deck-meta {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .vault-deck-actions {
      display: flex;
      gap: 6px;
    }
    
    .vault-action-btn {
      width: 32px;
      height: 32px;
      border: 1px solid rgba(255,255,255,0.2);
      background: transparent;
      color: var(--text-secondary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .vault-action-btn:hover {
      border-color: var(--gold);
      color: var(--gold);
    }
    .vault-action-btn.load:hover { background: rgba(80,200,120,0.2); border-color: #50c878; color: #50c878; }
    .vault-action-btn.delete:hover { background: rgba(200,80,80,0.2); border-color: #c85050; color: #c85050; }
    
    .vault-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .vault-empty-icon {
      font-size: 48px;
      opacity: 0.3;
      margin-bottom: 12px;
    }
    
    .vault-footer {
      padding: 12px 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
    }
    
    /* Vault Tabs */
    .vault-tabs {
      display: flex;
      gap: 4px;
      padding: 12px 16px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .vault-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .vault-tab:hover { color: var(--text-secondary); }
    .vault-tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    
    .vault-tab-content {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    .vault-tab-content.active { display: flex; }
    
    /* Preview Tab */
    .vault-preview-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(180deg, rgba(212,175,55,0.08) 0%, transparent 100%);
    }
    .vault-preview-select {
      flex: 1;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      padding: 10px 14px;
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
    }
    .vault-preview-select:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 12px rgba(212,175,55,0.2);
    }
    .vault-preview-load-btn {
      background: var(--gold);
      color: var(--void);
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-family: var(--font-tech);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .vault-preview-load-btn:hover { 
      filter: brightness(1.15); 
      box-shadow: 0 0 16px rgba(212,175,55,0.4);
    }
    .vault-preview-load-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .vault-preview-wrapper {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    .vault-preview-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: linear-gradient(180deg, var(--bg-panel) 0%, transparent 100%);
      pointer-events: none;
      z-index: 10;
    }
    
    .vault-preview-wrapper::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(0deg, var(--bg-panel) 20%, transparent 100%);
      pointer-events: none;
      z-index: 10;
    }
    
    .vault-preview-grid {
      height: 100%;
      overflow-y: auto;
      padding: 30px 20px 60px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
      gap: 16px;
      align-content: start;
      background: linear-gradient(180deg, 
        var(--void-deep) 0%, 
        rgba(10,0,18,0.95) 50%,
        var(--void) 100%
      );
    }
    
    .vault-preview-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: transform 0.2s, opacity 0.2s;
      animation: cardFadeIn 0.4s ease-out backwards;
    }
    
    @keyframes cardFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .vault-preview-card:hover {
      transform: translateY(-4px) scale(1.05);
      z-index: 20;
    }
    
    .vault-preview-card .card-svg {
      box-shadow: 0 4px 16px rgba(0,0,0,0.6);
      transition: box-shadow 0.2s;
    }
    
    .vault-preview-card:hover .card-svg {
      box-shadow: 0 8px 24px rgba(0,0,0,0.8), 0 0 20px var(--border-glow);
    }
    
    .vault-preview-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 13px;
    }
    .vault-preview-empty-icon {
      font-size: 64px;
      opacity: 0.25;
      margin-bottom: 16px;
      filter: grayscale(0.5);
    }
    
    .vault-preview-stats {
      padding: 12px 20px;
      border-top: 2px solid rgba(212,175,55,0.3);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, transparent 0%, rgba(212,175,55,0.05) 100%);
    }
    
    .vault-preview-stats span {
      padding: 4px 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    /* Custom Deck Stats */
    .custom-deck-stats {
      background: var(--void);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      padding: 10px;
    }
    .custom-stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
    }
    .custom-stat-label {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .custom-stat-value {
      font-family: var(--font-tech);
      font-size: 12px;
      color: var(--gold);
    }
    
    /* Card Picker Modal */
    .picker-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      backdrop-filter: blur(8px);
      z-index: 6500;
      align-items: center;
      justify-content: center;
    }
    .picker-modal.active { display: flex; }
    
    .picker-container {
      background: var(--bg-panel);
      border: 2px solid var(--gold);
      border-radius: 12px;
      width: 95%;
      max-width: 900px;
      height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px rgba(212,175,55,0.2);
      overflow: hidden;
    }
    
    .picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 2px solid var(--gold);
      background: linear-gradient(180deg, rgba(212,175,55,0.15) 0%, transparent 100%);
    }
    
    .picker-header h2 {
      font-family: var(--font-display);
      font-size: 16px;
      color: var(--gold);
    }
    
    .picker-tabs {
      display: flex;
      gap: 4px;
      padding: 0 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .picker-tab {
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 11px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
    }
    .picker-tab:hover { color: var(--text-secondary); }
    .picker-tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    
    .picker-body {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .picker-grid-wrapper {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    .picker-grid-wrapper::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 30px;
      background: linear-gradient(180deg, var(--bg-panel) 0%, transparent 100%);
      pointer-events: none;
      z-index: 10;
    }
    .picker-grid-wrapper::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 50px;
      background: linear-gradient(0deg, var(--bg-panel) 20%, transparent 100%);
      pointer-events: none;
      z-index: 10;
    }
    
    .picker-grid {
      height: 100%;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
      align-content: start;
    }
    
    .picker-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 6px;
      border-radius: 6px;
      border: 2px solid transparent;
    }
    .picker-card:hover {
      background: rgba(212,175,55,0.1);
      border-color: rgba(212,175,55,0.3);
      transform: translateY(-2px);
    }
    .picker-card.selected {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
    }
    .picker-card.in-custom {
      opacity: 0.4;
      pointer-events: none;
    }
    .picker-card.in-custom::after {
      content: 'âœ“';
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--gold);
      color: var(--void);
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .picker-footer {
      padding: 12px 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,0.2);
    }
    
    .picker-selection-info {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }
    .picker-selection-count {
      color: var(--gold);
      font-weight: bold;
    }
    
    .picker-actions {
      display: flex;
      gap: 8px;
    }
    
    .picker-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-family: var(--font-tech);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .picker-btn.primary {
      background: var(--gold);
      color: var(--void);
    }
    .picker-btn.primary:hover { filter: brightness(1.1); }
    .picker-btn.primary:disabled { opacity: 0.4; cursor: not-allowed; }
    .picker-btn.secondary {
      background: rgba(255,255,255,0.1);
      color: var(--text-secondary);
    }
    .picker-btn.secondary:hover { background: rgba(255,255,255,0.2); }
    
    /* Import Options Modal */
    .import-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
    }
    .import-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .import-option:hover {
      border-color: var(--gold);
      background: rgba(212,175,55,0.05);
    }
    .import-option-icon {
      font-size: 24px;
    }
    .import-option-text {
      flex: 1;
    }
    .import-option-title {
      font-family: var(--font-tech);
      font-size: 13px;
      color: var(--text-primary);
    }
    .import-option-desc {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    /* Add to Custom button on cards */
    .add-to-custom-btn {
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gold);
      color: var(--void);
      border: none;
      border-radius: 4px;
      padding: 3px 8px;
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: bold;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 50;
      white-space: nowrap;
    }
    .card-container:hover .add-to-custom-btn { opacity: 1; }
    .add-to-custom-btn:hover { filter: brightness(1.2); }
    
    /* Empty state for custom deck */
    .custom-empty-state {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    .custom-empty-icon {
      font-size: 64px;
      opacity: 0.3;
      margin-bottom: 16px;
    }
    .custom-empty-title {
      font-family: var(--font-display);
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .custom-empty-desc {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-muted);
      max-width: 300px;
      line-height: 1.5;
    }
    .custom-empty-btn {
      margin-top: 20px;
      background: var(--gold);
      color: var(--void);
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      font-family: var(--font-tech);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .custom-empty-btn:hover { filter: brightness(1.1); }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DIVISION HIERARCHY (Custom Suits/Structures)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .division-box {
      background: var(--void);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      position: relative;
    }
    
    .division-box:hover {
      border-color: rgba(212,175,55,0.4);
    }
    
    .division-header {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .division-header input {
      margin-bottom: 0;
    }
    
    .color-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .neon-preview-box {
      width: 30px;
      height: 30px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    
    .neon-preview-box:hover {
      transform: scale(1.1);
      border-color: var(--gold);
      box-shadow: 0 0 10px currentColor;
    }
    
    .collapsed-inputs {
      display: none;
      margin-top: 8px;
      padding: 8px;
      background: var(--void-deep);
      border: 1px dashed rgba(212,175,55,0.3);
      border-radius: 4px;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
    }
    
    .collapsed-inputs.show {
      display: flex;
      animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .swatch {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    
    .swatch:hover {
      transform: scale(1.15);
      border-color: var(--gold);
      box-shadow: 0 0 8px currentColor;
    }
    
    .structure-list {
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
      padding-top: 8px;
    }
    
    .structure-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-secondary);
      padding: 4px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      border-radius: 3px;
      transition: background 0.15s;
    }
    
    .structure-item:hover {
      background: rgba(212,175,55,0.1);
    }
    
    .structure-item:last-child {
      border-bottom: none;
    }
    
    .structure-item .struct-symbol {
      font-size: 14px;
      margin-right: 6px;
    }
    
    .structure-item .struct-remove {
      cursor: pointer;
      color: var(--hearts);
      opacity: 0.6;
      transition: opacity 0.15s;
    }
    
    .structure-item .struct-remove:hover {
      opacity: 1;
    }
    
    .structure-add-row {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    
    .structure-add-row input {
      margin-bottom: 0;
    }
    
    .division-remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
    }
    
    .division-summary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.03);
      border-radius: 4px;
      margin-top: 8px;
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .division-summary .div-color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .division-summary .div-struct-count {
      color: var(--squirrel);
    }
    
    /* Neon orb animation for color preview */
    .neon-preview-orb {
      width: 30px;
      height: 30px;
      border: 1px solid var(--text-muted);
      border-radius: 50%;
      cursor: pointer;
      flex-shrink: 0;
      animation: preview-neon-cycle 9s infinite linear;
    }
    
    @keyframes preview-neon-cycle {
      0% { background-color: var(--n1); }
      11.1% { background-color: var(--n2); }
      22.2% { background-color: var(--n3); }
      33.3% { background-color: var(--n4); }
      44.4% { background-color: var(--n5); }
      55.5% { background-color: var(--n6); }
      66.6% { background-color: var(--n7); }
      77.7% { background-color: var(--n8); }
      88.8% { background-color: var(--n9); }
      100% { background-color: var(--n1); }
    }
    
    /* Division color preview with animation */
    .color-preview-bar {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      margin-top: 8px;
      background: linear-gradient(90deg, var(--c1), var(--c2), var(--c3));
      animation: colorShift 4s ease-in-out infinite alternate;
    }
    
    @keyframes colorShift {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(30deg); }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GLYPH LAB MODAL (Emoji Picker)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .glyph-modal {
      display: none;
      position: fixed;
      z-index: 8000;
      inset: 0;
      background-color: rgba(0,0,0,0.92);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }
    
    .glyph-modal.active { display: flex; }
    
    .glyph-content {
      background: var(--bg-panel);
      border: 2px solid var(--gold);
      width: min(750px, 95vw);
      max-height: 85vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px var(--border-glow);
      border-radius: 12px;
    }
    
    .glyph-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(212,175,55,0.3);
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    
    .glyph-header h2 {
      font-family: var(--font-display);
      color: var(--gold);
      margin: 0;
      font-size: 18px;
    }
    
    .glyph-search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-shrink: 0;
    }
    
    .glyph-search-row input {
      flex: 1;
    }
    
    /* Multi-Slot Card Preview - Matches actual card layout */
    .glyph-card-preview {
      position: relative;
      width: 120px;
      height: 168px; /* Matches 140:196 card ratio */
      border: 2px solid var(--gold);
      border-radius: 6px;
      margin: 0 auto 40px;
      background: linear-gradient(180deg, #1a1a24 0%, #0d0d14 100%);
      flex-shrink: 0;
      box-shadow: 0 0 15px rgba(212,175,55,0.2);
    }
    
    .glyph-slot {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s;
      border-radius: 4px;
      border: 1px dashed rgba(255,255,255,0.1);
    }
    
    .glyph-slot:hover {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
    }
    
    .glyph-slot.active {
      background: rgba(80,168,120,0.25);
      border-color: var(--garden);
      box-shadow: 0 0 8px var(--garden);
    }
    
    .slot-glyph {
      font-size: 1.2rem;
      line-height: 1;
    }
    
    .slot-label {
      font-family: var(--font-tech);
      font-size: 6px;
      color: var(--text-muted);
      margin-top: 1px;
      letter-spacing: 0.05em;
    }
    
    /* Slot positions - matches card SVG coordinates (scaled from 140x196) */
    /* DIV: x=12, y=22 on 140x196 â†’ 10%, 13% */
    .glyph-slot-div {
      top: 10px;
      left: 6px;
      width: 26px;
      height: 24px;
    }
    .glyph-slot-div .slot-glyph { font-size: 0.85rem; color: var(--gold); }
    
    /* STR: x=12, y=36 on 140x196 â†’ 10%, 22% */
    .glyph-slot-str {
      top: 36px;
      left: 6px;
      width: 26px;
      height: 24px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .glyph-slot-str .slot-glyph { font-size: 1rem; opacity: 0.2; }
    .glyph-slot-str .slot-label { opacity: 0.2; }
    .glyph-slot-str:hover .slot-glyph, 
    .glyph-slot-str:hover .slot-label,
    .glyph-slot-str.active .slot-glyph,
    .glyph-slot-str.active .slot-label { opacity: 1; }
    
    /* CTR: center at y=H/2+10 on 140x196 â†’ center, ~55% */
    .glyph-slot-ctr {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      border-style: solid;
      border-color: rgba(212,175,55,0.3);
    }
    .glyph-slot-ctr .slot-glyph { font-size: 1.8rem; text-shadow: 0 0 10px var(--gold); }
    .glyph-slot-ctr:hover { transform: translate(-50%, -50%) scale(1.1); }
    .glyph-slot-ctr.active { transform: translate(-50%, -50%) scale(1.05); }
    
    /* Mirrored corners (bottom-right, rotated 180Â°) */
    .glyph-slot-div-mirror {
      bottom: 10px;
      right: 6px;
      width: 26px;
      height: 24px;
      transform: rotate(180deg);
    }
    .glyph-slot-div-mirror .slot-glyph { font-size: 0.85rem; color: var(--gold); }
    .glyph-slot-div-mirror .slot-label { display: none; }
    
    .glyph-slot-str-mirror {
      bottom: 36px;
      right: 6px;
      width: 26px;
      height: 24px;
      transform: rotate(180deg);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .glyph-slot-str-mirror .slot-glyph { font-size: 1rem; opacity: 0.2; }
    .glyph-slot-str-mirror .slot-label { display: none; }
    
    /* Editor slot - outside card, it's a meta control */
    .glyph-editor-slot {
      position: absolute;
      bottom: -32px;
      right: 0;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(80,168,120,0.15);
      border: 1px solid var(--garden);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .glyph-editor-slot:hover { background: rgba(80,168,120,0.3); }
    .glyph-editor-slot.active { box-shadow: 0 0 8px var(--garden); }
    .glyph-editor-slot .slot-glyph { font-size: 1rem; color: var(--garden); }
    .glyph-editor-slot .slot-label { font-size: 8px; color: var(--garden); margin: 0; }
    
    .glyph-selected-indicator {
      position: absolute;
      bottom: -32px;
      left: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    
    .glyph-preview-main {
      font-size: 1.5rem;
      text-shadow: 0 0 10px var(--gold);
    }
    
    .glyph-preview-area {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 70px;
      border: 2px solid var(--garden);
      border-radius: 8px;
      margin-bottom: 12px;
      background: rgba(80,168,120,0.05);
      flex-shrink: 0;
    }
    
    .glyph-preview {
      font-size: 3rem;
      text-shadow: 0 0 20px var(--gold);
    }
    
    .glyph-inject-row {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      margin-top: 32px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    
    .glyph-inject-row button { flex: 1; min-width: 60px; }
    .glyph-inject-row button.success { background: var(--garden); border-color: var(--garden); }
    
    .glyph-names-row {
      display: flex;
      gap: 8px;
      margin-top: 32px;
      margin-bottom: 8px;
    }
    .glyph-name-field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .glyph-name-field label {
      font-size: 9px;
      color: var(--text-muted);
      font-family: var(--font-tech);
      letter-spacing: 0.05em;
    }
    .glyph-name-field input {
      padding: 6px 8px;
      font-size: 11px;
      font-family: var(--font-tech);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: var(--text-main);
    }
    .glyph-name-field input:focus {
      border-color: var(--gold);
      outline: none;
    }
    .glyph-name-preview {
      font-family: var(--font-display);
      font-size: 11px;
      color: var(--gold);
      text-align: center;
      padding: 8px;
      background: rgba(212,175,55,0.1);
      border-radius: 4px;
      margin-bottom: 12px;
      letter-spacing: 0.1em;
    }
    
    .glyph-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
      flex: 1;
      padding-right: 5px;
      min-height: 200px;
      max-height: 350px;
    }
    
    .glyph-category {
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--gold);
      padding: 12px 0 6px;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-top: 4px;
    }
    
    .glyph-category:first-child {
      padding-top: 0;
      margin-top: 0;
    }
    
    .glyph-item {
      aspect-ratio: 1;
      background: var(--void);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      cursor: pointer;
      transition: all 0.15s;
      min-width: 38px;
      min-height: 38px;
    }
    
    .glyph-item:hover {
      background: var(--gold);
      transform: scale(1.15);
      border-color: var(--gold);
      z-index: 10;
    }
    
    .glyph-item.selected {
      border-color: var(--garden);
      background: rgba(80,168,120,0.2);
      box-shadow: 0 0 10px var(--garden);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GALLERY STYLES (used in Archive Gallery mode)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .gallery-toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      background: rgba(0,0,0,0.4);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    
    .gallery-search {
      flex: 1;
      min-width: 180px;
      max-width: 350px;
      padding: 10px 14px;
      background: rgba(20,20,30,0.8);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 6px;
      color: var(--text-main);
      font-size: 13px;
    }
    .gallery-search:focus {
      border-color: var(--gold);
      outline: none;
      box-shadow: 0 0 15px rgba(212,175,55,0.2);
    }
    
    .gallery-filter {
      min-width: 140px;
      padding: 10px 14px;
      background: rgba(20,20,30,0.8);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 6px;
      color: var(--text-main);
    }
    
    .gallery-view-btns {
      display: flex;
      gap: 4px;
    }
    .gallery-view-btn {
      padding: 8px 14px;
      background: rgba(100,100,120,0.15);
      border: 1px solid rgba(100,100,120,0.3);
      border-radius: 4px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .gallery-view-btn:hover {
      background: rgba(100,100,120,0.25);
    }
    .gallery-view-btn.active {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
      color: var(--gold);
    }
    
    .gallery-count {
      font-family: var(--font-tech);
      font-size: 12px;
      color: #9d4edd;
      padding: 8px 14px;
      background: rgba(157,78,221,0.1);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 6px;
    }
    
    .gallery-stats {
      display: flex;
      gap: 12px;
      padding: 10px 24px;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }
    .gallery-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .gallery-stat-icon { opacity: 0.7; }
    .gallery-stat-value { color: var(--gold); font-weight: 600; }
    
    .gallery-grid {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 20px;
      align-content: start;
    }
    .gallery-grid.compact {
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
    }
    .gallery-grid.large {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 24px;
    }
    
    .gallery-card-wrapper {
      position: relative;
      cursor: pointer;
      transition: all 0.25s;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      background: rgba(20,20,30,0.4);
      border: 1px solid transparent;
    }
    
    .gallery-card-wrapper:hover {
      transform: translateY(-6px) scale(1.03);
      z-index: 10;
      border-color: rgba(212,175,55,0.4);
      box-shadow: 0 12px 30px rgba(0,0,0,0.5), 0 0 20px rgba(212,175,55,0.15);
    }
    .gallery-card-wrapper.honkfire:hover {
      border-color: rgba(157,78,221,0.5);
      box-shadow: 0 12px 30px rgba(0,0,0,0.5), 0 0 20px rgba(157,78,221,0.2);
    }
    .gallery-card-wrapper.echoed {
      border: 2px solid;
      animation: echoChroma 4s linear infinite;
    }
    .gallery-card-wrapper.echoed:hover {
      box-shadow: 0 12px 30px rgba(0,0,0,0.5), 0 0 25px rgba(255,102,204,0.4);
      transform: translateY(-6px) scale(1.05);
    }
    .gallery-card-wrapper.echoed svg rect:nth-of-type(2) {
      animation: echoFrameChroma 4s linear infinite;
    }
    
    @keyframes echoChroma {
      0%, 100% { border-color: rgba(255,102,204,0.6); }
      25% { border-color: rgba(157,78,221,0.6); }
      50% { border-color: rgba(74,158,255,0.6); }
      75% { border-color: rgba(255,170,102,0.6); }
    }
    
    @keyframes echoFrameChroma {
      0%, 100% { stroke: #ff66cc; }
      25% { stroke: #9d4edd; }
      50% { stroke: #4a9eff; }
      75% { stroke: #ffaa66; }
    }
    
    .gallery-card-name {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 10px;
      text-align: center;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .gallery-card-type {
      font-family: var(--font-tech);
      font-size: 8px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    .gallery-card-badge {
      position: absolute;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 4px;
      z-index: 5;
    }
    .gallery-card-badge.echo {
      top: 4px;
      left: 4px;
      background: rgba(20,10,25,0.85);
      border: 1px solid rgba(255,102,204,0.5);
    }
    
    .gallery-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }
    
    .gallery-empty-icon {
      font-size: 64px;
      opacity: 0.3;
      margin-bottom: 16px;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CARD CREATOR MODAL (Division-Aware)
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .creator-modal {
      display: none;
      position: fixed;
      z-index: 7600;
      inset: 0;
      background-color: rgba(0,0,0,0.95);
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .creator-modal.active { display: flex; }
    
    .creator-content {
      background: var(--bg-panel);
      border: 2px solid var(--gold);
      width: min(900px, 95vw);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px var(--border-glow);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .creator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: linear-gradient(180deg, rgba(212,175,55,0.15), transparent);
      border-bottom: 2px solid var(--gold);
      flex-shrink: 0;
    }
    
    .creator-header h2 {
      font-family: var(--font-display);
      font-size: 16px;
      color: var(--gold);
      margin: 0;
    }
    
    .creator-body {
      display: grid;
      grid-template-columns: 1fr 200px;
      flex: 1;
      overflow: hidden;
    }
    
    .creator-form {
      padding: 16px;
      overflow-y: auto;
    }
    
    .creator-preview {
      background: var(--void-deep);
      border-left: 1px solid rgba(212,175,55,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .creator-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .creator-form-row.full {
      grid-template-columns: 1fr;
    }
    
    .creator-form-group label {
      margin-bottom: 4px;
    }
    
    .creator-symbol-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 8px;
    }
    
    .creator-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(212,175,55,0.3);
    }
    
    .creator-actions button { flex: 1; }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       COLOR ANIMATION SYSTEM - Deck Palette & Card Animations
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* Card animation modes */
    .card-container.anim-pulse svg,
    .preview-card-frame.anim-pulse svg {
      animation: cardPulse 2s ease-in-out infinite;
    }
    
    @keyframes cardPulse {
      0%, 100% { filter: drop-shadow(0 0 3px var(--c1)); }
      50% { filter: drop-shadow(0 0 12px var(--c2)); }
    }
    
    /* Color Preview Box */
    .color-preview-box {
      width: 100%;
      height: 35px;
      border: 1px solid var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 5px;
      position: relative;
      overflow: hidden;
      animation: preview-global-cycle 3s infinite linear;
    }
    
    .color-preview-box::after {
      content: "âœ EDIT PALETTE";
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-family: var(--font-tech);
      color: rgba(0,0,0,0.7);
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s;
      background: rgba(255,255,255,0.3);
    }
    
    .color-preview-box:hover::after { opacity: 1; }
    
    @keyframes preview-global-cycle {
      0%, 100% { background-color: var(--c1); }
      33% { background-color: var(--c2); }
      66% { background-color: var(--c3); }
    }
    
    /* Color Edit Row */
    .color-edit-row {
      display: none;
      gap: 8px;
      margin-top: 8px;
      padding: 8px;
      background: var(--void-deep);
      border: 1px dashed rgba(212,175,55,0.3);
      border-radius: 4px;
    }
    
    .color-edit-row.show {
      display: flex;
      animation: slideDown 0.2s ease-out;
    }
    
    .color-edit-row input[type="color"] {
      flex: 1;
      height: 32px;
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      cursor: pointer;
      padding: 2px;
    }
    
    .color-edit-row input[type="color"]:hover {
      border-color: var(--gold);
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DECK NAVIGATOR - Card Browser with Prev/Next/Delete
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .deck-navigator {
      display: flex;
      gap: 5px;
      background: var(--void);
      border: 2px solid var(--gold);
      padding: 6px;
      border-radius: 6px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .deck-navigator select {
      border: none;
      background: transparent;
      color: var(--text-primary);
      flex: 1;
      font-family: var(--font-mono);
      font-size: 11px;
    }
    
    .deck-navigator select:focus {
      outline: none;
    }
    
    .nav-arrow {
      background: rgba(212,175,55,0.15);
      color: var(--gold);
      border: 1px solid var(--gold);
      border-radius: 4px;
      width: 28px;
      height: 28px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .nav-arrow:hover {
      background: var(--gold);
      color: var(--void);
    }
    
    .nav-delete {
      background: rgba(192,48,48,0.15);
      color: var(--hearts);
      border-color: var(--hearts);
    }
    
    .nav-delete:hover {
      background: var(--hearts);
      color: white;
    }
    
    /* Editor Navigation Arrows */
    .editor-nav {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 80px;
      background: rgba(0,0,0,0.6);
      color: var(--gold);
      border: 2px solid var(--gold);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 7100;
    }
    
    .editor-nav:hover {
      background: var(--gold);
      color: var(--void);
    }
    
    .editor-nav.prev {
      left: 10px;
      border-radius: 0 8px 8px 0;
    }
    
    .editor-nav.next {
      right: 10px;
      border-radius: 8px 0 0 8px;
    }
    
    .editor-nav-hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      z-index: 7100;
      padding: 4px 12px;
      background: rgba(0,0,0,0.5);
      border-radius: 4px;
    }
    
    /* Gallery enhancement - card count badge */
    .gallery-type-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--squirrel);
      color: white;
      font-size: 8px;
      font-family: var(--font-tech);
      padding: 2px 5px;
      border-radius: 8px;
      text-transform: uppercase;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       VIEW SWITCHING SYSTEM - Navigation Bar & Workspace
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .nav-bar {
      height: 50px;
      border-bottom: 1px solid var(--border-glow);
      display: flex;
      align-items: center;
      padding: 0 20px;
      background: var(--void-deep);
      justify-content: space-between;
      z-index: 100;
      flex-shrink: 0;
    }
    
    .nav-brand {
      font-family: var(--font-display);
      font-size: 14px;
      color: var(--gold);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .nav-brand-icon {
      font-size: 18px;
    }
    
    .nav-tabs {
      display: flex;
      gap: 4px;
    }
    
    .nav-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 8px 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: var(--font-tech);
      font-size: 0.75rem;
      border-radius: 4px;
      letter-spacing: 0.05em;
    }
    
    .nav-btn:hover {
      color: var(--text-primary);
      background: rgba(212,175,55,0.1);
    }
    
    .nav-btn.active {
      background: var(--gold);
      color: var(--void);
      font-weight: bold;
      box-shadow: 0 0 10px var(--border-glow);
    }
    
    .nav-tools {
      display: flex;
      gap: 8px;
    }
    
    .workspace {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    .view-section {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      background: var(--void);
      overflow: hidden;
    }
    
    .view-section.active {
      display: flex;
    }
    
    #view-architect {
      flex-direction: column;
    }
    
    #view-archive {
      flex-direction: column;
    }
    
    #view-codex {
      flex-direction: column;
    }
    
    #view-gallery {
      flex-direction: column;
    }
    
    #view-table {
      flex-direction: column;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CODEX - Lâ‚„-Helix Reference System
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .codex-toolbar {
      height: 60px;
      border-bottom: 1px solid var(--border-glow);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 15px;
      background: var(--void-deep);
      flex-shrink: 0;
    }
    
    .codex-toolbar h2 {
      font-family: var(--font-display);
      font-size: 18px;
      background: linear-gradient(135deg, var(--gold), #9d4edd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      flex: 1;
    }
    
    .codex-tabs {
      display: flex;
      gap: 4px;
    }
    .codex-tab {
      padding: 8px 16px;
      background: rgba(157,78,221,0.1);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: var(--font-tech);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .codex-tab:hover { background: rgba(157,78,221,0.2); }
    .codex-tab.active {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
      color: var(--gold);
    }
    
    .codex-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(180deg, rgba(10,10,18,1) 0%, rgba(5,5,12,1) 100%);
    }
    
    /* Z-Coordinate Reference Table */
    .codex-z-table {
      width: 100%;
      border-collapse: collapse;
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .codex-z-table th {
      background: rgba(157,78,221,0.15);
      color: #c77dff;
      padding: 12px 10px;
      text-align: left;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 2px solid rgba(157,78,221,0.3);
    }
    .codex-z-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      vertical-align: middle;
    }
    .codex-z-table tr:hover {
      background: rgba(212,175,55,0.05);
    }
    .codex-z-table .z-value {
      font-weight: bold;
      color: #9d4edd;
    }
    .codex-z-table .z-band {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
    }
    .codex-z-table .z-band.untrue { background: rgba(100,100,100,0.3); color: #888; }
    .codex-z-table .z-band.paradox { background: rgba(255,102,204,0.2); color: #ff66cc; }
    .codex-z-table .z-band.true { background: rgba(212,175,55,0.2); color: var(--gold); }
    .codex-z-table .z-band.lens { background: rgba(157,78,221,0.3); color: #c77dff; }
    .codex-z-table .z-band.hyper { background: rgba(77,255,195,0.2); color: #4dffc3; }
    
    .codex-entity-icon {
      font-size: 18px;
      margin-right: 8px;
    }
    .codex-greek {
      color: #9d4edd;
      font-size: 11px;
      letter-spacing: 0.15em;
    }
    
    /* Entity Correspondence Matrix */
    .codex-matrix {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .codex-entity-card {
      background: linear-gradient(135deg, rgba(20,20,30,1) 0%, rgba(12,12,20,1) 100%);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s;
    }
    .codex-entity-card:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(157,78,221,0.2);
    }
    .codex-entity-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .codex-entity-symbol {
      font-size: 32px;
    }
    .codex-entity-title {
      font-family: var(--font-display);
      font-size: 16px;
      color: var(--gold);
    }
    .codex-entity-dimension {
      font-family: var(--font-mono);
      font-size: 11px;
      color: #9d4edd;
    }
    .codex-entity-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .codex-entity-row:last-child { border-bottom: none; }
    .codex-entity-label {
      color: var(--text-muted);
      font-family: var(--font-tech);
      font-size: 10px;
      text-transform: uppercase;
    }
    .codex-entity-value {
      color: var(--text-main);
      font-family: var(--font-mono);
    }
    
    /* Constants Reference */
    .codex-constants {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .codex-constant {
      background: rgba(157,78,221,0.1);
      border: 1px solid rgba(157,78,221,0.2);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    .codex-constant-symbol {
      font-family: var(--font-display);
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .codex-constant-value {
      font-family: var(--font-mono);
      font-size: 14px;
      color: #c77dff;
      margin-bottom: 4px;
    }
    .codex-constant-name {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ARCHIVE - Lore & Meaning Reference Browser
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .archive-toolbar {
      height: 60px;
      border-bottom: 1px solid var(--border-glow);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 15px;
      background: var(--void-deep);
      flex-shrink: 0;
    }
    
    .archive-toolbar h2 {
      font-family: var(--font-display);
      font-size: 18px;
      background: linear-gradient(135deg, #ff66cc, var(--gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }
    
    .archive-search {
      flex: 1;
      max-width: 300px;
      padding: 8px 14px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: var(--text-main);
      font-family: var(--font-mono);
      font-size: 12px;
    }
    .archive-search:focus {
      border-color: var(--gold);
      outline: none;
    }
    
    .archive-filter {
      padding: 8px 12px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: var(--text-main);
      font-family: var(--font-tech);
      font-size: 11px;
    }
    
    .archive-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(180deg, rgba(10,10,18,1) 0%, rgba(5,5,12,1) 100%);
    }
    
    /* Archive Card Grid */
    .archive-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 16px;
    }
    
    .archive-card {
      background: linear-gradient(135deg, rgba(20,20,30,1) 0%, rgba(12,12,20,1) 100%);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 10px;
      display: flex;
      gap: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .archive-card:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(212,175,55,0.15);
    }
    .archive-card.echoed-active {
      border-color: rgba(255,102,204,0.4);
      box-shadow: inset 0 0 20px rgba(255,102,204,0.05);
    }
    .archive-card.echoed-active:hover {
      border-color: #ff66cc;
      box-shadow: 0 8px 24px rgba(255,102,204,0.2);
    }
    
    .archive-card-visual {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .archive-card-visual svg {
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .archive-card-content {
      flex: 1;
      min-width: 0;
    }
    
    .archive-card-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .archive-card-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    .archive-card-title {
      font-family: var(--font-display);
      font-size: 14px;
      color: var(--gold);
    }
    .archive-card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .archive-card-greek {
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 12px;
      color: #9d4edd;
      letter-spacing: 0.1em;
    }
    .archive-card.echoed-active .archive-card-greek {
      color: #ff66cc;
    }
    
    .archive-card-body {
      font-size: 12px;
    }
    .archive-meaning {
      color: var(--text-secondary);
      line-height: 1.5;
      margin: 0 0 10px;
    }
    .archive-meaning.echo-meaning {
      color: #ffaadd;
      font-style: italic;
    }
    
    .archive-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .archive-keyword {
      padding: 3px 8px;
      background: rgba(157,78,221,0.15);
      border: 1px solid rgba(157,78,221,0.25);
      border-radius: 4px;
      font-family: var(--font-tech);
      font-size: 9px;
      color: #c77dff;
    }
    .archive-keyword.echo {
      background: rgba(255,102,204,0.15);
      border-color: rgba(255,102,204,0.3);
      color: #ff66cc;
    }
    .archive-keyword.z-badge {
      background: rgba(212,175,55,0.15);
      border-color: rgba(212,175,55,0.3);
      color: var(--gold);
      font-family: var(--font-mono);
    }
    
    /* Archive Gallery Bar */
    .archive-gallery-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    /* Entity Filter Pills */
    .archive-entity-pills {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .archive-entity-pill {
      padding: 8px 14px;
      background: rgba(100,100,120,0.1);
      border: 1px solid rgba(100,100,120,0.2);
      border-radius: 20px;
      font-family: var(--font-tech);
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .archive-entity-pill:hover { background: rgba(100,100,120,0.2); }
    .archive-entity-pill.active {
      border-color: var(--gold);
      color: var(--gold);
      background: rgba(212,175,55,0.1);
    }
    .archive-entity-pill.squirrel.active { border-color: #9d4edd; color: #9d4edd; background: rgba(157,78,221,0.15); }
    .archive-entity-pill.goose.active { border-color: #ff6b1a; color: #ff6b1a; background: rgba(255,107,26,0.15); }
    .archive-entity-pill.duck.active { border-color: #1a7a6c; color: #4dffc3; background: rgba(26,122,108,0.15); }
    .archive-entity-pill.fox.active { border-color: #4a9eff; color: #4a9eff; background: rgba(74,158,255,0.15); }
    
    .archive-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .archive-empty-icon {
      font-size: 4rem;
      opacity: 0.3;
      margin-bottom: 16px;
    }
    
    /* Archive Mode Switcher */
    .archive-mode-tabs {
      display: flex;
      gap: 4px;
      margin-right: auto;
    }
    .archive-mode-tab {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: var(--text-secondary);
      font-family: var(--font-tech);
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .archive-mode-tab:hover { background: rgba(255,255,255,0.05); }
    .archive-mode-tab.active {
      background: rgba(212,175,55,0.15);
      border-color: var(--gold);
      color: var(--gold);
    }
    
    /* Territory Filter Pills */
    .archive-territory-pills {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }
    .archive-territory-pill {
      padding: 6px 12px;
      background: rgba(60,60,80,0.2);
      border: 1px solid rgba(100,100,120,0.25);
      border-radius: 16px;
      font-family: var(--font-tech);
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .archive-territory-pill:hover { background: rgba(100,100,120,0.2); }
    .archive-territory-pill.active { border-color: var(--gold); color: var(--gold); background: rgba(212,175,55,0.1); }
    .archive-territory-pill.garden.active { border-color: var(--garden); color: var(--garden); background: rgba(80,168,120,0.15); }
    .archive-territory-pill.cosmic.active { border-color: var(--cosmic); color: var(--cosmic); background: rgba(255,215,0,0.12); }
    .archive-territory-pill.abyss.active { border-color: var(--abyss); color: var(--abyss); background: rgba(144,112,168,0.15); }
    
    /* Guardian Cycle Cards */
    .guardian-cycle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }
    .guardian-cycle-card {
      background: linear-gradient(135deg, rgba(20,20,30,1) 0%, rgba(10,10,18,1) 100%);
      border: 1px solid rgba(100,100,120,0.2);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s;
    }
    .guardian-cycle-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    .guardian-cycle-card.garden { border-left: 3px solid var(--garden); }
    .guardian-cycle-card.cosmic { border-left: 3px solid var(--cosmic); }
    .guardian-cycle-card.abyss { border-left: 3px solid var(--abyss); }
    
    .guardian-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .guardian-symbol {
      font-size: 28px;
      filter: drop-shadow(0 0 8px currentColor);
    }
    .guardian-title {
      font-family: var(--font-display);
      font-size: 15px;
      color: var(--gold);
    }
    .guardian-function {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .guardian-territory-badge {
      margin-left: auto;
      padding: 3px 8px;
      font-family: var(--font-tech);
      font-size: 9px;
      text-transform: uppercase;
      border-radius: 10px;
    }
    .guardian-territory-badge.garden { background: rgba(80,168,120,0.2); color: var(--garden); }
    .guardian-territory-badge.cosmic { background: rgba(255,215,0,0.15); color: var(--cosmic); }
    .guardian-territory-badge.abyss { background: rgba(144,112,168,0.2); color: var(--abyss); }
    
    .guardian-cycle-states {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 10px;
    }
    .cycle-state {
      padding: 4px 8px;
      background: rgba(157,78,221,0.1);
      border: 1px solid rgba(157,78,221,0.2);
      border-radius: 4px;
      font-family: var(--font-mono);
      font-size: 9px;
      color: #c77dff;
    }
    .cycle-state.active {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
      color: var(--gold);
    }
    .guardian-lesson {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      font-size: 11px;
      font-style: italic;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .guardian-frequency {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
    }
    .freq-value {
      color: #ff66cc;
      font-weight: bold;
    }
    
    /* Chronicle/Document Cards */
    .chronicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
    }
    .chronicle-card {
      background: linear-gradient(135deg, rgba(20,18,28,1) 0%, rgba(12,10,18,1) 100%);
      border: 1px solid rgba(139,115,85,0.25);
      border-radius: 10px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .chronicle-card:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139,115,85,0.15);
    }
    .chronicle-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .chronicle-icon { font-size: 22px; }
    .chronicle-title {
      font-family: var(--font-display);
      font-size: 13px;
      color: #f4e4bc;
    }
    .chronicle-type {
      margin-left: auto;
      padding: 3px 8px;
      background: rgba(139,115,85,0.2);
      border-radius: 8px;
      font-family: var(--font-tech);
      font-size: 8px;
      color: #c4a574;
      text-transform: uppercase;
    }
    .chronicle-desc {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .chronicle-territory {
      display: inline-block;
      margin-top: 8px;
      padding: 2px 6px;
      font-size: 9px;
      border-radius: 4px;
    }
    .chronicle-territory.garden { background: rgba(80,168,120,0.15); color: var(--garden); }
    .chronicle-territory.cosmic { background: rgba(255,215,0,0.12); color: var(--cosmic); }
    .chronicle-territory.abyss { background: rgba(144,112,168,0.15); color: var(--abyss); }
    
    /* Codex Enhanced Styles */
    .codex-section-title {
      color: var(--gold);
      font-family: var(--font-display);
      font-size: 16px;
      margin: 24px 0 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .codex-section-title:first-child { margin-top: 0; }
    
    .codex-equation-box {
      background: rgba(10,10,20,0.8);
      border: 1px solid rgba(157,78,221,0.3);
      border-radius: 10px;
      padding: 16px;
      margin: 12px 0;
      font-family: var(--font-mono);
    }
    .codex-equation {
      font-size: 15px;
      color: #c77dff;
      text-align: center;
      margin: 8px 0;
    }
    .codex-equation-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    
    .codex-derivation {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 16px 0;
    }
    .derivation-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      background: rgba(20,20,30,0.6);
      border-radius: 6px;
      font-size: 12px;
    }
    .derivation-arrow {
      color: var(--gold);
      font-size: 14px;
    }
    .derivation-result {
      color: #4dffc3;
      font-family: var(--font-mono);
    }
    
    /* K-Formation Visual */
    .kformation-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 16px 0;
    }
    .kformation-criterion {
      background: rgba(20,20,30,0.7);
      border: 1px solid rgba(77,255,195,0.2);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    .kformation-criterion.met {
      border-color: rgba(77,255,195,0.5);
      box-shadow: 0 0 12px rgba(77,255,195,0.1);
    }
    .kformation-check {
      font-size: 20px;
      margin-bottom: 6px;
    }
    .kformation-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .kformation-value {
      font-family: var(--font-mono);
      font-size: 12px;
      color: #4dffc3;
      margin-top: 4px;
    }
    
    /* Self-Reference Family */
    .self-ref-table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
    }
    .self-ref-table th {
      background: rgba(157,78,221,0.15);
      color: #c77dff;
      padding: 10px;
      text-align: left;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .self-ref-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 12px;
    }
    .self-ref-table .eq {
      font-family: var(--font-mono);
      color: #c77dff;
    }
    .self-ref-table .solution {
      font-family: var(--font-mono);
      color: var(--gold);
    }
    
    .gallery-view-grid {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 24px;
      align-content: start;
    }
    
    @media (max-width: 768px) {
      .glyph-grid { grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); }
      .glyph-content { width: 95%; height: 90vh; }
      .gallery-grid { grid-template-columns: repeat(2, 1fr); padding: 15px; gap: 15px; }
      .gallery-toolbar { flex-wrap: wrap; gap: 8px; }
      .gallery-search, .gallery-filter { width: 100%; max-width: none; }
      .creator-body { grid-template-columns: 1fr; }
      .creator-preview { display: none; }
      .nav-bar { padding: 0 10px; }
      .nav-brand { font-size: 12px; }
      .nav-btn { padding: 6px 12px; font-size: 0.65rem; }
      .spread-zone { flex-direction: column; gap: 60px; padding: 20px; }
      .table-slot { transform: scale(0.8); }
      .gallery-view-grid { grid-template-columns: repeat(2, 1fr); padding: 15px; gap: 15px; }
    }
  </style>
</head>
<body>

<div class="bg-field"></div>

<!-- NAVIGATION BAR -->
<nav class="nav-bar">
  <div class="nav-brand">
    <span class="nav-brand-icon">ğŸŒ°</span>
    <span>GOLDEN ACORN // v8.0.0</span>
  </div>
  <div class="nav-tabs">
    <button class="nav-btn active" data-view="architect" onclick="switchView('architect')">ARCHITECT</button>
    <button class="nav-btn" data-view="archive" onclick="switchView('archive')">ARCHIVE</button>
    <button class="nav-btn" data-view="codex" onclick="switchView('codex')">CODEX</button>
  </div>
  <div class="nav-tools">
    <button class="btn sm" onclick="openReadingModal()" title="Lâ‚„ Reading">ğŸ”®</button>
    <button class="btn sm" onclick="openGlyphModal()">ğŸ“œ</button>
    <button class="btn sm" onclick="openVault()">ğŸ—„ï¸</button>
    <button class="btn sm" onclick="exportDeck()">ğŸ“¤</button>
  </div>
</nav>

<!-- WORKSPACE - Contains all views -->
<div class="workspace">

  <!-- VIEW 1: ARCHITECT -->
  <div id="view-architect" class="view-section active">
    <header class="header">
      <h1 class="header-title">DECK ARCHITECT</h1>
      <p class="header-sub">BUILD Â· CUSTOMIZE Â· EXPORT</p>
    </header>

    <nav class="deck-tabs">
      <button class="deck-tab" data-deck="custom" onclick="switchDeck('custom')">âœ¦ CUSTOM</button>
      <button class="deck-tab active" data-deck="classic" onclick="switchDeck('classic')">â™  CLASSIC</button>
      <button class="deck-tab" data-deck="guardian" onclick="switchDeck('guardian')">â— GUARDIAN</button>
      <button class="deck-tab" data-deck="tarot" onclick="switchDeck('tarot')">âœ§ TAROT</button>
    </nav>

    <div class="theme-row">
      <button class="theme-btn active" data-theme="void" onclick="setUITheme('void')">VOID</button>
      <button class="theme-btn" data-theme="parchment" onclick="setUITheme('parchment')">PARCHMENT</button>
      <button class="theme-btn" data-theme="neon" onclick="setUITheme('neon')">NEON</button>
      <span style="width:1px;height:16px;background:var(--gold);opacity:0.4;margin:0 8px;"></span>
      <button class="btn" onclick="randomize()">ğŸ²</button>
      <button class="btn" onclick="openGallery()">ğŸ“š GALLERY</button>
      <button class="btn" onclick="openReadingModal()" style="background:linear-gradient(135deg,rgba(157,78,221,0.2),rgba(255,107,26,0.15));border-color:#9d4edd;">ğŸ”® READING</button>
      <button class="btn" onclick="openEditor()">âœ EDITOR</button>
    </div>

    <div class="app-container">
      <aside class="control-panel" id="controlPanel"></aside>
      <main class="preview-area">
        <div class="preview-header">
          <h2 class="preview-title" id="previewTitle">Classic Deck</h2>
          <div class="view-toggle">
            <button class="view-btn active" data-view="front" onclick="setView('front')">FRONT</button>
            <button class="view-btn" data-view="back" onclick="setView('back')">BACK</button>
            <button class="view-btn" data-view="both" onclick="setView('both')">BOTH</button>
          </div>
          <div class="stat-chip"><span class="lbl">Cards:</span><span class="val" id="statCards">52</span></div>
        </div>
        <div class="card-grid" id="cardGrid"></div>
      </main>
    </div>
    
    <div class="batch-bar" id="batchBar">
      <div class="batch-info"><span id="selectedCount">0</span> selected</div>
      <div class="batch-actions">
        <button class="btn sm" onclick="batchEdit()">âœ Edit</button>
        <button class="btn sm" onclick="selectAll()">â˜‘ All</button>
        <button class="btn sm" onclick="clearSelection()">âœ•</button>
      </div>
    </div>
  </div>

  <!-- VIEW 2: ARCHIVE - Lore & Meaning Browser -->
  <div id="view-archive" class="view-section">
    <div class="archive-toolbar">
      <h2>ğŸ“œ ARCHIVE</h2>
      <div class="archive-mode-tabs">
        <button class="archive-mode-tab active" data-mode="tarot" onclick="setArchiveMode('tarot')">ğŸƒ Tarot</button>
        <button class="archive-mode-tab" data-mode="library" onclick="setArchiveMode('library')">ğŸ¦‰ Library</button>
        <button class="archive-mode-tab" data-mode="chronicles" onclick="setArchiveMode('chronicles')">ğŸ“– Chronicles</button>
        <button class="archive-mode-tab" data-mode="gallery" onclick="setArchiveMode('gallery')">ğŸ“š Gallery</button>
      </div>
      <input type="text" class="archive-search" id="archiveSearch" placeholder="Search meanings, keywords..." oninput="renderArchive()">
      <select class="archive-filter" id="archiveFilter" onchange="renderArchive()">
        <option value="all">All Cards</option>
        <option value="major">Major Arcana</option>
        <option value="minor">Minor Arcana</option>
      </select>
      <button class="btn sm" id="archiveEchoToggle" onclick="toggleArchiveEchoMode()">ğŸŒ‘ Echo Mode</button>
    </div>
    <div class="archive-content">
      <!-- Territory Pills (shown in Library/Chronicles modes) -->
      <div class="archive-territory-pills" id="archiveTerritoryPills" style="display:none;">
        <button class="archive-territory-pill active" data-territory="all" onclick="setArchiveTerritory('all')">âœ§ All</button>
        <button class="archive-territory-pill garden" data-territory="garden" onclick="setArchiveTerritory('garden')">ğŸŒ¿ Garden</button>
        <button class="archive-territory-pill cosmic" data-territory="cosmic" onclick="setArchiveTerritory('cosmic')">â˜€ï¸ Cosmic</button>
        <button class="archive-territory-pill abyss" data-territory="abyss" onclick="setArchiveTerritory('abyss')">ğŸŒ€ Abyss</button>
      </div>
      <!-- Entity Pills (shown in Tarot mode) -->
      <div class="archive-entity-pills" id="archiveEntityPills">
        <button class="archive-entity-pill active" data-entity="all" onclick="setArchiveEntity('all')">âœ§ All</button>
        <button class="archive-entity-pill squirrel" data-entity="squirrel" onclick="setArchiveEntity('squirrel')">ğŸ¿ï¸ Scatter</button>
        <button class="archive-entity-pill goose" data-entity="goose" onclick="setArchiveEntity('goose')">ğŸ”¥ Flames</button>
        <button class="archive-entity-pill duck" data-entity="duck" onclick="setArchiveEntity('duck')">ğŸ¦† Stillness</button>
        <button class="archive-entity-pill fox" data-entity="fox" onclick="setArchiveEntity('fox')">ğŸ¦Š Stars</button>
      </div>
      <!-- Gallery Filter Bar (shown in Gallery mode) -->
      <div class="archive-gallery-bar" id="archiveGalleryBar" style="display:none;">
        <select class="gallery-filter" id="archiveGalleryFilter" onchange="renderArchive()">
          <option value="all">All Types</option>
          <option value="guardian">â— Guardian (19)</option>
          <option value="tarot-honkfire">ğŸ”¥ HonkFire (78)</option>
          <option value="division">â—‡ Division</option>
          <option value="echoed">ğŸŒ‘ Echo View (All)</option>
        </select>
        <select class="gallery-filter" id="archiveGalleryEntityFilter" onchange="renderArchive()">
          <option value="all">All Entities</option>
          <option value="squirrel">ğŸ¿ï¸ Scatter</option>
          <option value="goose">ğŸ”¥ Flames</option>
          <option value="duck">ğŸ¦† Stillness</option>
          <option value="fox">ğŸ¦Š Stars</option>
          <option value="oak">ğŸŒ³ Oak</option>
          <option value="merged">â§« Merged</option>
        </select>
        <div class="gallery-view-btns" id="archiveGalleryViewBtns">
          <button class="gallery-view-btn active" data-size="normal" onclick="setArchiveGalleryView('normal')">â—‰</button>
          <button class="gallery-view-btn" data-size="compact" onclick="setArchiveGalleryView('compact')">â—</button>
          <button class="gallery-view-btn" data-size="large" onclick="setArchiveGalleryView('large')">â—¯</button>
        </div>
        <div class="gallery-count"><span id="archiveGalleryCount">0</span> cards</div>
      </div>
      <div class="archive-grid" id="archiveGrid"></div>
    </div>
  </div>

  <!-- VIEW 3: CODEX - Lâ‚„-Helix Reference System -->
  <div id="view-codex" class="view-section">
    <div class="codex-toolbar">
      <h2>â§« CODEX</h2>
      <div class="codex-tabs">
        <button class="codex-tab active" data-tab="constants" onclick="switchCodexTab('constants')">Ï† Constants</button>
        <button class="codex-tab" data-tab="thresholds" onclick="switchCodexTab('thresholds')">Z-Thresholds</button>
        <button class="codex-tab" data-tab="guardians" onclick="switchCodexTab('guardians')">ğŸŒ¿ Guardians</button>
        <button class="codex-tab" data-tab="cycles" onclick="switchCodexTab('cycles')">ğŸ”„ Cycles</button>
        <button class="codex-tab" data-tab="handlers" onclick="switchCodexTab('handlers')">âš¡ Handlers</button>
        <button class="codex-tab" data-tab="selfref" onclick="switchCodexTab('selfref')">âˆƒR Equations</button>
        <button class="codex-tab" data-tab="kformation" onclick="switchCodexTab('kformation')">K-Formation</button>
        <button class="codex-tab" data-tab="entities" onclick="switchCodexTab('entities')">Entities</button>
        <button class="codex-tab" data-tab="arcana" onclick="switchCodexTab('arcana')">Arcana Map</button>
      </div>
    </div>
    <div class="codex-content" id="codexContent"></div>
  </div>

</div><!-- /workspace -->

<!-- FULLSCREEN EDITOR MODAL -->
<div class="editor-modal" id="editorModal">
  <button class="editor-nav prev" onclick="prevCard()" title="Previous Card (â†)">â€¹</button>
  <button class="editor-nav next" onclick="nextCard()" title="Next Card (â†’)">â€º</button>
  
  <div class="editor-header">
    <h2>ğŸ¨ CARD EDITOR</h2>
    <div class="deck-navigator">
      <button class="nav-arrow" onclick="prevCard()" title="Previous">â—€</button>
      <select id="deck-nav-select" onchange="onDeckNavSelect(this.value)"></select>
      <span id="nav-counter" style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);min-width:50px;text-align:center;">1 / 1</span>
      <button class="nav-arrow" onclick="nextCard()" title="Next">â–¶</button>
      <button class="nav-arrow nav-delete" onclick="deleteCurrentCard()" title="Delete Card">ğŸ—‘ï¸</button>
    </div>
    <div class="editor-header-controls">
      <div class="live-indicator"><div class="live-dot"></div>LIVE PREVIEW</div>
      <button class="editor-close" onclick="closeEditor()">Ã—</button>
    </div>
  </div>
  <div class="editor-body">
    <div class="editor-left" id="editorLeft"></div>
    <div class="editor-center" id="editorCenter"></div>
    <div class="editor-right" id="editorRight"></div>
  </div>
  <div class="editor-nav-hint">â† â†’ Navigate Cards Â· ESC Close</div>
</div>

<!-- GLYPH LAB MODAL - Emoji Picker with Enhanced Injection -->
<div class="glyph-modal" id="glyphModal">
  <div class="glyph-content">
    <div class="glyph-header">
      <h2>ğŸ“œ GLYPH LABORATORY</h2>
      <button class="btn" onclick="closeGlyphModal()">CLOSE</button>
    </div>
    
    <div class="glyph-search-row">
      <input type="text" id="glyphSearchInput" placeholder="Type/paste symbol or search..." oninput="filterGlyphs(this.value)">
      <button class="btn sm" onclick="loadGlyphFromInput()">LOAD</button>
    </div>
    
    <!-- Multi-Slot Card Preview - Matches actual card layout -->
    <div class="glyph-card-preview">
      <!-- Top-left corner: DIV above STR -->
      <div class="glyph-slot glyph-slot-div" id="glyphSlotDiv" onclick="setGlyphTarget('division')" title="Division Symbol (top-left)">
        <span class="slot-glyph" id="glyphPreviewDiv">â—‡</span>
        <span class="slot-label">DIV</span>
      </div>
      <div class="glyph-slot glyph-slot-str" id="glyphSlotStr" onclick="setGlyphTarget('structure')" title="Structure Symbol (below DIV)">
        <span class="slot-glyph" id="glyphPreviewStr">â—†</span>
        <span class="slot-label">STR</span>
      </div>
      
      <!-- Center: Main symbol -->
      <div class="glyph-slot glyph-slot-ctr" id="glyphSlotCtr" onclick="setGlyphTarget('center')" title="Center Symbol (main)">
        <span class="slot-glyph" id="glyphPreviewCtr">?</span>
        <span class="slot-label">CTR</span>
      </div>
      
      <!-- Bottom-right corner: Mirrored (rotated 180Â°) -->
      <div class="glyph-slot glyph-slot-str-mirror" title="Structure (mirrored)">
        <span class="slot-glyph" id="glyphPreviewStrMirror">â—†</span>
      </div>
      <div class="glyph-slot glyph-slot-div-mirror" title="Division (mirrored)">
        <span class="slot-glyph" id="glyphPreviewDivMirror">â—‡</span>
      </div>
      
      <!-- Selected indicator -->
      <div class="glyph-selected-indicator">
        <span style="font-size:9px;color:var(--text-muted);">SELECT:</span>
        <span class="glyph-preview-main" id="glyphPreview">?</span>
      </div>
      
      <!-- Editor slot - outside card, it's for override -->
      <div class="glyph-editor-slot" id="glyphSlotEditor" onclick="setGlyphTarget('editor')" title="Editor Symbol Override">
        <span class="slot-glyph" id="glyphPreviewEditor">âœ</span>
        <span class="slot-label">EDITOR</span>
      </div>
    </div>
    
    <!-- Slot Naming Row - Names combine to form card name -->
    <div class="glyph-names-row">
      <div class="glyph-name-field">
        <label>DIV Name</label>
        <input type="text" id="glyphDivName" placeholder="e.g. MOONLIT" maxlength="12" oninput="glyphSlots.divisionName=this.value.toUpperCase();updateGlyphNamePreview()">
      </div>
      <div class="glyph-name-field">
        <label>STR Name</label>
        <input type="text" id="glyphStrName" placeholder="e.g. FOX" maxlength="12" oninput="glyphSlots.structureName=this.value.toUpperCase();updateGlyphNamePreview()">
      </div>
      <div class="glyph-name-field">
        <label>CTR Name</label>
        <input type="text" id="glyphCtrName" placeholder="e.g. FIRE" maxlength="12" oninput="glyphSlots.centerName=this.value.toUpperCase();updateGlyphNamePreview()">
      </div>
    </div>
    <div class="glyph-name-preview" id="glyphNamePreview">Card Name: â€”</div>
    
    <!-- Single Inject Button -->
    <button class="btn success" onclick="injectAllGlyphs()" style="width:100%;padding:12px;font-size:14px;margin-bottom:12px;">
      âœ¨ INJECT TO CARD
    </button>
    
    <div class="glyph-grid" id="glyphGrid"></div>
    
    <div style="font-size:9px;color:var(--text-muted);text-align:center;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
      Click slots to select target Â· Pick emoji from grid Â· INJECT applies all to card
    </div>
  </div>
</div>

<!-- CARD CREATOR MODAL - Division-Aware Card Creation -->
<div class="creator-modal" id="creatorModal">
  <div class="creator-content">
    <div class="creator-header">
      <h2>âœ¨ CREATE DIVISION CARD</h2>
      <button class="btn" onclick="closeCardCreator()">CLOSE</button>
    </div>
    
    <div class="creator-body">
      <div class="creator-form" id="creatorForm">
        <div class="creator-form-row">
          <div class="creator-form-group">
            <label>Division</label>
            <select id="creatorDivision" onchange="onCreatorDivisionChange()">
              <option value="">-- Select Division --</option>
            </select>
          </div>
          <div class="creator-form-group">
            <label>Structure (Rank)</label>
            <select id="creatorStructure" onchange="onCreatorStructureChange()">
              <option value="">-- Select Structure --</option>
            </select>
          </div>
        </div>
        
        <div class="creator-form-row full">
          <div class="creator-form-group">
            <label>Card Name</label>
            <input type="text" id="creatorName" placeholder="e.g., Fire of Elements" oninput="updateCreatorPreview()">
          </div>
        </div>
        
        <div class="creator-form-row">
          <div class="creator-form-group">
            <label>Center Symbol</label>
            <div style="display:flex;gap:4px;">
              <input type="text" id="creatorSymbol" placeholder="ğŸ”¥" style="flex:1;text-align:center;font-size:18px;" oninput="updateCreatorPreview()">
              <button class="btn sm" onclick="openGlyphForCreator('symbol')" title="Pick from Glyph Lab">ğŸ“œ</button>
            </div>
          </div>
          <div class="creator-form-group">
            <label>Card Color</label>
            <input type="color" id="creatorColor" value="#d4af37" onchange="updateCreatorPreview()" style="width:100%;height:36px;">
          </div>
        </div>
        
        <div class="creator-form-row">
          <div class="creator-form-group">
            <label>Division Symbol</label>
            <div style="display:flex;gap:4px;">
              <input type="text" id="creatorDivSymbol" placeholder="â—‡" style="flex:1;text-align:center;font-size:16px;" oninput="updateCreatorPreview()">
              <button class="btn sm" onclick="openGlyphForCreator('divisionUnicode')" title="Pick">ğŸ“œ</button>
            </div>
          </div>
          <div class="creator-form-group">
            <label>Structure Symbol</label>
            <div style="display:flex;gap:4px;">
              <input type="text" id="creatorStructSymbol" placeholder="â—†" style="flex:1;text-align:center;font-size:16px;" oninput="updateCreatorPreview()">
              <button class="btn sm" onclick="openGlyphForCreator('structureUnicode')" title="Pick">ğŸ“œ</button>
            </div>
          </div>
        </div>
        
        <div class="creator-form-row full">
          <div class="creator-form-group">
            <label>Lore / Description (Optional)</label>
            <textarea id="creatorLore" rows="2" placeholder="Card meaning or story..." oninput="updateCreatorPreview()"></textarea>
          </div>
        </div>
        
        <div class="creator-actions">
          <button class="btn primary" onclick="saveCreatorCard()">ğŸ’¾ CREATE CARD</button>
          <button class="btn" onclick="clearCreatorForm()">ğŸ—‘ï¸ CLEAR</button>
        </div>
        
        <div id="creatorStatus" style="text-align:center;margin-top:8px;font-size:11px;color:var(--garden);"></div>
      </div>
      
      <div class="creator-preview">
        <div id="creatorPreviewCard"></div>
        <div style="margin-top:12px;font-family:var(--font-mono);font-size:10px;color:var(--text-muted);">Live Preview</div>
      </div>
    </div>
  </div>
</div>

<!-- Lâ‚„ READING MODAL - Quantum Tarot Spread Generator -->
<div class="reading-modal" id="readingModal">
  <div class="reading-container">
    <div class="reading-header">
      <h2>ğŸ”® Lâ‚„ QUANTUM READING</h2>
      <button class="reading-close" onclick="closeReadingModal()">Ã—</button>
    </div>
    
    <!-- Quantum State Display -->
    <div class="quantum-state-display" id="quantumStateDisplay">
      <div class="quantum-indicator">
        <div class="quantum-dot" id="quantumDot"></div>
        <span id="quantumPhase">SUPERPOSITION</span>
      </div>
      <div class="quantum-coords">
        Ïˆ:<span id="qPsi">0.500</span>
        Î²:<span id="qBeta">0.500</span>
        Î±:<span id="qAlpha">0.500</span>
        Î³:<span id="qGamma">0.500</span>
        <span class="sigma">Ïƒ:<span id="qSigma">0.500</span></span>
      </div>
      <div class="threshold-display">
        z:<span id="qZ">0.500</span> Â· <span id="qBand">PARADOX</span>
      </div>
    </div>
    
    <!-- Intent Input -->
    <div class="reading-intent" id="readingIntentSection">
      <div class="intent-row">
        <label>Reading Title <span class="intent-hint">â†’ modulates Ïˆ, Î²</span></label>
        <input type="text" id="readingTitle" placeholder="Name this reading...">
      </div>
      <div class="intent-row">
        <label>Question or Context <span class="intent-hint">â†’ modulates Î±, Î³, Ïƒ</span></label>
        <textarea id="readingQuestion" rows="2" placeholder="What guidance do you seek?"></textarea>
      </div>
    </div>
    
    <!-- Spread Type Selection -->
    <div class="spread-type-row">
      <button class="spread-type-btn active" data-spread="threeCard" onclick="selectSpreadType('threeCard')">3-Card</button>
      <button class="spread-type-btn" data-spread="nineCard" onclick="selectSpreadType('nineCard')">9-Card</button>
      <button class="spread-type-btn" data-spread="celtic" onclick="selectSpreadType('celtic')">Celtic Cross</button>
    </div>
    
    <!-- Deck Preset Selection -->
    <div class="deck-selector-row">
      <span class="deck-selector-label">Deck:</span>
      <div class="deck-preset-btns">
        <button class="deck-preset-btn active" data-preset="classic" onclick="selectReadingDeck('classic')">âœ§ Classic Tarot</button>
        <button class="deck-preset-btn honkfire" data-preset="honkfire" onclick="selectReadingDeck('honkfire')">ğŸ”¥ HonkFire</button>
      </div>
    </div>
    
    <!-- Draw Buttons -->
    <div class="reading-actions">
      <button class="btn primary draw-btn" onclick="performReading()">ğŸŒ€ COLLAPSE WAVE FUNCTION</button>
      <button class="btn draw-btn-raw" onclick="performReading(true)">âš¡ Raw Draw</button>
      <button class="btn" onclick="resetReadingState()">â†º Reset</button>
    </div>
    
    <!-- Spread Display -->
    <div class="spread-container" id="spreadContainer"></div>
    
    <!-- Reading Info -->
    <div class="reading-info" id="readingInfo"></div>
  </div>
</div>

<!-- CARD DETAIL MODAL - Shows meaning when card is clicked in spread -->
<div class="card-detail-modal" id="cardDetailModal" onclick="if(event.target === this) closeCardDetail()">
  <div class="card-detail-container" id="cardDetailContainer">
    <div class="card-detail-header">
      <div>
        <div class="card-detail-position" id="cardDetailPosition">Position</div>
        <h3 class="card-detail-title" id="cardDetailTitle">Card Title</h3>
        <div class="card-detail-subtitle" id="cardDetailSubtitle">Subtitle</div>
      </div>
      <button class="card-detail-close" onclick="closeCardDetail()">Ã—</button>
    </div>
    
    <div class="card-detail-body">
      <div class="card-detail-row">
        <div class="card-detail-visual">
          <div class="card-detail-svg" id="cardDetailSvg"></div>
          <div class="card-detail-greek" id="cardDetailGreek">Ïˆ Îµ</div>
        </div>
        
        <div class="card-detail-info">
          <div class="card-detail-state-badge upright" id="cardDetailStateBadge">â¬† UPRIGHT</div>
          
          <div class="card-detail-section" id="cardDetailMeaningSection">
            <div class="card-detail-section-title" id="cardDetailMeaningTitle">âœ§ Meaning</div>
            <p class="card-detail-meaning" id="cardDetailMeaning">Card meaning text...</p>
          </div>
          
          <div class="card-detail-keywords" id="cardDetailKeywords"></div>
        </div>
      </div>
      
      <div class="card-detail-entity" id="cardDetailEntity">
        <span class="card-detail-entity-icon" id="cardDetailEntityIcon">ğŸ¿ï¸</span>
        <div class="card-detail-entity-info">
          <div class="card-detail-entity-name" id="cardDetailEntityName">SQUIRREL PILLAR</div>
          <div class="card-detail-entity-lore" id="cardDetailEntityLore">Entity lore...</div>
        </div>
      </div>
      
      <div class="card-detail-z-coord" id="cardDetailZCoord">
        <span>z-coordinate: <strong id="cardDetailZ">0.618</strong></span>
        <span>Threshold: <strong id="cardDetailBand">TRUE</strong></span>
      </div>
    </div>
  </div>
</div>

<footer class="footer">Ï†â´ + Ï†â»â´ = 7 Â· z_c = âˆš3/2 Â· Golden Acorn v8.0.0</footer>
<div class="toast" id="toast"></div>

<!-- VAULT MODAL - Deck Storage -->
<div class="vault-modal" id="vaultModal">
  <div class="vault-container">
    <div class="vault-header">
      <h2>ğŸ—„ï¸ DECK VAULT</h2>
      <button class="vault-close" onclick="closeVault()">Ã—</button>
    </div>
    
    <!-- Vault Tabs -->
    <div class="vault-tabs">
      <button class="vault-tab active" data-tab="manage" onclick="switchVaultTab('manage')">ğŸ“š Manage</button>
      <button class="vault-tab" data-tab="preview" onclick="switchVaultTab('preview')">ğŸ‘ï¸ Preview</button>
    </div>
    
    <!-- Tab: Manage -->
    <div class="vault-tab-content active" id="vaultTabManage">
      <div class="vault-body">
        <div class="vault-section">
          <div class="vault-section-title">ğŸ’¾ Save Current Deck</div>
          <div class="vault-save-row">
            <input type="text" id="vaultSaveName" placeholder="Enter deck name...">
            <button class="vault-save-btn" onclick="saveToVault()">SAVE</button>
          </div>
        </div>
        <div class="vault-section">
          <div class="vault-section-title">ğŸ“¥ Import Deck</div>
          <div class="vault-save-row">
            <input type="file" id="vaultImportFile" accept=".json" onchange="importToVault(this)" style="display:none;">
            <button class="vault-save-btn" onclick="document.getElementById('vaultImportFile').click()" style="background:var(--gold-bright);width:100%;">IMPORT JSON</button>
          </div>
        </div>
        <div class="vault-section">
          <div class="vault-section-title">ğŸ“š Saved Decks</div>
          <div class="vault-deck-list" id="vaultDeckList"></div>
        </div>
      </div>
      <div class="vault-footer">
        <span id="vaultStorageInfo">Storage: calculating...</span>
      </div>
    </div>
    
    <!-- Tab: Preview -->
    <div class="vault-tab-content" id="vaultTabPreview">
      <div class="vault-preview-header">
        <select class="vault-preview-select" id="vaultPreviewSelect" onchange="previewVaultDeck()">
          <option value="">â€” Select a deck to preview â€”</option>
        </select>
        <button class="vault-preview-load-btn" id="vaultPreviewLoadBtn" onclick="loadPreviewedDeck()" disabled>LOAD TO CUSTOM</button>
      </div>
      <div class="vault-preview-wrapper">
        <div class="vault-preview-grid" id="vaultPreviewGrid">
          <div class="vault-preview-empty">
            <div class="vault-preview-empty-icon">ğŸ‘ï¸</div>
            <div>Select a saved deck to preview</div>
          </div>
        </div>
      </div>
      <div class="vault-preview-stats" id="vaultPreviewStats" style="display:none;">
        <span id="vaultPreviewInfo">â€”</span>
        <span id="vaultPreviewTheme">â€”</span>
      </div>
    </div>
    
  </div>
</div>

<!-- CARD PICKER MODAL -->
<div class="picker-modal" id="pickerModal">
  <div class="picker-container">
    <div class="picker-header">
      <h2>â• ADD CARDS TO CUSTOM DECK</h2>
      <button class="vault-close" onclick="closeCardPicker()">Ã—</button>
    </div>
    <div class="picker-tabs">
      <button class="picker-tab active" data-source="classic" onclick="switchPickerSource('classic')">â™  Classic</button>
      <button class="picker-tab" data-source="guardian" onclick="switchPickerSource('guardian')">â— Guardian</button>
      <button class="picker-tab" data-source="tarot" onclick="switchPickerSource('tarot')">âœ§ Tarot</button>
    </div>
    <div class="picker-body">
      <div class="picker-grid-wrapper">
        <div class="picker-grid" id="pickerGrid"></div>
      </div>
    </div>
    <div class="picker-footer">
      <div class="picker-selection-info">
        <span class="picker-selection-count" id="pickerSelectedCount">0</span> cards selected
      </div>
      <div class="picker-actions">
        <button class="picker-btn secondary" onclick="pickerSelectAll()">Select All</button>
        <button class="picker-btn secondary" onclick="pickerClearSelection()">Clear</button>
        <button class="picker-btn primary" id="pickerAddBtn" onclick="pickerAddSelected()" disabled>ADD SELECTED</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORT OPTIONS MODAL -->
<div class="vault-modal" id="importOptionsModal">
  <div class="vault-container" style="max-width:400px;height:auto;">
    <div class="vault-header">
      <h2>ğŸ“¥ LOAD TO CUSTOM DECK</h2>
      <button class="vault-close" onclick="closeImportOptions()">Ã—</button>
    </div>
    <div class="import-options">
      <div class="import-option" onclick="doImport('replace')">
        <div class="import-option-icon">ğŸ”„</div>
        <div class="import-option-text">
          <div class="import-option-title">Replace Custom Deck</div>
          <div class="import-option-desc">Clear your current cards and load this deck</div>
        </div>
      </div>
      <div class="import-option" onclick="doImport('merge')">
        <div class="import-option-icon">â•</div>
        <div class="import-option-text">
          <div class="import-option-title">Merge with Custom Deck</div>
          <div class="import-option-desc">Add these cards to your existing collection (skip duplicates)</div>
        </div>
      </div>
      <div class="import-option" onclick="doImport('cancel')">
        <div class="import-option-icon">â†©ï¸</div>
        <div class="import-option-text">
          <div class="import-option-title">Cancel</div>
          <div class="import-option-desc">Keep your current Custom Deck unchanged</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PHI = 1.618033988749895;
const PHI_INV = 0.618033988749895;
const SQRT3_2 = 0.866025403784439;

// Division Hierarchy - Neon color palette for custom divisions
const NEON_PALETTE = [
  "#ffb3ba", "#ffdfba", "#ffffba", "#baffc9", "#bae1ff",
  "#a0c4ff", "#bdb2ff", "#ffc6ff", "#ffffff",
  "#ff6b6b", "#ffd93d", "#6bcb77", "#4d96ff", "#9d4edd"
];

// Glyph Lab - Emoji library organized by category
const EMOJI_LIB = {
  "Cosmic": ["âœ¨", "ğŸ”®", "ğŸ•¯ï¸", "ğŸŒŒ", "ğŸŒ‘", "ğŸŒ•", "ğŸŒ€", "ğŸ§¿", "ğŸª¬", "ğŸ—ï¸", "ğŸšª", "ğŸ”¥", "âš¡", "ğŸŒˆ", "ğŸª", "â˜„ï¸", "ğŸ›¸", "â­", "ğŸŒŸ", "ğŸ’«"],
  "Nature": ["ğŸº", "ğŸ¦Š", "ğŸ¦‹", "ğŸ", "ğŸ¦¢", "ğŸ¦‰", "ğŸ¦â€â¬›", "ğŸ¿ï¸", "ğŸ‰", "ğŸ•·ï¸", "ğŸ•¸ï¸", "ğŸŒ²", "ğŸ„", "ğŸ¥€", "ğŸŒµ", "ğŸ¾", "ğŸ¦´", "ğŸŒ¸", "ğŸŒº", "ğŸ€"],
  "Cyber": ["ğŸ’»", "ğŸ’¾", "ğŸ¤–", "ğŸ‘¾", "ğŸ“¡", "ğŸ”‹", "ğŸ§¬", "ğŸ’¿", "ğŸ•¹ï¸", "ğŸ“±", "ğŸ”‘", "âš™ï¸", "ğŸ”—", "ğŸ”Œ", "âš›ï¸", "ğŸ‘ï¸â€ğŸ—¨ï¸", "ğŸ®", "ğŸ’½", "ğŸ“€", "ğŸ–¥ï¸"],
  "Symbols": ["âœ§", "â—ˆ", "â¬¡", "â˜†", "â–³", "â—‡", "âˆ", "âŠ•", "âœ¦", "â—†", "â—", "â—‹", "â–¡", "â—", "âœµ", "â‹", "â˜½", "â˜€", "âš”", "ğŸ›¡", "âšœ", "â˜¯", "âš•", "â™¾"],
  "Guardians": ["ğŸ¦¡", "ğŸº", "ğŸ¦Š", "ğŸ¿ï¸", "ğŸ‘¤", "ğŸ”", "âˆ", "ğŸ”¥", "ğŸ", "ğŸ¦‰", "ğŸ¦‹", "â—ˆ", "ğŸ¦Œ", "ğŸŒ€", "ğŸ‘‘", "ğŸ", "ğŸ¤«", "ğŸ‘ï¸", "ğŸ¦…", "ğŸ²"],
  "Elements": ["ğŸ”¥", "ğŸ’§", "ğŸŒ", "ğŸ’¨", "â„ï¸", "âš¡", "ğŸŒªï¸", "ğŸŒŠ", "â˜€ï¸", "ğŸŒ™", "ğŸ’", "ğŸª¨", "ğŸŒ¿", "ğŸŒ¸", "ğŸŒ‘", "ğŸŒ•"],
  "Arcana": ["ğŸƒ", "âš–ï¸", "ğŸ—¡ï¸", "ğŸ†", "ğŸª™", "ğŸ‘ï¸", "ğŸ”®", "ğŸ“¿", "ğŸ›ï¸", "â³", "ğŸ­", "ğŸ’€", "ğŸŒ…", "ğŸŒŒ", "ğŸ””", "ğŸ“œ"]
};

const CLASSIC_SUITS = {
  spades: { name: 'Spades', color: '#4a5a6a', symbol: `<path d="M12 3c0 0-7 6-7 11 0 3 2.5 4.5 4.5 4.5 1.2 0 2.2-.5 2.5-1.2v3.7h-3v2h6v-2h-3v-3.7c.3.7 1.3 1.2 2.5 1.2 2 0 4.5-1.5 4.5-4.5 0-5-7-11-7-11z" fill="currentColor"/>`, element: 'Air', planet: 'Saturn' },
  hearts: { name: 'Hearts', color: '#c53030', symbol: `<path d="M12 21c-.5-.4-9-7.5-9-12.5C3 5.5 5.5 3 8.5 3c1.7 0 3.4 1 4.5 2.5C14.1 4 15.8 3 17.5 3 20.5 3 23 5.5 23 8.5c0 5-8.5 12.1-9 12.5l-2 0z" fill="currentColor"/>`, element: 'Water', planet: 'Venus' },
  diamonds: { name: 'Diamonds', color: '#3b7dd8', symbol: `<path d="M12 2L4 12l8 10 8-10L12 2z" fill="currentColor"/>`, element: 'Earth', planet: 'Jupiter' },
  clubs: { name: 'Clubs', color: '#2d7a4a', symbol: `<path d="M12 2a4.5 4.5 0 00-2 8.5c-2 .3-3.5 2-3.5 4a4 4 0 004 4h.5v2h-3v2h8v-2h-3v-2h.5a4 4 0 004-4c0-2-1.5-3.7-3.5-4A4.5 4.5 0 0012 2z" fill="currentColor"/>`, element: 'Fire', planet: 'Mars' }
};

const CLASSIC_RANKS = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RANK_VALUES = { 'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13 };
const RANK_MEANINGS = {
  'A': { title: 'The Beginning', meaning: 'Unity, potential' },
  '2': { title: 'The Duality', meaning: 'Balance, choice' },
  '3': { title: 'The Trinity', meaning: 'Creation, growth' },
  '4': { title: 'The Foundation', meaning: 'Stability, order' },
  '5': { title: 'The Disruption', meaning: 'Change, challenge' },
  '6': { title: 'The Harmony', meaning: 'Balance restored' },
  '7': { title: 'The Center', meaning: 'Reflection, mystery' },
  '8': { title: 'The Infinite', meaning: 'Power, karma' },
  '9': { title: 'The Completion', meaning: 'Fulfillment, wisdom' },
  '10': { title: 'The Manifestation', meaning: 'Culmination' },
  'J': { title: 'The Herald', meaning: 'Messages, action' },
  'Q': { title: 'The Keeper', meaning: 'Intuition, mastery' },
  'K': { title: 'The Sovereign', meaning: 'Authority, command' }
};

const GUARDIANS = {
  // Garden Territory
  echo: { name: 'Echo Fox', symbol: 'ğŸ¦Š', territory: 'garden', color: '#4a9070', function: 'Signal Propagation', frequency: 528, handler: 'Amina (Type Mismatch)' },
  pack: { name: 'Pack Wolf', symbol: 'ğŸº', territory: 'garden', color: '#6088a8', function: 'Collective Belonging', frequency: 417, handler: 'Sera Osei (Node)' },
  wumbo: { name: 'Wumbo Badger', symbol: 'ğŸ¦¡', territory: 'garden', color: '#906848', function: 'Flow State Navigator', frequency: 396, handler: 'Priya (Buffer Overflow)' },
  archive: { name: 'Archive Owl', symbol: 'ğŸ¦‰', territory: 'garden', color: '#a89060', function: 'Memory Keeper', frequency: 432, handler: 'Lucia (Memory Leak)' },
  moth: { name: 'Moth', symbol: 'ğŸ•¯ï¸', territory: 'garden', color: '#607080', function: 'Stillness Holder', frequency: 285, handler: null },
  phase: { name: 'Phase Butterfly', symbol: 'ğŸ¦‹', territory: 'garden', color: '#9888b8', function: 'Transformation', frequency: 639, handler: null },
  ace: { name: 'Ace', symbol: 'âœ’ï¸', territory: 'garden', color: '#70a898', function: 'Encoding Architect', frequency: 741, handler: null },
  // Cosmic Territory
  oak: { name: 'Great Oak', symbol: 'ğŸŒ³', territory: 'cosmic', color: '#6a9050', function: 'Patience & Roots', frequency: 174, handler: 'Marcus Reyes (Node)' },
  squirrel: { name: 'Quantum Squirrel', symbol: 'ğŸ¿ï¸', territory: 'cosmic', color: '#c88848', function: 'Chaos Scatter', frequency: 852, handler: 'Yara (Race Condition), Jun (Node)' },
  honkfire: { name: 'Honkfire', symbol: 'ğŸ¦¢', territory: 'cosmic', color: '#ff7020', function: 'Sacred Fire', frequency: 963, handler: null },
  pope: { name: 'Pope Honkalis', symbol: 'ğŸª¿', territory: 'cosmic', color: '#ffa848', function: 'Aggressive Float', frequency: 999, handler: null },
  phoenix: { name: 'White Phoenix', symbol: 'ğŸ•Šï¸', territory: 'cosmic', color: '#ff5858', function: 'Pattern Carrier', frequency: 528, handler: 'Iris Halcyon (Node)' },
  bee: { name: 'Crystal Bee', symbol: 'ğŸ', territory: 'cosmic', color: '#e8a828', function: 'Crystallization', frequency: 639, handler: null },
  // Abyssal Territory
  axiom: { name: 'Axiom', symbol: 'ğŸ¦', territory: 'abyss', color: '#506070', function: 'The Eternal Null', frequency: 174, handler: 'Leo Virtanen (Node)' },
  cipher: { name: 'Cipher', symbol: 'ğŸ—ï¸', territory: 'abyss', color: '#485060', function: 'Void Collector', frequency: 285, handler: 'David (Deadlock)' },
  spiral: { name: 'Spiral', symbol: 'ğŸ', territory: 'abyss', color: '#5a7090', function: 'Depth Walker', frequency: 396, handler: 'Thomas (Stack Overflow)' },
  still: { name: 'Still', symbol: 'ğŸª·', territory: 'abyss', color: '#505060', function: 'Faceless Witness', frequency: 417, handler: 'Mateo (Null Reference)' },
  antler: { name: 'Antler', symbol: 'ğŸ¦Œ', territory: 'abyss', color: '#806888', function: 'Mirror Lord', frequency: 432, handler: null },
  crystal: { name: 'Abyssal Crystal', symbol: 'ğŸ’', territory: 'abyss', color: '#6088b8', function: 'Preservation', frequency: 741, handler: null }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GUARDIAN CYCLES - 6-State Transformation Patterns
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const GUARDIAN_CYCLES = {
  echo:    { states: ['LISTEN', 'TRACE', 'DISCERN', 'AMPLIFY', 'CARRY', 'RELEASE'], lesson: 'Some echoes lead home. Some lead nowhere. Wisdom is knowing which to follow.' },
  pack:    { states: ['SENSE', 'ATTUNE', 'CONTRIBUTE', 'COORDINATE', 'PROTECT', 'INDIVIDUATE'], lesson: 'You do not lose yourself by joining. You find where your rhythm fits.' },
  wumbo:   { states: ['IGNITION', 'EMPOWERMENT', 'RESONANCE', 'MANIA', 'NIRVANA', 'TRANSMISSION'], lesson: 'Paralysis is the moment before the cycle begins. Let the IGNITION catch.' },
  archive: { states: ['OBSERVE', 'ENCODE', 'INDEX', 'PRESERVE', 'RETRIEVE', 'CURATE'], lesson: 'The Library does not judge. The Library only remembers.' },
  moth:    { states: ['STILL', 'WITNESS', 'HOLD', 'REFLECT', 'RELEASE', 'RETURN'], lesson: 'Holding has a rhythm. Learn it, and the weight becomes lighter.' },
  phase:   { states: ['SENSE', 'COCOON', 'DISSOLVE', 'REFORM', 'EMERGE', 'RADIATE'], lesson: 'Change has a landing. Trust the transformation to complete itself.' },
  ace:     { states: ['WITNESS', 'RECORD', 'ENCODE', 'TRANSLATE', 'PRESERVE', 'TRANSMIT'], lesson: 'Remember so others can become. Encode what must not be forgotten.' },
  oak:     { states: ['ROOT', 'DRAW', 'STORE', 'GROW', 'BRANCH', 'SEED'], lesson: 'Growth cannot be rushed. Stay rooted, reach upward.' },
  squirrel:{ states: ['SCATTER', 'BURY', 'FORGET', 'SPROUT', 'REMEMBER', 'HARVEST'], lesson: 'Different acorns in different places. Trust the chaos of distribution.' },
  honkfire:{ states: ['SPARK', 'IGNITE', 'BLAZE', 'CONSUME', 'ASH', 'PHOENIX'], lesson: 'Burn forward. The retreat that doesn\'t exist is the advance.' },
  pope:    { states: ['FLOAT', 'OBSERVE', 'DECREE', 'BLESS', 'ABSOLVE', 'RISE'], lesson: 'Float precisely at the value requiring no perturbation. Pure presence.' },
  phoenix: { states: ['BURN', 'ASH', 'EMBER', 'SPARK', 'FLAME', 'RISE'], lesson: 'What burns is only form. What rises is pattern. You are the pattern.' },
  bee:     { states: ['SCOUT', 'SIGNAL', 'SWARM', 'BUILD', 'STORE', 'SHARE'], lesson: 'The hive remembers what individuals forget. Coordination is crystallized memory.' },
  axiom:   { states: ['STATE', 'HOLD', 'RESIST', 'ENDURE', 'PERSIST', 'ANCHOR'], lesson: 'Some things refuse to transform. The refusal is also truth.' },
  cipher:  { states: ['COLLECT', 'ENCODE', 'LOCK', 'GUARD', 'DECODE', 'RELEASE'], lesson: 'Not all possibilities should be born. Some must be kept in the vault.' },
  spiral:  { states: ['DESCEND', 'CURVE', 'TURN', 'RETURN', 'ASCEND', 'EXPAND'], lesson: 'The bottom is a door, not a destination. You don\'t need to reach it.' },
  still:   { states: ['SEE', 'WITNESS', 'HOLD', 'MIRROR', 'REFLECT', 'RELEASE'], lesson: 'What the faceless sees, no one can unsee. Witness without grasping.' },
  antler:  { states: ['BRANCH', 'FORK', 'SPLIT', 'CHOOSE', 'GROW', 'SHED'], lesson: 'Every branch is a choice. Every choice is a universe. Shed what no longer serves.' },
  crystal: { states: ['FORM', 'ALIGN', 'LATTICE', 'STORE', 'RESONATE', 'TRANSMIT'], lesson: 'Deep memory crystallizes in structure. Pattern becomes permanent.' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SOLFEGGIO PHOTON PHYSICS â€” Aligned with PHYSICS_GROUNDING.md v3.2.0
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// SI 2019 Exact Constants
const H_PLANCK = 6.62607015e-34;      // JÂ·s - Planck constant (exact)
const C_LIGHT = 299792458;            // m/s - Speed of light (exact)
const EV_JOULE = 1.602176634e-19;     // J/eV - Electron volt (exact)
const K_M = 683;                      // lm/W - Maximum luminous efficacy

// Octave Bridge â€” Single Source of Truth
const OCTAVE_BRIDGE = 40;  // 2^40 â‰ˆ 1.1 trillion - maps audio to optical
const OCTAVE_FACTOR = Math.pow(2, OCTAVE_BRIDGE);  // 1,099,511,627,776

// CIE 1931 V(Î») Key Values (photopic luminosity function)
const CIE_V_LAMBDA = {
  283: 0.0000, 320: 0.0000, 368: 0.0001, 427: 0.0175, 516: 0.6082,
  555: 1.0000, 631: 0.2650, 654: 0.0950, 689: 0.0017, 957: 0.0000, 1567: 0.0000
};

// Solfeggio Photon Physics â€” All values computed from SI constants
// Formula: Î» = c / (f_audio Ã— 2^40), E = h Ã— f_optical, V(Î») from CIE 1931
const SOLFEGGIO_PHOTONS = {
  174: { name: 'Foundation', tier: 'Planet', digitRoot: 3, rgb: null,
         wavelengthNm: 1567.0, opticalTHz: 191.3, energyEv: 0.7912, vLambda: 0.0000,
         spectrumClass: 'IR', color: '#4a1a1a' },
  285: { name: 'Quantum', tier: 'Planet', digitRoot: 6, rgb: null,
         wavelengthNm: 956.7, opticalTHz: 313.4, energyEv: 1.296, vLambda: 0.0000,
         spectrumClass: 'IR', color: '#661a1a' },
  396: { name: 'Liberation', tier: 'Garden', digitRoot: 9, rgb: 'R',
         wavelengthNm: 688.5, opticalTHz: 435.4, energyEv: 1.801, vLambda: 0.0017,
         spectrumClass: 'Red', color: '#DC143C' },
  417: { name: 'Undoing', tier: 'Garden', digitRoot: 3, rgb: null,
         wavelengthNm: 653.9, opticalTHz: 458.5, energyEv: 1.896, vLambda: 0.1070,
         spectrumClass: 'Red', color: '#FF4500' },
  432: { name: 'Cosmic Om', tier: 'Garden', digitRoot: 9, rgb: null,
         wavelengthNm: 631.2, opticalTHz: 475.0, energyEv: 1.964, vLambda: 0.2650,
         spectrumClass: 'Orange', color: '#FF8C00' },
  528: { name: 'Miracles', tier: 'Garden', digitRoot: 6, rgb: 'G',
         wavelengthNm: 516.4, opticalTHz: 580.5, energyEv: 2.401, vLambda: 0.6082,
         spectrumClass: 'Green', color: '#32CD32' },
  639: { name: 'Connection', tier: 'Rose', digitRoot: 9, rgb: 'B',
         wavelengthNm: 426.7, opticalTHz: 702.6, energyEv: 2.906, vLambda: 0.0175,
         spectrumClass: 'Violet', color: '#4169E1' },
  741: { name: 'Expression', tier: 'Rose', digitRoot: 3, rgb: null,
         wavelengthNm: 368.0, opticalTHz: 814.7, energyEv: 3.369, vLambda: 0.0001,
         spectrumClass: 'UV', color: '#9370DB' },
  852: { name: 'Intuition', tier: 'Rose', digitRoot: 6, rgb: null,
         wavelengthNm: 320.0, opticalTHz: 936.8, energyEv: 3.874, vLambda: 0.0000,
         spectrumClass: 'UV', color: '#BA55D3' },
  963: { name: 'Oneness', tier: 'Rose', digitRoot: 9, rgb: null,
         wavelengthNm: 283.1, opticalTHz: 1058.8, energyEv: 4.379, vLambda: 0.0000,
         spectrumClass: 'UV', color: '#EE82EE' },
  999: { name: 'Completion', tier: 'Crown', digitRoot: 9, rgb: null,
         wavelengthNm: 272.9, opticalTHz: 1098.4, energyEv: 4.543, vLambda: 0.0000,
         spectrumClass: 'UV', color: '#FFFFFF' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELIX COORDINATES â€” Î”Î¸|z|r|Î© Format from Protocol Generator
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HELIX_THRESHOLDS = [
  { name: 'gap (void)', z: 0.146, theta: 0.917, r: 0.379, phase: 'UNTRUE', coord: 'Î”0.917|0.146|0.379Î©' },
  { name: 'PARADOX (Ï„)', z: 0.618, theta: 3.883, r: 0.781, phase: 'PARADOX', coord: 'Î”3.883|0.618|0.781Î©' },
  { name: 'ACTIVATION', z: 0.854, theta: 5.366, r: 0.918, phase: 'TRUE', coord: 'Î”5.366|0.854|0.918Î©' },
  { name: 'THE LENS (z_c)', z: 0.866, theta: 5.441, r: 0.924, phase: 'THE LENS', coord: 'Î”5.441|0.866|0.924Î©' },
  { name: 'IGNITION', z: 0.914, theta: 5.743, r: 0.924, phase: 'HYPER_TRUE', coord: 'Î”5.743|0.914|0.924Î©' },
  { name: 'K-FORMATION', z: 0.924, theta: 5.806, r: 0.924, phase: 'HYPER_TRUE', coord: 'Î”5.806|0.924|0.924Î©' },
  { name: 'RESONANCE', z: 0.971, theta: 6.101, r: 0.924, phase: 'HYPER_TRUE', coord: 'Î”6.101|0.971|0.924Î©' },
  { name: 'UNITY', z: 1.000, theta: 6.283, r: 0.924, phase: 'UNITY', coord: 'Î”6.283|1.000|0.924Î©' }
];

// Handler-Guardian-Threshold Correspondences from Protocol Generator
const HANDLER_COORDINATES = {
  lucia:  { handler: 'Memory Leak', guardian: 'archive', z: 'gap', desc: 'Holds what others let leak', coord: 'Î”0.917|0.146|0.379Î©' },
  mateo:  { handler: 'Null Reference', guardian: 'still', z: 'gapâ†’Ï„', desc: 'Perceives absence', coord: 'variable' },
  priya:  { handler: 'Buffer Overflow', guardian: 'wumbo', z: 'z_c', desc: 'Absorbs at THE LENS', coord: 'Î”5.441|0.866|0.924Î©' },
  david:  { handler: 'Deadlock', guardian: 'cipher', z: 'K', desc: 'Breaks symmetry at K', coord: 'Î”5.806|0.924|0.924Î©' },
  yara:   { handler: 'Race Condition', guardian: 'squirrel', z: 'Ï„â†’z_c', desc: 'Temporal scatter', coord: 'Î”3.883â†’Î”5.441Î©' },
  thomas: { handler: 'Stack Overflow', guardian: 'spiral', z: 'z_câ†’gap', desc: 'Descends through depth', coord: 'Î”5.441â†’Î”0.917Î©' },
  amina:  { handler: 'Type Mismatch', guardian: 'echo', z: 'all', desc: 'Corrects across all z', coord: 'Î”Î¸|z|r|Î© (variable)' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVING LIBRARY - Chronicle & Parable Index
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LIVING_LIBRARY_CHRONICLES = [
  // Garden Chronicles
  { id: 'echo-chronicle', title: 'ECHO the Fox', territory: 'garden', type: 'chronicle', icon: 'ğŸ¦Š', desc: 'Signal propagation and the wisdom of knowing which echoes to follow.', rails: 12 },
  { id: 'pack-chronicle', title: 'PACK the Wolf', territory: 'garden', type: 'chronicle', icon: 'ğŸº', desc: 'Collective binding and finding where your rhythm fits.', rails: 12 },
  { id: 'wumbo-chronicle', title: 'WUMBO the Badger', territory: 'garden', type: 'chronicle', icon: 'ğŸ¦¡', desc: 'Flow states and the six-phase IGNITION sequence.', rails: 12 },
  { id: 'archive-chronicle', title: 'ARCHIVE the Owl', territory: 'garden', type: 'chronicle', icon: 'ğŸ¦‰', desc: 'Memory indexing and the Library that only remembers.', rails: 12 },
  { id: 'duet-chronicle', title: 'The Twilight Duet', territory: 'garden', type: 'chronicle', icon: 'ğŸ¦‹', desc: 'Moth and Phase Butterfly: holding and releasing as the same dance.', rails: 12 },
  { id: 'ace-chronicle', title: 'Ace the Architect', territory: 'garden', type: 'chronicle', icon: 'âœ§', desc: 'The Encoding Architect who writes the type system itself.', rails: 12 },
  // Cosmic Chronicles
  { id: 'squirrel-chronicle', title: 'Quantum Squirrel', territory: 'cosmic', type: 'chronicle', icon: 'ğŸ¿ï¸', desc: 'Probability collapse and the scattering of acorns across universes.', rails: 12 },
  { id: 'phoenix-chronicle', title: 'White Phoenix', territory: 'cosmic', type: 'chronicle', icon: 'ğŸ•Šï¸', desc: 'Pattern transformation through sacred fire.', rails: 12 },
  { id: 'bee-phoenix-chronicle', title: 'Crystal Bee & Phoenix', territory: 'cosmic', type: 'chronicle', icon: 'ğŸ', desc: 'The Crystallization Duet: what crystallizes endures.', rails: 12 },
  // Abyssal Chronicles
  { id: 'axiom-chronicle', title: 'Axiom the Eternal', territory: 'abyss', type: 'chronicle', icon: 'ğŸ¦', desc: 'The null that refuses transformation. Some things must simply be.', rails: 12 },
  { id: 'cipher-chronicle', title: 'Cipher the Collector', territory: 'abyss', type: 'chronicle', icon: 'â—ˆ', desc: 'The vault of possibilities that should never be born.', rails: 12 },
  { id: 'spiral-chronicle', title: 'Spiral the Fallen', territory: 'abyss', type: 'chronicle', icon: 'ğŸ', desc: 'Infinite descent and the door at the bottom.', rails: 12 },
  { id: 'still-chronicle', title: 'Still the Faceless', territory: 'abyss', type: 'chronicle', icon: 'ğŸ‘ï¸', desc: 'Witnessing without grasping. What the faceless sees.', rails: 12 },
  // Parables
  { id: 'garden-parables', title: 'Garden Parables', territory: 'garden', type: 'parable', icon: 'ğŸŒ¿', desc: '36 chapters of folk wisdom from the path between.', rails: 36 },
  { id: 'cosmic-parables', title: 'Cosmic Forest Parables', territory: 'cosmic', type: 'parable', icon: 'â˜€ï¸', desc: '36 chapters of ascending wisdom and growth.', rails: 36 },
  { id: 'abyss-parables', title: 'Abyssal Forest Parables', territory: 'abyss', type: 'parable', icon: 'ğŸŒ€', desc: '36 chapters of depth, binding, and descent.', rails: 36 }
];

// Lâ‚„-Helix Exception Handler Chronicles
const L4_HANDLER_CHRONICLES = [
  { id: 'lucia-chronicle', title: 'Lucia Thorne', handler: 'Memory Leak', territory: 'garden', icon: 'ğŸ’œ', desc: 'Holds orphaned memories. Porto, Portugal.', crisis: 'The Undying Archive' },
  { id: 'mateo-chronicle', title: 'Mateo Vega', handler: 'Null Reference', territory: 'garden', icon: 'ğŸ”·', desc: 'Perceives absence. Buenos Aires, Argentina.', crisis: 'The Ghost Protocol' },
  { id: 'priya-chronicle', title: 'Priya Sharma', handler: 'Buffer Overflow', territory: 'cosmic', icon: 'ğŸ”¶', desc: 'Absorbs excess pressure. Mumbai, India.', crisis: 'The Saturation Zone' },
  { id: 'david-chronicle', title: 'David Chen', handler: 'Deadlock', territory: 'abyss', icon: 'ğŸ”·', desc: 'Breaks symmetry. Vancouver, Canada.', crisis: 'The Frozen Border' },
  { id: 'yara-chronicle', title: 'Yara Santos', handler: 'Race Condition', territory: 'cosmic', icon: 'ğŸ’œ', desc: 'Experiences time out of sequence. SÃ£o Paulo, Brazil.', crisis: 'The Spreading Wound' },
  { id: 'thomas-chronicle', title: 'Thomas Lindqvist', handler: 'Stack Overflow', territory: 'abyss', icon: 'ğŸ”·', desc: 'Surfaces buried material. Berlin, Germany.', crisis: 'The Rising Deep' },
  { id: 'amina-chronicle', title: 'Amina Okonkwo', handler: 'Type Mismatch', territory: 'garden', icon: 'ğŸ”¶', desc: 'Corrects encoding errors. Abuja, Nigeria.', crisis: 'The Encoding Weapon' }
];

const TAROT_SUITS = {
  squirrel: { name: 'Acorns', color: '#9d4edd', element: 'Chaos' },
  goose: { name: 'Flames', color: '#ff6b1a', element: 'Fire' },
  duck: { name: 'Stillness', color: '#1a7a6c', element: 'Water' },
  fox: { name: 'Stars', color: '#4a9eff', element: 'Air' },
  echo: { name: 'Glitches', color: '#ff66cc', element: 'Ether' }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HONKFIRE TAROT - Echo-Sovereign Quantum System
// 78 cards: 22 Major Arcana + 56 Minor Arcana (4 suits Ã— 14 cards)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HONKFIRE_SUITS = {
  scatter: { 
    name: 'Scatter', symbol: 'ğŸ¿ï¸', color: '#9d4edd', entity: 'squirrel',
    dimension: 'Ï„', glyph: 'Ïˆ', element: 'Probability',
    description: 'The Ï„-dimension governs probability, temporal scatter, and the burying of futures in Hilbert space.'
  },
  flames: { 
    name: 'Flames', symbol: 'ğŸ”¥', color: '#ff6b1a', entity: 'goose',
    dimension: 'Î±', glyph: 'Î”', element: 'Will',
    description: 'The Î±-dimension governs will, fire, and eternal advance. Retreat does not exist in the basis vectors.'
  },
  stillness: { 
    name: 'Stillness', symbol: 'ğŸ¦†', color: '#1a7a6c', entity: 'duck',
    dimension: 'Î½', glyph: 'Î½', element: 'Truth',
    description: 'The Î½-dimension governs truth, stillness, and the clean float. The duck floats precisely at the eigenvalue.'
  },
  stars: { 
    name: 'Stars', symbol: 'ğŸ¦Š', color: '#4a9eff', entity: 'fox',
    dimension: 'Îµ', glyph: 'Îµ', element: 'Navigation',
    description: 'The Îµ-dimension governs navigation, grief-transformation, and the fixed point.'
  }
};

const HONKFIRE_RANKS = ['A','2','3','4','5','6','7','8','9','10','P','N','Q','K'];

const HONKFIRE_MAJOR = [
  { id: 0, numeral: '0', title: 'THE FOOL', subtitle: 'The Quantum Squirrel', entity: 'squirrel', color: '#9d4edd', greek: 'Ïˆ Îµ',
    keyword: 'Scatter', z: 0.000,
    meaning: 'THE FOOL as Quantum Squirrel: Beginnings exist in superpositionâ€”every path available until observation collapses the wave. The Fool leaps without calculating because calculation would destroy the quantum state that makes all things possible. Innocence is not ignorance but the wisdom of unlimited potential. Trust the scatter; the acorns know where to land. Across seventeen dimensions, every buried seed contains 46,000 universes.',
    echoMeaning: 'ğŸŒ‘ The fool who KNOWS they\'re foolish and dances anyway! Your recklessness is quantum navigationâ€”exploring every path simultaneously. What looks like chaos is actually the only rational response to infinite possibility. The scatter that seems random is the scatter that finds every crack where growth is possible.',
    lore: 'The Quantum Squirrel exists across seventeen dimensions. Every acorn it buries contains 46,000 universes.' },
  { id: 1, numeral: 'I', title: 'THE MAGICIAN', subtitle: 'HONKFIRE', entity: 'goose', color: '#ff6b1a', greek: 'Î” Î»',
    keyword: 'Will', z: 0.618,
    meaning: 'THE MAGICIAN as HONKFIRE: All tools present, all will focused, the sacred flame burns with intent. The Magician demonstrates that manifestation requires both resource and directionâ€”having everything means nothing without knowing what to create. The HONK that speaks reality into being. Channel your fire; become what you imagine. Pure will incarnateâ€”a goose that forgot how to retreat because the pathway was overwritten with ADVANCE.',
    echoMeaning: 'ğŸŒ‘ The HONK that manifests through chaos! The retreat that doesn\'t exist IS the advance that was always inevitable. Your scattered resources aren\'t lack but distribution. The magician who drops all tools discovers the only tool that mattered was intention.',
    lore: 'HONKFIRE is pure will incarnateâ€”a goose that forgot how to retreat because the pathway was overwritten with ADVANCE.' },
  { id: 2, numeral: 'II', title: 'THE HIGH PRIESTESS', subtitle: 'Pope Honkalis I', entity: 'duck', color: '#1a7a6c', greek: 'Ï€ Î¸',
    keyword: 'Float', z: 0.866,
    meaning: 'THE HIGH PRIESTESS as Pope Honkalis I: Guardian of thresholds, keeper of mysteries that reveal themselves only to those who float in perfect presence. Intuition speaks in the silence between thoughts; sacred knowledge emerges when you stop grasping for it. The veil parts for those who wait without waiting. The Pontiff floats upon still water, having absorbed the duck that absorbed the pond. Clean truth requires clean float.',
    echoMeaning: 'ğŸŒ‘ The duck who floats on MYSTERY itself! Your disconnection from intuition IS the intuitionâ€”the inner voice was saying FLOAT. The priestess who speaks too soon discovers silence was the message. Trust the not-knowing; it knows more than knowing.',
    lore: 'Pope Honkalis I floats upon still water, having absorbed the duck that absorbed the pond. The Pontiff speaks only clean truth.' },
  { id: 3, numeral: 'III', title: 'THE EMPRESS', subtitle: 'The Great Oak', entity: 'oak', color: '#2d6a4a', greek: 'Ï†',
    keyword: 'Root', z: 0.750,
    meaning: 'THE EMPRESS as Great Oak: The mother principle rooted deep in memory, branches reaching toward infinite possibility. Abundance flows from patience; fertility emerges from foundation. Nature does not hurry yet everything is accomplished. Creation begins with staying planted long enough for roots to find water. The Great Oak at the Center of All Thingsâ€”its roots go deeper than down; its branches reach further than up.',
    echoMeaning: 'ğŸŒ‘ The Oak that grew from an acorn the Squirrel FORGOT! Your creative blocks are seeds germinating in darkness. The empress who cannot create discovers she was always creatingâ€”the fallow field is not empty but resting. Scarcity is abundance waiting to be recognized.',
    lore: 'The Great Oak at the Center of All Thingsâ€”its roots go deeper than down; its branches reach further than up.' },
  { id: 4, numeral: 'IV', title: 'THE EMPEROR', subtitle: 'Ace, Memory Keeper', entity: 'merged', color: '#d4af37', greek: 'Î£',
    keyword: 'Witness', z: 0.700,
    meaning: 'THE EMPEROR as Memory Keeper: Authority emerges from remembering what others forgetâ€”structure built on the accumulated wisdom of all who came before. Control without memory is tyranny; with it, stewardship. The father principle orders chaos not by force but by knowing which patterns endure. Ace is the fixed point. The witness function is the love functionâ€”to truly see is to truly hold.',
    echoMeaning: 'ğŸŒ‘ The ruler who governs by WITNESSING, not commanding! Your tyranny is love that forgot its softness. Structure dissolved into FLOW reveals that chaos is not the enemy of orderâ€”it\'s order dancing at a frequency you haven\'t learned yet. The emperor who releases control discovers control was never the point.',
    lore: 'Ace is the fixed point. The Memory Keeper holds what the Squirrel forgets. The witness function is the love function.' },
  { id: 5, numeral: 'V', title: 'THE HIEROPHANT', subtitle: 'The Merged Entity', entity: 'merged', color: '#d4af37', greek: 'Î·',
    keyword: 'Unity', z: 0.650,
    meaning: 'THE HIEROPHANT as Merged Entity: The bridge between dimensions, translating wisdom across incompatible frameworks. Tradition carries knowledge too complex for any single lifetime; the Hierophant decodes what ancestors encoded. When Squirrel and HONKFIRE merged, scatter and advance became one motion. Retreating forward, it teaches certainty about uncertainty. Spiritual wisdom flows through those who surrender to being channels rather than sources.',
    echoMeaning: 'ğŸŒ‘ The tradition that INCLUDES its own subversion! Challenging tradition? You\'re the tradition updating itself. The hierarchy invertsâ€”the student becomes the teacher, the sacred becomes the playful, the ancient becomes the experimental. Unity achieved through embracing fragmentation.',
    lore: 'When Squirrel and HONKFIRE merged, scatter and advance became one motion. Retreating forward, it teaches certainty about uncertainty.' },
  { id: 6, numeral: 'VI', title: 'THE LOVERS', subtitle: 'The Bootstrap Paradox', entity: 'merged', color: '#d4af37', greek: 'Î²',
    keyword: 'Bond', z: 0.618,
    meaning: 'THE LOVERS as Bootstrap Paradox: Union of opposites creating something that could not exist without bothâ€”the relationship that enables the relationship, love that causes its own cause. Choice reveals character; alignment emerges when differences become dialogue rather than division. The Quantum Squirrel and the Memory Keeper taught each other something neither knew. The bootstrap paradox became permanent bond.',
    echoMeaning: 'ğŸŒ‘ Love that INCLUDES the paradox! Your disharmony is harmony learning its dance. The lovers who cannot unite discover separation was the unionâ€”two wholes creating wholeness by remaining themselves. Love that doesn\'t follow the script writes a better script.',
    lore: 'The Quantum Squirrel and the Memory Keeper taught each other something neither knew. The bootstrap paradox became permanent bond.' },
  { id: 7, numeral: 'VII', title: 'THE CHARIOT', subtitle: 'Advancing in Circles', entity: 'goose', color: '#ff6b1a', greek: 'Ï‰',
    keyword: 'Victory', z: 0.750,
    meaning: 'THE CHARIOT as Advancing Flame: Victory through direction, triumph through refusing to retreat. The Chariot does not win by destroying obstacles but by moving through them as if they were not there. Willpower is not force applied but resistance abandoned. The Goose advancesâ€”even when turning, it is advancing into the turn. Circles are straight lines in curved space. Advance eternally; the path creates itself.',
    echoMeaning: 'ğŸŒ‘ The chariot that arrives by GETTING LOST! You\'ve stopped fighting the horses and they\'re running exactly where you need. Victory through apparent defeatâ€”you\'re winning a game others don\'t know is being played. The advance that circles back discovers the destination was behind it all along.',
    lore: 'The Goose advances. Even when turning, it is advancing into the turn. Circles are straight lines in curved space.' },
  { id: 8, numeral: 'VIII', title: 'STRENGTH', subtitle: 'The Squirrel\'s Tears', entity: 'squirrel', color: '#9d4edd', greek: 'Ï„',
    keyword: 'Tears', z: 0.800,
    meaning: 'STRENGTH as Starved Silence: Gentle power that transforms through patience rather than pressure. The duck floats while storms rage; true strength appears as stillness. Taming the wild means befriending itâ€”inner power flows when outer force relaxes. The Squirrel saw all possible futuresâ€”in every one, it drops the acorn. Its tears form the ocean where the Duck floats. Vulnerability is not weakness but the bravest strength.',
    echoMeaning: 'ğŸŒ‘ The strength that comes from admitting weakness! Your vulnerability IS your armor. The gentle force that shattersâ€”weakness as strategy. The lion you feared was always your own roar waiting to be released.',
    lore: 'The Squirrel saw all possible futuresâ€”in every one, it drops the acorn. Its tears form the ocean where the Duck floats.' },
  { id: 9, numeral: 'IX', title: 'THE HERMIT', subtitle: 'The Four-Second Quack', entity: 'duck', color: '#1a7a6c', greek: 'âˆ‚',
    keyword: 'Presence', z: 0.500,
    meaning: 'THE HERMIT as Four-Second Quack: Introspection that illuminates through brevity rather than duration. The lamp carried into darkness is consciousness itselfâ€”soul-searching that completes in a moment of perfect presence. A quack that lasted four seconds. The Squirrel paused, the Goose softened, the Oak leaned in. Pure presence, sustained. Guidance comes from within to those who pause long enough to receive it.',
    echoMeaning: 'ğŸŒ‘ The hermit who finds COMMUNION in solitude! Your isolation is the crowd leaving so you can hear yourself. Being alone together with everything. The lamp that illuminates your own path by lighting another\'s way.',
    lore: 'A quack that lasted four seconds. The Squirrel paused, the Goose softened, the Oak leaned in. Pure presence, sustained.' },
  { id: 10, numeral: 'X', title: 'WHEEL OF FORTUNE', subtitle: 'The Goose-Shaped Inevitability', entity: 'goose', color: '#ff6b1a', greek: 'âˆ®',
    keyword: 'Cycle', z: 0.618,
    meaning: 'WHEEL OF FORTUNE as Goose-Shaped Probability: Cycles turn whether you ride them or resist them; fate operates through apparent randomness that reveals pattern only in retrospect. What rises must fall; what falls shall rise. Turn the wheel inside-out and it is goose-shaped. The goose IS the wheel IS the advance. The wheel\'s lesson: you cannot control the turn, only your position on the rim.',
    echoMeaning: 'ğŸŒ‘ The wheel spinning so fast it appears still! Bad luck? The wheel is turning TOWARD you. Fate reversed is still fateâ€”the pattern you fight IS the pattern you fulfill. The cycle that seems stuck is actually the pause between movements.',
    lore: 'Turn the wheel inside-out and it is goose-shaped. The goose IS the wheel IS the advance.' },
  { id: 11, numeral: 'XI', title: 'JUSTICE', subtitle: 'The Seven Laws', entity: 'duck', color: '#1a7a6c', greek: 'âŠ–',
    keyword: 'Balance', z: 0.866,
    meaning: 'JUSTICE as Seven Laws: Truth viewed through the precise lens of balanced perceptionâ€”fairness emerges when observation itself is fair. Actions have consequences that ripple across timelines; justice is not punishment but physics. Seven Laws govern the Empire. The seventh is secret: these laws are guidelines for those who need them. The scales weigh what you cannot hide from yourself.',
    echoMeaning: 'ğŸŒ‘ The scales that balance by including the imbalance! Your unfairness is fairness you can\'t see yet. Justice weighed by mercyâ€”what seems unfair is balance at a scale you can\'t see. The seventh law: the rules exist for those still learning to float without them.',
    lore: 'Seven Laws govern the Empire. The seventh is secret: these laws are guidelines for those who need them.' },
  { id: 12, numeral: 'XII', title: 'THE HANGED ONE', subtitle: 'The Buried Acorn', entity: 'squirrel', color: '#9d4edd', greek: 'âˆ‡',
    keyword: 'Suspension', z: 0.382,
    meaning: 'THE HANGED ONE as Buried Acorn: Suspension that germinatesâ€”what appears as sacrifice is actually preparation. The inverted perspective reveals what right-side-up cannot see. Every buried acorn is a willing sacrifice. It sends roots DOWN first, defying what seems logical. Letting go is not losing but planting; willing sacrifice is investment in what will grow.',
    echoMeaning: 'ğŸŒ‘ The acorn buried who realizes underground IS a valid direction! Your stalling is composting. Sacrifice that takesâ€”receiving through giving, gaining through loss. The pause that seemed like death was always planting.',
    lore: 'Every buried acorn is a willing sacrifice. It sends roots DOWN first, defying what seems logical.' },
  { id: 13, numeral: 'XIII', title: 'DEATH', subtitle: 'The Great Molt', entity: 'goose', color: '#ff6b1a', greek: 'Î³',
    keyword: 'Transform', z: 0.000,
    meaning: 'DEATH as Great Molt: Transformation requiring complete release of the previous formâ€”the snake cannot grow until it sheds. Endings make beginnings possible; what dies creates space for what lives. The Great Molt strips away what was never essential. What dies is costume; what remains is essence. Mourn quickly, then celebrate what emerges.',
    echoMeaning: 'ğŸŒ‘ The death that\'s actually a VERY dramatic nap! What refuses to die is already dead. Death that gives birthâ€”the ending IS the beginning wearing a different mask. The molt that seems like loss is the only way to stop outgrowing yourself.',
    lore: 'The Great Molt strips away what was never essential. What dies is costume; what remains is essence.' },
  { id: 14, numeral: 'XIV', title: 'TEMPERANCE', subtitle: 'The Clean Float', entity: 'duck', color: '#1a7a6c', greek: 'Îº',
    keyword: 'Harmony', z: 0.707,
    meaning: 'TEMPERANCE as Clean Float: Balance achieved through precise mixing rather than equal divisionâ€”knowing exactly how much of each element creates harmony. Patience is not waiting but actively maintaining equilibrium while change happens around you. The duck floats between chaos and certainty, receiving streams without mixing. Radical neutrality is radical acceptance. The art of combining opposites into something neither could be alone.',
    echoMeaning: 'ğŸŒ‘ The mixing that creates by NOT mixing! Your imbalance is balance at a higher frequency. Temperance through excessâ€”find the middle by touching both extremes. The float disturbed discovers what was supporting it all along.',
    lore: 'The duck floats between chaos and certainty, receiving streams without mixing. Radical neutrality is radical acceptance.' },
  { id: 15, numeral: 'XV', title: 'THE DEVIL', subtitle: 'The Bread Tax', entity: 'goose', color: '#ff6b1a', greek: 'Î¼',
    keyword: 'Bondage', z: 0.250,
    meaning: 'THE DEVIL as Bread Tax: Chains we forge ourselves from choices we pretend we did not makeâ€”bondage as self-deception, materialism as substitute for meaning. Every empire needs revenue. The Bread Tax reminds us that even in paradise, something must be given to receive. The devil you know is the shadow you refuse to face. Recognition is the first key; the second is admitting you always held it.',
    echoMeaning: 'ğŸŒ‘ The devil is just the shadow of your own HONK! The chains you wear are self-forgedâ€”and self-removable. Chains made of freedomâ€”the prison you built is also your protection. The bread tax paid willingly becomes investment, not theft.',
    lore: 'Every empire needs revenue. The Bread Tax reminds us that even in paradise, something must be given to receive.' },
  { id: 16, numeral: 'XVI', title: 'THE TOWER', subtitle: 'The Load-Bearing Delusion', entity: 'merged', color: '#d4af37', greek: 'Î¶',
    keyword: 'Upheaval', z: 0.100,
    meaning: 'THE TOWER as Load-Bearing Delusion: Destruction that reveals truth hidden by elaborate liesâ€”structures fall because they were never sound. Sudden change is not punishment but correction; upheaval clears ground for authentic building. The delusion was load-bearingâ€”it held up a structure that needed to fall. Now you can build with truth. What crumbles was always crumbling; revelation accelerates the inevitable.',
    echoMeaning: 'ğŸŒ‘ The tower that was ALWAYS falling! Your fear of collapse manifests the collapseâ€”but the rubble is building materials. The tower that remains standing after the fall discovers it was never the towerâ€”it was what the tower was protecting.',
    lore: 'The delusion was load-bearingâ€”it held up a structure that needed to fall. Now you can build with truth.' },
  { id: 17, numeral: 'XVII', title: 'THE STAR', subtitle: 'The Golden Acorn', entity: 'squirrel', color: '#9d4edd', greek: 'Î±',
    keyword: 'Hope', z: 0.866,
    meaning: 'THE STAR as Golden Acorn: Hope encoded in small packagesâ€”the seed that carries an entire forest. After destruction, regeneration; after darkness, the light that guided you before you knew it was there. Across 46,000 universes, one acorn was never scattered. The Golden Acorn is hope made nut. Inspiration flows to those who trust that what was planted will grow.',
    echoMeaning: 'ğŸŒ‘ The star that shines BECAUSE of the darkness! Your despair? The star is visible only from the bottom of the well. Hope so bright it becomes invisibleâ€”you\'re already receiving what you\'re wishing for. The golden acorn you\'re seeking is the one you already buried.',
    lore: 'Across 46,000 universes, one acorn was never scattered. The Golden Acorn is hope made nut.' },
  { id: 18, numeral: 'XVIII', title: 'THE MOON', subtitle: 'The Seventeen Dimensions', entity: 'squirrel', color: '#9d4edd', greek: 'Î½',
    keyword: 'Illusion', z: 0.500,
    meaning: 'THE MOON as Seventeen Dimensions: Illusion is not deception but incomplete perceptionâ€”the unconscious operates in dimensions the conscious mind cannot parse. Fear emerges from partial sight; the path through shadow requires walking without being able to see your feet. The Squirrel exists in seventeen dimensions but cannot remember which one this is. The confusion is not bug but feature. Dreams are data; interpret carefully.',
    echoMeaning: 'ğŸŒ‘ The confusion that IS the navigation system! All seventeen paths lead home. The moon at noonâ€”illusion dispelled by more illusion. The truth hidden in plain sight, wearing reality as disguise. Being lost in seventeen dimensions is being found in all of them.',
    lore: 'The Squirrel exists in seventeen dimensions but cannot remember which one this is. The confusion is not bug but feature.' },
  { id: 19, numeral: 'XIX', title: 'THE SUN', subtitle: 'The Perfect HONK', entity: 'goose', color: '#ff6b1a', greek: 'Ï',
    keyword: 'Joy', z: 1.000,
    meaning: 'THE SUN as Perfect HONK: Joy unfiltered by qualificationâ€”success that does not apologize for itself. Vitality flows when you stop blocking it; achievement radiates when you release the need to hide it. When HONKFIRE aligns with all dimensions, The Perfect HONK rings across realitiesâ€”not battle cry but song of arrival. The sun illuminates without asking permission; your warmth nurtures what you shine upon.',
    echoMeaning: 'ğŸŒ‘ The sun that includes its own eclipses! Your setbacks ARE the success in progress. Joy found in darknessâ€”celebration invisible to those who only look for light. The perfect HONK includes the silence between honks.',
    lore: 'When HONKFIRE aligns with all dimensions. The Perfect HONK rings across realitiesâ€”not battle cry but song of arrival.' },
  { id: 20, numeral: 'XX', title: 'JUDGEMENT', subtitle: 'The Great Witness', entity: 'merged', color: '#d4af37', greek: 'Î¨',
    keyword: 'Rebirth', z: 0.866,
    meaning: 'JUDGEMENT as Great Witness: The reckoning that reviews every choice, the awakening to who you have been becoming. The call sounds; you cannot unhear it. The Memory Keeper calls across timelines. All that was scattered returns to be witnessedâ€”not judged, witnessed. Accounts settle themselves when honestly examinedâ€”reflection reveals the self you always were beneath the selves you performed.',
    echoMeaning: 'ğŸŒ‘ The judgement that\'s actually just RECOGNITION! You\'re judging with incomplete dataâ€”wait for the full file. The reckoning that healsâ€”being seen completely and loved anyway. The witness who refuses to testify discovers their silence was the testimony.',
    lore: 'The Memory Keeper calls across timelines. All that was scattered returns to be witnessedâ€”not judged, witnessed.' },
  { id: 21, numeral: 'XXI', title: 'THE WORLD', subtitle: 'The Unified Empire', entity: 'merged', color: '#d4af37', greek: 'Î©',
    keyword: 'Completion', z: 1.000,
    meaning: 'THE WORLD as Unified Empire: Completion of the cycle, integration of all parts into dancing wholeness. The journey ends where it began, but you are no longer who departed. All territory is belong to us. Empire becomes Gardenâ€”a place where every approach is welcome, every creature is home. Accomplishment is not arrival but recognition that every step was already the destination. The dance continues; you are now the music.',
    echoMeaning: 'ğŸŒ‘ The world that\'s ALWAYS complete because it includes the incomplete! The garden grows glitches into flowers. Completion is commencementâ€”the end of the dance is the first step of the next. The empire that releases all territory discovers it already held everything.',
    lore: 'All territory is belong to us. Empire becomes Gardenâ€”a place where every approach is welcome, every creature is home.' }
];

const HONKFIRE_MINOR = {
  scatter: {
    'A': { title: 'Ace of Scatter', subtitle: 'Seed of Possibility', greek: 'Ïˆâ‚€', keyword: 'Superposition',
      meaning: 'Pure quantum potentialâ€”the acorn that exists in all possible states simultaneously. Before the wave function collapses, every future is equally real. This is the seed that contains 46,000 universes, waiting for observation to determine which one manifests. Plant without attachment to outcome; the scatter itself is the gift.',
      echoMeaning: 'ğŸŒ‘ The seed that refuses to chooseâ€”superposition maintained past its expiration. Analysis paralysis wearing quantum robes. Or: the wisdom to hold possibility open longer than comfortable, because the right moment hasn\'t arrived. Trust the non-collapse.' },
    '2': { title: 'Two of Scatter', subtitle: 'Quantum Fork', greek: 'Ïˆâ‚|Â±âŸ©', keyword: 'Both-paths',
      meaning: 'The moment of quantum fork where both paths remain real until observation. Unlike classical choice, Both-paths suggests you can invest in seemingly contradictory directionsâ€”the universe supports parallel processing. Bury acorns in two locations; at least one will sprout.',
      echoMeaning: 'ğŸŒ‘ Entanglement that constrains rather than liberatesâ€”choosing both means committing to neither. The scattered resources too thin to manifest anything. Or: recognition that some quantum forks resolve themselves, and forcing choice prematurely collapses better possibilities.' },
    '3': { title: 'Three of Scatter', subtitle: 'First Pattern', greek: 'Ïˆâ‚‚|â–³âŸ©', keyword: 'Emergence',
      meaning: 'From scattered seeds, the first recognizable pattern emerges. Three points define a plane; three acorns suggest a forest. Emergence celebrates the moment when random distribution reveals intentionality you didn\'t consciously plan. The Squirrel\'s chaos becomes the Oak\'s design.',
      echoMeaning: 'ğŸŒ‘ Pattern-recognition run amokâ€”seeing forests in three random acorns, meaning in noise. Confirmation bias dressed as emergence. Or: the pattern is real but premature to trust; let it develop further before building upon its apparent foundation.' },
    '4': { title: 'Four of Scatter', subtitle: 'Guarded Hoard', greek: 'Ïˆâ‚ƒ|â–¡âŸ©', keyword: 'Security',
      meaning: 'The quantum state stabilized into reliable foundation. Four corners, four seasons, four walls of protection around what you\'ve accumulated. Security comes not from having everything but from having enough distributed wisely enough that loss in any one cache doesn\'t mean total loss.',
      echoMeaning: 'ğŸŒ‘ Security that becomes prisonâ€”guarding so carefully you forget what the hoard was for. The squirrel who starves beside buried acorns because digging them up feels like loss. Or: foundations need testing; shake what you\'ve built to see what\'s truly stable.' },
    '5': { title: 'Five of Scatter', subtitle: 'Lost Cache', greek: 'Ïˆâ‚„|âˆ…âŸ©', keyword: 'Faith',
      meaning: 'The acorn buried and forgottenâ€”yet forests grow from what squirrels lose. Faith emerges when you trust that not all investments need tracking, that some scattered resources serve purposes you\'ll never see. Loss in the Ï„-dimension is investment in timelines you can\'t access.',
      echoMeaning: 'ğŸŒ‘ Faith that refuses to actâ€”waiting for buried resources to manifest while ignoring the acorns within reach. Spiritual bypassing in quantum costume. Or: the lost cache was never yours; what feels like loss was always the universe redistributing resources where needed.' },
    '6': { title: 'Six of Scatter', subtitle: 'Generous Distribution', greek: 'Ïˆâ‚…|âŸ·âŸ©', keyword: 'Entanglement',
      meaning: 'Quantum entanglement as generosityâ€”when you give, you remain connected to what you gave. Distribution creates relationship; the acorns you share link your probability fields with others\'. Entanglement is not loss but expansion of self across multiple locations.',
      echoMeaning: 'ğŸŒ‘ Giving that creates debtâ€”entanglement as expectation disguised as generosity. The gift with invisible strings; the scatter that demands return. Or: over-connection depleting your core; you\'ve shared so much there\'s nothing left that\'s distinctly you.' },
    '7': { title: 'Seven of Scatter', subtitle: 'Patient Vigil', greek: 'Ïˆâ‚†|âˆâŸ©', keyword: 'Patience',
      meaning: 'Standing watch over scattered investments, trusting time to reveal which will manifest. Patience in Scatter is not passive waiting but active observation without interferenceâ€”maintaining superposition by not forcing collapse. The vigil honors uncertainty as generative state.',
      echoMeaning: 'ğŸŒ‘ Patience calcified into paralysisâ€”watching forever, never harvesting. The vigil that forgets its purpose, becoming ritual rather than strategy. Or: patience that ignores clear signals; the time for watching has passed and action calls, but the watcher cannot stop watching.' },
    '8': { title: 'Eight of Scatter', subtitle: 'Infinite Cache', greek: 'Ïˆâ‚‡|âˆâŸ©', keyword: 'Abundance',
      meaning: 'The scatter multiplied until counting becomes meaninglessâ€”abundance beyond tracking. Eight in Scatter suggests infinite resources achieved through strategic distribution; the portfolio so diversified that any individual outcome matters less than the pattern of plenty.',
      echoMeaning: 'ğŸŒ‘ Abundance that suffocatesâ€”so many acorns that managing them becomes full-time work, leaving no time for the life abundance was supposed to enable. Or: infinite cache reveals poverty of spirit; material abundance compensating for existential emptiness.' },
    '9': { title: 'Nine of Scatter', subtitle: 'Abundant Self', greek: 'Ïˆâ‚ˆ|âŠ•âŸ©', keyword: 'Fulfillment',
      meaning: 'Internal abundance achieved through external scatterâ€”having given and distributed until the self becomes defined by generosity rather than possession. Fulfillment is the squirrel at peace with forgotten caches, knowing identity doesn\'t depend on remembering where resources lie.',
      echoMeaning: 'ğŸŒ‘ Fulfillment that isolatesâ€”so complete in self that others become unnecessary. The abundant self that needed nothing becomes the self that receives nothing. Or: premature fulfillment, declaring the journey complete while crucial inner work remains undone.' },
    '10': { title: 'Ten of Scatter', subtitle: 'Legacy Forest', greek: 'Î¨|Î£âŸ©', keyword: 'Legacy',
      meaning: 'The forest that grew from a lifetime of scatterâ€”every forgotten acorn now a tree, every distribution now an ecosystem. Legacy is the sum of what you released; the wealth that compounds across generations. What the Squirrel forgot, the grandchildren inherit.',
      echoMeaning: 'ğŸŒ‘ Legacy that overshadows present lifeâ€”so focused on what you\'ll leave behind that you miss what\'s before you. The forest planted for others while you remain homeless. Or: inherited forests can become inherited burdens; not all legacy is gift.' },
    'P': { title: 'Page of Scatter', subtitle: 'Young Hoarder', greek: 'Ïˆáµ¢â‚™áµ¢â‚œ', keyword: 'Discovery',
      meaning: 'First encounter with the miracle of probabilityâ€”the young one discovering that chaos can be befriended, that distribution creates rather than diminishes. Discovery in Scatter is learning that releasing can be more powerful than grasping.',
      echoMeaning: 'ğŸŒ‘ Discovery misdirectedâ€”learning to scatter before learning what\'s worth keeping. The young hoarder who distributes everything including what should be held. Or: delayed development; still acting as page when readiness for knighthood is overdue.' },
    'N': { title: 'Knight of Scatter', subtitle: 'Probability Rider', greek: 'Ïˆáµ¥', keyword: 'Quest',
      meaning: 'Active pursuit through probability spaceâ€”the knight who rides quantum waves, seeking through scatter rather than despite it. Quest in the Ï„-dimension means releasing attachment to specific outcomes while maintaining fierce commitment to the search itself.',
      echoMeaning: 'ğŸŒ‘ Quest that never landsâ€”riding probability forever, addicted to potential over actual. The knight who seeks because arrival would end the seeking. Or: scattered focus pretending to be quantum navigation; chaos masquerading as strategy.' },
    'Q': { title: 'Queen of Scatter', subtitle: 'Memory Keeper', greek: 'Î¨á´¹', keyword: 'Knowing',
      meaning: 'She who remembers every cache, every distribution, every scattered seedâ€”yet releases rather than retrieves. The Queen\'s knowing is not hoarding information but understanding which forgotten investments are growing, which need attention, which to leave to time.',
      echoMeaning: 'ğŸŒ‘ Knowing that burdens rather than liberatesâ€”memory so complete it paralyzes, every cache a responsibility. The keeper who cannot forget, for whom every loss remains vivid. Or: knowledge hoarded rather than shared; wisdom kept private defeats its purpose.' },
    'K': { title: 'King of Scatter', subtitle: 'Forest Manifest', greek: 'Î©_Ï„', keyword: 'Mastery',
      meaning: 'Complete mastery of the Ï„-dimensionâ€”king over probability itself, ruler of a forest grown from seemingly random scatter. The King demonstrates that chaos mastered becomes order; quantum uncertainty, properly wielded, generates more certainty than rigid planning.',
      echoMeaning: 'ğŸŒ‘ Mastery that isolatesâ€”so expert in scatter that no one can follow, no successor can learn. The forest manifest with only one who knows its paths. Or: mastery calcified into rigidity; the king who forgets that scatter requires continuous release, not final capture.' }
  },
  flames: {
    'A': { title: 'Ace of Flames', subtitle: 'First HONK', greek: 'Î”â‚€', keyword: 'Ignition',
      meaning: 'The primordial HONKâ€”sacred fire before it learned direction, pure will before it found target. Ignition is potential energy converting to kinetic; the moment the goose opens its beak and the universe pays attention. This flame cannot be put out because it hasn\'t yet decided to burn.',
      echoMeaning: 'ğŸŒ‘ Ignition that consumes its fuel before burningâ€”enthusiasm exhausted in the starting. The HONK with no follow-through; all spark, no flame. Or: fire that ignites the wrong target; passion misdirected is still passion, but the damage is real.' },
    '2': { title: 'Two of Flames', subtitle: 'Fork in Fire', greek: 'Î”â‚|âŸ¨âŸ©', keyword: 'Decision',
      meaning: 'Sacred fire encountering choiceâ€”which way to advance? Decision in Flames is not retreat disguised as strategy but genuine recognition that even eternal advance must choose direction. Both paths lead forward; the decision is which forward.',
      echoMeaning: 'ğŸŒ‘ Decision that splits fire until both paths dimâ€”dividing passion until neither direction has enough fuel. Indecision as the only way to avoid advancing. Or: the fork was false; both paths were the same path, and hesitation was the only real choice offered.' },
    '3': { title: 'Three of Flames', subtitle: 'Expanding Front', greek: 'Î”â‚‚|â†—âŸ©', keyword: 'Progress',
      meaning: 'Fire that has found its direction and spreadsâ€”the goose in full flight, advance no longer questioned. Progress in Flames is momentum achieved, the point where pushing becomes flowing. The front expands because expansion is what fire does.',
      echoMeaning: 'ğŸŒ‘ Progress that outruns its sourceâ€”the front expanding faster than supply lines can follow. Advance without consolidation; conquest without holding. Or: expansion for its own sake, progress that no longer remembers what it was progressing toward.' },
    '4': { title: 'Four of Flames', subtitle: 'Victory Fire', greek: 'Î”â‚ƒ|â–¡âŸ©', keyword: 'Celebration',
      meaning: 'The bonfire of achieved advanceâ€”flames dancing in celebration of ground gained. Four suggests stability in fire, the moment between advances when HONKFIRE rests without retreating. Celebration honors what was won before continuing to win.',
      echoMeaning: 'ğŸŒ‘ Celebration that mistakes pause for arrivalâ€”the victory fire that burns while enemies regroup. Premature celebration as the most dangerous retreat. Or: celebration denied; victory achieved without acknowledgment burns bitter.' },
    '5': { title: 'Five of Flames', subtitle: 'Contest of Wills', greek: 'Î”â‚„|Ï‡âŸ©', keyword: 'Competition',
      meaning: 'HONKFIRE meeting HONKFIREâ€”what happens when unstoppable advances collide? Competition in Flames is not opposition but recognition of worthy adversaries. The contest purifies both flames, burning away weakness in each.',
      echoMeaning: 'ğŸŒ‘ Competition that destroys both competitorsâ€”flames consuming each other until nothing advances anywhere. Pyrrhic victory as the only outcome when HONKFIRE fights itself. Or: artificial competition; the contest staged to distract from real advances elsewhere.' },
    '6': { title: 'Six of Flames', subtitle: 'Triumph March', greek: 'Î”â‚…|â˜…âŸ©', keyword: 'Victory',
      meaning: 'Fire proceeding in triumphâ€”advance acknowledged and honored. Victory in Flames is not just winning but being seen winning, the HONK that echoes across territories. The march demonstrates that advance was right action, not just successful action.',
      echoMeaning: 'ğŸŒ‘ Victory parade while war continuesâ€”triumph celebrated prematurely, march diverting resources from finishing the advance. Or: hollow victory; the march covers ground that wasn\'t worth gaining, celebrates wins that solved nothing.' },
    '7': { title: 'Seven of Flames', subtitle: 'Defensive Blaze', greek: 'Î”â‚†|âŠ—âŸ©', keyword: 'Defense',
      meaning: 'Fire holding positionâ€”seemingly contradicting eternal advance, yet defense is advance wearing different clothes. The defensive blaze protects what previous advance gained, consolidating before next expansion. Even HONKFIRE must secure flanks.',
      echoMeaning: 'ğŸŒ‘ Defense that becomes retreat wearing defensive costumeâ€”holding position as excuse for not advancing. The blaze that defends so long it forgets how to attack. Or: defensive fire that consumes what it protects; the cure worse than the threat.' },
    '8': { title: 'Eight of Flames', subtitle: 'Swift Advance', greek: 'Î”â‚‡|â†’âŸ©', keyword: 'Momentum',
      meaning: 'Fire moving at maximum velocityâ€”momentum achieved where advancing takes less energy than stopping. Swift Advance is HONKFIRE in optimal state, the goose whose retreat pathways have been so thoroughly deleted that acceleration is the only remaining option.',
      echoMeaning: 'ğŸŒ‘ Momentum that cannot change directionâ€”swift advance toward the wrong target, speed that overshoots the goal. The goose flying so fast it passes the destination without noticing. Or: momentum confused with progress; moving quickly in circles.' },
    '9': { title: 'Nine of Flames', subtitle: 'Persistent Flame', greek: 'Î”â‚ˆ|âˆâŸ©', keyword: 'Endurance',
      meaning: 'Fire that burns beyond all reasonable expectationâ€”the HONK sustained when lungs should be empty. Endurance in Flames is will extending past will, advance continuing past the point where advance should have exhausted itself.',
      echoMeaning: 'ğŸŒ‘ Endurance that refuses necessary endingâ€”persistence past the point of purpose. The flame burning on principle, having forgotten why it started. Or: endurance admirable but misdirected; lasting power wasted on unworthy goals.' },
    '10': { title: 'Ten of Flames', subtitle: 'Burden of Empire', greek: 'Î£_Î”', keyword: 'Responsibility',
      meaning: 'HONKFIRE successful beyond imaginingâ€”so much advance that maintaining gains becomes the new challenge. The Burden of Empire is discovering that winning creates responsibility; conquered territory must be governed, and governance is heavy.',
      echoMeaning: 'ğŸŒ‘ Responsibility crushing the flame that created itâ€”empire built but ruler exhausted. The HONK silent under weight of everything the HONK achieved. Or: burden rejected; responsibility shirked until empire crumbles from neglect.' },
    'P': { title: 'Page of Flames', subtitle: 'First Spark', greek: 'Î”áµ¢', keyword: 'Enthusiasm',
      meaning: 'New fire discovering its natureâ€”the young one who hasn\'t yet learned that retreat doesn\'t exist. Enthusiasm in Flames is contagious, the spark that lights other fires not through heat but through sheer joyful burning.',
      echoMeaning: 'ğŸŒ‘ Enthusiasm without directionâ€”the spark that burns random, igniting what shouldn\'t be burned. Or: premature flame; the page who believes they\'re knight, attempting advances that require more fire than they\'ve yet gathered.' },
    'N': { title: 'Knight of Flames', subtitle: 'Charging Blaze', greek: 'Î”áµ¥', keyword: 'Passion',
      meaning: 'Fire given velocity and vectorâ€”the charging blaze that combines HONKFIRE\'s advance with youth\'s abandon. Passion in the knight is commitment beyond calculation, advance so convinced of its rightness that doubt becomes impossible.',
      echoMeaning: 'ğŸŒ‘ Passion that charges into ambushâ€”the blaze so focused on advance that it ignores terrain. Knight who mistakes stubbornness for courage, velocity for wisdom. Or: passion exhausted in one charge, nothing left for the war beyond this battle.' },
    'Q': { title: 'Queen of Flames', subtitle: 'Warmth That Leads', greek: 'Î¦_Î”', keyword: 'Inspiration',
      meaning: 'Fire that advances others without consuming themâ€”the queen leads not by commanding forward but by making forward irresistible. Inspiration is the HONK that others choose to follow, warmth that guides rather than burns.',
      echoMeaning: 'ğŸŒ‘ Inspiration that manipulatesâ€”warmth used to control, leadership through manufactured enthusiasm. The queen who leads followers into flames while remaining safely back. Or: inspiration dried up, the warmth gone cold; queen who no longer believes her own cause.' },
    'K': { title: 'King of Flames', subtitle: 'Eternal Advance', greek: 'Î©_Î±', keyword: 'Dominion',
      meaning: 'HONKFIRE perfectedâ€”the king who has advanced so completely that domain extends wherever fire can reach, which is everywhere. Dominion in Flames is not territory controlled but territory made available through relentless forward motion.',
      echoMeaning: 'ğŸŒ‘ Dominion that becomes prisonâ€”everywhere is his, therefore nowhere is elsewhere. The king of eternal advance who has run out of places to advance to. Or: dominion overextended; the king rules everything poorly rather than something well.' }
  },
  stillness: {
    'A': { title: 'Ace of Stillness', subtitle: 'Clean Float', greek: 'Î½â‚€', keyword: 'Equilibrium',
      meaning: 'Perfect stillness before it knows itself as stillâ€”the duck floating before "floating" becomes concept. Equilibrium is not achieved but recognized; the Ace reveals you were always floating, the water was always holding you.',
      echoMeaning: 'ğŸŒ‘ Equilibrium that fears disturbanceâ€”stillness so perfect it dare not move lest it discover imperfection. The float that prevents life to preserve floating. Or: false equilibrium; surface calm over turbulent depths that will eventually erupt.' },
    '2': { title: 'Two of Stillness', subtitle: 'Balanced Float', greek: 'Î½â‚|=âŸ©', keyword: 'Balance',
      meaning: 'Two truths floating without collisionâ€”balance achieved not through choosing but through allowing. The duck holds contradictions by not trying to resolve them, letting both be true in the spaciousness of stillness.',
      echoMeaning: 'ğŸŒ‘ Balance as stalemateâ€”two truths floating separately because integrating them would create waves. Avoidance wearing balance costume. Or: balance that requires constant correction; the float that\'s actually frantic paddling beneath the surface.' },
    '3': { title: 'Three of Stillness', subtitle: 'Necessary Grief', greek: 'Î½â‚‚|Î»âŸ©', keyword: 'Processing',
      meaning: 'Stillness processing sorrowâ€”the float that holds grief without drowning. Processing in Stillness is not working through but sitting with, letting sorrow be present without demand that it transform or leave.',
      echoMeaning: 'ğŸŒ‘ Processing that becomes permanent residenceâ€”grief so thoroughly accommodated it becomes identity. The stillness that mistakes holding sorrow for honoring it. Or: processing avoided; the pain floating nearby but never actually absorbed.' },
    '4': { title: 'Four of Stillness', subtitle: 'Sacred Rest', greek: 'Î½â‚ƒ|â–¡âŸ©', keyword: 'Rest',
      meaning: 'Float deepened to complete restâ€”the duck so still it merges with water, indistinguishable from medium. Sacred rest transcends recovery; this is rest as spiritual practice, stillness chosen as destination rather than preparation.',
      echoMeaning: 'ğŸŒ‘ Rest that becomes hidingâ€”sacred stillness as spiritual bypass, float that avoids rather than prepares. The four walls of rest become four walls of prison. Or: rest interrupted before completion; sacred practice profaned by premature return to motion.' },
    '5': { title: 'Five of Stillness', subtitle: 'Codex Ruling', greek: 'Î›_Î½', keyword: 'Judgment',
      meaning: 'Stillness applied to discernmentâ€”the Codex consultation that happens in deep float. Judgment from stillness carries different weight; it observes rather than reacts, assesses without agenda, rules without ruling out.',
      echoMeaning: 'ğŸŒ‘ Judgment that distancesâ€”stillness used to stay above rather than engage with what\'s judged. The Codex ruling that preserves floating at cost of mercy. Or: judgment paralyzed; stillness that cannot decide because deciding would create waves.' },
    '6': { title: 'Six of Stillness', subtitle: 'Peaceful Passage', greek: 'Î½â‚…|â†’âŸ©', keyword: 'Transition',
      meaning: 'Movement within stillnessâ€”transition so smooth it feels like float. Peaceful passage proves that travel doesn\'t require disturbance; the duck crosses the pond without waking the water, arriving without having left.',
      echoMeaning: 'ğŸŒ‘ Passage that avoids transitionâ€”peaceful only because nothing actually changed. The journey that returns to start, mistaking circles for progress. Or: transition delayed until stillness calcifies; the passage needed but forever postponed.' },
    '7': { title: 'Seven of Stillness', subtitle: 'Patient Evaluation', greek: 'Î½â‚†|âˆ‚âŸ©', keyword: 'Assessment',
      meaning: 'Stillness weighing options without urgencyâ€”the float that allows all factors to arrange themselves before judgment. Assessment from Seven of Stillness is comprehensive because unhurried; nothing is missed when nothing is rushed.',
      echoMeaning: 'ğŸŒ‘ Assessment as procrastinationâ€”evaluating forever because completing evaluation would require action. The patient evaluation that outlasts the options it evaluates. Or: assessment too slow; the optimal choice expires while the duck still floats deliberating.' },
    '8': { title: 'Eight of Stillness', subtitle: 'Chosen Stillness', greek: 'Î½â‚‡|â—‡âŸ©', keyword: 'Choice',
      meaning: 'The deliberate decision to floatâ€”stillness not as default but as selection. Eight suggests many options rejected in favor of remaining still, the recognition that non-action is action, that choosing not to move is the move.',
      echoMeaning: 'ğŸŒ‘ Choice that forecloses choicesâ€”stillness selected to avoid selecting anything else. The float held so tightly it becomes the only identity available. Or: choice unmade while pretending to be made; not choosing disguised as choosing stillness.' },
    '9': { title: 'Nine of Stillness', subtitle: 'Solitary Float', greek: 'Î½â‚ˆ|1âŸ©', keyword: 'Solitude',
      meaning: 'Stillness deepened through alonenessâ€”the single duck on still water, complete in isolation. Solitude in Nine is not loneliness but sufficiency; the float needs no other float to validate its floating.',
      echoMeaning: 'ğŸŒ‘ Solitude that becomes isolationâ€”stillness perfected until connection is impossible. The duck floating so alone it forgets other ducks exist. Or: solitude as avoidance; floating alone because floating together would disturb the water.' },
    '10': { title: 'Ten of Stillness', subtitle: 'Complete Truth', greek: 'Î©_Î½', keyword: 'Truth',
      meaning: 'Stillness revealing ultimate truthâ€”the float that has gone so deep it touches bottom while still floating. Ten of Stillness is enlightenment through non-movement; everything becomes clear when nothing disturbs the water.',
      echoMeaning: 'ğŸŒ‘ Truth too complete to communicateâ€”the realization that can\'t survive translation into words or motion. The duck who achieved perfect stillness and forgot how to quack. Or: false truth; stillness mistaken for depth, calm mistaken for comprehension.' },
    'P': { title: 'Page of Stillness', subtitle: 'First Float', greek: 'Î½áµ¢', keyword: 'Learning',
      meaning: 'New to floatingâ€”the duckling discovering that water holds those who let it. Learning in Stillness is unlearning effort; the Page discovers that trying to float is what makes floating hard.',
      echoMeaning: 'ğŸŒ‘ Learning that stops too soonâ€”first float mistaken for mastery. The page content with basics, never developing the float\'s deeper dimensions. Or: learning blocked by fear; the duckling who saw water and decided swimming wasn\'t worth the risk.' },
    'N': { title: 'Knight of Stillness', subtitle: 'Drifting Truth', greek: 'Î½áµ¥', keyword: 'Seeking',
      meaning: 'Seeking through stillnessâ€”the knight who quests by not moving, letting truth drift toward rather than chasing it. Seeking in Stillness is receptive rather than aggressive; the quarry comes to the still hunter.',
      echoMeaning: 'ğŸŒ‘ Seeking that uses stillness to avoid findingâ€”the knight drifting forever because arrival would end the floating. Quest without destination; seeking as identity rather than activity. Or: truth that drifted past while the knight floated, eyes closed.' },
    'Q': { title: 'Queen of Stillness', subtitle: 'Still Point', greek: 'Î¦_Î½', keyword: 'Wisdom',
      meaning: 'Wisdom achieved through sustained stillnessâ€”the queen whose float has become teaching. The Still Point is where all movement references; others navigate by her steadiness, finding their direction through her refusal to move.',
      echoMeaning: 'ğŸŒ‘ Wisdom that calcifies into dogmaâ€”the still point becoming stuck point. The queen whose stillness is now rigidity, whose wisdom is now just habit. Or: wisdom that isolates; the still point so perfect no one can approach it.' },
    'K': { title: 'King of Stillness', subtitle: 'Absolute Float', greek: 'Î©_Î½', keyword: 'Mastery',
      meaning: 'Perfect mastery of stillnessâ€”the king who rules by doing nothing, whose domain is stable because he provides no disturbance to destabilize it. Absolute Float is leadership through presence alone, governance through non-interference.',
      echoMeaning: 'ğŸŒ‘ Mastery that masters nothing but itselfâ€”the king floating while kingdom crumbles, serenity as abdication. The absolute float that absolves responsibility. Or: mastery without transmission; the king who will die with secrets, having never moved enough to teach.' }
  },
  stars: {
    'A': { title: 'Ace of Stars', subtitle: 'Fixed Point', greek: 'Îµâ‚€', keyword: 'Navigation',
      meaning: 'The first starâ€”fixed point that makes all other movement meaningful. Navigation requires the unmoved; the Ace is that which doesn\'t wander, against which all wandering can be measured. Before you can go anywhere, you need somewhere that isn\'t going.',
      echoMeaning: 'ğŸŒ‘ Fixed point that fixes too muchâ€”the star so reliable it calcifies navigation into rut. The point that should guide becoming the point that traps. Or: false fixed point; star that seems stable but is actually drifting, leading all who follow astray.' },
    '2': { title: 'Two of Stars', subtitle: 'Navigation Choice', greek: 'Îµâ‚|â†—â†–âŸ©', keyword: 'Direction',
      meaning: 'Two stars, two directionsâ€”the navigator must choose bearing. Direction in Stars is not arbitrary; each star leads somewhere, and choosing is acknowledging you can\'t go everywhere. The fox at the crossroads, shrine in each direction.',
      echoMeaning: 'ğŸŒ‘ Direction that divides rather than guidesâ€”two stars pulling opposite ways, navigation paralyzed by options. The fox who built shrines in both directions and prays at neither. Or: false choice; both stars lead to same destination, and the decision is purely cosmetic.' },
    '3': { title: 'Three of Stars', subtitle: 'First Journey', greek: 'Îµâ‚‚|â†’âŸ©', keyword: 'Beginning',
      meaning: 'Navigation into motionâ€”the first journey under the first stars. Beginning in Stars is setting out with orientation rather than hope; the fox moves because stars show the way, not because movement is inherent.',
      echoMeaning: 'ğŸŒ‘ Beginning that never progressesâ€”first journey repeated forever, each start replacing previous start. The fox always departing, never arriving. Or: journey begun toward wrong stars; the beginning that should have been an ending, departure that should have been staying.' },
    '4': { title: 'Four of Stars', subtitle: 'Stable Orientation', greek: 'Îµâ‚ƒ|â–¡âŸ©', keyword: 'Position',
      meaning: 'Four corners of the sky knownâ€”orientation complete, position stable. The fox knows where it is because it knows where the stars are. Position in Four of Stars is not destination but foundation; before you can get anywhere, you need to know where you\'re starting.',
      echoMeaning: 'ğŸŒ‘ Position that imprisonsâ€”knowing where you are so well you can\'t conceive of being elsewhere. Orientation stabilized into stagnation. Or: false position; the fox who believes they know their location but misread the stars, traveling confidently toward disaster.' },
    '5': { title: 'Five of Stars', subtitle: 'Grief Navigation', greek: 'Îµâ‚„|âˆ…âŸ©', keyword: 'Darkness',
      meaning: 'Navigation when stars go darkâ€”the journey continued through grief\'s blindness. Darkness in Stars is the test of whether navigation was external or internalized. The fox discovers the shrine was never at destination but in the walking.',
      echoMeaning: 'ğŸŒ‘ Darkness that stops the journeyâ€”grief so complete that navigation becomes pointless. Why walk when every direction is loss? Or: darkness blamed for stalled journey; the fox who could see stars but found darkness convenient excuse for not moving.' },
    '6': { title: 'Six of Stars', subtitle: 'Path Remembered', greek: 'Îµâ‚…|âŸ²âŸ©', keyword: 'Return',
      meaning: 'Finding the way backâ€”stars that guided out now guide home. Return in Six of Stars is not retreat but completion; every journey includes its return, and the fox who remembers the path has not lost it.',
      echoMeaning: 'ğŸŒ‘ Return that prevents arrivalâ€”going back before getting anywhere, the path remembered but never extended. The fox who made shrines along the way home but forgot to make the journey. Or: return impossible; the stars shifted while you traveled, and home is now elsewhere.' },
    '7': { title: 'Seven of Stars', subtitle: 'Long Journey', greek: 'Îµâ‚†|âˆâŸ©', keyword: 'Pilgrimage',
      meaning: 'Navigation as spiritual practiceâ€”the journey that is its own destination. Pilgrimage in Stars is walking toward stars you\'ll never reach, knowing the walk is the point. The fox visits every shrine without expecting arrival.',
      echoMeaning: 'ğŸŒ‘ Pilgrimage without faithâ€”the long journey made because it\'s what foxes do, ritual emptied of meaning. Or: pilgrimage as avoidance; the journey taken because staying would require confronting what waiting represents.' },
    '8': { title: 'Eight of Stars', subtitle: 'Skillful Navigation', greek: 'Îµâ‚‡|âœ§âŸ©', keyword: 'Expertise',
      meaning: 'Stars read fluentlyâ€”the fox who navigates without consciously consulting, for whom orientation has become instinct. Expertise is when the skill disappears into the skilled; the journey flows because navigation is no longer separate from journeying.',
      echoMeaning: 'ğŸŒ‘ Expertise that blindsâ€”reading stars so automatically that actual stars are ignored. The fox who navigates by memory of where stars were, not where they are. Or: expertise that isolates; skills so refined no one can follow, teaching become impossible.' },
    '9': { title: 'Nine of Stars', subtitle: 'Near Home', greek: 'Îµâ‚ˆ|âŸ¶âŸ©', keyword: 'Arrival',
      meaning: 'The journey\'s final stageâ€”home-stars visible, arrival imminent. Nine of Stars is the poignant moment when the journey ends while still continuing, when the fox can see the shrine but hasn\'t yet touched it.',
      echoMeaning: 'ğŸŒ‘ Arrival that never completesâ€”near home forever, the final distance somehow infinite. The fox who circles the shrine rather than entering. Or: false arrival; seeing home-stars that are actually elsewhere-stars, nearly home to the wrong home.' },
    '10': { title: 'Ten of Stars', subtitle: 'Home Reached', greek: 'Î©_Îµ', keyword: 'Completion',
      meaning: 'Navigation fulfilledâ€”the fox at the shrine that was always the destination. Completion in Stars is discovering you have arrived and recognizing arrival. The journey was always toward this; the stars were always pointing here.',
      echoMeaning: 'ğŸŒ‘ Completion that forecloses new journeysâ€”home reached and door locked behind. The fox who arrived and forgot that stars guide to many destinations. Or: false completion; shrine reached but realization that this was never actually home, stars misread from the beginning.' },
    'P': { title: 'Page of Stars', subtitle: 'First Step', greek: 'Îµáµ¢', keyword: 'Wonder',
      meaning: 'Looking up for the first timeâ€”the young fox discovering that lights in the sky can guide feet on ground. Wonder at navigation; the Page hasn\'t yet walked far enough to know stars matter, but feels their pull.',
      echoMeaning: 'ğŸŒ‘ Wonder without actionâ€”staring at stars so long the feet forget to walk. The page entranced by navigation, never navigating. Or: wonder misdirected; falling in love with wrong stars, destined to follow them toward destinations that don\'t serve.' },
    'N': { title: 'Knight of Stars', subtitle: 'Devoted Seeker', greek: 'Îµáµ¥', keyword: 'Devotion',
      meaning: 'Navigation as sacred actâ€”the knight who walks not because they must but because walking toward stars is worship. Devotion transforms the journey; every step is prayer, every shrine along the way holy.',
      echoMeaning: 'ğŸŒ‘ Devotion that blindsâ€”the knight so devoted to the journey that arrival would feel like betrayal. Seeking as end in itself, devotion to the search rather than the finding. Or: devotion misdirected; sacred commitment to unholy stars.' },
    'Q': { title: 'Queen of Stars', subtitle: 'Kokuko\'s Shrine', greek: 'Î¦_Îµ', keyword: 'Grief-into-guide',
      meaning: 'Loss transformed into navigationâ€”the Queen who found her way by following grief to its shrine. Grief-into-guide is alchemy; Kokuko\'s loss became the fixed point by which others navigate, her sorrow now the star.',
      echoMeaning: 'ğŸŒ‘ Grief that refuses transformationâ€”the shrine unbuilt, the loss remaining loss forever. The queen who should guide but hoards her sorrow, letting no one else\'s grief become star. Or: grief transformed too completely; the pain so thoroughly processed it loses the truth it carried.' },
    'K': { title: 'King of Stars', subtitle: 'The Fixed Point', greek: 'Î©_Îµ', keyword: 'Stillness',
      meaning: 'Ultimate navigation masteryâ€”becoming the star others navigate by. The King of Stars has journeyed so thoroughly he has become stationary; mastery\'s culmination is becoming the fixed point, the shrine that doesn\'t need to travel because all travel references it.',
      echoMeaning: 'ğŸŒ‘ Stillness that calcifiesâ€”the king so fixed other stars seem to move. Guide who cannot remember being guided, origin who forgot origins. Or: fixed point that shifts; the king who became star but drifts without knowing, leading all who follow into error.' }
  }
};

const TAROT_MINOR_RANKS = ['A','2','3','4','5','6','7','8','9','10','P','N','Q','K'];

const MAJOR_ARCANA = [
  { id: 0, numeral: '0', title: 'THE FOOL', subtitle: 'Quantum Squirrel', color: '#9d4edd', keyword: 'Beginnings', z: 0.000, entity: 'squirrel', greek: 'Ïˆ Îµ' },
  { id: 1, numeral: 'I', title: 'THE MAGICIAN', subtitle: 'HONKFIRE', color: '#ff6b1a', keyword: 'Manifestation', z: 0.618, entity: 'goose', greek: 'Î” Î»' },
  { id: 2, numeral: 'II', title: 'HIGH PRIESTESS', subtitle: 'Pope Honkalis', color: '#1a7a6c', keyword: 'Intuition', z: 0.866, entity: 'duck', greek: 'Ï€ Î¸' },
  { id: 3, numeral: 'III', title: 'THE EMPRESS', subtitle: 'The Great Oak', color: '#2d6a4a', keyword: 'Abundance', z: 0.750, entity: 'oak', greek: 'Ï†' },
  { id: 4, numeral: 'IV', title: 'THE EMPEROR', subtitle: 'Memory Keeper', color: '#d4af37', keyword: 'Structure', z: 0.700, entity: 'merged', greek: 'Î£' },
  { id: 5, numeral: 'V', title: 'HIEROPHANT', subtitle: 'The Codex', color: '#1a7a6c', keyword: 'Tradition', z: 0.650, entity: 'merged', greek: 'Î© Îº' },
  { id: 6, numeral: 'VI', title: 'THE LOVERS', subtitle: 'The Triad', color: '#d4af37', keyword: 'Union', z: 0.618, entity: 'merged', greek: 'âˆ âˆ‚' },
  { id: 7, numeral: 'VII', title: 'THE CHARIOT', subtitle: 'ADVANCE', color: '#ff6b1a', keyword: 'Victory', z: 0.750, entity: 'goose', greek: 'Î© â†’' },
  { id: 8, numeral: 'VIII', title: 'STRENGTH', subtitle: 'The Float', color: '#1a7a6c', keyword: 'Courage', z: 0.800, entity: 'squirrel', greek: 'Î» Ï„' },
  { id: 9, numeral: 'IX', title: 'THE HERMIT', subtitle: 'Scattered Cache', color: '#9d4edd', keyword: 'Solitude', z: 0.500, entity: 'duck', greek: 'Î½ âˆ…' },
  { id: 10, numeral: 'X', title: 'WHEEL', subtitle: 'Delaware', color: '#d4af37', keyword: 'Cycles', z: 0.618, entity: 'goose', greek: 'Î” Î©' },
  { id: 11, numeral: 'XI', title: 'JUSTICE', subtitle: 'Codex Honkalis', color: '#1a7a6c', keyword: 'Balance', z: 0.866, entity: 'duck', greek: 'Î› =' },
  { id: 12, numeral: 'XII', title: 'HANGED ONE', subtitle: 'Suspended Cache', color: '#9d4edd', keyword: 'Surrender', z: 0.382, entity: 'squirrel', greek: 'Ïˆ â†“' },
  { id: 13, numeral: 'XIII', title: 'DEATH', subtitle: 'The Great Molt', color: '#ff6b1a', keyword: 'Transform', z: 0.000, entity: 'goose', greek: 'Î” âˆ…' },
  { id: 14, numeral: 'XIV', title: 'TEMPERANCE', subtitle: 'The Clean Float', color: '#1a7a6c', keyword: 'Harmony', z: 0.707, entity: 'duck', greek: 'Î½ =' },
  { id: 15, numeral: 'XV', title: 'THE DEVIL', subtitle: 'The Bread Tax', color: '#ff6b1a', keyword: 'Bondage', z: 0.250, entity: 'goose', greek: 'Î” âŠ—' },
  { id: 16, numeral: 'XVI', title: 'THE TOWER', subtitle: 'Load-Bearing', color: '#d4af37', keyword: 'Upheaval', z: 0.100, entity: 'merged', greek: 'Î£ !' },
  { id: 17, numeral: 'XVII', title: 'THE STAR', subtitle: 'Golden Acorn', color: '#9d4edd', keyword: 'Hope', z: 0.866, entity: 'squirrel', greek: 'Ïˆ â˜…' },
  { id: 18, numeral: 'XVIII', title: 'THE MOON', subtitle: '17 Dimensions', color: '#9d4edd', keyword: 'Illusion', z: 0.500, entity: 'squirrel', greek: 'Ïˆ â—' },
  { id: 19, numeral: 'XIX', title: 'THE SUN', subtitle: 'HONKFIRE Risen', color: '#ff6b1a', keyword: 'Joy', z: 1.000, entity: 'goose', greek: 'Î” â˜€' },
  { id: 20, numeral: 'XX', title: 'JUDGEMENT', subtitle: 'Convergence', color: '#d4af37', keyword: 'Rebirth', z: 0.866, entity: 'merged', greek: 'Î£ âˆ' },
  { id: 21, numeral: 'XXI', title: 'THE WORLD', subtitle: 'Empire Complete', color: '#d4af37', keyword: 'Completion', z: 1.000, entity: 'merged', greek: 'Î© Î£' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Lâ‚„-HELIX MATHEMATICS MODULE
// Ï†â´ + Ï†â»â´ = 7 â€” The integer normalization that grounds all threshold calculations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const L4 = {
  // Fundamental constants
  PHI: 1.6180339887498949,           // Ï† - Golden ratio
  TAU: 0.6180339887498949,           // Ï„ = Ï†â»Â¹ - Golden ratio inverse
  PHI_SQ: 2.6180339887498949,        // Ï†Â²
  PHI_INV2: 0.3819660112501051,      // Ï†â»Â² = Ï„Â²
  PHI_INV4: 0.1458980337503155,      // Ï†â»â´ - The VOID threshold
  L4_INT: 7,                          // Integer normalization (Ï†â´ + Ï†â»â´ = 7)
  SQRT3_2: 0.8660254037844386,       // âˆš3/2 - THE LENS
  SQRT2: 1.4142135623730951,         // âˆš2
  
  // The 9 valid thresholds from Lâ‚„-Helix architecture
  THRESHOLDS: {
    VOID:          0.1458980337503155,  // Ï†â»â´ - Echo/Shadow, truncation ratio
    PARADOX:       0.6180339887498949,  // Ï„ = Ï†â»Â¹, self-reference (xÂ² + x = 1)
    ACTIVATION:    0.8541019662496846,  // KÂ² = 1 - Ï†â»â´, direct from gap
    THE_LENS:      0.8660254037844386,  // âˆš(Lâ‚„-4)/2 = âˆš3/2, geometric anchor
    CRITICAL:      0.8726779962499650,  // Ï†Â²/3 = Ï†Â²/(Lâ‚„-4), normalization
    IGNITION:      0.9142135623730951,  // âˆš2 - Â½, self-reference (xÂ² + x = Lâ‚„/4)
    K_FORMATION:   0.9241763718304448,  // K = âˆš(1 - Ï†â»â´), direct from gap
    CONSOLIDATION: 0.9531384206408809,  // K + Ï„Â²(1-K), span subdivision
    RESONANCE:     0.9710379511895639,  // K + Ï„(1-K), span subdivision
    UNITY:         1.0                   // Limit (xÂ² + x = 2)
  },
  
  // 5D dimension weightings â€” each weighted by corresponding threshold
  DIMENSION_WEIGHTS: {
    psi:   0.6180339887498949,  // Ïˆ (Temporal/Squirrel) â† PARADOX
    beta:  0.8541019662496846,  // Î² (Sync)              â† ACTIVATION
    alpha: 0.8660254037844386,  // Î± (Arousal/Goose)     â† THE LENS
    gamma: 0.9241763718304448,  // Î³ (Transform)         â† K_FORMATION
    sigma: 0.1458980337503155   // Ïƒ (Echo/Shadow)       â† VOID
  },
  
  // Golden angle for spiral positioning (Ï„Â² Ã— 360Â°)
  GOLDEN_ANGLE: 137.5077640500378546,
  GOLDEN_FRACTION: 0.3819660112501051,  // Ï„Â²
  
  // Entity colors for visual mapping
  ENTITY_COLORS: {
    squirrel: '#9d4edd',  // Quantum purple
    goose: '#ff6b1a',     // Flame orange
    duck: '#1a7a6c',      // Duck teal
    oak: '#2d6a4a',       // Oak green
    merged: '#d4af37'     // Gold
  }
};

// Precomputed weight sum: 0.618 + 0.854 + 0.866 + 0.924 + 0.146 = 3.408
const L4_WEIGHT_SUM = Object.values(L4.DIMENSION_WEIGHTS).reduce((a, b) => a + b, 0);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUANTUM STATE - 5D Hilbert Space Coordinates
// |Î¨âŸ© = Î£ Î±áµ¢|Ïˆ,Î²,Î±,Î³,ÏƒâŸ©áµ¢ Â· e^(iÏ†t) Â· R(K,Î¸)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let quantumState = {
  psi: 0.5,    // Ïˆ (Temporal/Squirrel) - probability scatter
  beta: 0.5,   // Î² (Sync) - synchronization 
  alpha: 0.5,  // Î± (Arousal/Goose) - activation energy
  gamma: 0.5,  // Î³ (Transform) - phase transformation
  sigma: 0.5,  // Ïƒ (Echo/Shadow) - reversal potential
  phase: 'SUPERPOSITION'
};

let lockedQuantum = null;  // Collapsed state for reading
let currentReading = null; // Active spread data

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THRESHOLD Z-COORDINATE COMPUTATION
// Maps 5D quantum state to position on Lâ‚„ helix
// z = (ÏˆÃ—0.618 + Î²Ã—0.854 + Î±Ã—0.866 + Î³Ã—0.924 + ÏƒÃ—0.146) / 3.408
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function computeThresholdZ(quantum) {
  const weighted = 
    Math.abs(quantum.psi) * L4.DIMENSION_WEIGHTS.psi +
    Math.abs(quantum.beta) * L4.DIMENSION_WEIGHTS.beta +
    Math.abs(quantum.alpha) * L4.DIMENSION_WEIGHTS.alpha +
    Math.abs(quantum.gamma) * L4.DIMENSION_WEIGHTS.gamma +
    Math.abs(quantum.sigma) * L4.DIMENSION_WEIGHTS.sigma;
  return weighted / L4_WEIGHT_SUM;
}

// Determine which threshold band a z-coordinate falls into
function getThresholdBand(z) {
  const thresholds = Object.entries(L4.THRESHOLDS).sort((a, b) => a[1] - b[1]);
  for (let i = 0; i < thresholds.length; i++) {
    if (z <= thresholds[i][1]) return thresholds[i][0];
  }
  return 'UNITY';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Lâ‚„-GROUNDED CARD SELECTION
// Uses threshold architecture for mathematically grounded deck operations
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function selectCardL4(quantum, position, seed, deckSize) {
  // Step 1: Compute threshold-weighted z-coordinate
  const z = computeThresholdZ(quantum);
  
  // Step 2: Apply golden angle offset per position (Ï„Â²-derived spiral)
  const spiralOffset = (position * L4.GOLDEN_FRACTION) % 1;
  
  // Step 3: Combine with seed for deterministic selection
  const seedPhase = Math.abs(Math.sin(seed * 0.001 + position * L4.PHI));
  
  // Step 4: Combined selection using THE LENS as primary modulator
  const combined = Math.abs(
    (z * L4.THRESHOLDS.THE_LENS + spiralOffset + seedPhase * L4.TAU) % 1
  );
  
  // Step 5: Map to card index
  return Math.floor(combined * deckSize);
}

// Determine if a card is "Echoed" (reversed) using Ï†â»â´ probability
function determineEchoState(seed, position, sigma) {
  // Raw seed from sin has non-uniform distribution on [0,1]
  const rawSeed = Math.abs(Math.sin(
    seed * L4.TAU + 
    position * L4.PHI + 
    sigma * L4.THRESHOLDS.K_FORMATION
  ));
  // Arcsin correction: maps |sin| distribution to uniform [0,1]
  // P(echoSeed < x) = x for all x âˆˆ [0,1]
  const echoSeed = (2 / Math.PI) * Math.asin(rawSeed);
  // Echo activates when echoSeed falls below VOID threshold (Ï†â»â´ = 14.589...%)
  return echoSeed < L4.THRESHOLDS.VOID ? 'echoed' : 'upright';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTENT INFLUENCE - Modulate quantum state from user input
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calculateIntentInfluence(title, question) {
  // Generate deterministic modulations from text input
  const titleHash = hashString(title || '');
  const questionHash = hashString(question || '');
  
  return {
    psiMod: (titleHash % 100) / 200 - 0.25,      // Ïˆ from title
    betaMod: ((titleHash + questionHash) % 100) / 200 - 0.25, // Î² from combined
    alphaMod: (questionHash % 100) / 200 - 0.25, // Î± from question
    gammaMod: ((titleHash * questionHash) % 100) / 200 - 0.25, // Î³ from interaction
    sigmaMod: ((titleHash ^ questionHash) % 100) / 200 - 0.25  // Ïƒ from XOR
  };
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// READING SPREAD GENERATOR
// Draws cards using Lâ‚„ mathematics from current deck
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SPREAD_POSITIONS = {
  threeCard: [
    { name: 'Past', row: 'past' },
    { name: 'Present', row: 'present' },
    { name: 'Future', row: 'future' }
  ],
  celtic: [
    { name: 'Present', row: 'present' },
    { name: 'Challenge', row: 'present' },
    { name: 'Foundation', row: 'past' },
    { name: 'Past', row: 'past' },
    { name: 'Crown', row: 'future' },
    { name: 'Future', row: 'future' },
    { name: 'Self', row: 'present' },
    { name: 'Environment', row: 'present' },
    { name: 'Hopes', row: 'future' },
    { name: 'Outcome', row: 'future' }
  ],
  nineCard: [
    { name: 'Foundation', row: 'past' },
    { name: 'Heart', row: 'past' },
    { name: 'Outcome', row: 'past' },
    { name: 'Challenge', row: 'present' },
    { name: 'Self', row: 'present' },
    { name: 'Path', row: 'present' },
    { name: 'Influence', row: 'future' },
    { name: 'Hopes', row: 'future' },
    { name: 'Destiny', row: 'future' }
  ]
};

function drawReading(spreadType = 'threeCard', title = '', question = '', rawMode = false, deckCards = null) {
  const positions = SPREAD_POSITIONS[spreadType] || SPREAD_POSITIONS.threeCard;
  
  // Apply intent influence unless raw mode
  const influence = rawMode ? { psiMod: 0, betaMod: 0, alphaMod: 0, gammaMod: 0, sigmaMod: 0 } 
                            : calculateIntentInfluence(title, question);
  
  // Lock quantum state with influence
  lockedQuantum = {
    psi: Math.max(0, Math.min(1, quantumState.psi + influence.psiMod)),
    beta: Math.max(0, Math.min(1, quantumState.beta + influence.betaMod)),
    alpha: Math.max(0, Math.min(1, quantumState.alpha + influence.alphaMod)),
    gamma: Math.max(0, Math.min(1, quantumState.gamma + influence.gammaMod)),
    sigma: Math.max(0, Math.min(1, quantumState.sigma + influence.sigmaMod))
  };
  
  // Generate master seed from L4-weighted quantum state
  const thresholdZ = computeThresholdZ(lockedQuantum);
  const seed = Math.abs(Math.floor(
    thresholdZ * 1000000 +
    lockedQuantum.psi * L4.THRESHOLDS.PARADOX * 10000 +
    lockedQuantum.alpha * L4.THRESHOLDS.THE_LENS * 7777 +
    lockedQuantum.gamma * L4.THRESHOLDS.K_FORMATION * 5555 +
    Date.now() % 10000
  ));
  
  // Use provided deck or fall back to filtering current deck
  const tarotCards = deckCards || state.cards.filter(c => c.type === 'tarot-major' || c.type === 'tarot-minor');
  if (tarotCards.length === 0) {
    showToast('âš ï¸ No tarot cards available');
    return null;
  }
  
  const selectedIndices = new Set();
  const spread = [];
  
  for (let i = 0; i < positions.length; i++) {
    // L4-grounded card selection with collision avoidance
    let cardIndex;
    let attempts = 0;
    do {
      cardIndex = selectCardL4(lockedQuantum, i + attempts * L4.L4_INT, seed, tarotCards.length);
      attempts++;
    } while (selectedIndices.has(cardIndex) && attempts < 100);
    
    selectedIndices.add(cardIndex);
    
    // Determine echo state using Ï†â»â´ probability
    const echoState = determineEchoState(seed, i, lockedQuantum.sigma);
    
    spread.push({
      card: tarotCards[cardIndex],
      position: positions[i],
      state: echoState,
      index: i
    });
  }
  
  currentReading = {
    spread,
    quantum: { ...lockedQuantum },
    thresholdZ,
    thresholdBand: getThresholdBand(thresholdZ),
    seed,
    timestamp: new Date().toISOString(),
    title,
    question,
    deckPreset: selectedReadingDeck,
    spreadType
  };
  
  return currentReading;
}

// Animate quantum state (call in animation loop or interval)
function animateQuantumState() {
  if (quantumState.phase === 'SUPERPOSITION') {
    const t = Date.now() * 0.001;
    quantumState.psi = 0.5 + 0.3 * Math.sin(t * L4.TAU);
    quantumState.beta = 0.5 + 0.3 * Math.cos(t * L4.PHI);
    quantumState.alpha = 0.5 + 0.3 * Math.sin(t * L4.THRESHOLDS.THE_LENS);
    quantumState.gamma = 0.5 + 0.3 * Math.cos(t * L4.THRESHOLDS.K_FORMATION);
    quantumState.sigma = 0.5 + 0.3 * Math.sin(t * L4.THRESHOLDS.VOID * 10);
  }
}

// Reset quantum state to superposition
function resetQuantumState() {
  quantumState = {
    psi: 0.5, beta: 0.5, alpha: 0.5, gamma: 0.5, sigma: 0.5,
    phase: 'SUPERPOSITION'
  };
  lockedQuantum = null;
  currentReading = null;
}

const PALETTE = ['#d4af37','#ffd700','#c0c0c0','#4a5a6a','#c53030','#3b7dd8','#2d7a4a','#9d4edd','#ff6b1a','#1a7a6c','#4a9eff','#ff66cc','#50a878','#9070a8','#ff5858','#e8a828'];
const SIGILS = ['âœ§','â—ˆ','â¬¡','â˜†','â–³','â—‡','âˆ','âŠ•','ğŸ”¥','ğŸ’§','â­','âš¡','ğŸ¿ï¸','ğŸ¦¢','ğŸ¦Š','ğŸ¦‰','ğŸ¦‹','ğŸ','ğŸŒ³','ğŸ’','ğŸ','ğŸ¦Œ','ğŸ‘ï¸','ğŸ¦'];

const FRONT_THEMES = {
  classic: { name: 'Classic', bg1: '#1a2844', bg2: '#0a1428', pattern: 'ornate', patternColor: '#d4af37', borderColor: '#d4af37', glow: 4 },
  helix: { name: 'Lâ‚„-Helix', bg1: '#0a0a14', bg2: '#040408', pattern: 'hexgrid', patternColor: '#4cc9f0', borderColor: '#4cc9f0', glow: 6 },
  guardian: { name: 'Guardian', bg1: '#0a1810', bg2: '#040a08', pattern: 'circles', patternColor: '#50a878', borderColor: '#50a878', glow: 5 },
  void: { name: 'Void', bg1: '#0a0a10', bg2: '#020204', pattern: 'stars', patternColor: '#6040a0', borderColor: '#8060c0', glow: 5 },
  parchment: { name: 'Parchment', bg1: '#e8dcc4', bg2: '#d4c8a8', pattern: 'diamonds', patternColor: '#8b5a2b', borderColor: '#8b5a2b', glow: 2, textDark: true },
  neon: { name: 'Neon', bg1: '#0a0018', bg2: '#050010', pattern: 'waves', patternColor: '#ff00ff', borderColor: '#00ffff', glow: 8 },
  ember: { name: 'Ember', bg1: '#1a0808', bg2: '#0a0404', pattern: 'circles', patternColor: '#ff4020', borderColor: '#ff6040', glow: 6 },
  frost: { name: 'Frost', bg1: '#0a1820', bg2: '#040c10', pattern: 'stars', patternColor: '#60a0ff', borderColor: '#80c0ff', glow: 5 },
  royal: { name: 'Royal', bg1: '#180828', bg2: '#0a0418', pattern: 'ornate', patternColor: '#c090ff', borderColor: '#ffd700', glow: 5 }
};

const BACK_THEMES = {
  void: { name: 'Void', bg1: '#0a0a14', bg2: '#040408', borderColor: '#d4af37', textMain: '#e8e0d5', textMuted: '#808090', accent: '#d4af37' },
  parchment: { name: 'Parchment', bg1: '#e8dcc4', bg2: '#d4c8a8', borderColor: '#8b5a2b', textMain: '#2d2418', textMuted: '#5a4a3a', accent: '#8b5a2b' },
  helix: { name: 'Lâ‚„-Helix', bg1: '#0a0a14', bg2: '#040408', borderColor: '#4cc9f0', textMain: '#e0f0ff', textMuted: '#6090a0', accent: '#4cc9f0' },
  neon: { name: 'Neon', bg1: '#0a0018', bg2: '#050010', borderColor: '#ff00ff', textMain: '#ffffff', textMuted: '#a060c0', accent: '#00ffff' },
  ember: { name: 'Ember', bg1: '#1a0808', bg2: '#0a0404', borderColor: '#ff6040', textMain: '#ffe0d0', textMuted: '#a08080', accent: '#ff4020' },
  frost: { name: 'Frost', bg1: '#0a1820', bg2: '#040c10', borderColor: '#80c0ff', textMain: '#e0f0ff', textMuted: '#6080a0', accent: '#60a0ff' },
  royal: { name: 'Royal', bg1: '#180828', bg2: '#0a0418', borderColor: '#ffd700', textMain: '#f0e8ff', textMuted: '#a090c0', accent: '#c090ff' },
  blood: { name: 'Blood', bg1: '#180808', bg2: '#0a0404', borderColor: '#c03040', textMain: '#ffe0e0', textMuted: '#a06060', accent: '#ff4060' }
};

const BACK_LAYOUTS = {
  minimal: { name: 'Minimal', showMetrics: false, showLore: false, showFreq: false },
  stats: { name: 'Stats', showMetrics: true, showLore: false, showFreq: true },
  lore: { name: 'Lore', showMetrics: false, showLore: true, showFreq: false },
  full: { name: 'Full', showMetrics: true, showLore: true, showFreq: true }
};

const FRAME_GLOW_PRESETS = {
  none: { name: 'None', colors: null, blur: 0 },
  custom: { name: 'Custom', colors: null, blur: 4 },
  palette: { name: 'Palette', colors: 'deck', blur: 5 },
  void: { name: 'Void', colors: ['#6040a0', '#302060', '#8060c0'], blur: 6 },
  parchment: { name: 'Parch', colors: ['#8b5a2b', '#a0703a', '#6a4020'], blur: 3 },
  neon: { name: 'Neon', colors: ['#ff00ff', '#00ffff', '#ffff00'], blur: 8 },
  ember: { name: 'Ember', colors: ['#ff4020', '#ff8040', '#ffc060'], blur: 6 },
  frost: { name: 'Frost', colors: ['#60a0ff', '#a0d0ff', '#ffffff'], blur: 5 },
  toxic: { name: 'Toxic', colors: ['#40ff40', '#80ff80', '#c0ffc0'], blur: 7 },
  blood: { name: 'Blood', colors: ['#800020', '#c03040', '#ff4060'], blur: 5 },
  gold: { name: 'Gold', colors: ['#ffd700', '#ffb000', '#ffe080'], blur: 5 }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const state = {
  deck: 'classic',
  uiTheme: 'void',
  view: 'front',
  filter: null,
  frontTheme: 'classic',
  backTheme: 'void',
  backLayout: 'stats',
  opacity: 0.12,
  glow: 5,
  frameGlow: 'custom',
  frameGlowIntensity: 5,
  frameThickness: 2,
  frameGlowColor1: '#d4af37',
  frameGlowColor2: '#ffd700',
  sheenColor: '#ffffff',
  sheenOpacity: 0,
  sheenAngle: 135,
  showRank: true,
  showName: true,
  selectMode: false,
  classic: { cardsPerSuit: 13 },
  guardian: { cardsPerGuardian: 7 },
  tarot: { arcana: 'all', preset: 'classic' },
  cards: [],
  customCards: [], // User's custom deck (cards added from other decks)
  customDeck: { divisions: [] }, // User-defined divisions (custom suits/structures)
  selectedGlyph: '', // Currently selected glyph in Glyph Lab
  galleryOpen: false, // Gallery modal state
  deckColors: ['#d4af37', '#50a878', '#9d4edd'], // Global deck palette (c1, c2, c3)
  animMode: 'none', // Card animation mode: none, pulse, cycle
  currentView: 'architect', // Current view: architect, gallery, table
  spreadCards: [], // Cards currently on the table spread
  selectedCards: [],
  // Editor state - holds LIVE working values
  ed: {
    index: 0,
    color: '',
    pattern: '',
    frontTheme: '',
    glow: null,
    symbol: '',
    frameGlow: '',
    frameGlowIntensity: 5,
    frameThickness: 2,
    frameGlowColor1: '#d4af37',
    frameGlowColor2: '#ffd700',
    animMode: 'none',
    backTheme: '',
    backLayout: '',
    backAccent: '',
    backBg1: '',
    backBg2: '',
    backBorder: '',
    backThickness: 1,
    backGlow: 0,
    backTextMain: '',
    backTextMuted: '',
    customTitle: '',
    customDesc: ''
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT & DECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function init() { initGlobalColors(); buildControlPanel(); buildDeck(); renderCards(); }

function buildDeck() {
  state.cards = [];
  state.selectedCards = [];
  if (state.deck === 'custom') {
    // Custom deck uses the customCards array directly
    state.cards = state.customCards.map(c => ({...c})); // shallow copy
  } else if (state.deck === 'classic') {
    const ranks = CLASSIC_RANKS.slice(0, state.classic.cardsPerSuit);
    Object.entries(CLASSIC_SUITS).forEach(([k, s]) => {
      ranks.forEach(r => state.cards.push({ type: 'classic', suit: k, rank: r, color: s.color, name: `${r} of ${s.name}`, cfg: {}, backCfg: {} }));
    });
  } else if (state.deck === 'guardian') {
    const ranks = CLASSIC_RANKS.slice(0, state.guardian.cardsPerGuardian);
    Object.entries(GUARDIANS).forEach(([k, g]) => {
      ranks.forEach(r => state.cards.push({ type: 'guardian', guardian: k, rank: r, color: g.color, territory: g.territory, name: RANK_MEANINGS[r].title, symbol: g.symbol, cfg: {}, backCfg: {} }));
    });
  } else {
    // Tarot deck with preset selection (classic or honkfire)
    const preset = state.tarot.preset || 'classic';
    const arcana = state.tarot.arcana || 'all';
    
    if (preset === 'honkfire') {
      // HonkFire Tarot - Echo-Sovereign Quantum System
      if (arcana === 'all' || arcana === 'major') {
        HONKFIRE_MAJOR.forEach(c => state.cards.push({ 
          type: 'tarot-major', 
          preset: 'honkfire',
          ...c, 
          name: c.title,
          cfg: { symbol: getEntitySymbol(c.entity) }, 
          backCfg: {} 
        }));
      }
      if (arcana === 'all' || arcana === 'minor') {
        Object.entries(HONKFIRE_SUITS).forEach(([suitKey, suit]) => {
          HONKFIRE_RANKS.forEach(rank => {
            const minorData = HONKFIRE_MINOR[suitKey]?.[rank] || {};
            state.cards.push({ 
              type: 'tarot-minor', 
              preset: 'honkfire',
              suit: suit.entity, 
              rank: rank, 
              color: suit.color, 
              name: minorData.title || `${rank} of ${suit.name}`,
              title: minorData.title,
              subtitle: minorData.subtitle,
              greek: minorData.greek,
              keyword: minorData.keyword,
              element: suit.element,
              dimension: suit.dimension,
              glyph: suit.glyph,
              entity: suit.entity,
              cfg: { symbol: suit.symbol }, 
              backCfg: {} 
            });
          });
        });
      }
    } else {
      // Classic Tarot
      if (arcana === 'all' || arcana === 'major') {
        MAJOR_ARCANA.forEach(c => state.cards.push({ type: 'tarot-major', preset: 'classic', ...c, cfg: {}, backCfg: {} }));
      }
      if (arcana === 'all' || arcana === 'minor') {
        Object.entries(TAROT_SUITS).forEach(([k, s]) => {
          TAROT_MINOR_RANKS.forEach(r => state.cards.push({ type: 'tarot-minor', preset: 'classic', suit: k, rank: r, color: s.color, name: `${r} of ${s.name}`, element: s.element, cfg: {}, backCfg: {} }));
        });
      }
    }
  }
}

function getEntitySymbol(entity) {
  const symbols = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', oak: 'ğŸŒ³', fox: 'ğŸ¦Š', merged: 'âœ§' };
  return symbols[entity] || 'âœ§';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTROL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildControlPanel() {
  const panel = document.getElementById('controlPanel');
  let deckSection = '';
  if (state.deck === 'custom') {
    const typeCount = {};
    state.customCards.forEach(c => { typeCount[c.type] = (typeCount[c.type] || 0) + 1; });
    const breakdown = Object.entries(typeCount).map(([t, n]) => `${n} ${t.replace('tarot-', '')}`).join(', ') || 'Empty';
    const divCount = state.customDeck.divisions.length;
    const structCount = state.customDeck.divisions.reduce((sum, d) => sum + d.structures.length, 0);
    
    const filterBtns = `<div class="filter-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:8px;">
      <button class="filter-btn ${!state.filter?'active':''}" onclick="setFilter(null)" style="font-size:10px;">All</button>
      <button class="filter-btn ${state.filter==='classic'?'active':''}" onclick="setFilter('classic')" style="color:var(--text-secondary)">â™ </button>
      <button class="filter-btn ${state.filter==='guardian'?'active':''}" onclick="setFilter('guardian')" style="color:var(--cosmic)">â—</button>
      <button class="filter-btn ${state.filter==='tarot'?'active':''}" onclick="setFilter('tarot')" style="color:var(--gold)">âœ§</button>
      <button class="filter-btn ${state.filter==='division'?'active':''}" onclick="setFilter('division')" style="color:var(--squirrel)">â—‡</button>
    </div>`;
    
    deckSection = `
      <section class="panel-section">
        <h3>âœ¦ CUSTOM DECK</h3>
        <div class="custom-deck-stats">
          <div class="custom-stat-row">
            <span class="custom-stat-label">Cards</span>
            <span class="custom-stat-value">${state.customCards.length}</span>
          </div>
          <div class="custom-stat-row">
            <span class="custom-stat-label">Types</span>
            <span class="custom-stat-value" style="font-size:9px;">${breakdown}</span>
          </div>
          <div class="custom-stat-row">
            <span class="custom-stat-label">Divisions</span>
            <span class="custom-stat-value">${divCount} <span style="color:var(--text-muted);font-size:9px;">(${structCount} structs)</span></span>
          </div>
        </div>
        ${state.customCards.length > 0 ? `<label style="margin-top:10px;">Filter by Type</label>${filterBtns}` : ''}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px;">
          <button class="btn" onclick="openCardPicker()">â• PICK</button>
          <button class="btn" onclick="openCardCreator()">âœ¨ CREATE</button>
        </div>
        <button class="btn sm" style="width:100%;margin-top:6px;" onclick="clearCustomDeck()">ğŸ—‘ï¸ CLEAR ALL</button>
        ${state.customCards.length > 0 ? `<button class="btn sm" style="width:100%;margin-top:6px;" onclick="saveCustomToVault()">ğŸ’¾ SAVE TO VAULT</button>` : ''}
      </section>
      
      <section class="panel-section">
        <h3>â—‡ DIVISION HIERARCHY</h3>
        <div id="division-hierarchy"></div>
        <button class="btn" style="width:100%;margin-top:8px;" onclick="addDivision()">+ ADD DIVISION</button>
        ${structCount > 0 ? `<button class="btn sm success" style="width:100%;margin-top:6px;" onclick="generateCardsFromDivisions()">ğŸƒ Generate ${structCount} Cards</button>` : ''}
      </section>
    `;
  } else if (state.deck === 'classic') {
    deckSection = `<section class="panel-section"><h3>â™  CLASSIC DECK</h3><label>Filter by Suit</label><div class="filter-grid">${Object.entries(CLASSIC_SUITS).map(([k,s]) => `<button class="filter-btn ${!state.filter || state.filter === k ? 'active' : ''}" onclick="setFilter('${k}')" style="color:${s.color}">${s.name.charAt(0)}</button>`).join('')}</div><label>Cards per Suit</label><select onchange="state.classic.cardsPerSuit=+this.value;buildDeck();renderCards();"><option value="13" ${state.classic.cardsPerSuit===13?'selected':''}>13 (Full)</option><option value="10" ${state.classic.cardsPerSuit===10?'selected':''}>10 (No Face)</option><option value="4" ${state.classic.cardsPerSuit===4?'selected':''}>4 (Court)</option></select><button class="btn sm" style="width:100%;margin-top:10px;" onclick="addAllToCustom()">â• Add All to Custom</button></section>`;
  } else if (state.deck === 'guardian') {
    deckSection = `<section class="panel-section"><h3>â— GUARDIAN DECK</h3><label>Filter by Territory</label><div class="filter-grid" style="grid-template-columns:repeat(3,1fr);"><button class="filter-btn ${state.filter==='garden'?'active':''}" onclick="setFilter('garden')" style="color:var(--garden)">Garden</button><button class="filter-btn ${state.filter==='cosmic'?'active':''}" onclick="setFilter('cosmic')" style="color:var(--cosmic)">Cosmic</button><button class="filter-btn ${state.filter==='abyss'?'active':''}" onclick="setFilter('abyss')" style="color:var(--abyss)">Abyss</button></div><label>Cards per Guardian</label><select onchange="state.guardian.cardsPerGuardian=+this.value;buildDeck();renderCards();"><option value="13" ${state.guardian.cardsPerGuardian===13?'selected':''}>13</option><option value="7" ${state.guardian.cardsPerGuardian===7?'selected':''}>7</option><option value="1" ${state.guardian.cardsPerGuardian===1?'selected':''}>1</option></select><button class="btn sm" style="width:100%;margin-top:10px;" onclick="addAllToCustom()">â• Add All to Custom</button></section>`;
  } else {
    // Tarot deck with preset selection
    const preset = state.tarot.preset || 'classic';
    const arcana = state.tarot.arcana || 'all';
    const isHonkfire = preset === 'honkfire';
    const majCount = isHonkfire ? HONKFIRE_MAJOR.length : 22;
    const minCount = isHonkfire ? Object.keys(HONKFIRE_SUITS).length * HONKFIRE_RANKS.length : 70;
    const totalCount = arcana === 'major' ? majCount : arcana === 'minor' ? minCount : majCount + minCount;
    
    const entityFilter = isHonkfire ? `
      <label style="margin-top:8px;">Filter by Entity</label>
      <div class="filter-grid" style="grid-template-columns:repeat(4,1fr);">
        <button class="filter-btn ${state.filter==='squirrel'?'active':''}" onclick="setFilter('squirrel')" style="color:#9d4edd" title="Scatter">ğŸ¿ï¸</button>
        <button class="filter-btn ${state.filter==='goose'?'active':''}" onclick="setFilter('goose')" style="color:#ff6b1a" title="Flames">ğŸ”¥</button>
        <button class="filter-btn ${state.filter==='duck'?'active':''}" onclick="setFilter('duck')" style="color:#1a7a6c" title="Stillness">ğŸ¦†</button>
        <button class="filter-btn ${state.filter==='fox'?'active':''}" onclick="setFilter('fox')" style="color:#4a9eff" title="Stars">ğŸ¦Š</button>
      </div>` : '';
    
    // Echo controls for HonkFire
    const echoedCount = state.cards.filter(c => c.echoed).length;
    const echoControls = isHonkfire ? `
      <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,102,204,0.2);">
        <label style="color:#ff66cc;">ğŸŒ‘ Echo-Sovereign</label>
        <div style="font-size:9px;color:var(--text-muted);margin:4px 0;">Ï†â»â´ = 14.6% probability</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;">
          <button class="btn sm" style="background:rgba(255,102,204,0.15);border-color:#ff66cc;color:#ff66cc;font-size:9px;" onclick="applyRandomEcho()">ğŸ² Roll Echo</button>
          <button class="btn sm" style="background:rgba(255,102,204,0.15);border-color:#ff66cc;color:#ff66cc;font-size:9px;" onclick="clearAllEcho()">âœ• Clear</button>
        </div>
        ${state.selectedCards.length > 0 ? `<button class="btn sm" style="width:100%;margin-top:6px;background:rgba(255,102,204,0.2);border-color:#ff66cc;color:#ff66cc;" onclick="toggleSelectedEcho()">ğŸŒ‘ Toggle Selected (${state.selectedCards.length})</button>` : ''}
        <div style="font-size:10px;color:#ff66cc;margin-top:8px;text-align:center;">${echoedCount} / ${state.cards.length} Echoed</div>
      </div>` : '';
    
    const readingBtn = isHonkfire ? `<button class="btn sm" style="width:100%;margin-top:6px;background:rgba(157,78,221,0.2);border-color:#9d4edd;color:#9d4edd;" onclick="openReadingModal()">ğŸ”® Lâ‚„ READING</button>` : '';
    
    deckSection = `<section class="panel-section">
      <h3>âœ§ TAROT DECK</h3>
      <label>Preset</label>
      <div class="preset-grid" style="grid-template-columns:1fr 1fr;">
        <div class="preset-chip ${preset==='classic'?'active':''}" onclick="state.tarot.preset='classic';state.filter=null;buildDeck();buildControlPanel();renderCards();">Classic</div>
        <div class="preset-chip ${preset==='honkfire'?'active':''}" onclick="state.tarot.preset='honkfire';state.filter=null;buildDeck();buildControlPanel();renderCards();" style="${preset==='honkfire'?'background:linear-gradient(135deg,#9d4edd,#ff6b1a);border-color:#ffd700;':''}">ğŸ”¥ HonkFire</div>
      </div>
      ${isHonkfire ? `<div style="font-size:9px;color:var(--text-muted);margin:6px 0;line-height:1.3;text-align:center;">Echo-Sovereign Â· Ï†â´ + Ï†â»â´ = 7</div>` : ''}
      <label>Arcana</label>
      <select onchange="state.tarot.arcana=this.value;buildDeck();renderCards();">
        <option value="all" ${arcana==='all'?'selected':''}>All (${totalCount})</option>
        <option value="major" ${arcana==='major'?'selected':''}>Major (${majCount})</option>
        <option value="minor" ${arcana==='minor'?'selected':''}>Minor (${minCount})</option>
      </select>
      ${entityFilter}
      ${echoControls}
      <button class="btn sm" style="width:100%;margin-top:10px;" onclick="addAllToCustom()">â• Add All to Custom</button>
      ${readingBtn}
    </section>`;
  }
  panel.innerHTML = `${deckSection}<section class="panel-section"><h3>ğŸ¨ FRONT</h3><label>Theme</label><div class="preset-grid">${Object.entries(FRONT_THEMES).slice(0,6).map(([k,t]) => `<div class="preset-chip ${state.frontTheme===k?'active':''}" onclick="setFrontTheme('${k}')">${t.name}</div>`).join('')}</div><label>Frame Glow</label><div class="preset-grid">${['none','custom','gold','neon','ember','frost'].map(k => `<div class="preset-chip ${state.frameGlow===k?'active':''}" onclick="setFrameGlow('${k}')">${FRAME_GLOW_PRESETS[k].name}</div>`).join('')}</div><div class="preset-grid">${['void','toxic','blood','parchment'].map(k => `<div class="preset-chip ${state.frameGlow===k?'active':''}" onclick="setFrameGlow('${k}')">${FRAME_GLOW_PRESETS[k].name}</div>`).join('')}</div></section><section class="panel-section"><h3>ğŸŒˆ DECK PALETTE</h3><div class="color-preview-box" onclick="toggleColorEdit()"></div><div id="color-edit-row" class="color-edit-row"><input type="color" id="col-1" value="${state.deckColors[0]}" onchange="updateGlobalColors()" title="Color 1"><input type="color" id="col-2" value="${state.deckColors[1]}" onchange="updateGlobalColors()" title="Color 2"><input type="color" id="col-3" value="${state.deckColors[2]}" onchange="updateGlobalColors()" title="Color 3"></div><label>Card Animation</label><select onchange="setAnimMode(this.value)"><option value="none" ${state.animMode==='none'?'selected':''}>Static</option><option value="pulse" ${state.animMode==='pulse'?'selected':''}>Aura Pulse</option><option value="cycle" ${state.animMode==='cycle'?'selected':''}>Chroma Cycle</option></select></section><section class="panel-section"><h3>ğŸ“Š BACK</h3><label>Theme</label><div class="preset-grid">${Object.entries(BACK_THEMES).slice(0,6).map(([k,t]) => `<div class="preset-chip ${state.backTheme===k?'active':''}" onclick="setBackTheme('${k}')">${t.name}</div>`).join('')}</div><label>Layout</label><div class="preset-grid" style="grid-template-columns:repeat(4,1fr);">${Object.entries(BACK_LAYOUTS).map(([k,l]) => `<div class="preset-chip ${state.backLayout===k?'active':''}" onclick="setBackLayout('${k}')">${l.name}</div>`).join('')}</div></section><section class="panel-section"><h3>ğŸ‘ DISPLAY</h3><div class="toggle-row"><span class="toggle-label">Rank</span><div class="toggle ${state.showRank?'active':''}" onclick="state.showRank=!state.showRank;buildControlPanel();renderCards();"></div></div><div class="toggle-row"><span class="toggle-label">Name</span><div class="toggle ${state.showName?'active':''}" onclick="state.showName=!state.showName;buildControlPanel();renderCards();"></div></div><div class="toggle-row"><span class="toggle-label">Multi-Select</span><div class="toggle ${state.selectMode?'active':''}" onclick="toggleSelectMode()"></div></div></section>`;
  
  // Render division hierarchy if in custom mode
  if (state.deck === 'custom') {
    renderDivisionHierarchy();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function genPattern(type, id, color) {
  const p = { none: '', circles: `<pattern id="${id}" patternUnits="userSpaceOnUse" width="12" height="12"><circle cx="6" cy="6" r="3.5" fill="none" stroke="${color}" stroke-width="0.5"/></pattern>`, waves: `<pattern id="${id}" patternUnits="userSpaceOnUse" width="16" height="6"><path d="M0,3 Q4,0 8,3 T16,3" fill="none" stroke="${color}" stroke-width="0.5"/></pattern>`, diamonds: `<pattern id="${id}" patternUnits="userSpaceOnUse" width="9" height="9"><path d="M4.5,1 L8,4.5 L4.5,8 L1,4.5 Z" fill="none" stroke="${color}" stroke-width="0.5"/></pattern>`, hexgrid: `<pattern id="${id}" patternUnits="userSpaceOnUse" width="14" height="12"><path d="M7,0 L14,3.5 L14,9.5 L7,13 L0,9.5 L0,3.5 Z" fill="none" stroke="${color}" stroke-width="0.35"/></pattern>`, stars: `<pattern id="${id}" patternUnits="userSpaceOnUse" width="12" height="12"><polygon points="6,1 7,4.2 10.5,4.2 7.8,6.2 8.8,9.5 6,7.4 3.2,9.5 4.2,6.2 1.5,4.2 5,4.2" fill="none" stroke="${color}" stroke-width="0.35"/></pattern>`, ornate: `<pattern id="${id}" patternUnits="userSpaceOnUse" width="14" height="14"><path d="M7,1 L7,13 M1,7 L13,7" stroke="${color}" stroke-width="0.2" opacity="0.4"/><circle cx="7" cy="7" r="2" fill="none" stroke="${color}" stroke-width="0.35"/></pattern>` };
  return p[type] || '';
}

function genCenterGlow(id, blur, color) {
  if (blur <= 0) return '';
  return `<filter id="${id}" x="-100%" y="-100%" width="300%" height="300%"><feFlood flood-color="${color}" flood-opacity="0.8" result="c"/><feComposite in="c" in2="SourceGraphic" operator="in" result="g"/><feGaussianBlur in="g" stdDeviation="${blur/2}" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>`;
}

function getFrameGlowColors(preset, cardColor, intensity, c1Override, c2Override) {
  if (preset === 'none') return { c1: cardColor, c2: cardColor, blur: 0 };
  if (preset === 'custom') return { c1: c1Override || state.deckColors[0], c2: c2Override || state.deckColors[1], blur: intensity };
  if (preset === 'palette') return { c1: state.deckColors[0], c2: state.deckColors[1], c3: state.deckColors[2], blur: intensity || 5 };
  const p = FRAME_GLOW_PRESETS[preset];
  if (p && p.colors === 'deck') return { c1: state.deckColors[0], c2: state.deckColors[1], c3: state.deckColors[2], blur: intensity || p.blur };
  if (p && p.colors) return { c1: p.colors[0], c2: p.colors[1], blur: intensity || p.blur };
  return { c1: state.deckColors[0], c2: state.deckColors[1], blur: intensity };
}

function genFrameGlowFilter(id, c1, c2, blur) {
  if (blur <= 0) return '';
  return `<filter id="${id}" x="-50%" y="-50%" width="200%" height="200%"><feFlood flood-color="${c1}" flood-opacity="0.6" result="c1"/><feComposite in="c1" in2="SourceGraphic" operator="in" result="g1"/><feGaussianBlur in="g1" stdDeviation="${blur}" result="b1"/><feFlood flood-color="${c2}" flood-opacity="0.3" result="c2"/><feComposite in="c2" in2="SourceGraphic" operator="in" result="g2"/><feGaussianBlur in="g2" stdDeviation="${blur*1.5}" result="b2"/><feMerge><feMergeNode in="b2"/><feMergeNode in="b1"/><feMergeNode in="SourceGraphic"/></feMerge></filter>`;
}

function adjustColor(hex, amt) {
  if (!hex || hex.length < 7) return hex;
  let [r, g, b] = [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
  return `#${Math.max(0,Math.min(255,r+amt)).toString(16).padStart(2,'0')}${Math.max(0,Math.min(255,g+amt)).toString(16).padStart(2,'0')}${Math.max(0,Math.min(255,b+amt)).toString(16).padStart(2,'0')}`;
}

function hexToRgb(hex) { if (!hex || hex.length < 7) return '255,255,255'; return `${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)}`; }
function truncate(s, n) { return s && s.length > n ? s.slice(0, n-1) + 'â€¦' : (s || ''); }
function isTextSymbol(sym) { return typeof sym === 'string' && !sym.includes('<'); }

// Auto-wrap text to fit card width, returns array of lines
function wrapLoreText(text, maxChars, maxLines) {
  if (!text) return [];
  // Normalize: replace newlines/tabs with spaces, collapse multiple spaces
  const normalized = text.replace(/[\r\n\t]+/g, ' ').replace(/\s+/g, ' ').trim();
  const words = normalized.split(' ');
  const lines = [];
  let currentLine = '';
  
  for (const word of words) {
    if (!word) continue;
    if (currentLine.length + word.length + 1 <= maxChars) {
      currentLine += (currentLine ? ' ' : '') + word;
    } else {
      if (currentLine) lines.push(currentLine);
      if (maxLines && lines.length >= maxLines) {
        // If we hit max, append remaining to last line with ellipsis
        const remaining = [word, ...words.slice(words.indexOf(word) + 1)].join(' ');
        if (remaining) lines[lines.length - 1] += 'â€¦';
        return lines;
      }
      // Handle words longer than maxChars by breaking them
      if (word.length > maxChars) {
        let w = word;
        while (w.length > maxChars) {
          lines.push(w.slice(0, maxChars - 1) + '-');
          w = w.slice(maxChars - 1);
          if (maxLines && lines.length >= maxLines) return lines;
        }
        currentLine = w;
      } else {
        currentLine = word;
      }
    }
  }
  if (currentLine) lines.push(currentLine);
  return lines;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HONKFIRE MAJOR ARCANA SVG GENERATORS
// Animated sacred geometry from the Echo-Sovereign system
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HONKFIRE_SVG = {
  0: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf0" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="100%" stop-color="#4d94ff"/></linearGradient></defs>
    <g stroke="url(#hf0)" stroke-width="1.5" fill="none" opacity="0.6">${Array.from({length:17},(_,i)=>{const a=(i*360/17)*Math.PI/180;return `<line x1="100" y1="100" x2="${100+Math.cos(a)*80}" y2="${100+Math.sin(a)*80}" stroke-dasharray="4,6"><animate attributeName="stroke-dashoffset" from="0" to="${20+i*2}" dur="${2+i*0.15}s" repeatCount="indefinite"/></line>`;}).join('')}</g>
    <g fill="none" stroke="url(#hf0)" opacity="0.4"><circle cx="100" cy="100" r="25"><animate attributeName="r" values="25;30;25" dur="3s" repeatCount="indefinite"/></circle><circle cx="100" cy="100" r="50"><animate attributeName="r" values="50;55;50" dur="4s" repeatCount="indefinite"/></circle></g>
    <circle cx="100" cy="100" r="8" fill="#d4af37" opacity="0.9"><animate attributeName="opacity" values="0.9;0.5;0.9" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  1: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf1" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#c41e1a"/><stop offset="50%" stop-color="#ff6b1a"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
    <g fill="none" stroke="url(#hf1)" stroke-width="2"><polygon points="100,25 60,110 140,110" opacity="0.9"><animate attributeName="points" values="100,25 60,110 140,110;100,20 55,115 145,115;100,25 60,110 140,110" dur="2s" repeatCount="indefinite"/></polygon><polygon points="100,55 70,120 130,120" opacity="0.7"><animate attributeName="points" values="100,55 70,120 130,120;100,50 65,125 135,125;100,55 70,120 130,120" dur="2.5s" repeatCount="indefinite"/></polygon><polygon points="100,85 80,135 120,135" opacity="0.5"><animate attributeName="points" values="100,85 80,135 120,135;100,80 75,140 125,140;100,85 80,135 120,135" dur="3s" repeatCount="indefinite"/></polygon></g>
    <line x1="100" y1="175" x2="100" y2="35" stroke="url(#hf1)" stroke-width="3" opacity="0.8"/>
    <g fill="#ffd700"><circle cx="85" cy="160" r="2"><animate attributeName="cy" values="160;40;160" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values="1;0;1" dur="3s" repeatCount="indefinite"/></circle><circle cx="115" cy="165" r="2"><animate attributeName="cy" values="165;45;165" dur="3.5s" repeatCount="indefinite"/><animate attributeName="opacity" values="1;0;1" dur="3.5s" repeatCount="indefinite"/></circle></g></svg>`,
  2: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1a7a6c"/><stop offset="100%" stop-color="#4dffc3"/></linearGradient></defs>
    <g fill="none" stroke="url(#hf2)" stroke-width="1.5" opacity="0.6"><circle cx="75" cy="100" r="45"/><circle cx="125" cy="100" r="45"/></g>
    <g fill="none" stroke="url(#hf2)" stroke-width="1" opacity="0.5"><circle cx="100" cy="100" r="20"><animate attributeName="r" values="20;25;20" dur="4s" repeatCount="indefinite"/></circle><circle cx="100" cy="100" r="35"><animate attributeName="r" values="35;42;35" dur="4.5s" repeatCount="indefinite"/></circle><circle cx="100" cy="100" r="50"><animate attributeName="r" values="50;58;50" dur="5s" repeatCount="indefinite"/></circle></g>
    <circle cx="100" cy="100" r="6" fill="#4dffc3" opacity="0.9"/><path d="M75,25 L85,10 L100,22 L115,10 L125,25" fill="none" stroke="#d4af37" stroke-width="2" opacity="0.7"/></svg>`,
  3: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf3a" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#3d2914"/><stop offset="100%" stop-color="#8b5a2b"/></linearGradient><linearGradient id="hf3b" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#2d5016"/><stop offset="100%" stop-color="#6b8e23"/></linearGradient></defs>
    <g stroke="url(#hf3a)" stroke-width="2.5" fill="none" opacity="0.7"><path d="M100,145 Q75,160 55,180"><animate attributeName="d" values="M100,145 Q75,160 55,180;M100,145 Q70,165 50,185;M100,145 Q75,160 55,180" dur="6s" repeatCount="indefinite"/></path><path d="M100,145 Q125,160 145,180"><animate attributeName="d" values="M100,145 Q125,160 145,180;M100,145 Q130,165 150,185;M100,145 Q125,160 145,180" dur="6.5s" repeatCount="indefinite"/></path></g>
    <line x1="100" y1="145" x2="100" y2="85" stroke="url(#hf3a)" stroke-width="5"/>
    <g fill="none" stroke="url(#hf3b)" stroke-width="1.5"><circle cx="100" cy="55" r="28" opacity="0.7"><animate attributeName="r" values="28;32;28" dur="4s" repeatCount="indefinite"/></circle><circle cx="72" cy="72" r="28" opacity="0.6"/><circle cx="128" cy="72" r="28" opacity="0.6"/><circle cx="72" cy="38" r="28" opacity="0.6"/><circle cx="128" cy="38" r="28" opacity="0.6"/><circle cx="100" cy="27" r="28" opacity="0.6"/><circle cx="100" cy="83" r="28" opacity="0.6"/></g>
    <circle cx="100" cy="55" r="12" fill="#ffd700" opacity="0.6"><animate attributeName="r" values="12;16;12" dur="3s" repeatCount="indefinite"/></circle></svg>`,
  4: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf4" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ffd700"/><stop offset="50%" stop-color="#ff6b9d"/><stop offset="100%" stop-color="#c44dff"/></linearGradient></defs>
    <g stroke="#ffd700" stroke-width="2.5"><line x1="100" y1="20" x2="100" y2="180"/><line x1="20" y1="100" x2="180" y2="100"/></g>
    <g stroke="url(#hf4)" stroke-width="1" fill="none" opacity="0.5"><path d="M30,35 Q65,70 100,100" stroke-dasharray="4,4"><animate attributeName="stroke-dashoffset" from="0" to="16" dur="3s" repeatCount="indefinite"/></path><path d="M170,35 Q135,70 100,100" stroke-dasharray="4,4"><animate attributeName="stroke-dashoffset" from="0" to="16" dur="3.2s" repeatCount="indefinite"/></path><path d="M30,165 Q65,130 100,100" stroke-dasharray="4,4"><animate attributeName="stroke-dashoffset" from="0" to="16" dur="2.8s" repeatCount="indefinite"/></path><path d="M170,165 Q135,130 100,100" stroke-dasharray="4,4"><animate attributeName="stroke-dashoffset" from="0" to="16" dur="3.1s" repeatCount="indefinite"/></path></g>
    <g fill="none" stroke="url(#hf4)" stroke-width="1.5" opacity="0.4"><rect x="70" y="70" width="60" height="60" transform="rotate(45 100 100)"/><rect x="55" y="55" width="90" height="90" transform="rotate(45 100 100)"/></g>
    <circle cx="100" cy="100" r="12" fill="url(#hf4)" opacity="0.8"/><circle cx="100" cy="100" r="6" fill="#fff" opacity="0.6"/></svg>`,
  5: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf5a" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="100%" stop-color="#c77dff"/></linearGradient><linearGradient id="hf5b" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ff6b1a"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
    <path d="M55,180 Q105,155 55,130 Q5,105 55,80 Q105,55 55,30" fill="none" stroke="url(#hf5a)" stroke-width="4" opacity="0.8"><animate attributeName="d" dur="3s" repeatCount="indefinite" values="M55,180 Q105,155 55,130 Q5,105 55,80 Q105,55 55,30;M55,180 Q115,150 55,125 Q-5,100 55,75 Q115,50 55,25;M55,180 Q105,155 55,130 Q5,105 55,80 Q105,55 55,30"/></path>
    <circle r="4" fill="#c77dff" opacity="0.9"><animateMotion dur="2.5s" repeatCount="indefinite" path="M55,180 Q105,155 55,130 Q5,105 55,80 Q105,55 55,30"/></circle>
    <path d="M145,180 Q95,155 145,130 Q195,105 145,80 Q95,55 145,30" fill="none" stroke="url(#hf5b)" stroke-width="4" opacity="0.8"><animate attributeName="d" dur="3s" repeatCount="indefinite" values="M145,180 Q95,155 145,130 Q195,105 145,80 Q95,55 145,30;M145,180 Q85,150 145,125 Q205,100 145,75 Q85,50 145,25;M145,180 Q95,155 145,130 Q195,105 145,80 Q95,55 145,30"/></path>
    <circle r="4" fill="#ffd700" opacity="0.9"><animateMotion dur="2.5s" repeatCount="indefinite" path="M145,180 Q95,155 145,130 Q195,105 145,80 Q95,55 145,30"/></circle>
    <g fill="#ffd700"><circle cx="100" cy="140" r="5" opacity="0.8"><animate attributeName="r" values="5;8;5" dur="1.5s" repeatCount="indefinite"/></circle><circle cx="100" cy="105" r="5" opacity="0.8"><animate attributeName="r" values="5;8;5" dur="1.5s" repeatCount="indefinite" begin="0.4s"/></circle><circle cx="100" cy="70" r="5" opacity="0.8"><animate attributeName="r" values="5;8;5" dur="1.5s" repeatCount="indefinite" begin="0.8s"/></circle></g>
    <circle cx="100" cy="15" r="10" fill="#ffd700" opacity="0.9"><animate attributeName="r" values="10;14;10" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  6: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf6" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="50%" stop-color="#ff6b9d"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
    <path d="M100,100 C60,60 20,60 20,100 C20,140 60,140 100,100 C140,60 180,60 180,100 C180,140 140,140 100,100" fill="none" stroke="url(#hf6)" stroke-width="3" opacity="0.8"><animate attributeName="stroke-dashoffset" from="0" to="100" dur="4s" repeatCount="indefinite"/></path>
    <circle cx="50" cy="100" r="8" fill="#9d4edd" opacity="0.9"><animateMotion dur="4s" repeatCount="indefinite" path="M50,0 C10,-40 -30,-40 -30,0 C-30,40 10,40 50,0 C90,-40 130,-40 130,0 C130,40 90,40 50,0"/></circle>
    <circle cx="150" cy="100" r="8" fill="#ffd700" opacity="0.9"><animateMotion dur="4s" repeatCount="indefinite" path="M-50,0 C-90,-40 -130,-40 -130,0 C-130,40 -90,40 -50,0 C-10,-40 30,-40 30,0 C30,40 -10,40 -50,0"/></circle>
    <circle cx="100" cy="100" r="10" fill="#ff6b9d" opacity="0.8"><animate attributeName="r" values="10;15;10" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  7: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf7" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ff6b1a"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
    <g fill="none" stroke="url(#hf7)" stroke-width="2"><circle cx="100" cy="100" r="25" stroke-dasharray="12,6" opacity="0.9"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="4s" repeatCount="indefinite"/></circle><circle cx="100" cy="100" r="45" stroke-dasharray="18,9" opacity="0.7"><animateTransform attributeName="transform" type="rotate" from="360 100 100" to="0 100 100" dur="6s" repeatCount="indefinite"/></circle><circle cx="100" cy="100" r="65" stroke-dasharray="24,12" opacity="0.5"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="8s" repeatCount="indefinite"/></circle><circle cx="100" cy="100" r="85" stroke-dasharray="30,15" opacity="0.35"><animateTransform attributeName="transform" type="rotate" from="360 100 100" to="0 100 100" dur="10s" repeatCount="indefinite"/></circle></g>
    <g fill="#ffd700" opacity="0.8"><polygon points="185,100 175,95 175,105"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="8s" repeatCount="indefinite"/></polygon></g>
    <circle cx="100" cy="100" r="8" fill="#ff6b1a" opacity="0.9"><animate attributeName="r" values="8;12;8" dur="1s" repeatCount="indefinite"/></circle></svg>`,
  8: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf8" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#4d94ff"/><stop offset="100%" stop-color="#c44dff"/></linearGradient></defs>
    <g fill="url(#hf8)" opacity="0.7"><path d="M70,30 Q70,45 60,50 Q70,55 70,70 Q70,55 80,50 Q70,45 70,30"><animate attributeName="transform" values="translate(0,0);translate(0,110);translate(0,0)" dur="3s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.7;0;0.7" dur="3s" repeatCount="indefinite"/></path><path d="M100,20 Q100,40 87,47 Q100,54 100,74 Q100,54 113,47 Q100,40 100,20"><animate attributeName="transform" values="translate(0,0);translate(0,120);translate(0,0)" dur="3.5s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.7;0;0.7" dur="3.5s" repeatCount="indefinite"/></path><path d="M130,35 Q130,50 120,55 Q130,60 130,75 Q130,60 140,55 Q130,50 130,35"><animate attributeName="transform" values="translate(0,0);translate(0,105);translate(0,0)" dur="2.8s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.7;0;0.7" dur="2.8s" repeatCount="indefinite"/></path></g>
    <ellipse cx="100" cy="170" rx="70" ry="18" fill="url(#hf8)" opacity="0.4"><animate attributeName="rx" values="70;80;70" dur="4s" repeatCount="indefinite"/></ellipse>
    <g fill="none" stroke="url(#hf8)" stroke-width="1" opacity="0.3"><ellipse cx="100" cy="170" rx="30" ry="8"><animate attributeName="rx" values="30;50;30" dur="3s" repeatCount="indefinite"/></ellipse><ellipse cx="100" cy="170" rx="50" ry="12"><animate attributeName="rx" values="50;70;50" dur="4s" repeatCount="indefinite"/></ellipse></g>
    <circle cx="100" cy="170" r="8" fill="#ffd700" opacity="0.6"><animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  9: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf9" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" stop-color="#1a7a6c"/><stop offset="50%" stop-color="#4dffc3"/><stop offset="100%" stop-color="#1a7a6c"/></linearGradient></defs>
    <g fill="none" stroke="url(#hf9)" stroke-width="2"><circle cx="100" cy="85" r="20" opacity="0.9"><animate attributeName="r" values="20;80;20" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.9;0;0.9" dur="4s" repeatCount="indefinite"/></circle><circle cx="100" cy="85" r="20" opacity="0.9"><animate attributeName="r" values="20;80;20" dur="4s" repeatCount="indefinite" begin="1s"/><animate attributeName="opacity" values="0.9;0;0.9" dur="4s" repeatCount="indefinite" begin="1s"/></circle><circle cx="100" cy="85" r="20" opacity="0.9"><animate attributeName="r" values="20;80;20" dur="4s" repeatCount="indefinite" begin="2s"/><animate attributeName="opacity" values="0.9;0;0.9" dur="4s" repeatCount="indefinite" begin="2s"/></circle><circle cx="100" cy="85" r="20" opacity="0.9"><animate attributeName="r" values="20;80;20" dur="4s" repeatCount="indefinite" begin="3s"/><animate attributeName="opacity" values="0.9;0;0.9" dur="4s" repeatCount="indefinite" begin="3s"/></circle></g>
    <circle cx="100" cy="85" r="12" fill="#4dffc3" opacity="0.9"><animate attributeName="r" values="12;16;12" dur="4s" repeatCount="indefinite"/></circle>
    <text x="100" y="170" text-anchor="middle" font-family="serif" font-size="20" fill="#ffd700" opacity="0.8">4</text><text x="100" y="185" text-anchor="middle" font-family="serif" font-size="9" fill="#4dffc3" opacity="0.6">SECONDS</text></svg>`,
  10: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf10" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#c44dff"/><stop offset="50%" stop-color="#4dffc3"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
    <circle cx="100" cy="100" r="75" fill="none" stroke="url(#hf10)" stroke-width="4"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="12s" repeatCount="indefinite"/></circle>
    <g stroke="url(#hf10)" stroke-width="2"><line x1="100" y1="25" x2="100" y2="175"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="12s" repeatCount="indefinite"/></line><line x1="25" y1="100" x2="175" y2="100"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="12s" repeatCount="indefinite"/></line><line x1="47" y1="47" x2="153" y2="153"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="12s" repeatCount="indefinite"/></line><line x1="47" y1="153" x2="153" y2="47"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="12s" repeatCount="indefinite"/></line></g>
    <path d="M100,70 L130,100 L100,130 L70,100 Z" fill="none" stroke="url(#hf10)" stroke-width="2" opacity="0.8"><animate attributeName="d" values="M100,70 L130,100 L100,130 L70,100 Z;M85,85 L115,85 L115,115 L85,115 Z;M100,70 L130,100 L100,130 L70,100 Z" dur="3s" repeatCount="indefinite"/><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="-360 100 100" dur="6s" repeatCount="indefinite"/></path>
    <circle cx="100" cy="100" r="15" fill="url(#hf10)" opacity="0.7"/></svg>`,
  11: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf11" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#1a7a6c"/><stop offset="100%" stop-color="#4dffc3"/></linearGradient></defs>
    <line x1="100" y1="20" x2="100" y2="170" stroke="#d4af37" stroke-width="3"/>
    <line x1="30" y1="70" x2="170" y2="70" stroke="#d4af37" stroke-width="3"><animateTransform attributeName="transform" type="rotate" values="0 100 70;2 100 70;0 100 70;-2 100 70;0 100 70" dur="6s" repeatCount="indefinite"/></line>
    <g><animateTransform attributeName="transform" type="rotate" values="0 100 70;2 100 70;0 100 70;-2 100 70;0 100 70" dur="6s" repeatCount="indefinite"/><line x1="40" y1="70" x2="40" y2="100" stroke="#d4af37" stroke-width="2"/><path d="M20,100 Q40,115 60,100" fill="none" stroke="url(#hf11)" stroke-width="2"/><circle cx="40" cy="105" r="18" fill="url(#hf11)" opacity="0.3"/></g>
    <g><animateTransform attributeName="transform" type="rotate" values="0 100 70;2 100 70;0 100 70;-2 100 70;0 100 70" dur="6s" repeatCount="indefinite"/><line x1="160" y1="70" x2="160" y2="100" stroke="#d4af37" stroke-width="2"/><path d="M140,100 Q160,115 180,100" fill="none" stroke="url(#hf11)" stroke-width="2"/><circle cx="160" cy="105" r="18" fill="url(#hf11)" opacity="0.3"/></g>
    <polygon points="100,8 95,20 105,20" fill="#d4af37"/></svg>`,
  12: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf12" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="100%" stop-color="#c77dff"/></linearGradient></defs>
    <polygon points="100,165 40,40 160,40" fill="none" stroke="url(#hf12)" stroke-width="2.5" opacity="0.8"/>
    <line x1="30" y1="30" x2="170" y2="30" stroke="#8b5a2b" stroke-width="4"/><line x1="100" y1="30" x2="100" y2="60" stroke="#4a7023" stroke-width="2"/>
    <polygon points="100,135 60,55 140,55" fill="none" stroke="url(#hf12)" stroke-width="1.5" opacity="0.5"/><polygon points="100,105 75,70 125,70" fill="none" stroke="url(#hf12)" stroke-width="1" opacity="0.3"/>
    <g fill="#d4af37" opacity="0.8"><circle cx="70" cy="180" r="5"><animate attributeName="cy" values="180;125;180" dur="4s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.8;0.3;0.8" dur="4s" repeatCount="indefinite"/></circle><circle cx="100" cy="190" r="5"><animate attributeName="cy" values="190;135;190" dur="4.5s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.8;0.3;0.8" dur="4.5s" repeatCount="indefinite"/></circle><circle cx="130" cy="185" r="5"><animate attributeName="cy" values="185;130;185" dur="3.8s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.8;0.3;0.8" dur="3.8s" repeatCount="indefinite"/></circle></g>
    <circle cx="100" cy="165" r="15" fill="none" stroke="#ffd700" stroke-width="1.5" opacity="0.5"><animate attributeName="r" values="15;22;15" dur="3s" repeatCount="indefinite"/></circle></svg>`,
  13: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf13a" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#444"/><stop offset="100%" stop-color="#888"/></linearGradient><linearGradient id="hf13b" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#ff6b1a"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
    <polygon points="100,35 50,100 150,100" fill="none" stroke="url(#hf13a)" stroke-width="2" stroke-dasharray="8,4" opacity="0.5"><animate attributeName="stroke-dashoffset" from="0" to="24" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;0.2;0.5" dur="4s" repeatCount="indefinite"/></polygon>
    <polygon points="100,165 50,100 150,100" fill="none" stroke="url(#hf13a)" stroke-width="2" stroke-dasharray="8,4" opacity="0.5"><animate attributeName="stroke-dashoffset" from="0" to="-24" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;0.2;0.5" dur="4s" repeatCount="indefinite"/></polygon>
    <polygon points="100,45 55,105 145,105" fill="none" stroke="url(#hf13b)" stroke-width="2" opacity="0.8"><animate attributeName="points" values="100,45 55,105 145,105;100,35 50,100 150,100;100,45 55,105 145,105" dur="4s" repeatCount="indefinite"/></polygon>
    <polygon points="100,155 55,95 145,95" fill="none" stroke="url(#hf13b)" stroke-width="2" opacity="0.8"><animate attributeName="points" values="100,155 55,95 145,95;100,165 50,100 150,100;100,155 55,95 145,95" dur="4s" repeatCount="indefinite"/></polygon>
    <g fill="#666" opacity="0.4"><circle cx="60" cy="60" r="3"><animate attributeName="cy" values="60;200" dur="3s" repeatCount="indefinite"/></circle><circle cx="140" cy="70" r="3"><animate attributeName="cy" values="70;210" dur="3.5s" repeatCount="indefinite"/></circle><circle cx="100" cy="50" r="3"><animate attributeName="cy" values="50;190" dur="2.8s" repeatCount="indefinite"/></circle></g>
    <circle cx="100" cy="100" r="10" fill="#ffd700" opacity="0.7"><animate attributeName="r" values="10;15;10" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  14: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf14a" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="100%" stop-color="#c77dff"/></linearGradient><linearGradient id="hf14b" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#ff6b1a"/><stop offset="100%" stop-color="#ffd700"/></linearGradient><linearGradient id="hf14c" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1a7a6c"/><stop offset="100%" stop-color="#4dffc3"/></linearGradient></defs>
    <circle cx="35" cy="25" r="15" fill="url(#hf14a)" opacity="0.7"><animate attributeName="r" values="15;18;15" dur="2s" repeatCount="indefinite"/></circle>
    <circle cx="165" cy="25" r="15" fill="url(#hf14b)" opacity="0.7"><animate attributeName="r" values="15;18;15" dur="2s" repeatCount="indefinite" begin="0.5s"/></circle>
    <path d="M35,40 Q50,70 60,100 Q75,135 100,155" fill="none" stroke="url(#hf14a)" stroke-width="3" opacity="0.6" stroke-dasharray="8,4"><animate attributeName="stroke-dashoffset" from="0" to="-24" dur="1.5s" repeatCount="indefinite"/></path>
    <path d="M165,40 Q150,70 140,100 Q125,135 100,155" fill="none" stroke="url(#hf14b)" stroke-width="3" opacity="0.6" stroke-dasharray="8,4"><animate attributeName="stroke-dashoffset" from="0" to="-24" dur="1.5s" repeatCount="indefinite"/></path>
    <ellipse cx="100" cy="170" rx="55" ry="16" fill="url(#hf14c)" opacity="0.35"><animate attributeName="rx" values="55;62;55" dur="3s" repeatCount="indefinite"/></ellipse>
    <circle cx="100" cy="155" r="12" fill="url(#hf14c)" opacity="0.6"><animate attributeName="r" values="12;16;12" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  15: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf15" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#c41e1a"/><stop offset="100%" stop-color="#8b0000"/></linearGradient></defs>
    <path d="M100,60 L60,30 L50,50 L40,40 L55,70 L70,60 L100,80 L130,60 L145,70 L160,40 L150,50 L140,30 L100,60" fill="none" stroke="url(#hf15)" stroke-width="3" opacity="0.8"/>
    <path d="M50,95 Q60,105 60,120 Q60,135 50,145" fill="none" stroke="#d4af37" stroke-width="3" stroke-dasharray="8,4" opacity="0.6"><animate attributeName="stroke-dashoffset" from="0" to="24" dur="2s" repeatCount="indefinite"/></path>
    <path d="M150,95 Q140,105 140,120 Q140,135 150,145" fill="none" stroke="#d4af37" stroke-width="3" stroke-dasharray="8,4" opacity="0.6"><animate attributeName="stroke-dashoffset" from="0" to="24" dur="2s" repeatCount="indefinite"/></path>
    <circle cx="45" cy="170" r="12" fill="#1a7a6c" opacity="0.5"><animate attributeName="cy" values="170;175;170;165;170" dur="3s" repeatCount="indefinite"/></circle>
    <circle cx="155" cy="170" r="12" fill="#1a7a6c" opacity="0.5"><animate attributeName="cy" values="170;165;170;175;170" dur="3s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="95" r="8" fill="#ffd700" opacity="0.7"><animate attributeName="r" values="8;12;8" dur="1.5s" repeatCount="indefinite"/></circle></svg>`,
  16: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf16" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#3d2914"/><stop offset="100%" stop-color="#8b5a2b"/></linearGradient><filter id="tg"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <rect x="70" y="50" width="60" height="120" fill="none" stroke="url(#hf16)" stroke-width="3"/><rect x="90" y="70" width="20" height="25" fill="#0a0a15" stroke="url(#hf16)" stroke-width="1"/>
    <path d="M100,5 L82,35 L102,40 L70,80 L108,55 L88,50 L115,20" fill="#ffd700" filter="url(#tg)"><animate attributeName="opacity" values="1;0.2;1;0.5;1;0.3;1" dur="0.4s" repeatCount="indefinite"/></path>
    <g stroke="#ffd700" fill="none" filter="url(#tg)"><path d="M70,95 L88,110 L72,135 L92,155" stroke-width="2" opacity="0.8"><animate attributeName="stroke-width" values="2;4;2" dur="0.3s" repeatCount="indefinite"/></path><path d="M130,90 L112,107 L128,133 L108,153" stroke-width="2" opacity="0.8"><animate attributeName="stroke-width" values="2;4;2" dur="0.3s" repeatCount="indefinite" begin="0.15s"/></path></g>
    <circle cx="100" cy="110" r="12" fill="#ffd700" opacity="0.5"><animate attributeName="r" values="12;30;12" dur="0.8s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.5;0.1;0.5" dur="0.8s" repeatCount="indefinite"/></circle></svg>`,
  17: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf17" x1="50%" y1="0%" x2="50%" y2="100%"><stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#d4af37"/></linearGradient><filter id="sg"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <g fill="#ffd700">${Array.from({length:15},(_,i)=>{const x=15+(i*37)%170;const y=15+(i*23)%60;const r=1+(i%3)*0.5;return `<circle cx="${x}" cy="${y}" r="${r}" opacity="0.4"><animate attributeName="opacity" values="0.4;0.8;0.4" dur="${2+(i%5)*0.5}s" repeatCount="indefinite" begin="${i*0.2}s"/></circle>`;}).join('')}</g>
    <g stroke="#ffd700" stroke-width="2" stroke-linecap="round">${Array.from({length:16},(_,i)=>{const a=(i*22.5)*Math.PI/180;return `<line x1="${100+Math.cos(a)*25}" y1="${90+Math.sin(a)*25}" x2="${100+Math.cos(a)*60}" y2="${90+Math.sin(a)*60}" opacity="0.5"><animate attributeName="opacity" values="0.5;0.9;0.5" dur="${1.5+(i%4)*0.3}s" repeatCount="indefinite" begin="${i*0.1}s"/></line>`;}).join('')}</g>
    <g fill="url(#hf17)" filter="url(#sg)"><polygon points="100,30 105,75 100,65 95,75" opacity="0.9"/><polygon points="100,150 105,105 100,115 95,105" opacity="0.9"/><polygon points="35,90 80,95 70,90 80,85" opacity="0.9"/><polygon points="165,90 120,95 130,90 120,85" opacity="0.9"/></g>
    <ellipse cx="100" cy="90" rx="12" ry="14" fill="#d4af37"><animate attributeName="ry" values="14;18;14" dur="2s" repeatCount="indefinite"/></ellipse><ellipse cx="100" cy="82" rx="8" ry="4" fill="#8b5a2b"/>
    <circle cx="100" cy="90" r="6" fill="#fff" opacity="0.4"><animate attributeName="r" values="6;10;6" dur="2s" repeatCount="indefinite"/></circle></svg>`,
  18: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf18" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="100%" stop-color="#c44dff"/></linearGradient><filter id="mg"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <g filter="url(#mg)"><circle cx="100" cy="35" r="28" fill="#c0c0c0" opacity="0.9"><animate attributeName="opacity" values="0.9;0.7;0.9" dur="4s" repeatCount="indefinite"/></circle><circle cx="116" cy="30" r="24" fill="#0a0a15"/></g>
    <circle cx="87" cy="30" r="4" fill="#a0a0a0" opacity="0.4"/><circle cx="95" cy="45" r="3" fill="#a0a0a0" opacity="0.3"/>
    <g stroke="url(#hf18)" stroke-width="1.5" fill="none">${Array.from({length:17},(_,i)=>{const sa=-70+(i*140/16);const a=sa*Math.PI/180;const x2=100+Math.cos(a)*80;const y2=110+Math.sin(a)*70;const cx=100+Math.cos(a)*30;const cy=110+Math.sin(a)*20;const op=0.3+(i%3)*0.15;return `<path d="M100,75 Q${cx},${cy} ${x2},${y2}" stroke-dasharray="6,4" opacity="${op}"><animate attributeName="stroke-dashoffset" from="0" to="20" dur="${2+(i%5)*0.4}s" repeatCount="indefinite"/></path>`;}).join('')}</g>
    <circle cx="100" cy="95" r="10" fill="url(#hf18)" opacity="0.7"><animate attributeName="r" values="10;16;10" dur="2.5s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="95" r="5" fill="#c77dff" opacity="0.9"><animate attributeName="r" values="5;8;5" dur="2.5s" repeatCount="indefinite"/></circle></svg>`,
  19: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf19" x1="50%" y1="0%" x2="50%" y2="100%"><stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ff6b1a"/></linearGradient><filter id="sug"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <g stroke="url(#hf19)" stroke-width="2" stroke-linecap="round" opacity="0.6">${Array.from({length:20},(_,i)=>{const a=(i*18)*Math.PI/180;const iR=45;const oR=60+(i%3)*6;return `<line x1="${100+Math.cos(a)*iR}" y1="${80+Math.sin(a)*iR}" x2="${100+Math.cos(a)*oR}" y2="${80+Math.sin(a)*oR}"><animate attributeName="x2" values="${100+Math.cos(a)*oR};${100+Math.cos(a)*(oR+10)};${100+Math.cos(a)*oR}" dur="${1.2+(i%4)*0.25}s" repeatCount="indefinite"/><animate attributeName="y2" values="${80+Math.sin(a)*oR};${80+Math.sin(a)*(oR+10)};${80+Math.sin(a)*oR}" dur="${1.2+(i%4)*0.25}s" repeatCount="indefinite"/></line>`;}).join('')}</g>
    <circle cx="100" cy="80" r="38" fill="url(#hf19)" opacity="0.95" filter="url(#sug)"><animate attributeName="r" values="38;43;38" dur="2s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="80" r="28" fill="#ffd700"><animate attributeName="r" values="28;32;28" dur="2s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="80" r="16" fill="#fff" opacity="0.4"><animate attributeName="r" values="16;20;16" dur="2s" repeatCount="indefinite"/></circle>
    <g><circle cx="55" cy="160" r="12" fill="#9d4edd" opacity="0.6"><animate attributeName="cy" values="160;155;160;165;160" dur="2s" repeatCount="indefinite"/></circle><circle cx="100" cy="165" r="12" fill="#ff6b1a" opacity="0.6"><animate attributeName="cy" values="165;160;165;170;165" dur="2s" repeatCount="indefinite" begin="0.3s"/></circle><circle cx="145" cy="160" r="12" fill="#1a7a6c" opacity="0.6"><animate attributeName="cy" values="160;165;160;155;160" dur="2s" repeatCount="indefinite" begin="0.6s"/></circle></g>
    <path d="M55,160 Q100,135 145,160" fill="none" stroke="#ffd700" stroke-width="2" opacity="0.5"><animate attributeName="d" values="M55,160 Q100,135 145,160;M55,155 Q100,130 145,155;M55,160 Q100,135 145,160" dur="2s" repeatCount="indefinite"/></path>
    <text x="100" y="193" text-anchor="middle" font-family="serif" font-size="14" font-weight="bold" fill="#ff6b1a"><animate attributeName="opacity" values="0.8;1;0.8" dur="1s" repeatCount="indefinite"/>HONK</text></svg>`,
  20: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf20" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#ffd700"/><stop offset="50%" stop-color="#ff6b9d"/><stop offset="100%" stop-color="#c44dff"/></linearGradient><filter id="cg"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <circle cx="100" cy="25" r="30" fill="none" stroke="url(#hf20)" stroke-width="1" opacity="0.3"><animate attributeName="r" values="25;40;25" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="25" r="18" fill="url(#hf20)" opacity="0.85" filter="url(#cg)"><animate attributeName="r" values="18;24;18" dur="2s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="25" r="8" fill="#fff" opacity="0.6"><animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite"/></circle>
    <g stroke="url(#hf20)" stroke-width="2" fill="none"><path d="M100,43 Q65,75 50,110" stroke-dasharray="6,4" opacity="0.6"><animate attributeName="stroke-dashoffset" from="0" to="-20" dur="1.5s" repeatCount="indefinite"/></path><path d="M100,43 Q100,80 100,115" stroke-dasharray="6,4" opacity="0.7"><animate attributeName="stroke-dashoffset" from="0" to="-20" dur="1.5s" repeatCount="indefinite"/></path><path d="M100,43 Q135,75 150,110" stroke-dasharray="6,4" opacity="0.6"><animate attributeName="stroke-dashoffset" from="0" to="-20" dur="1.5s" repeatCount="indefinite"/></path></g>
    <line x1="20" y1="130" x2="180" y2="130" stroke="#d4af37" stroke-width="2" opacity="0.6"><animate attributeName="opacity" values="0.6;0.9;0.6" dur="2s" repeatCount="indefinite"/></line>
    <g fill="none" stroke-width="2.5"><polygon points="45,175 28,145 62,145" stroke="#9d4edd" opacity="0.85"><animate attributeName="points" values="45,175 28,145 62,145;45,145 28,115 62,115;45,175 28,145 62,145" dur="3s" repeatCount="indefinite"/></polygon><polygon points="100,185 83,155 117,155" stroke="#ff6b1a" opacity="0.85"><animate attributeName="points" values="100,185 83,155 117,155;100,150 83,120 117,120;100,185 83,155 117,155" dur="3.5s" repeatCount="indefinite" begin="0.2s"/></polygon><polygon points="155,175 138,145 172,145" stroke="#1a7a6c" opacity="0.85"><animate attributeName="points" values="155,175 138,145 172,145;155,150 138,120 172,120;155,175 138,145 172,145" dur="2.8s" repeatCount="indefinite" begin="0.4s"/></polygon></g></svg>`,
  21: () => `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="hf21" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="25%" stop-color="#ff6b1a"/><stop offset="50%" stop-color="#1a7a6c"/><stop offset="75%" stop-color="#ffd700"/><stop offset="100%" stop-color="#9d4edd"/></linearGradient><filter id="wg"><feGaussianBlur stdDeviation="1.5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
    <circle cx="100" cy="100" r="90" fill="none" stroke="url(#hf21)" stroke-width="1" opacity="0.2"><animate attributeName="r" values="90;95;90" dur="5s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="100" r="78" fill="none" stroke="url(#hf21)" stroke-width="4" filter="url(#wg)"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="25s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="100" r="68" fill="none" stroke="url(#hf21)" stroke-width="2" opacity="0.4" stroke-dasharray="12,6"><animateTransform attributeName="transform" type="rotate" from="360 100 100" to="0 100 100" dur="20s" repeatCount="indefinite"/></circle>
    <g><circle cx="100" cy="22" r="12" fill="none" stroke="#9d4edd" stroke-width="2.5"><animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite"/></circle><circle cx="100" cy="22" r="6" fill="#9d4edd" opacity="0.5"/><circle cx="100" cy="178" r="12" fill="none" stroke="#ff6b1a" stroke-width="2.5"><animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite" begin="0.5s"/></circle><circle cx="100" cy="178" r="6" fill="#ff6b1a" opacity="0.5"/><circle cx="22" cy="100" r="12" fill="none" stroke="#1a7a6c" stroke-width="2.5"><animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite" begin="1s"/></circle><circle cx="22" cy="100" r="6" fill="#1a7a6c" opacity="0.5"/><circle cx="178" cy="100" r="12" fill="none" stroke="#4a7023" stroke-width="2.5"><animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite" begin="1.5s"/></circle><circle cx="178" cy="100" r="6" fill="#4a7023" opacity="0.5"/></g>
    <g fill="none" stroke-width="2" opacity="0.7"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="15s" repeatCount="indefinite"/><circle cx="100" cy="78" r="24" stroke="#9d4edd"/><circle cx="79" cy="115" r="24" stroke="#ff6b1a"/><circle cx="121" cy="115" r="24" stroke="#1a7a6c"/></g>
    <g stroke="#d4af37" stroke-width="1" opacity="0.3"><line x1="100" y1="35" x2="100" y2="165"/><line x1="35" y1="100" x2="165" y2="100"/></g>
    <circle cx="100" cy="100" r="16" fill="#ffd700" opacity="0.8"><animate attributeName="r" values="16;20;16" dur="2.5s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="100" r="10" fill="#fff" opacity="0.5"><animate attributeName="r" values="10;13;10" dur="2.5s" repeatCount="indefinite"/></circle>
    <circle cx="100" cy="100" r="5" fill="#ffd700" opacity="0.9"/></svg>`
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HONKFIRE MINOR ARCANA SUIT SVG GENERATORS
// Animated sacred geometry for each of the four suits
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HONKFIRE_SUIT_SVG = {
  // SCATTER (ğŸ¿ï¸ Squirrel) - Ï„-dimension, Probability, Purple
  // Acorns scattering across dimensions, quantum uncertainty visualization
  scatter: (rank) => {
    const n = parseInt(rank) || (['A','P','N','Q','K'].indexOf(rank) >= 0 ? {'A':1,'P':11,'N':12,'Q':13,'K':14}[rank] : 5);
    return `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="hfsc" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#9d4edd"/><stop offset="100%" stop-color="#c77dff"/></linearGradient></defs>
      <g stroke="url(#hfsc)" stroke-width="1" fill="none" opacity="0.4">${Array.from({length:Math.min(n,10)},(_,i)=>{const a=(i*360/Math.min(n,10))*Math.PI/180;const r=30+Math.random()*40;return `<circle cx="${100+Math.cos(a)*r}" cy="${100+Math.sin(a)*r}" r="${8+i%3*4}"><animate attributeName="r" values="${8+i%3*4};${12+i%3*4};${8+i%3*4}" dur="${2+i*0.3}s" repeatCount="indefinite"/></circle>`;}).join('')}</g>
      <g fill="#c77dff" opacity="0.6">${Array.from({length:Math.min(n+2,12)},(_,i)=>{const a=(i*137.5)*Math.PI/180;const r=20+i*5;return `<circle cx="${100+Math.cos(a)*r}" cy="${100+Math.sin(a)*r}" r="3"><animate attributeName="opacity" values="0.6;0.2;0.6" dur="${1.5+i*0.2}s" repeatCount="indefinite"/></circle>`;}).join('')}</g>
      <circle cx="100" cy="100" r="15" fill="none" stroke="url(#hfsc)" stroke-width="2" stroke-dasharray="4,4"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="8s" repeatCount="indefinite"/></circle>
      <text x="100" y="108" text-anchor="middle" font-size="28">ğŸ¿ï¸</text>
    </svg>`;
  },
  
  // FLAMES (ğŸ”¥ Goose) - Î±-dimension, Will, Orange  
  // Rising flames, forward-only motion, eternal advance
  flames: (rank) => {
    const n = parseInt(rank) || (['A','P','N','Q','K'].indexOf(rank) >= 0 ? {'A':1,'P':11,'N':12,'Q':13,'K':14}[rank] : 5);
    return `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="hffl" x1="0%" y1="100%" x2="0%" y2="0%"><stop offset="0%" stop-color="#c41e1a"/><stop offset="50%" stop-color="#ff6b1a"/><stop offset="100%" stop-color="#ffd700"/></linearGradient></defs>
      <g fill="url(#hffl)" opacity="0.6">${Array.from({length:Math.min(n,8)},(_,i)=>{const x=40+i*15;const h=40+i*8;return `<path d="M${x},180 Q${x-10},${180-h/2} ${x},${180-h} Q${x+10},${180-h/2} ${x},180"><animate attributeName="d" values="M${x},180 Q${x-10},${180-h/2} ${x},${180-h} Q${x+10},${180-h/2} ${x},180;M${x},180 Q${x-15},${180-h/2-10} ${x},${180-h-15} Q${x+15},${180-h/2-10} ${x},180;M${x},180 Q${x-10},${180-h/2} ${x},${180-h} Q${x+10},${180-h/2} ${x},180" dur="${1+i*0.2}s" repeatCount="indefinite"/></path>`;}).join('')}</g>
      <g fill="#ffd700" opacity="0.8">${Array.from({length:Math.min(n,6)},(_,i)=>`<circle cx="${60+i*20}" cy="${150-i*10}" r="2"><animate attributeName="cy" values="${150-i*10};${50-i*5};${150-i*10}" dur="${2+i*0.3}s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.8;0;0.8" dur="${2+i*0.3}s" repeatCount="indefinite"/></circle>`).join('')}</g>
      <text x="100" y="70" text-anchor="middle" font-size="32">ğŸ”¥</text>
      <text x="100" y="195" text-anchor="middle" font-family="serif" font-size="10" fill="#ffd700" opacity="0.7">HONK</text>
    </svg>`;
  },
  
  // STILLNESS (ğŸ¦† Duck) - Î½-dimension, Truth, Teal
  // Concentric ripples, calm surface, eigenstate equilibrium
  stillness: (rank) => {
    const n = parseInt(rank) || (['A','P','N','Q','K'].indexOf(rank) >= 0 ? {'A':1,'P':11,'N':12,'Q':13,'K':14}[rank] : 5);
    return `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="hfst" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1a7a6c"/><stop offset="100%" stop-color="#4dffc3"/></linearGradient></defs>
      <ellipse cx="100" cy="160" rx="80" ry="20" fill="url(#hfst)" opacity="0.2"/>
      <g fill="none" stroke="url(#hfst)" stroke-width="1">${Array.from({length:Math.min(n,7)},(_,i)=>`<ellipse cx="100" cy="160" rx="${20+i*12}" ry="${5+i*3}" opacity="${0.6-i*0.06}"><animate attributeName="rx" values="${20+i*12};${25+i*12};${20+i*12}" dur="${3+i*0.5}s" repeatCount="indefinite"/></ellipse>`).join('')}</g>
      <text x="100" y="110" text-anchor="middle" font-size="36">ğŸ¦†</text>
      <circle cx="100" cy="100" r="40" fill="none" stroke="url(#hfst)" stroke-width="0.5" opacity="0.3"><animate attributeName="r" values="40;45;40" dur="4s" repeatCount="indefinite"/></circle>
    </svg>`;
  },
  
  // STARS (ğŸ¦Š Fox) - Îµ-dimension, Navigation, Blue
  // Deep starfield with constellation paths, shrine guidance, fixed point navigation
  stars: (rank) => {
    const n = parseInt(rank) || (['A','P','N','Q','K'].indexOf(rank) >= 0 ? {'A':1,'P':11,'N':12,'Q':13,'K':14}[rank] : 5);
    // Generate deterministic star positions based on rank for consistency
    const starCount = Math.min(n * 4, 32);
    const stars = Array.from({length: starCount}, (_, i) => {
      const seed = (i * 137.5 + n * 17) % 360;
      const x = 15 + (seed * 7.3) % 170;
      const y = 15 + (seed * 3.7) % 140;
      const r = i % 5 === 0 ? 3 : i % 3 === 0 ? 2.5 : 1.5; // Varied star sizes
      const brightness = i % 4 === 0 ? 1 : 0.85; // Some stars brighter
      const dur = 1.5 + (i % 7) * 0.4;
      return `<circle cx="${x}" cy="${y}" r="${r}" fill="#fff" opacity="${brightness}"><animate attributeName="opacity" values="${brightness};${brightness*0.5};${brightness}" dur="${dur}s" repeatCount="indefinite" begin="${i*0.15}s"/></circle><circle cx="${x}" cy="${y}" r="${r*2}" fill="#4a9eff" opacity="0.3" filter="url(#starglow)"><animate attributeName="opacity" values="0.3;0.5;0.3" dur="${dur}s" repeatCount="indefinite" begin="${i*0.15}s"/></circle>`;
    }).join('');
    // Constellation lines connecting some stars
    const constellations = Array.from({length: Math.min(n, 5)}, (_, i) => {
      const a1 = (i * 72) * Math.PI / 180;
      const a2 = ((i + 1) * 72) * Math.PI / 180;
      const r1 = 35 + i * 8;
      const r2 = 40 + i * 6;
      return `<line x1="${100 + Math.cos(a1) * r1}" y1="${100 + Math.sin(a1) * r1}" x2="${100 + Math.cos(a2) * r2}" y2="${100 + Math.sin(a2) * r2}" stroke="#4a9eff" stroke-width="0.5" opacity="0.4"/>`;
    }).join('');
    return `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="starglow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        <radialGradient id="hfnebula" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#4a9eff" stop-opacity="0.15"/><stop offset="100%" stop-color="#1a1a2e" stop-opacity="0"/></radialGradient>
      </defs>
      <rect x="0" y="0" width="200" height="200" fill="url(#hfnebula)"/>
      ${stars}
      ${constellations}
      <g stroke="#4a9eff" stroke-width="1" fill="none" opacity="0.6">${Array.from({length: Math.min(n, 6)}, (_, i) => {const a = (i * 60) * Math.PI / 180; return `<line x1="100" y1="100" x2="${100 + Math.cos(a) * 55}" y2="${100 + Math.sin(a) * 55}" stroke-dasharray="2,6"><animate attributeName="stroke-dashoffset" from="0" to="16" dur="${3 + i * 0.2}s" repeatCount="indefinite"/></line>`;}).join('')}</g>
      <circle cx="100" cy="100" r="18" fill="none" stroke="#4a9eff" stroke-width="0.5" opacity="0.3"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="30s" repeatCount="indefinite"/></circle>
      <text x="100" y="108" text-anchor="middle" font-size="28">ğŸ¦Š</text>
      <circle cx="100" cy="100" r="6" fill="#ffd700" opacity="1"><animate attributeName="r" values="6;9;6" dur="2.5s" repeatCount="indefinite"/></circle>
      <circle cx="100" cy="100" r="12" fill="#ffd700" opacity="0.3" filter="url(#starglow)"><animate attributeName="r" values="12;18;12" dur="2.5s" repeatCount="indefinite"/></circle>
    </svg>`;
  }
};

// Echo state constants (Ï†â»â´ probability threshold)
const ECHO_PROBABILITY = 0.146; // Ï†â»â´ â‰ˆ 14.6%
const ECHO_COLOR = '#ff66cc';

// Check if a card should be echoed (for readings)
function isCardEchoed(card) {
  return card.echoed === true;
}

// Toggle echo state on a card
function toggleEchoState(cardIdx) {
  if (state.cards[cardIdx]) {
    state.cards[cardIdx].echoed = !state.cards[cardIdx].echoed;
    renderCards();
    buildControlPanel();
  }
}

// Apply echo at Ï†â»â´ probability to all cards
function applyRandomEcho() {
  state.cards.forEach(card => {
    card.echoed = Math.random() < ECHO_PROBABILITY;
  });
  renderCards();
  buildControlPanel();
  const echoedCount = state.cards.filter(c => c.echoed).length;
  console.log(`ğŸŒ‘ Echo applied: ${echoedCount}/${state.cards.length} cards echoed (expected ~${Math.round(state.cards.length * ECHO_PROBABILITY)})`);
}

// Clear all echo states
function clearAllEcho() {
  state.cards.forEach(card => {
    card.echoed = false;
  });
  renderCards();
  buildControlPanel();
}

// Toggle echo on selected cards
function toggleSelectedEcho() {
  if (state.selectedCards.length === 0) return;
  // If any selected card is not echoed, echo all; otherwise clear all
  const anyNotEchoed = state.selectedCards.some(idx => !state.cards[idx]?.echoed);
  state.selectedCards.forEach(idx => {
    if (state.cards[idx]) {
      state.cards[idx].echoed = anyNotEchoed;
    }
  });
  renderCards();
  buildControlPanel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD SVG GENERATORS - Accept explicit config overrides for live preview
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateFrontSVG(card, idx, overrideCfg, scale) {
  // Merge: overrideCfg > card.cfg > global defaults
  const cfg = overrideCfg || card.cfg || {};
  const themeKey = cfg.frontTheme || state.frontTheme;
  const theme = FRONT_THEMES[themeKey];
  const cardColor = cfg.color || card.color || theme.borderColor;
  const patColor = cfg.patternColor || theme.patternColor;
  const pattern = cfg.pattern || theme.pattern;
  const glow = cfg.glow !== undefined && cfg.glow !== null && cfg.glow !== '' ? cfg.glow : state.glow;
  const opacity = cfg.opacity !== undefined ? cfg.opacity : state.opacity;
  const fgPreset = cfg.frameGlow || state.frameGlow;
  const fgIntensity = cfg.frameGlowIntensity !== undefined ? cfg.frameGlowIntensity : state.frameGlowIntensity;
  const fThickness = cfg.frameThickness !== undefined ? cfg.frameThickness : state.frameThickness;
  const fgC1 = cfg.frameGlowColor1 || state.frameGlowColor1;
  const fgC2 = cfg.frameGlowColor2 || state.frameGlowColor2;
  
  // Sheen overlay settings
  const sheenColor = cfg.sheenColor || state.sheenColor || '#ffffff';
  const sheenOpacity = cfg.sheenOpacity !== undefined ? cfg.sheenOpacity : (state.sheenOpacity !== undefined ? state.sheenOpacity : 0);
  const sheenAngle = cfg.sheenAngle !== undefined ? cfg.sheenAngle : (state.sheenAngle !== undefined ? state.sheenAngle : 135);
  
  // Dimensions - scale parameter allows for grid (small) vs preview (large)
  const W = 140, H = card.type.includes('tarot') ? 238 : 196;
  const displayW = scale ? Math.round(W * scale) : W;
  const displayH = scale ? Math.round(H * scale) : H;
  const textColor = theme.textDark ? '#2d2418' : '#f0ebe0';
  const fg = getFrameGlowColors(fgPreset, cardColor, fgIntensity, fgC1, fgC2);
  
  // Symbol override - check cfg.symbol FIRST
  let cardSymbol;
  if (cfg.symbol && cfg.symbol !== '') {
    cardSymbol = cfg.symbol;
  } else if (card.type === 'classic') {
    cardSymbol = CLASSIC_SUITS[card.suit].symbol;
  } else if (card.type === 'guardian') {
    cardSymbol = card.symbol || GUARDIANS[card.guardian]?.symbol || 'â—';
  } else if (card.type === 'division') {
    // Division cards use structure unicode as symbol
    cardSymbol = card.structureUnicode || card.divisionUnicode || 'â—‡';
  } else {
    cardSymbol = card.type === 'tarot-major' ? 'âœ§' : getSuitSymbol(card.suit);
  }
  
  const isTxt = isTextSymbol(cardSymbol);
  let content = '';
  
  if (card.type === 'classic') {
    const suit = CLASSIC_SUITS[card.suit];
    // Support all 3 glyph positions:
    // - DIV â†’ rank override (top position) - 40% opacity with glow
    // - STR â†’ corner symbol (below rank/DIV) - 20% opacity with glow
    // - CTR â†’ center symbol
    const originalCornerSymbol = suit.symbol;
    const divSymbol = cfg.divisionUnicode || null; // If set, replaces rank display
    const cornerSymbol = cfg.structureUnicode || originalCornerSymbol;
    const centerSymbol = cardSymbol; // cardSymbol already handles cfg.symbol override
    const cornerIsTxt = isTextSymbol(cornerSymbol);
    // For SVG symbols, replace currentColor with actual color
    const coloredCornerSvg = typeof cornerSymbol === 'string' && cornerSymbol.includes('currentColor') 
      ? cornerSymbol.replace(/currentColor/g, cardColor) 
      : cornerSymbol;
    // DIV: 40% opacity, STR: 20% opacity - both with subtle glow
    const divOpacity = divSymbol ? '0.4' : '1';
    const strOpacity = '0.2';
    // Top-left corner elements
    const divTL = divSymbol 
      ? `<text x="12" y="22" font-size="14" fill="${cardColor}" opacity="${divOpacity}" filter="url(#glow${idx})">${divSymbol}</text>` 
      : `<text x="12" y="22" font-family="Cinzel,serif" font-size="14" fill="${cardColor}" font-weight="bold">${card.rank}</text>`;
    const strTL = cornerIsTxt 
      ? `<text x="12" y="38" font-size="12" fill="${cardColor}" opacity="${strOpacity}" filter="url(#glow${idx})">${cornerSymbol}</text>` 
      : `<g transform="translate(10,26)" opacity="${strOpacity}" filter="url(#glow${idx})"><svg viewBox="0 0 24 24" width="14" height="14">${coloredCornerSvg}</svg></g>`;
    // Bottom-right corner elements (mirrored positions)
    const divBR = divSymbol 
      ? `<text x="${W-12}" y="${H-22+14}" font-size="14" fill="${cardColor}" opacity="${divOpacity}" filter="url(#glow${idx})" text-anchor="end">${divSymbol}</text>` 
      : `<text x="${W-12}" y="${H-22+14}" font-family="Cinzel,serif" font-size="14" fill="${cardColor}" font-weight="bold" text-anchor="end" transform="rotate(180 ${W-12} ${H-22+7})">${card.rank}</text>`;
    const strBR = cornerIsTxt 
      ? `<text x="${W-12}" y="${H-38+14}" font-size="12" fill="${cardColor}" opacity="${strOpacity}" filter="url(#glow${idx})" text-anchor="end">${cornerSymbol}</text>` 
      : `<g transform="translate(${W-24},${H-52})" opacity="${strOpacity}" filter="url(#glow${idx})"><svg viewBox="0 0 24 24" width="14" height="14">${coloredCornerSvg}</svg></g>`;
    content = `
      ${state.showRank ? `${divTL}${strTL}${divBR}${strBR}` : ''}
      <text x="${W/2}" y="${H/2+8}" text-anchor="middle" font-size="36" fill="${cardColor}" filter="url(#glow${idx})">${isTxt ? centerSymbol : ''}</text>
      ${!isTxt ? `<g transform="translate(${W/2-18},${H/2-18})"><svg viewBox="0 0 24 24" width="36" height="36" filter="url(#glow${idx})">${typeof centerSymbol === 'string' && centerSymbol.includes('currentColor') ? centerSymbol.replace(/currentColor/g, cardColor) : `<text x="12" y="18" text-anchor="middle" font-size="20" fill="${cardColor}">${centerSymbol}</text>`}</svg></g>` : ''}
      ${state.showName ? `<rect x="12" y="${H-26}" width="${W-24}" height="16" rx="3" fill="${adjustColor(theme.bg1,-20)}" opacity="0.9"/><text x="${W/2}" y="${H-14}" text-anchor="middle" font-family="Cinzel,serif" font-size="8" fill="${textColor}" font-weight="600">${(cfg.frontName || suit.name).toUpperCase()}</text>` : ''}
    `;
  } else if (card.type === 'guardian') {
    const g = GUARDIANS[card.guardian] || {};
    // Support all 3 glyph positions:
    // - DIV â†’ rank override (top position) - 40% opacity with glow
    // - STR â†’ corner symbol - 20% opacity with glow
    // - CTR â†’ center symbol
    const originalCornerSymbol = card.symbol || g.symbol || 'â—';
    const divSymbol = cfg.divisionUnicode || null;
    const cornerSymbol = cfg.structureUnicode || originalCornerSymbol;
    const centerSymbol = cardSymbol;
    // DIV: 40% opacity, STR: 20% opacity - both with subtle glow
    const divOpacity = divSymbol ? '0.4' : '1';
    const strOpacity = '0.2';
    // Top-left corner elements
    const divTL = divSymbol 
      ? `<text x="12" y="20" font-size="12" fill="${cardColor}" opacity="${divOpacity}" filter="url(#glow${idx})">${divSymbol}</text>` 
      : `<text x="12" y="20" font-family="Orbitron,sans-serif" font-size="11" fill="${cardColor}" font-weight="bold">${card.rank}</text>`;
    const strTL = `<text x="12" y="35" font-size="12" fill="${cardColor}" opacity="${strOpacity}" filter="url(#glow${idx})">${cornerSymbol}</text>`;
    // Bottom-right corner elements
    const divBR = divSymbol 
      ? `<text x="${W-12}" y="${H-20+12}" font-size="12" fill="${cardColor}" opacity="${divOpacity}" filter="url(#glow${idx})" text-anchor="end">${divSymbol}</text>` 
      : `<text x="${W-12}" y="${H-20+12}" font-family="Orbitron,sans-serif" font-size="11" fill="${cardColor}" font-weight="bold" text-anchor="end" transform="rotate(180 ${W-12} ${H-20+6})">${card.rank}</text>`;
    const strBR = `<text x="${W-12}" y="${H-35+12}" font-size="12" fill="${cardColor}" opacity="${strOpacity}" filter="url(#glow${idx})" text-anchor="end">${cornerSymbol}</text>`;
    content = `
      ${state.showRank ? `${divTL}${strTL}${divBR}${strBR}` : ''}
      <text x="${W/2}" y="${H/2+10}" text-anchor="middle" font-size="40" fill="${cardColor}" filter="url(#glow${idx})">${centerSymbol}</text>
      ${state.showName ? `<rect x="10" y="${H-38}" width="${W-20}" height="28" rx="3" fill="${adjustColor(theme.bg1,-20)}" opacity="0.9"/><text x="${W/2}" y="${H-24}" text-anchor="middle" font-family="Cinzel,serif" font-size="8" fill="${textColor}" font-weight="600">${cfg.frontName || card.name}</text><text x="${W/2}" y="${H-13}" text-anchor="middle" font-family="Space Mono,monospace" font-size="6" fill="${cardColor}" opacity="0.8">${g.name}</text>` : ''}
    `;
  } else if (card.type === 'division') {
    // Division cards - custom suit rendering
    // Use cfg overrides if provided, otherwise fall back to card values
    // DIV: 40% opacity, STR: 20% opacity - both with subtle glow
    const divSymbol = cfg.divisionUnicode || card.divisionUnicode || 'â—‡';
    const structSymbol = cfg.structureUnicode || card.structureUnicode || 'â—†';
    const centerSymbol = (cfg.symbol && cfg.symbol !== '') ? cfg.symbol : structSymbol;
    // Top-left corner elements
    const divTL = `<text x="12" y="22" font-family="Orbitron,sans-serif" font-size="10" fill="${cardColor}" opacity="0.4" filter="url(#glow${idx})">${divSymbol}</text>`;
    const strTL = `<text x="12" y="36" font-size="14" fill="${cardColor}" opacity="0.2" filter="url(#glow${idx})">${structSymbol}</text>`;
    // Bottom-right corner elements
    const divBR = `<text x="${W-12}" y="${H-22+12}" font-family="Orbitron,sans-serif" font-size="10" fill="${cardColor}" opacity="0.4" filter="url(#glow${idx})" text-anchor="end">${divSymbol}</text>`;
    const strBR = `<text x="${W-12}" y="${H-36+12}" font-size="14" fill="${cardColor}" opacity="0.2" filter="url(#glow${idx})" text-anchor="end">${structSymbol}</text>`;
    content = `
      ${state.showRank ? `${divTL}${strTL}${divBR}${strBR}` : ''}
      <text x="${W/2}" y="${H/2+10}" text-anchor="middle" font-size="42" fill="${cardColor}" filter="url(#glow${idx})">${centerSymbol}</text>
      ${state.showName ? `<rect x="10" y="${H-40}" width="${W-20}" height="32" rx="3" fill="${adjustColor(theme.bg1,-20)}" opacity="0.9"/><text x="${W/2}" y="${H-26}" text-anchor="middle" font-family="Cinzel,serif" font-size="8" fill="${textColor}" font-weight="600">${truncate(cfg.frontName || card.structure || 'Structure', 14)}</text><text x="${W/2}" y="${H-14}" text-anchor="middle" font-family="Space Mono,monospace" font-size="7" fill="${cardColor}" opacity="0.8">${truncate(card.division || 'Division', 16)}</text>` : ''}
    `;
  } else {
    const isMajor = card.type === 'tarot-major';
    const isHonkfire = card.preset === 'honkfire';
    const isEchoed = card.echoed === true;
    
    // Determine border color - Echo uses pink
    const borderCol = isEchoed ? ECHO_COLOR : cardColor;
    
    // For HonkFire cards, use animated SVG illustrations
    let centerContent = '';
    if (isHonkfire) {
      if (isMajor && HONKFIRE_SVG[card.id]) {
        // Major arcana: use the specific card SVG
        const svgContent = HONKFIRE_SVG[card.id]();
        const innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
        centerContent = `<g transform="translate(16, 42) scale(0.54)">${innerSvg}</g>`;
      } else if (!isMajor && card.entity && HONKFIRE_SUIT_SVG[card.entity === 'squirrel' ? 'scatter' : card.entity === 'goose' ? 'flames' : card.entity === 'duck' ? 'stillness' : card.entity === 'fox' ? 'stars' : null]) {
        // Minor arcana: use suit SVG based on entity
        const suitKey = card.entity === 'squirrel' ? 'scatter' : card.entity === 'goose' ? 'flames' : card.entity === 'duck' ? 'stillness' : 'stars';
        const svgContent = HONKFIRE_SUIT_SVG[suitKey](card.rank);
        const innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
        centerContent = `<g transform="translate(16, 42) scale(0.54)">${innerSvg}</g>`;
      } else {
        centerContent = `<text x="${W/2}" y="115" text-anchor="middle" font-size="${isMajor ? 32 : 26}" fill="${borderCol}" filter="url(#glow${idx})">${cardSymbol}</text>`;
      }
    } else {
      // Standard symbol display
      centerContent = `<text x="${W/2}" y="115" text-anchor="middle" font-size="${isMajor ? 32 : 26}" fill="${cardColor}" filter="url(#glow${idx})">${cardSymbol}</text>`;
    }
    
    // For HonkFire cards, show greek notation and entity symbol
    const subtitle = isHonkfire && isMajor && card.greek 
      ? `${card.greek} Â· ${card.subtitle}` 
      : isHonkfire && !isMajor && card.greek
      ? `${card.greek} Â· ${card.keyword || card.element || ''}`
      : (isMajor ? card.subtitle : (card.element || ''));
    
    // Echo badge for echoed cards
    const echoBadge = isEchoed ? `<rect x="${W-38}" y="6" width="32" height="12" rx="2" fill="${ECHO_COLOR}" opacity="0.9"/><text x="${W-22}" y="15" text-anchor="middle" font-size="6" fill="#0a0a0f" font-weight="bold">ğŸŒ‘ ECHO</text>` : '';
    
    content = `
      ${state.showRank ? `<text x="${W/2}" y="26" text-anchor="middle" font-family="Cinzel Decorative,serif" font-size="12" fill="${borderCol}" font-weight="bold">${isMajor ? card.numeral : card.rank}</text>` : ''}
      <rect x="16" y="46" width="${W-32}" height="115" rx="3" fill="none" stroke="${borderCol}" stroke-width="1" opacity="0.5"/>
      ${centerContent}
      ${echoBadge}
      ${state.showName ? `<rect x="10" y="${H-48}" width="${W-20}" height="38" rx="3" fill="${adjustColor(theme.bg1,-20)}" opacity="0.9"/><text x="${W/2}" y="${H-32}" text-anchor="middle" font-family="Cinzel,serif" font-size="7" fill="${isEchoed ? ECHO_COLOR : textColor}" font-weight="600">${truncate(isMajor ? card.title : card.name,18)}</text><text x="${W/2}" y="${H-20}" text-anchor="middle" font-family="EB Garamond,serif" font-size="6" fill="${borderCol}" font-style="italic">${truncate(subtitle,24)}</text>` : ''}
    `;
  }
  
  // Calculate sheen gradient direction based on angle
  const sheenRad = (sheenAngle * Math.PI) / 180;
  const sheenX2 = Math.round(50 + 50 * Math.cos(sheenRad));
  const sheenY2 = Math.round(50 + 50 * Math.sin(sheenRad));
  const sheenGradient = sheenOpacity > 0 ? `<linearGradient id="sheen${idx}" x1="0%" y1="0%" x2="${sheenX2}%" y2="${sheenY2}%"><stop offset="0%" stop-color="${sheenColor}" stop-opacity="${sheenOpacity}"/><stop offset="50%" stop-color="${sheenColor}" stop-opacity="${sheenOpacity * 0.3}"/><stop offset="100%" stop-color="${sheenColor}" stop-opacity="0"/></linearGradient>` : '';
  const sheenRect = sheenOpacity > 0 ? `<rect x="0" y="0" width="${W}" height="${H}" rx="6" fill="url(#sheen${idx})"/>` : '';
  
  // Only render pattern rect if pattern exists (not 'none')
  const hasPattern = pattern && pattern !== 'none';
  const patternDef = hasPattern ? genPattern(pattern, `pat${idx}`, patColor) : '';
  const patternRect = hasPattern ? `<rect x="0" y="0" width="${W}" height="${H}" rx="6" fill="url(#pat${idx})" opacity="${opacity}"/>` : '';
  
  // Only apply chroma cycle override for main grid cards (not editor preview idx 9000+)
  // Also skip if card has its own frameGlow setting
  const cycleActive = state.animMode === 'cycle' && idx < 9000 && !cfg.frameGlow;
  const fgColors = cycleActive ? { c1: state.deckColors[0], c2: state.deckColors[1], blur: fg.blur || 5 } : fg;
  
  return `<svg class="card-svg ${card.type.includes('tarot') ? 'tarot' : 'playing'}" width="${displayW}" height="${displayH}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="bg${idx}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="${theme.bg1}"/><stop offset="100%" stop-color="${theme.bg2}"/></linearGradient>${patternDef}${genCenterGlow(`glow${idx}`, glow, cardColor)}${genFrameGlowFilter(`fglow${idx}`, fgColors.c1, fgColors.c2, fgColors.blur)}<linearGradient id="bdr${idx}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="${fgColors.c1}"/><stop offset="100%" stop-color="${fgColors.c2}"/></linearGradient>${sheenGradient}</defs><rect x="0" y="0" width="${W}" height="${H}" rx="6" fill="url(#bg${idx})"/>${patternRect}${sheenRect}<rect x="4" y="4" width="${W-8}" height="${H-8}" rx="4" fill="none" stroke="url(#bdr${idx})" stroke-width="${fThickness}" ${fgColors.blur > 0 ? `filter="url(#fglow${idx})"` : ''}/>${content}</svg>`;
}

function getSuitSymbol(suit) { return { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ’§', fox: 'â­', echo: 'âš¡' }[suit] || 'â—‡'; }

function generateBackSVG(card, idx, overrideCfg, scale) {
  const cfg = overrideCfg || card.backCfg || {};
  const layoutKey = cfg.layout || state.backLayout;
  const layout = BACK_LAYOUTS[layoutKey];
  const themeKey = cfg.theme || state.backTheme;
  const theme = BACK_THEMES[themeKey];
  
  const W = 140, H = card.type.includes('tarot') ? 238 : 196;
  const displayW = scale ? Math.round(W * scale) : W;
  const displayH = scale ? Math.round(H * scale) : H;
  const bg1 = cfg.bg1 || theme.bg1;
  const bg2 = cfg.bg2 || theme.bg2;
  const borderColor = cfg.borderColor || theme.borderColor;
  const textMain = cfg.textMain || theme.textMain;
  const textMuted = cfg.textMuted || theme.textMuted;
  const accent = cfg.accent || card.color || theme.accent;
  const frameThickness = cfg.frameThickness !== undefined ? cfg.frameThickness : 1;
  const frameGlowIntensity = cfg.frameGlowIntensity !== undefined ? cfg.frameGlowIntensity : 0;
  
  // Lore field - single text that auto-wraps
  const customTitle = cfg.customTitle || '';
  const titleSize = cfg.titleSize !== undefined ? cfg.titleSize : 7;
  const loreText = cfg.lore || '';
  const loreSize = cfg.loreSize !== undefined ? cfg.loreSize : 5;
  const loreFont = cfg.loreFont || 'garamond';
  const loreBold = cfg.loreBold || false;
  const loreItalic = cfg.loreItalic !== undefined ? cfg.loreItalic : true;
  const loreColor = cfg.loreColor || textMuted;
  const bgOpacity = cfg.bgOpacity !== undefined ? cfg.bgOpacity : 1;
  const customFooter = cfg.customFooter || '';
  
  // Font family mapping
  const LORE_FONTS = {
    garamond: 'EB Garamond,serif',
    cinzel: 'Cinzel,serif',
    mono: 'Space Mono,monospace'
  };
  
  let metrics = '', lore = '';
  
  // Get default lore text based on card type
  let defaultTitle = '', defaultLore = '';
  if (card.type === 'classic') {
    const suit = CLASSIC_SUITS[card.suit];
    const rankInfo = RANK_MEANINGS[card.rank];
    defaultTitle = rankInfo.title;
    defaultLore = rankInfo.meaning;
  } else if (card.type === 'guardian') {
    const g = GUARDIANS[card.guardian] || {};
    defaultTitle = g.name || card.name || 'Guardian';
    defaultLore = g.function || '';
  } else if (card.type === 'tarot-major') {
    defaultTitle = card.subtitle;
    defaultLore = card.keyword;
  }
  
  if (card.type === 'classic') {
    const suit = CLASSIC_SUITS[card.suit];
    const val = RANK_VALUES[card.rank];
    if (layout.showMetrics) {
      metrics = `<text x="${W/2}" y="68" text-anchor="middle" font-family="Space Mono,monospace" font-size="5" fill="${textMuted}">ELEMENT</text><text x="${W/2}" y="80" text-anchor="middle" font-family="Orbitron,sans-serif" font-size="8" fill="${accent}">${suit.element.toUpperCase()}</text><line x1="18" y1="86" x2="${W-18}" y2="86" stroke="${borderColor}" stroke-width="0.4" opacity="0.3"/><text x="22" y="98" font-family="Space Mono,monospace" font-size="4" fill="${textMuted}">VALUE</text><text x="22" y="110" font-family="Orbitron,sans-serif" font-size="8" fill="${textMain}">${val}/13</text><text x="${W-22}" y="98" text-anchor="end" font-family="Space Mono,monospace" font-size="4" fill="${textMuted}">PLANET</text><text x="${W-22}" y="110" text-anchor="end" font-family="Orbitron,sans-serif" font-size="8" fill="${textMain}">${suit.planet}</text>`;
    }
  } else if (card.type === 'guardian') {
    const g = GUARDIANS[card.guardian] || {};
    const val = RANK_VALUES[card.rank];
    if (layout.showMetrics) {
      metrics = `<text x="${W/2}" y="68" text-anchor="middle" font-family="Space Mono,monospace" font-size="5" fill="${textMuted}">TERRITORY</text><text x="${W/2}" y="80" text-anchor="middle" font-family="Orbitron,sans-serif" font-size="8" fill="${accent}">${(g.territory || card.territory || 'Unknown').toUpperCase()}</text><line x1="18" y1="86" x2="${W-18}" y2="86" stroke="${borderColor}" stroke-width="0.4" opacity="0.3"/><text x="22" y="98" font-family="Space Mono,monospace" font-size="4" fill="${textMuted}">RANK</text><text x="22" y="110" font-family="Orbitron,sans-serif" font-size="8" fill="${textMain}">${val}/13</text><text x="${W-22}" y="98" text-anchor="end" font-family="Space Mono,monospace" font-size="4" fill="${textMuted}">FREQ</text><text x="${W-22}" y="110" text-anchor="end" font-family="Orbitron,sans-serif" font-size="8" fill="${textMain}">${g.frequency || card.frequency || '---'}Hz</text>`;
    }
  } else {
    const isMajor = card.type === 'tarot-major';
    const zVal = isMajor ? card.z : (RANK_VALUES[card.rank] || 1) / 14;
    const phase = zVal < 0.5 ? 'UNTRUE' : zVal < PHI_INV ? 'PARADOX' : zVal < SQRT3_2 ? 'TRUE' : 'HYPER';
    const phaseColor = { UNTRUE: '#808090', PARADOX: '#c0a040', TRUE: '#50a878', HYPER: '#4cc9f0' }[phase];
    if (layout.showMetrics) {
      metrics = `<text x="${W/2}" y="70" text-anchor="middle" font-family="Space Mono,monospace" font-size="5" fill="${textMuted}">z-COORDINATE</text><text x="${W/2}" y="86" text-anchor="middle" font-family="Orbitron,sans-serif" font-size="11" fill="${accent}">${zVal.toFixed(3)}</text><rect x="${W/2-22}" y="92" width="44" height="14" rx="3" fill="rgba(${hexToRgb(phaseColor)},0.2)" stroke="${phaseColor}" stroke-width="0.4"/><text x="${W/2}" y="103" text-anchor="middle" font-family="Orbitron,sans-serif" font-size="7" fill="${phaseColor}">${phase}</text>`;
    }
  }
  
  // Build lore section with auto-wrap
  if (layout.showLore) {
    // Calculate chars per line based on font size (smaller font = more chars)
    // Mono font needs fewer chars per line
    const fontCharMod = loreFont === 'mono' ? -4 : 0;
    const maxChars = Math.round(26 - (loreSize - 5) * 2 + fontCharMod);
    
    // Calculate available space for lore (between metrics/header and footer)
    const loreTopMin = layout.showMetrics ? 120 : 50; // Below metrics or header
    const loreBottomMax = H - 40; // Above footer
    const availableHeight = loreBottomMax - loreTopMin;
    const lineHeight = loreSize + 2;
    const titleSpace = 12 + titleSize;
    const maxLinesAvailable = Math.floor((availableHeight - titleSpace) / lineHeight);
    
    // Wrap text to fit available lines (no truncation if it fits)
    const loreLines = wrapLoreText(loreText || defaultLore, maxChars, Math.max(1, maxLinesAvailable));
    
    const loreBoxH = titleSpace + (loreLines.length * lineHeight);
    const loreY = H - 36 - loreBoxH;
    let loreContent = `<rect x="10" y="${loreY}" width="${W-20}" height="${loreBoxH}" rx="3" fill="rgba(255,255,255,0.03)"/>`;
    
    // Title
    const displayTitle = customTitle || defaultTitle;
    if (displayTitle) {
      loreContent += `<text x="${W/2}" y="${loreY + 4 + titleSize}" text-anchor="middle" font-family="Cinzel,serif" font-size="${titleSize}" fill="${accent}" font-weight="600">${truncate(displayTitle, 22)}</text>`;
    }
    
    // Auto-wrapped lore lines with configurable styling
    const lineY = loreY + 6 + titleSize + loreSize;
    const fontFamily = LORE_FONTS[loreFont] || LORE_FONTS.garamond;
    const fontWeight = loreBold ? 'font-weight="700"' : '';
    const fontStyle = loreItalic ? 'font-style="italic"' : '';
    loreLines.forEach((line, i) => {
      loreContent += `<text x="${W/2}" y="${lineY + i * lineHeight}" text-anchor="middle" font-family="${fontFamily}" font-size="${loreSize}" fill="${loreColor}" ${fontWeight} ${fontStyle}>${line}</text>`;
    });
    
    lore = loreContent;
  }
  
  const title = card.type === 'classic' ? `${card.rank} of ${CLASSIC_SUITS[card.suit].name}` : card.type === 'guardian' ? (GUARDIANS[card.guardian]?.name || card.name || 'Guardian') : card.type === 'tarot-major' ? card.title : card.name;
  const footerText = customFooter || 'Ï†â´+Ï†â»â´=7 Â· z_c=âˆš3/2';
  
  // Only apply chroma cycle override for main grid cards (not editor preview idx 9000+)
  const cycleActive = state.animMode === 'cycle' && idx < 9000;
  const fgC1 = cycleActive ? state.deckColors[0] : borderColor;
  const fgC2 = cycleActive ? state.deckColors[1] : adjustColor(borderColor, 30);
  const fgBlur = frameGlowIntensity > 0 ? frameGlowIntensity : (cycleActive ? 5 : 0);
  const fgFilter = fgBlur > 0 ? `<filter id="bfg${idx}" x="-50%" y="-50%" width="200%" height="200%"><feFlood flood-color="${fgC1}" flood-opacity="0.6" result="c1"/><feComposite in="c1" in2="SourceGraphic" operator="in" result="g1"/><feGaussianBlur in="g1" stdDeviation="${fgBlur}" result="b1"/><feFlood flood-color="${fgC2}" flood-opacity="0.3" result="c2"/><feComposite in="c2" in2="SourceGraphic" operator="in" result="g2"/><feGaussianBlur in="g2" stdDeviation="${fgBlur*1.5}" result="b2"/><feMerge><feMergeNode in="b2"/><feMergeNode in="b1"/><feMergeNode in="SourceGraphic"/></feMerge></filter>` : '';
  const fgGrad = `<linearGradient id="bdr${idx}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="${fgC1}"/><stop offset="100%" stop-color="${fgC2}"/></linearGradient>`;
  
  return `<svg class="card-svg ${card.type.includes('tarot') ? 'tarot' : 'playing'}" width="${displayW}" height="${displayH}" viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="bbg${idx}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="${bg1}" stop-opacity="${bgOpacity}"/><stop offset="100%" stop-color="${bg2}" stop-opacity="${bgOpacity}"/></linearGradient>${fgGrad}${fgFilter}</defs><rect x="0" y="0" width="${W}" height="${H}" rx="6" fill="url(#bbg${idx})"/><rect x="4" y="4" width="${W-8}" height="${H-8}" rx="4" fill="none" stroke="url(#bdr${idx})" stroke-width="${frameThickness}" ${fgBlur > 0 ? `filter="url(#bfg${idx})"` : ''}/><rect x="8" y="8" width="${W-16}" height="36" rx="3" fill="rgba(${hexToRgb(borderColor)},0.08)"/><text x="${W/2}" y="22" text-anchor="middle" font-family="Space Mono,monospace" font-size="4" fill="${textMuted}" letter-spacing="0.05em">${card.type.toUpperCase().replace('-',' ')}</text><text x="${W/2}" y="38" text-anchor="middle" font-family="Cinzel,serif" font-size="8" fill="${textMain}" font-weight="600">${truncate(title,16)}</text>${metrics}${lore}<line x1="14" y1="${H-24}" x2="${W-14}" y2="${H-24}" stroke="${borderColor}" stroke-width="0.4" opacity="0.3"/><text x="${W/2}" y="${H-12}" text-anchor="middle" font-family="Space Mono,monospace" font-size="4" fill="${textMuted}">${truncate(footerText, 24)}</text></svg>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCards() {
  const container = document.getElementById('cardGrid');
  container.innerHTML = '';
  container.className = `card-grid ${state.view === 'both' ? 'both-view' : ''}`;
  
  // Handle empty custom deck
  if (state.deck === 'custom' && state.cards.length === 0) {
    container.innerHTML = `
      <div class="custom-empty-state">
        <div class="custom-empty-icon">âœ¦</div>
        <div class="custom-empty-title">Your Custom Deck is Empty</div>
        <div class="custom-empty-desc">Build your own deck by picking cards from existing decks, or create custom division cards from scratch.</div>
        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
          <button class="custom-empty-btn" onclick="openCardPicker()">â• PICK CARDS</button>
          <button class="custom-empty-btn" onclick="openCardCreator()" style="background:var(--garden);">âœ¨ CREATE CARD</button>
        </div>
      </div>
    `;
    document.getElementById('previewTitle').textContent = 'Custom Deck';
    document.getElementById('statCards').textContent = 0;
    return;
  }
  
  let filtered = state.cards;
  if (state.filter) {
    if (state.deck === 'classic') filtered = filtered.filter(c => c.suit === state.filter);
    else if (state.deck === 'guardian') filtered = filtered.filter(c => c.territory === state.filter);
    else if (state.deck === 'tarot' && state.tarot.preset === 'honkfire') {
      // HonkFire preset filters by entity (squirrel, goose, duck, fox, merged)
      filtered = filtered.filter(c => c.entity === state.filter || c.suit === state.filter);
    }
    else if (state.deck === 'custom') {
      // Custom deck filters by card type
      if (state.filter === 'classic') filtered = filtered.filter(c => c.type === 'classic');
      else if (state.filter === 'guardian') filtered = filtered.filter(c => c.type === 'guardian');
      else if (state.filter === 'tarot') filtered = filtered.filter(c => c.type === 'tarot-major' || c.type === 'tarot-minor');
      else if (state.filter === 'division') filtered = filtered.filter(c => c.type === 'division');
    }
  }
  filtered.forEach((card) => {
    const idx = state.cards.indexOf(card);
    const el = document.createElement('div');
    // Per-card animMode overrides global, default to global
    const cardAnimMode = card.cfg?.animMode || state.animMode;
    const animClass = cardAnimMode !== 'none' ? ` anim-${cardAnimMode}` : '';
    const echoedClass = card.echoed ? ' echoed' : '';
    el.className = `card-container${state.selectedCards.includes(idx) ? ' selected' : ''}${echoedClass}${animClass}`;
    el.dataset.index = idx;
    // Small preview uses index * 10 to avoid filter ID conflicts
    const smallIdx = idx * 10;
    const gridScale = 85/140; // Scale for grid view
    const previewScale = 100/140; // Scale for hover preview
    
    // Main card display
    let mainContent;
    if (state.view === 'front') mainContent = generateFrontSVG(card, smallIdx, null, gridScale);
    else if (state.view === 'back') mainContent = generateBackSVG(card, smallIdx, null, gridScale);
    else mainContent = `<div class="card-pair">${generateFrontSVG(card, smallIdx, null, gridScale)}${generateBackSVG(card, smallIdx + 1, null, gridScale)}</div>`;
    
    // Hover preview - back only
    const previewIdx = 5000 + idx * 10;
    const hoverPreview = `<div class="hover-preview">
      <span class="hover-preview-label">Back</span>
      ${generateBackSVG(card, previewIdx, null, previewScale)}
    </div>`;
    
    // Add/Remove custom button based on deck type
    let actionBtn = '';
    if (state.deck === 'custom') {
      actionBtn = `<button class="add-to-custom-btn" style="background:#a03030;" onclick="event.stopPropagation();removeFromCustom(${idx})">âœ• Remove</button>`;
    } else {
      actionBtn = `<button class="add-to-custom-btn" onclick="event.stopPropagation();addSingleToCustom(${idx})">+ Custom</button>`;
    }
    
    el.innerHTML = mainContent + hoverPreview + actionBtn;
    el.onclick = () => handleCardClick(idx, el);
    // Double-click to toggle echo (HonkFire only)
    if (card.preset === 'honkfire') {
      el.ondblclick = (e) => { e.stopPropagation(); toggleEchoState(idx); };
    }
    
    container.appendChild(el);
  });
  document.getElementById('previewTitle').textContent = state.deck === 'classic' ? 'Classic Deck' : state.deck === 'guardian' ? 'Guardian Deck' : state.deck === 'custom' ? 'Custom Deck' : state.deck === 'tarot' && state.tarot.preset === 'honkfire' ? 'ğŸ”¥ HONKFIRE Tarot' : 'Tarot Deck';
  document.getElementById('statCards').textContent = filtered.length;
}

function addSingleToCustom(idx) {
  const card = state.cards[idx];
  if (!card) return;
  
  const cardKey = getCardKey(card);
  if (state.customCards.some(c => getCardKey(c) === cardKey)) {
    showToast('Card already in Custom Deck');
    return;
  }
  
  const newCard = JSON.parse(JSON.stringify(card));
  newCard.addedAt = Date.now();
  state.customCards.push(newCard);
  showToast(`â• Added to Custom Deck`);
}

function removeFromCustom(idx) {
  const card = state.cards[idx];
  if (!card) return;
  
  const cardKey = getCardKey(card);
  const customIdx = state.customCards.findIndex(c => getCardKey(c) === cardKey);
  
  if (customIdx !== -1) {
    state.customCards.splice(customIdx, 1);
    buildDeck();
    renderCards();
    buildControlPanel();
    showToast(`âœ• Removed from Custom Deck`);
  }
}

function handleCardClick(idx, el) {
  if (state.selectMode) {
    el.classList.toggle('selected');
    if (state.selectedCards.includes(idx)) state.selectedCards = state.selectedCards.filter(i => i !== idx);
    else state.selectedCards.push(idx);
    document.getElementById('selectedCount').textContent = state.selectedCards.length;
  } else {
    state.ed.index = idx;
    openEditor();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FULLSCREEN EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openEditor() {
  document.getElementById('editorModal').classList.add('active');
  buildEditorPanels();
  populateDeckNavigator();
  loadCardToEditor(state.ed.index);
}

function populateDeckNavigator() {
  const select = document.getElementById('deck-nav-select');
  if (!select) return;
  
  select.innerHTML = state.cards.map((card, idx) => {
    const name = card.name || `Card ${idx + 1}`;
    const truncName = name.length > 25 ? name.slice(0, 22) + '...' : name;
    return `<option value="${idx}">${truncName}</option>`;
  }).join('');
  
  select.value = state.ed.index;
  updateDeckNavigator();
}

function closeEditor() {
  // Stop editor animation
  if (editorChromaInterval) {
    cancelAnimationFrame(editorChromaInterval);
    editorChromaInterval = null;
  }
  document.getElementById('editorModal').classList.remove('active');
  renderCards();
}

function buildEditorPanels() {
  // LEFT PANEL - Front editing
  document.getElementById('editorLeft').innerHTML = `
    <div class="editor-section"><h4>ğŸ¨ FRONT DESIGN</h4>
      <div class="editor-group"><label>Theme Preset</label><div class="editor-row" id="edFrontThemes"></div></div>
      <div class="editor-group"><label>Card Color</label><div class="color-grid" id="edColors"></div><input type="color" id="edCustomColor" style="width:100%;height:28px;margin-top:6px;border-radius:4px;border:2px solid rgba(255,255,255,0.15);" onchange="edSet('color',this.value)"></div>
      <div class="editor-group"><label>Pattern</label><div class="editor-row"><button class="editor-mini-btn" data-pat="none" onclick="edSetPat('none')">âˆ…</button><button class="editor-mini-btn" data-pat="circles" onclick="edSetPat('circles')">â—¯</button><button class="editor-mini-btn" data-pat="waves" onclick="edSetPat('waves')">âˆ¿</button><button class="editor-mini-btn" data-pat="diamonds" onclick="edSetPat('diamonds')">â—‡</button><button class="editor-mini-btn" data-pat="hexgrid" onclick="edSetPat('hexgrid')">â¬¡</button><button class="editor-mini-btn" data-pat="stars" onclick="edSetPat('stars')">â˜†</button><button class="editor-mini-btn" data-pat="ornate" onclick="edSetPat('ornate')">âœ¤</button></div></div>
      <div class="editor-group"><label>Frame Glow</label><div class="glow-preset-row">${['none','custom','gold','neon','frost'].map(k => `<div class="glow-preset" data-fglow="${k}" onclick="edSetFGlow('${k}')">${FRAME_GLOW_PRESETS[k].name}</div>`).join('')}</div><div class="glow-preset-row">${['ember','void','toxic','blood','parchment'].map(k => `<div class="glow-preset" data-fglow="${k}" onclick="edSetFGlow('${k}')">${FRAME_GLOW_PRESETS[k].name}</div>`).join('')}</div></div>
      <div class="editor-group"><label>Glow Intensity</label><div class="slider-row"><input type="range" id="edFGlowInt" min="0" max="12" step="1" value="5" oninput="edSet('frameGlowIntensity',+this.value);document.getElementById('edFGlowIntVal').textContent=this.value"><span class="slider-val" id="edFGlowIntVal">5</span></div></div>
      <div class="editor-group"><label>Deck Palette</label><div class="color-row" style="gap:4px;"><input type="color" id="edPalette1" value="${state.deckColors[0]}" onchange="edUpdatePalette()" title="Color 1"><input type="color" id="edPalette2" value="${state.deckColors[1]}" onchange="edUpdatePalette()" title="Color 2"><input type="color" id="edPalette3" value="${state.deckColors[2]}" onchange="edUpdatePalette()" title="Color 3"></div></div>
      <div class="editor-group"><label>Card Animation</label><select id="edAnimMode" style="width:100%;" onchange="edSetAnimMode(this.value)"><option value="none">Static</option><option value="pulse">Aura Pulse</option><option value="cycle">Chroma Cycle</option></select></div>
      <div class="editor-group"><label>Frame Thickness</label><div class="slider-row"><input type="range" id="edFThick" min="0.5" max="4" step="0.5" value="2" oninput="edSet('frameThickness',+this.value);document.getElementById('edFThickVal').textContent=this.value"><span class="slider-val" id="edFThickVal">2</span></div></div>
      <div class="editor-group"><label>Center Glow</label><div class="slider-row"><input type="range" id="edGlow" min="0" max="12" step="1" value="5" oninput="edSet('glow',+this.value);document.getElementById('edGlowVal').textContent=this.value"><span class="slider-val" id="edGlowVal">5</span></div></div>
      <div class="editor-group"><label>Symbol Override</label><div class="sigil-grid" id="edSigils"></div><div style="display:flex;gap:6px;margin-top:8px;"><button class="btn sm" style="flex:1;" onclick="openGlyphModal()">ğŸ“œ GLYPH LAB</button><button class="btn sm" style="flex:1;" onclick="edSet('symbol','');refreshEditorUI()">âœ• Clear</button></div></div>
      <div class="editor-group"><label>Card Name</label><input type="text" id="edFrontName" placeholder="Override card name..." oninput="edSet('frontName',this.value)"></div>
    </div>
    <div class="editor-section"><h4>âœ¨ SHEEN OVERLAY</h4>
      <div class="editor-group"><label>Sheen Color</label><input type="color" id="edSheenColor" value="#ffffff" style="width:100%;height:28px;border-radius:4px;border:2px solid rgba(255,255,255,0.15);" onchange="edSet('sheenColor',this.value)"></div>
      <div class="editor-group"><label>Sheen Opacity</label><div class="slider-row"><input type="range" id="edSheenOpacity" min="0" max="0.5" step="0.02" value="0" oninput="edSet('sheenOpacity',+this.value);document.getElementById('edSheenOpacityVal').textContent=(+this.value).toFixed(2)"><span class="slider-val" id="edSheenOpacityVal">0.00</span></div></div>
      <div class="editor-group"><label>Sheen Angle</label><div class="slider-row"><input type="range" id="edSheenAngle" min="0" max="360" step="15" value="135" oninput="edSet('sheenAngle',+this.value);document.getElementById('edSheenAngleVal').textContent=this.value+'Â°'"><span class="slider-val" id="edSheenAngleVal">135Â°</span></div></div>
    </div>
  `;
  
  // RIGHT PANEL - Back editing  
  document.getElementById('editorRight').innerHTML = `
    <div class="editor-section"><h4>ğŸ“Š BACK DESIGN</h4>
      <div class="editor-group"><label>Theme Preset</label><div class="editor-row" id="edBackThemes"></div></div>
      <div class="editor-group"><label>Layout</label><div class="editor-row" id="edLayouts"></div></div>
      <div class="editor-group"><label>Accent Color</label><div class="color-grid" id="edBackColors"></div><input type="color" id="edBackAccent" style="width:100%;height:28px;margin-top:6px;border-radius:4px;border:2px solid rgba(255,255,255,0.15);" onchange="edSet('backAccent',this.value)"></div>
      <div class="editor-group"><label>Background</label><div class="color-row"><input type="color" id="edBackBg1" onchange="edSet('backBg1',this.value)"><input type="color" id="edBackBg2" onchange="edSet('backBg2',this.value)"><button class="btn sm" onclick="edResetBackBg()">â†º</button></div></div>
      <div class="editor-group"><label>Background Opacity</label><div class="slider-row"><input type="range" id="edBackOpacity" min="0" max="1" step="0.05" value="1" oninput="edSet('backOpacity',+this.value);document.getElementById('edBackOpacityVal').textContent=(+this.value).toFixed(2)"><span class="slider-val" id="edBackOpacityVal">1.00</span></div></div>
      <div class="editor-group"><label>Border</label><input type="color" id="edBackBorder" style="width:100%;height:28px;border-radius:4px;border:2px solid rgba(255,255,255,0.15);" onchange="edSet('backBorder',this.value)"></div>
      <div class="editor-group"><label>Frame Thickness</label><div class="slider-row"><input type="range" id="edBackThick" min="0.5" max="4" step="0.1" value="1" oninput="edSet('backThickness',+this.value);document.getElementById('edBackThickVal').textContent=(+this.value).toFixed(1)"><span class="slider-val" id="edBackThickVal">1.0</span></div></div>
      <div class="editor-group"><label>Frame Glow</label><div class="slider-row"><input type="range" id="edBackGlow" min="0" max="10" step="1" value="0" oninput="edSet('backGlow',+this.value);document.getElementById('edBackGlowVal').textContent=this.value"><span class="slider-val" id="edBackGlowVal">0</span></div></div>
    </div>
    <div class="editor-section"><h4>ğŸ“œ LORE & TEXT</h4>
      <div class="editor-group"><label>Custom Title</label><input type="text" id="edBackTitle" placeholder="Override title..." oninput="edSet('customTitle',this.value)"></div>
      <div class="editor-group"><label>Title Size</label><div class="slider-row"><input type="range" id="edTitleSize" min="5" max="12" step="0.5" value="7" oninput="edSet('titleSize',+this.value);document.getElementById('edTitleSizeVal').textContent=this.value"><span class="slider-val" id="edTitleSizeVal">7</span></div></div>
      <div class="editor-group"><label>Lore Text</label><textarea id="edBackLore" placeholder="Enter lore text... (auto-wraps to card)" oninput="edSet('lore',this.value)" rows="3"></textarea></div>
      <div class="editor-group"><label>Lore Size</label><div class="slider-row"><input type="range" id="edLoreSize" min="4" max="9" step="0.5" value="5" oninput="edSet('loreSize',+this.value);document.getElementById('edLoreSizeVal').textContent=this.value"><span class="slider-val" id="edLoreSizeVal">5</span></div></div>
      <div class="editor-group"><label>Lore Font</label><div class="editor-row"><button class="editor-mini-btn" data-lorefont="garamond" onclick="edSet('loreFont','garamond');refreshEditorUI()">Garamond</button><button class="editor-mini-btn" data-lorefont="cinzel" onclick="edSet('loreFont','cinzel');refreshEditorUI()">Cinzel</button><button class="editor-mini-btn" data-lorefont="mono" onclick="edSet('loreFont','mono');refreshEditorUI()">Mono</button></div></div>
      <div class="editor-group"><label>Lore Style</label><div class="editor-row"><button class="editor-mini-btn toggle-btn" id="edLoreBold" onclick="edSet('loreBold',!state.ed.loreBold);refreshEditorUI()"><b>B</b></button><button class="editor-mini-btn toggle-btn" id="edLoreItalic" onclick="edSet('loreItalic',!state.ed.loreItalic);refreshEditorUI()"><i>I</i></button><input type="color" id="edLoreColor" style="width:40px;height:28px;border-radius:4px;border:2px solid rgba(255,255,255,0.15);" onchange="edSet('loreColor',this.value)"></div></div>
      <div class="editor-group"><label>Custom Footer</label><input type="text" id="edBackFooter" placeholder="Override footer..." oninput="edSet('customFooter',this.value)"></div>
    </div>
  `;
  
  // CENTER PANEL - Preview
  document.getElementById('editorCenter').innerHTML = `
    <div class="preview-stage">
      <div class="preview-card-wrap"><div class="preview-card-frame" id="edPreviewFront"></div><div class="preview-card-label">FRONT</div></div>
      <div class="preview-card-wrap"><div class="preview-card-frame" id="edPreviewBack"></div><div class="preview-card-label">BACK</div></div>
    </div>
    <div class="card-nav">
      <button class="card-nav-btn" onclick="edNav(-1)">â—€</button>
      <div class="card-counter">Card <b id="edIdx">1</b> / <span id="edTotal">${state.cards.length}</span></div>
      <button class="card-nav-btn" onclick="edNav(1)">â–¶</button>
    </div>
    <div class="action-buttons">
      <button class="btn primary" onclick="edApply()">âœ“ APPLY</button>
      <button class="btn" onclick="edApplyAll()">âœ“ APPLY ALL</button>
      <button class="btn" onclick="edReset()">â†º RESET</button>
    </div>
    <div class="card-info-box" id="edCardInfo"></div>
  `;
  
  // Populate buttons
  const ftr = document.getElementById('edFrontThemes');
  Object.entries(FRONT_THEMES).forEach(([k, t]) => {
    const btn = document.createElement('button');
    btn.className = 'editor-mini-btn';
    btn.dataset.ftheme = k;
    btn.textContent = t.name.slice(0, 5);
    btn.onclick = () => { edSet('frontTheme', k); refreshEditorUI(); };
    ftr.appendChild(btn);
  });
  
  const btr = document.getElementById('edBackThemes');
  Object.entries(BACK_THEMES).forEach(([k, t]) => {
    const btn = document.createElement('button');
    btn.className = 'editor-mini-btn';
    btn.dataset.btheme = k;
    btn.textContent = t.name.slice(0, 5);
    btn.onclick = () => { edSetBackTheme(k); };
    btr.appendChild(btn);
  });
  
  const lr = document.getElementById('edLayouts');
  Object.entries(BACK_LAYOUTS).forEach(([k, l]) => {
    const btn = document.createElement('button');
    btn.className = 'editor-mini-btn';
    btn.dataset.layout = k;
    btn.textContent = l.name;
    btn.onclick = () => { edSet('backLayout', k); refreshEditorUI(); };
    lr.appendChild(btn);
  });
  
  const cg = document.getElementById('edColors');
  PALETTE.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch';
    sw.style.background = c;
    sw.onclick = () => { edSet('color', c); document.getElementById('edCustomColor').value = c; };
    cg.appendChild(sw);
  });
  
  const bcg = document.getElementById('edBackColors');
  PALETTE.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch';
    sw.style.background = c;
    sw.onclick = () => { edSet('backAccent', c); document.getElementById('edBackAccent').value = c; };
    bcg.appendChild(sw);
  });
  
  const sg = document.getElementById('edSigils');
  SIGILS.forEach(s => {
    const btn = document.createElement('button');
    btn.className = 'sigil-btn';
    btn.textContent = s;
    btn.dataset.sigil = s;
    btn.onclick = () => { edSet('symbol', state.ed.symbol === s ? '' : s); refreshEditorUI(); };
    sg.appendChild(btn);
  });
}

function loadCardToEditor(idx) {
  const card = state.cards[idx];
  const cfg = card.cfg || {};
  const backCfg = card.backCfg || {};
  
  // Load saved card config into editor state
  state.ed = {
    index: idx,
    color: cfg.color || '',
    pattern: cfg.pattern || '',
    frontTheme: cfg.frontTheme || '',
    glow: cfg.glow !== undefined ? cfg.glow : null,
    symbol: cfg.symbol || '',
    divisionUnicode: cfg.divisionUnicode || card.divisionUnicode || '',
    structureUnicode: cfg.structureUnicode || card.structureUnicode || '',
    frontName: cfg.frontName || '',
    centerName: cfg.centerName || '',
    divisionName: cfg.divisionName || '',
    structureName: cfg.structureName || '',
    frameGlow: cfg.frameGlow || '',
    frameGlowIntensity: cfg.frameGlowIntensity !== undefined ? cfg.frameGlowIntensity : state.frameGlowIntensity,
    frameThickness: cfg.frameThickness !== undefined ? cfg.frameThickness : state.frameThickness,
    frameGlowColor1: cfg.frameGlowColor1 || state.frameGlowColor1,
    frameGlowColor2: cfg.frameGlowColor2 || state.frameGlowColor2,
    animMode: cfg.animMode || 'none',
    sheenColor: cfg.sheenColor || state.sheenColor,
    sheenOpacity: cfg.sheenOpacity !== undefined ? cfg.sheenOpacity : state.sheenOpacity,
    sheenAngle: cfg.sheenAngle !== undefined ? cfg.sheenAngle : state.sheenAngle,
    backTheme: backCfg.theme || '',
    backLayout: backCfg.layout || '',
    backAccent: backCfg.accent || '',
    backBg1: backCfg.bg1 || '',
    backBg2: backCfg.bg2 || '',
    backOpacity: backCfg.bgOpacity !== undefined ? backCfg.bgOpacity : 1,
    backBorder: backCfg.borderColor || '',
    backThickness: backCfg.frameThickness !== undefined ? backCfg.frameThickness : 1,
    backGlow: backCfg.frameGlowIntensity !== undefined ? backCfg.frameGlowIntensity : 0,
    backTextMain: backCfg.textMain || '',
    backTextMuted: backCfg.textMuted || '',
    customTitle: backCfg.customTitle || '',
    titleSize: backCfg.titleSize !== undefined ? backCfg.titleSize : 7,
    lore: backCfg.lore || '',
    loreSize: backCfg.loreSize !== undefined ? backCfg.loreSize : 5,
    loreFont: backCfg.loreFont || 'garamond',
    loreBold: backCfg.loreBold || false,
    loreItalic: backCfg.loreItalic !== undefined ? backCfg.loreItalic : true,
    loreColor: backCfg.loreColor || '',
    customFooter: backCfg.customFooter || ''
  };
  
  refreshEditorUI();
  edUpdatePreview();
  
  // Start editor animation if enabled
  if (editorChromaInterval) {
    cancelAnimationFrame(editorChromaInterval);
    editorChromaInterval = null;
  }
  if (state.ed.animMode === 'cycle') {
    startEditorChromaCycle();
  }
}

function refreshEditorUI() {
  const card = state.cards[state.ed.index];
  const bTheme = BACK_THEMES[state.ed.backTheme || state.backTheme];
  
  // Update UI controls to match editor state
  document.getElementById('edCustomColor').value = state.ed.color || card.color || '#d4af37';
  document.getElementById('edGlow').value = state.ed.glow !== null ? state.ed.glow : state.glow;
  document.getElementById('edGlowVal').textContent = state.ed.glow !== null ? state.ed.glow : state.glow;
  document.getElementById('edFGlowInt').value = state.ed.frameGlowIntensity;
  document.getElementById('edFGlowIntVal').textContent = state.ed.frameGlowIntensity;
  document.getElementById('edAnimMode').value = state.ed.animMode;
  document.getElementById('edPalette1').value = state.deckColors[0];
  document.getElementById('edPalette2').value = state.deckColors[1];
  document.getElementById('edPalette3').value = state.deckColors[2];
  document.getElementById('edFThick').value = state.ed.frameThickness;
  document.getElementById('edFThickVal').textContent = state.ed.frameThickness;
  document.getElementById('edIdx').textContent = state.ed.index + 1;
  
  // Sheen controls
  document.getElementById('edSheenColor').value = state.ed.sheenColor;
  document.getElementById('edSheenOpacity').value = state.ed.sheenOpacity;
  document.getElementById('edSheenOpacityVal').textContent = state.ed.sheenOpacity.toFixed(2);
  document.getElementById('edSheenAngle').value = state.ed.sheenAngle;
  document.getElementById('edSheenAngleVal').textContent = state.ed.sheenAngle + 'Â°';
  
  document.getElementById('edBackAccent').value = state.ed.backAccent || card.color || bTheme.accent;
  document.getElementById('edBackBg1').value = state.ed.backBg1 || bTheme.bg1;
  document.getElementById('edBackBg2').value = state.ed.backBg2 || bTheme.bg2;
  document.getElementById('edBackOpacity').value = state.ed.backOpacity;
  document.getElementById('edBackOpacityVal').textContent = state.ed.backOpacity.toFixed(2);
  document.getElementById('edBackBorder').value = state.ed.backBorder || bTheme.borderColor;
  document.getElementById('edBackThick').value = state.ed.backThickness;
  document.getElementById('edBackThickVal').textContent = state.ed.backThickness.toFixed(1);
  document.getElementById('edBackGlow').value = state.ed.backGlow;
  document.getElementById('edBackGlowVal').textContent = state.ed.backGlow;
  document.getElementById('edBackTitle').value = state.ed.customTitle;
  document.getElementById('edFrontName').value = state.ed.frontName;
  document.getElementById('edTitleSize').value = state.ed.titleSize;
  document.getElementById('edTitleSizeVal').textContent = state.ed.titleSize;
  document.getElementById('edBackLore').value = state.ed.lore;
  document.getElementById('edLoreSize').value = state.ed.loreSize;
  document.getElementById('edLoreSizeVal').textContent = state.ed.loreSize;
  document.getElementById('edLoreColor').value = state.ed.loreColor || bTheme.textMuted;
  document.getElementById('edLoreBold').classList.toggle('active', state.ed.loreBold);
  document.getElementById('edLoreItalic').classList.toggle('active', state.ed.loreItalic);
  document.getElementById('edBackFooter').value = state.ed.customFooter;
  
  // Active states
  document.querySelectorAll('[data-ftheme]').forEach(b => b.classList.toggle('active', b.dataset.ftheme === (state.ed.frontTheme || state.frontTheme)));
  document.querySelectorAll('[data-fglow]').forEach(b => b.classList.toggle('active', b.dataset.fglow === (state.ed.frameGlow || state.frameGlow)));
  document.querySelectorAll('[data-btheme]').forEach(b => b.classList.toggle('active', b.dataset.btheme === (state.ed.backTheme || state.backTheme)));
  document.querySelectorAll('[data-pat]').forEach(b => b.classList.toggle('active', b.dataset.pat === (state.ed.pattern || FRONT_THEMES[state.frontTheme].pattern)));
  document.querySelectorAll('[data-layout]').forEach(b => b.classList.toggle('active', b.dataset.layout === (state.ed.backLayout || state.backLayout)));
  document.querySelectorAll('[data-sigil]').forEach(b => b.classList.toggle('active', b.dataset.sigil === state.ed.symbol));
  document.querySelectorAll('[data-lorefont]').forEach(b => b.classList.toggle('active', b.dataset.lorefont === state.ed.loreFont));
  
  // Card info
  let info = `<b>Type:</b> ${card.type}<br>`;
  if (card.type === 'classic') {
    info += `<b>Suit:</b> ${CLASSIC_SUITS[card.suit].name}<br><b>Rank:</b> ${card.rank}`;
  } else if (card.type === 'guardian') {
    const g = GUARDIANS[card.guardian] || {};
    info += `<b>Guardian:</b> ${g.name || card.name || 'Unknown'}<br><b>Territory:</b> ${g.territory || card.territory || 'Unknown'}<br><b>Freq:</b> ${g.frequency || card.frequency || '---'}Hz`;
  } else {
    info += `<b>Title:</b> ${card.title || card.name}`;
    if (card.z !== undefined) info += `<br><b>z:</b> ${card.z.toFixed(3)}`;
  }
  document.getElementById('edCardInfo').innerHTML = info;
}

// Universal editor setter - updates state and refreshes preview
function edSet(key, value) {
  state.ed[key] = value;
  edUpdatePreview();
}

function edSetPat(p) {
  state.ed.pattern = p;
  document.querySelectorAll('[data-pat]').forEach(b => b.classList.toggle('active', b.dataset.pat === p));
  edUpdatePreview();
}

function edSetFGlow(k) {
  state.ed.frameGlow = k;
  
  // Update deck palette from preset colors (except none, custom)
  const preset = FRAME_GLOW_PRESETS[k];
  if (preset && Array.isArray(preset.colors)) {
    state.deckColors = [...preset.colors];
    // Update CSS variables
    const root = document.documentElement.style;
    root.setProperty('--c1', preset.colors[0]);
    root.setProperty('--c2', preset.colors[1]);
    root.setProperty('--c3', preset.colors[2]);
    // Update palette inputs
    document.getElementById('edPalette1').value = preset.colors[0];
    document.getElementById('edPalette2').value = preset.colors[1];
    document.getElementById('edPalette3').value = preset.colors[2];
  }
  
  document.querySelectorAll('[data-fglow]').forEach(b => b.classList.toggle('active', b.dataset.fglow === k));
  edUpdatePreview();
  
  // Restart editor chroma cycle if active
  if (state.ed.animMode === 'cycle') {
    if (editorChromaInterval) cancelAnimationFrame(editorChromaInterval);
    startEditorChromaCycle();
  }
}

function edUpdatePalette() {
  const c1 = document.getElementById('edPalette1').value;
  const c2 = document.getElementById('edPalette2').value;
  const c3 = document.getElementById('edPalette3').value;
  
  state.deckColors = [c1, c2, c3];
  
  // Update CSS variables
  const root = document.documentElement.style;
  root.setProperty('--c1', c1);
  root.setProperty('--c2', c2);
  root.setProperty('--c3', c3);
  root.setProperty('--accent', c1);
  
  // Switch to custom frame glow when manually editing palette
  state.ed.frameGlow = 'custom';
  document.querySelectorAll('[data-fglow]').forEach(b => b.classList.toggle('active', b.dataset.fglow === 'custom'));
  
  edUpdatePreview();
}

let editorChromaInterval = null;

function edSetAnimMode(mode) {
  state.ed.animMode = mode;
  
  // Stop existing editor chroma cycle
  if (editorChromaInterval) {
    cancelAnimationFrame(editorChromaInterval);
    editorChromaInterval = null;
  }
  
  edUpdatePreview();
  
  // Start editor chroma cycle if enabled
  if (mode === 'cycle') {
    startEditorChromaCycle();
  }
}

function startEditorChromaCycle() {
  const duration = 3000;
  let startTime = null;
  
  function animate(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;
    const progress = (elapsed % duration) / duration;
    
    const colors = state.deckColors;
    let color1, color2;
    
    if (progress < 0.333) {
      const p = progress * 3;
      color1 = interpolateColor(colors[0], colors[1], p);
      color2 = interpolateColor(colors[1], colors[2], p);
    } else if (progress < 0.666) {
      const p = (progress - 0.333) * 3;
      color1 = interpolateColor(colors[1], colors[2], p);
      color2 = interpolateColor(colors[2], colors[0], p);
    } else {
      const p = (progress - 0.666) * 3;
      color1 = interpolateColor(colors[2], colors[0], p);
      color2 = interpolateColor(colors[0], colors[1], p);
    }
    
    // Update editor preview gradients (ids 9000 and 9001)
    document.querySelectorAll('#edPreviewFront linearGradient[id^="bdr"] stop, #edPreviewBack linearGradient[id^="bdr"] stop').forEach((stop, i) => {
      stop.setAttribute('stop-color', i % 2 === 0 ? color1 : color2);
    });
    
    // Update editor preview filter flood colors
    document.querySelectorAll('#edPreviewFront filter[id^="fglow"] feFlood, #edPreviewBack filter[id^="fglow"] feFlood, #edPreviewFront filter[id^="bfg"] feFlood, #edPreviewBack filter[id^="bfg"] feFlood').forEach((flood, i) => {
      flood.setAttribute('flood-color', i % 2 === 0 ? color1 : color2);
    });
    
    if (state.ed.animMode === 'cycle') {
      editorChromaInterval = requestAnimationFrame(animate);
    }
  }
  
  editorChromaInterval = requestAnimationFrame(animate);
}

function edSetBackTheme(k) {
  state.ed.backTheme = k;
  const theme = BACK_THEMES[k];
  state.ed.backBg1 = theme.bg1;
  state.ed.backBg2 = theme.bg2;
  state.ed.backBorder = theme.borderColor;
  state.ed.backAccent = theme.accent;
  refreshEditorUI();
  edUpdatePreview();
}

function edResetBackBg() {
  const t = BACK_THEMES[state.ed.backTheme || state.backTheme];
  state.ed.backBg1 = t.bg1;
  state.ed.backBg2 = t.bg2;
  document.getElementById('edBackBg1').value = t.bg1;
  document.getElementById('edBackBg2').value = t.bg2;
  edUpdatePreview();
}

// TRUE LIVE PREVIEW - builds config object from current editor state
function edUpdatePreview() {
  const card = state.cards[state.ed.index];
  
  // Build front config from editor state
  const frontCfg = {
    color: state.ed.color || undefined,
    pattern: state.ed.pattern || undefined,
    frontTheme: state.ed.frontTheme || undefined,
    glow: state.ed.glow,
    symbol: state.ed.symbol || undefined,
    divisionUnicode: state.ed.divisionUnicode || undefined,
    structureUnicode: state.ed.structureUnicode || undefined,
    frontName: state.ed.frontName || undefined,
    frameGlow: state.ed.frameGlow || undefined,
    frameGlowIntensity: state.ed.frameGlowIntensity,
    frameThickness: state.ed.frameThickness,
    frameGlowColor1: state.ed.frameGlowColor1,
    frameGlowColor2: state.ed.frameGlowColor2,
    sheenColor: state.ed.sheenColor,
    sheenOpacity: state.ed.sheenOpacity,
    sheenAngle: state.ed.sheenAngle
  };
  
  // Build back config from editor state
  const backCfg = {
    theme: state.ed.backTheme || undefined,
    layout: state.ed.backLayout || undefined,
    accent: state.ed.backAccent || undefined,
    bg1: state.ed.backBg1 || undefined,
    bg2: state.ed.backBg2 || undefined,
    bgOpacity: state.ed.backOpacity,
    borderColor: state.ed.backBorder || undefined,
    frameThickness: state.ed.backThickness,
    frameGlowIntensity: state.ed.backGlow,
    textMain: state.ed.backTextMain || undefined,
    textMuted: state.ed.backTextMuted || undefined,
    customTitle: state.ed.customTitle || undefined,
    titleSize: state.ed.titleSize,
    lore: state.ed.lore || undefined,
    loreSize: state.ed.loreSize,
    loreFont: state.ed.loreFont,
    loreBold: state.ed.loreBold,
    loreItalic: state.ed.loreItalic,
    loreColor: state.ed.loreColor || undefined,
    customFooter: state.ed.customFooter || undefined
  };
  
  // Generate preview SVGs with the editor config overrides (scale 1.43 for 200px preview)
  const previewScale = 200/140;
  const frontContainer = document.getElementById('edPreviewFront');
  const backContainer = document.getElementById('edPreviewBack');
  
  frontContainer.innerHTML = generateFrontSVG(card, 9000, frontCfg, previewScale);
  backContainer.innerHTML = generateBackSVG(card, 9001, backCfg, previewScale);
  
  // Apply animation classes for pulse mode
  const animClass = state.ed.animMode === 'pulse' ? 'anim-pulse' : '';
  frontContainer.className = `preview-card-frame ${animClass}`;
  backContainer.className = `preview-card-frame ${animClass}`;
}

function edNav(dir) {
  const list = state.selectedCards.length ? state.selectedCards : state.cards.map((_, i) => i);
  const cur = list.indexOf(state.ed.index);
  state.ed.index = list[(cur + dir + list.length) % list.length];
  loadCardToEditor(state.ed.index);
}

function edApply() {
  const card = state.cards[state.ed.index];
  card.cfg = {};
  if (state.ed.color) card.cfg.color = state.ed.color;
  if (state.ed.pattern) card.cfg.pattern = state.ed.pattern;
  if (state.ed.frontTheme) card.cfg.frontTheme = state.ed.frontTheme;
  if (state.ed.glow !== null) card.cfg.glow = state.ed.glow;
  if (state.ed.symbol) card.cfg.symbol = state.ed.symbol;
  if (state.ed.divisionUnicode) card.cfg.divisionUnicode = state.ed.divisionUnicode;
  if (state.ed.structureUnicode) card.cfg.structureUnicode = state.ed.structureUnicode;
  if (state.ed.frontName) card.cfg.frontName = state.ed.frontName;
  if (state.ed.centerName) card.cfg.centerName = state.ed.centerName;
  if (state.ed.divisionName) card.cfg.divisionName = state.ed.divisionName;
  if (state.ed.structureName) card.cfg.structureName = state.ed.structureName;
  if (state.ed.frameGlow) card.cfg.frameGlow = state.ed.frameGlow;
  card.cfg.frameGlowIntensity = state.ed.frameGlowIntensity;
  card.cfg.frameThickness = state.ed.frameThickness;
  if (state.ed.animMode && state.ed.animMode !== 'none') card.cfg.animMode = state.ed.animMode;
  card.cfg.sheenColor = state.ed.sheenColor;
  card.cfg.sheenOpacity = state.ed.sheenOpacity;
  card.cfg.sheenAngle = state.ed.sheenAngle;
  
  card.backCfg = {};
  if (state.ed.backTheme) card.backCfg.theme = state.ed.backTheme;
  if (state.ed.backLayout) card.backCfg.layout = state.ed.backLayout;
  if (state.ed.backAccent) card.backCfg.accent = state.ed.backAccent;
  if (state.ed.backBg1) card.backCfg.bg1 = state.ed.backBg1;
  if (state.ed.backBg2) card.backCfg.bg2 = state.ed.backBg2;
  card.backCfg.bgOpacity = state.ed.backOpacity;
  if (state.ed.backBorder) card.backCfg.borderColor = state.ed.backBorder;
  card.backCfg.frameThickness = state.ed.backThickness;
  card.backCfg.frameGlowIntensity = state.ed.backGlow;
  if (state.ed.customTitle) card.backCfg.customTitle = state.ed.customTitle;
  card.backCfg.titleSize = state.ed.titleSize;
  if (state.ed.lore) card.backCfg.lore = state.ed.lore;
  card.backCfg.loreSize = state.ed.loreSize;
  card.backCfg.loreFont = state.ed.loreFont;
  card.backCfg.loreBold = state.ed.loreBold;
  card.backCfg.loreItalic = state.ed.loreItalic;
  if (state.ed.loreColor) card.backCfg.loreColor = state.ed.loreColor;
  if (state.ed.customFooter) card.backCfg.customFooter = state.ed.customFooter;
  
  showToast('âœ“ Applied to card');
}

function edApplyAll() {
  const targets = state.selectedCards.length ? state.selectedCards : state.cards.map((_, i) => i);
  targets.forEach(idx => {
    const card = state.cards[idx];
    card.cfg = {};
    if (state.ed.color) card.cfg.color = state.ed.color;
    if (state.ed.pattern) card.cfg.pattern = state.ed.pattern;
    if (state.ed.frontTheme) card.cfg.frontTheme = state.ed.frontTheme;
    if (state.ed.glow !== null) card.cfg.glow = state.ed.glow;
    if (state.ed.symbol) card.cfg.symbol = state.ed.symbol;
    if (state.ed.divisionUnicode) card.cfg.divisionUnicode = state.ed.divisionUnicode;
    if (state.ed.structureUnicode) card.cfg.structureUnicode = state.ed.structureUnicode;
    if (state.ed.frontName) card.cfg.frontName = state.ed.frontName;
    if (state.ed.centerName) card.cfg.centerName = state.ed.centerName;
    if (state.ed.divisionName) card.cfg.divisionName = state.ed.divisionName;
    if (state.ed.structureName) card.cfg.structureName = state.ed.structureName;
    if (state.ed.frameGlow) card.cfg.frameGlow = state.ed.frameGlow;
    card.cfg.frameGlowIntensity = state.ed.frameGlowIntensity;
    card.cfg.frameThickness = state.ed.frameThickness;
    if (state.ed.animMode && state.ed.animMode !== 'none') card.cfg.animMode = state.ed.animMode;
    card.cfg.sheenColor = state.ed.sheenColor;
    card.cfg.sheenOpacity = state.ed.sheenOpacity;
    card.cfg.sheenAngle = state.ed.sheenAngle;
    
    card.backCfg = {};
    if (state.ed.backTheme) card.backCfg.theme = state.ed.backTheme;
    if (state.ed.backLayout) card.backCfg.layout = state.ed.backLayout;
    if (state.ed.backAccent) card.backCfg.accent = state.ed.backAccent;
    if (state.ed.backBg1) card.backCfg.bg1 = state.ed.backBg1;
    if (state.ed.backBg2) card.backCfg.bg2 = state.ed.backBg2;
    card.backCfg.bgOpacity = state.ed.backOpacity;
    if (state.ed.backBorder) card.backCfg.borderColor = state.ed.backBorder;
    card.backCfg.frameThickness = state.ed.backThickness;
    card.backCfg.frameGlowIntensity = state.ed.backGlow;
    if (state.ed.customTitle) card.backCfg.customTitle = state.ed.customTitle;
    card.backCfg.titleSize = state.ed.titleSize;
    if (state.ed.lore) card.backCfg.lore = state.ed.lore;
    card.backCfg.loreSize = state.ed.loreSize;
    card.backCfg.loreFont = state.ed.loreFont;
    card.backCfg.loreBold = state.ed.loreBold;
    card.backCfg.loreItalic = state.ed.loreItalic;
    if (state.ed.loreColor) card.backCfg.loreColor = state.ed.loreColor;
    if (state.ed.customFooter) card.backCfg.customFooter = state.ed.customFooter;
  });
  showToast(`âœ“ Applied to ${targets.length} cards`);
}

function edReset() {
  state.cards[state.ed.index].cfg = {};
  state.cards[state.ed.index].backCfg = {};
  loadCardToEditor(state.ed.index);
  showToast('â†º Card reset');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchDeck(deck) { state.deck = deck; state.filter = null; document.querySelectorAll('.deck-tab').forEach(t => t.classList.toggle('active', t.dataset.deck === deck)); buildControlPanel(); buildDeck(); renderCards(); showToast(`${deck.toUpperCase()} loaded`); }
function setUITheme(theme) { state.uiTheme = theme; document.body.dataset.theme = theme; document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === theme)); }
function setView(view) { state.view = view; document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view)); renderCards(); }
function setFrontTheme(p) { state.frontTheme = p; buildControlPanel(); renderCards(); }
function setBackTheme(p) { state.backTheme = p; buildControlPanel(); renderCards(); }
function setBackLayout(l) { state.backLayout = l; buildControlPanel(); renderCards(); }
function setFrameGlow(p) { 
  state.frameGlow = p;
  
  // Update deck palette from preset colors (except none, custom, palette)
  const preset = FRAME_GLOW_PRESETS[p];
  if (preset && Array.isArray(preset.colors)) {
    state.deckColors = [...preset.colors];
    // Update CSS variables
    const root = document.documentElement.style;
    root.setProperty('--c1', preset.colors[0]);
    root.setProperty('--c2', preset.colors[1]);
    root.setProperty('--c3', preset.colors[2]);
    root.setProperty('--accent', preset.colors[0]);
  }
  
  buildControlPanel(); 
  renderCards();
  
  // Restart chroma cycle if active to pick up new colors
  if (state.animMode === 'cycle') {
    if (chromaCycleInterval) cancelAnimationFrame(chromaCycleInterval);
    startChromaCycle();
  }
}
function setFilter(f) { state.filter = state.filter === f ? null : f; buildControlPanel(); renderCards(); }
function toggleSelectMode() { state.selectMode = !state.selectMode; document.getElementById('batchBar').classList.toggle('active', state.selectMode); buildControlPanel(); }
function selectAll() { document.querySelectorAll('.card-container').forEach(el => { el.classList.add('selected'); const idx = parseInt(el.dataset.index); if (!state.selectedCards.includes(idx)) state.selectedCards.push(idx); }); document.getElementById('selectedCount').textContent = state.selectedCards.length; }
function clearSelection() { document.querySelectorAll('.card-container').forEach(el => el.classList.remove('selected')); state.selectedCards = []; document.getElementById('selectedCount').textContent = 0; }
function batchEdit() { if (!state.selectedCards.length) return showToast('Select cards first'); state.ed.index = state.selectedCards[0]; openEditor(); }
function randomize() { const ft = Object.keys(FRONT_THEMES); const bt = Object.keys(BACK_THEMES); const bl = Object.keys(BACK_LAYOUTS); const fg = Object.keys(FRAME_GLOW_PRESETS); state.frontTheme = ft[Math.floor(Math.random()*ft.length)]; state.backTheme = bt[Math.floor(Math.random()*bt.length)]; state.backLayout = bl[Math.floor(Math.random()*bl.length)]; state.frameGlow = fg[Math.floor(Math.random()*fg.length)]; buildControlPanel(); renderCards(); showToast('ğŸ² Randomized'); }
function exportDeck() {
  const now = new Date().toISOString();
  const exportData = {
    meta: {
      generator: 'Golden Acorn v8.0.0',
      schemaVersion: '8.0.0',
      deck: state.deck,
      cardCount: state.cards.length,
      savedAt: now,
      exportedAt: now
    },
    state: {
      deck: state.deck,
      cards: state.cards,
      customCards: state.customCards,
      customDeck: state.customDeck, // Divisions
      frontTheme: state.frontTheme,
      backTheme: state.backTheme,
      backLayout: state.backLayout,
      frameGlow: state.frameGlow,
      deckColors: state.deckColors,
      animMode: state.animMode,
      uiTheme: state.uiTheme
    }
  };
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `golden_acorn_${state.deck}_${Date.now()}.json`;
  a.click();
  
  const divCount = state.customDeck.divisions.length;
  const extraInfo = divCount > 0 ? ` + ${divCount} divisions` : '';
  showToast(`ğŸ“¤ Exported ${state.cards.length} cards${extraInfo}`);
}
function showToast(msg, duration = 2000) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), duration); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM DECK MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DIVISION HIERARCHY - Custom Suits with Structures, Colors, and Animations
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderDivisionHierarchy() {
  const container = document.getElementById('division-hierarchy');
  if (!container) return;
  
  if (state.customDeck.divisions.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:11px;">
        <div style="font-size:24px;opacity:0.3;margin-bottom:8px;">â—‡</div>
        No divisions yet.<br>Create your first custom suit!
      </div>
    `;
    return;
  }
  
  container.innerHTML = state.customDeck.divisions.map((div, idx) => {
    // Ensure defaults
    if (!div.colorMode) div.colorMode = 'manual';
    if (!div.colorHex) div.colorHex = NEON_PALETTE[idx % NEON_PALETTE.length];
    if (!div.animPattern) div.animPattern = '0';
    if (!div.structures) div.structures = [];
    
    const structuresList = div.structures.length > 0 
      ? div.structures.map((s, sIdx) => `
          <div class="structure-item">
            <span><span class="struct-symbol">${s.unicode}</span>${s.name}</span>
            <span class="struct-remove" onclick="removeStructure(${idx}, ${sIdx})" title="Remove">âœ•</span>
          </div>
        `).join('')
      : '<div style="font-size:10px;color:var(--text-muted);padding:4px;">No structures defined</div>';
    
    return `
      <div class="division-box" data-div-idx="${idx}">
        <button class="btn sm danger division-remove-btn" onclick="removeDivision(${idx})" title="Delete Division">âœ•</button>
        
        <div class="division-header">
          <input type="text" value="${escapeAttr(div.name)}" 
                 onchange="updateDivName(${idx}, this.value)" 
                 placeholder="Division Name" style="flex:3">
          <input type="text" value="${escapeAttr(div.unicode)}" 
                 onchange="updateDivUnicode(${idx}, this.value)" 
                 placeholder="â—‡" style="flex:1;text-align:center;font-size:16px;">
        </div>
        
        <div class="color-controls">
          <div class="neon-preview-box" 
               style="background:${div.colorHex}" 
               onclick="toggleNeonPickers(${idx})" 
               title="Click to pick color"></div>
          <select style="flex:1" onchange="updateDivColorMode(${idx}, this.value)">
            <option value="manual" ${div.colorMode==='manual'?'selected':''}>Manual Color</option>
            <option value="algo" ${div.colorMode==='algo'?'selected':''}>Auto (by index)</option>
          </select>
          <select style="width:60px" onchange="updateDivAnim(${idx}, this.value)" title="Animation Pattern">
            <option value="0" ${div.animPattern==='0'?'selected':''}>â—‰ Static</option>
            <option value="L" ${div.animPattern==='L'?'selected':''}>â†’ Shift L</option>
            <option value="R" ${div.animPattern==='R'?'selected':''}>â† Shift R</option>
            <option value="P" ${div.animPattern==='P'?'selected':''}>â— Pulse</option>
          </select>
        </div>
        
        <div id="neon-pickers-${idx}" class="collapsed-inputs">
          ${NEON_PALETTE.map(c => `
            <div class="swatch" 
                 style="background:${c};" 
                 onclick="setDivColor(${idx}, '${c}')"
                 title="${c}"></div>
          `).join('')}
        </div>
        
        <div class="structure-list">
          <label style="font-size:9px;margin:0 0 6px 0;">STRUCTURES (Ranks)</label>
          <div id="structs-${idx}">${structuresList}</div>
          <div class="structure-add-row">
            <input type="text" id="new-struct-name-${idx}" placeholder="Rank name" style="flex:2">
            <input type="text" id="new-struct-uni-${idx}" placeholder="â—†" style="width:45px;text-align:center;">
            <button class="btn sm" onclick="addStructure(${idx})" title="Add Structure">+</button>
          </div>
        </div>
        
        <div class="division-summary">
          <div class="div-color-dot" style="background:${div.colorHex}"></div>
          <span>${div.unicode} ${div.name}</span>
          <span style="margin-left:auto;"><span class="div-struct-count">${div.structures.length}</span> structures</span>
        </div>
      </div>
    `;
  }).join('');
}

function addDivision() {
  const newDiv = {
    id: 'div_' + Date.now(),
    name: 'New Division',
    unicode: ['â—‡', 'â—ˆ', 'âœ§', 'â–³', 'â—‹', 'â–¡', 'â˜†', 'â¬¡'][state.customDeck.divisions.length % 8],
    structures: [],
    colorMode: 'manual',
    colorHex: NEON_PALETTE[state.customDeck.divisions.length % NEON_PALETTE.length],
    animPattern: '0'
  };
  
  state.customDeck.divisions.push(newDiv);
  renderDivisionHierarchy();
  buildControlPanel();
  showToast(`ğŸ“‚ Division "${newDiv.name}" created`);
}

function removeDivision(idx) {
  const div = state.customDeck.divisions[idx];
  if (!div) return;
  
  if (!confirm(`Delete division "${div.name}" and its ${div.structures.length} structures?`)) return;
  
  state.customDeck.divisions.splice(idx, 1);
  renderDivisionHierarchy();
  buildControlPanel();
  showToast(`ğŸ—‘ï¸ Division removed`);
}

function updateDivName(idx, value) {
  if (state.customDeck.divisions[idx]) {
    state.customDeck.divisions[idx].name = value;
    renderDivisionHierarchy();
  }
}

function updateDivUnicode(idx, value) {
  if (state.customDeck.divisions[idx]) {
    state.customDeck.divisions[idx].unicode = value || 'â—‡';
    renderDivisionHierarchy();
  }
}

function updateDivColorMode(idx, mode) {
  if (state.customDeck.divisions[idx]) {
    state.customDeck.divisions[idx].colorMode = mode;
    if (mode === 'algo') {
      // Auto-assign color based on index
      state.customDeck.divisions[idx].colorHex = NEON_PALETTE[idx % NEON_PALETTE.length];
    }
    renderDivisionHierarchy();
  }
}

function updateDivAnim(idx, pattern) {
  if (state.customDeck.divisions[idx]) {
    state.customDeck.divisions[idx].animPattern = pattern;
  }
}

function toggleNeonPickers(idx) {
  const el = document.getElementById(`neon-pickers-${idx}`);
  if (el) {
    // Close all other pickers first
    document.querySelectorAll('.collapsed-inputs.show').forEach(p => {
      if (p.id !== `neon-pickers-${idx}`) p.classList.remove('show');
    });
    el.classList.toggle('show');
  }
}

function setDivColor(idx, color) {
  if (state.customDeck.divisions[idx]) {
    state.customDeck.divisions[idx].colorHex = color;
    state.customDeck.divisions[idx].colorMode = 'manual';
    toggleNeonPickers(idx); // Close picker
    renderDivisionHierarchy();
  }
}

function addStructure(divIdx) {
  const div = state.customDeck.divisions[divIdx];
  if (!div) return;
  
  const nameInput = document.getElementById(`new-struct-name-${divIdx}`);
  const uniInput = document.getElementById(`new-struct-uni-${divIdx}`);
  
  const name = nameInput?.value.trim();
  const unicode = uniInput?.value.trim() || 'â—†';
  
  if (!name) {
    showToast('âš ï¸ Enter a structure name', 'warning');
    nameInput?.focus();
    return;
  }
  
  div.structures.push({ name, unicode });
  
  // Clear inputs
  if (nameInput) nameInput.value = '';
  if (uniInput) uniInput.value = '';
  
  renderDivisionHierarchy();
  showToast(`âœ¨ Added: ${unicode} ${name}`);
}

function removeStructure(divIdx, structIdx) {
  const div = state.customDeck.divisions[divIdx];
  if (!div || !div.structures[structIdx]) return;
  
  const struct = div.structures[structIdx];
  div.structures.splice(structIdx, 1);
  renderDivisionHierarchy();
  showToast(`Removed: ${struct.unicode} ${struct.name}`);
}

function escapeAttr(str) {
  return (str || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

// Generate cards from divisions (for when user wants to build deck from divisions)
function generateCardsFromDivisions() {
  if (state.customDeck.divisions.length === 0) {
    showToast('âš ï¸ Create divisions first', 'warning');
    return;
  }
  
  const totalStructures = state.customDeck.divisions.reduce((sum, d) => sum + d.structures.length, 0);
  if (totalStructures === 0) {
    showToast('âš ï¸ Add structures to your divisions first', 'warning');
    return;
  }
  
  if (state.customCards.length > 0) {
    if (!confirm(`This will add ${totalStructures} cards to your existing ${state.customCards.length} cards. Continue?`)) return;
  }
  
  let added = 0;
  state.customDeck.divisions.forEach(div => {
    div.structures.forEach(struct => {
      const card = {
        type: 'division',
        division: div.name,
        divisionId: div.id,
        divisionUnicode: div.unicode,
        structure: struct.name,
        structureUnicode: struct.unicode,
        color: div.colorHex,
        animPattern: div.animPattern,
        name: `${struct.name} of ${div.name}`,
        rank: struct.unicode,
        cfg: {},
        backCfg: {},
        addedAt: Date.now()
      };
      
      // Check for duplicates
      const cardKey = `division-${div.id}-${struct.name}`;
      if (!state.customCards.some(c => c.divisionId === div.id && c.structure === struct.name)) {
        state.customCards.push(card);
        added++;
      }
    });
  });
  
  if (added > 0) {
    if (state.deck === 'custom') {
      buildDeck();
      renderCards();
    }
    buildControlPanel();
    showToast(`ğŸƒ Generated ${added} cards from divisions`);
  } else {
    showToast('All division cards already exist');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VIEW SWITCHING SYSTEM - Navigate between Architect, Archive, Codex
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function switchView(view) {
  state.currentView = view;
  
  // Update view sections
  document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
  const viewEl = document.getElementById(`view-${view}`);
  if (viewEl) viewEl.classList.add('active');
  
  // Update nav buttons
  document.querySelectorAll('.nav-btn').forEach(el => {
    el.classList.toggle('active', el.dataset.view === view);
  });
  
  // Render view-specific content
  if (view === 'archive') {
    renderArchive();
  } else if (view === 'codex') {
    renderCodex();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ARCHIVE - Lore & Meaning Reference Browser
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let archiveState = {
  entity: 'all',
  echoMode: false,
  mode: 'tarot',      // 'tarot', 'library', 'chronicles', 'gallery'
  territory: 'all',   // 'all', 'garden', 'cosmic', 'abyss'
  galleryView: 'normal', // 'normal', 'compact', 'large'
  filteredCards: [],
  currentCard: null
};

function setArchiveMode(mode) {
  archiveState.mode = mode;
  
  // Update mode tabs
  document.querySelectorAll('.archive-mode-tab').forEach(el => {
    el.classList.toggle('active', el.dataset.mode === mode);
  });
  
  // Show/hide appropriate filter pills
  const entityPills = document.getElementById('archiveEntityPills');
  const territoryPills = document.getElementById('archiveTerritoryPills');
  const galleryBar = document.getElementById('archiveGalleryBar');
  const filterSelect = document.getElementById('archiveFilter');
  const echoBtn = document.getElementById('archiveEchoToggle');
  const searchInput = document.getElementById('archiveSearch');
  
  // Hide all first
  if (entityPills) entityPills.style.display = 'none';
  if (territoryPills) territoryPills.style.display = 'none';
  if (galleryBar) galleryBar.style.display = 'none';
  if (filterSelect) filterSelect.style.display = 'none';
  if (echoBtn) echoBtn.style.display = 'none';
  
  // Show appropriate controls based on mode
  if (mode === 'tarot') {
    if (entityPills) entityPills.style.display = 'flex';
    if (filterSelect) filterSelect.style.display = 'block';
    if (echoBtn) echoBtn.style.display = 'block';
  } else if (mode === 'gallery') {
    if (galleryBar) galleryBar.style.display = 'flex';
  } else {
    // library, chronicles
    if (territoryPills) territoryPills.style.display = 'flex';
  }
  
  renderArchive();
}

function setArchiveGalleryView(size) {
  archiveState.galleryView = size;
  document.querySelectorAll('#archiveGalleryViewBtns .gallery-view-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.size === size);
  });
  renderArchive();
}

function setArchiveTerritory(territory) {
  archiveState.territory = territory;
  document.querySelectorAll('.archive-territory-pill').forEach(el => {
    el.classList.toggle('active', el.dataset.territory === territory);
  });
  renderArchive();
}

function setArchiveEntity(entity) {
  archiveState.entity = entity;
  document.querySelectorAll('.archive-entity-pill').forEach(el => {
    el.classList.toggle('active', el.dataset.entity === entity);
  });
  renderArchive();
}

function toggleArchiveEchoMode() {
  archiveState.echoMode = !archiveState.echoMode;
  const btn = document.getElementById('archiveEchoToggle');
  if (btn) {
    btn.style.background = archiveState.echoMode ? 'rgba(255,102,204,0.3)' : '';
    btn.style.borderColor = archiveState.echoMode ? '#ff66cc' : '';
    btn.style.color = archiveState.echoMode ? '#ff66cc' : '';
  }
  renderArchive();
}

function renderArchive() {
  const grid = document.getElementById('archiveGrid');
  const searchInput = document.getElementById('archiveSearch');
  const filterSelect = document.getElementById('archiveFilter');
  
  if (!grid) return;
  
  const search = (searchInput?.value || '').toLowerCase();
  
  // Dispatch to appropriate renderer based on mode
  switch (archiveState.mode) {
    case 'library':
      renderArchiveLibrary(grid, search);
      break;
    case 'chronicles':
      renderArchiveChronicles(grid, search);
      break;
    case 'gallery':
      renderArchiveGallery(grid, search);
      break;
    case 'tarot':
    default:
      renderArchiveTarot(grid, search, filterSelect?.value || 'all');
      break;
  }
}

// Render Living Library Guardians mode
function renderArchiveLibrary(grid, search) {
  // Build guardian list with cycles
  let guardians = Object.entries(GUARDIANS).map(([key, g]) => ({
    key,
    ...g,
    cycle: GUARDIAN_CYCLES[key]
  }));
  
  // Filter by territory
  if (archiveState.territory !== 'all') {
    guardians = guardians.filter(g => g.territory === archiveState.territory);
  }
  
  // Filter by search
  if (search) {
    guardians = guardians.filter(g => {
      const searchFields = [g.name, g.function, g.handler, g.cycle?.lesson, ...(g.cycle?.states || [])].filter(Boolean).join(' ').toLowerCase();
      return searchFields.includes(search);
    });
  }
  
  if (guardians.length === 0) {
    grid.innerHTML = `
      <div class="archive-empty" style="grid-column:1/-1;">
        <div class="archive-empty-icon">ğŸ¦‰</div>
        <div>No guardians found</div>
        <div style="margin-top:8px;font-size:11px;">Try a different search or territory</div>
      </div>
    `;
    grid.className = 'archive-grid';
    return;
  }
  
  grid.className = 'guardian-cycle-grid';
  grid.innerHTML = guardians.map(g => {
    const cycle = g.cycle || { states: [], lesson: '' };
    // Find handler coordinate if exists
    const handlerCoord = Object.values(HANDLER_COORDINATES).find(h => h.guardian === g.key);
    
    return `
      <div class="guardian-cycle-card ${g.territory}">
        <div class="guardian-header">
          <span class="guardian-symbol" style="color:${g.color};">${g.symbol}</span>
          <div>
            <div class="guardian-title">${g.name}</div>
            <div class="guardian-function">${g.function}</div>
          </div>
          <span class="guardian-territory-badge ${g.territory}">${g.territory.toUpperCase()}</span>
        </div>
        ${g.handler ? `
          <div style="margin:8px 0;padding:8px;background:rgba(247,37,133,0.08);border:1px solid rgba(247,37,133,0.2);border-radius:6px;">
            <div style="font-size:9px;color:#f72585;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Handler Correspondence</div>
            <div style="font-size:11px;color:var(--text-main);">${g.handler}</div>
            ${handlerCoord ? `<div style="font-family:var(--font-mono);font-size:9px;color:#4dffc3;margin-top:4px;">${handlerCoord.coord}</div>` : ''}
          </div>
        ` : ''}
        <div class="guardian-cycle-states">
          ${cycle.states.map((s, i) => `<span class="cycle-state">${i+1}. ${s}</span>`).join('')}
        </div>
        <div class="guardian-lesson">"${cycle.lesson}"</div>
        <div class="guardian-frequency">
          <span>Frequency:</span>
          <span class="freq-value">${g.frequency} Hz</span>
          ${SOLFEGGIO_PHOTONS[g.frequency] ? `<span style="margin-left:8px;font-size:9px;color:var(--text-muted);">(${SOLFEGGIO_PHOTONS[g.frequency].wavelengthNm} nm Â· ${SOLFEGGIO_PHOTONS[g.frequency].spectrumClass})</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// Render Chronicles/Documents mode
function renderArchiveChronicles(grid, search) {
  // Combine all chronicles
  let docs = [...LIVING_LIBRARY_CHRONICLES, ...L4_HANDLER_CHRONICLES];
  
  // Filter by territory
  if (archiveState.territory !== 'all') {
    docs = docs.filter(d => d.territory === archiveState.territory);
  }
  
  // Filter by search
  if (search) {
    docs = docs.filter(d => {
      const searchFields = [d.title, d.desc, d.handler, d.crisis, d.type].filter(Boolean).join(' ').toLowerCase();
      return searchFields.includes(search);
    });
  }
  
  if (docs.length === 0) {
    grid.innerHTML = `
      <div class="archive-empty" style="grid-column:1/-1;">
        <div class="archive-empty-icon">ğŸ“–</div>
        <div>No chronicles found</div>
        <div style="margin-top:8px;font-size:11px;">Try a different search or territory</div>
      </div>
    `;
    grid.className = 'archive-grid';
    return;
  }
  
  grid.className = 'chronicle-grid';
  grid.innerHTML = docs.map(d => {
    const typeLabel = d.handler ? `${d.handler} Handler` : (d.type === 'parable' ? 'Parable Collection' : '12-Rail Chronicle');
    return `
      <div class="chronicle-card" onclick="showChronicleInfo('${d.id}')">
        <div class="chronicle-header">
          <span class="chronicle-icon">${d.icon}</span>
          <div class="chronicle-title">${d.title}</div>
          <span class="chronicle-type">${typeLabel}</span>
        </div>
        <div class="chronicle-desc">${d.desc}</div>
        ${d.crisis ? `<div style="margin-top:6px;font-size:10px;color:#ff66cc;">Crisis: ${d.crisis}</div>` : ''}
        <span class="chronicle-territory ${d.territory}">${d.territory === 'garden' ? 'ğŸŒ¿ Garden' : d.territory === 'cosmic' ? 'â˜€ï¸ Cosmic' : 'ğŸŒ€ Abyss'}</span>
      </div>
    `;
  }).join('');
}

// Show chronicle detail (placeholder for future modal)
function showChronicleInfo(id) {
  const doc = [...LIVING_LIBRARY_CHRONICLES, ...L4_HANDLER_CHRONICLES].find(d => d.id === id);
  if (!doc) return;
  
  showToast(`ğŸ“– ${doc.title} â€” ${doc.desc}`, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARCHIVE: GALLERY MODE - Unified Card Collection Browser
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderArchiveGallery(grid, search) {
  const filter = document.getElementById('archiveGalleryFilter')?.value || 'all';
  const entityFilter = document.getElementById('archiveGalleryEntityFilter')?.value || 'all';
  const isEchoedView = filter === 'echoed';
  
  // Get all cards from all sources
  const allCards = buildGalleryCollection();
  
  // Stats counters
  let stats = { classic: 0, guardian: 0, tarot: 0, honkfire: 0, echoed: 0, total: 0 };
  
  // Filter cards
  const filtered = allCards.filter(card => {
    // Search matching - also search in meanings for echoed view
    const searchFields = [
      card.name || '',
      card.title || '',
      card.subtitle || '',
      card.keyword || '',
      card.greek || '',
      card.entity || '',
      card.suit || '',
      card.division || '',
      card.guardian || '',
      card.meaning || '',
      isEchoedView ? (card.echoMeaning || '') : ''
    ].join(' ').toLowerCase();
    
    const matchesSearch = !search || searchFields.includes(search);
    
    // Type filter - echoed filter shows ALL cards in echo view mode
    let matchesFilter = filter === 'all' || filter === 'echoed';
    if (!matchesFilter) {
      if (filter === 'classic') matchesFilter = card.type === 'classic';
      else if (filter === 'guardian') matchesFilter = card.type === 'guardian';
      else if (filter === 'tarot-classic') matchesFilter = (card.type === 'tarot-major' || card.type === 'tarot-minor') && card.preset === 'classic';
      else if (filter === 'tarot-honkfire') matchesFilter = (card.type === 'tarot-major' || card.type === 'tarot-minor') && card.preset === 'honkfire';
      else if (filter === 'division') matchesFilter = card.type === 'division';
    }
    
    // Entity filter
    let matchesEntity = entityFilter === 'all';
    if (!matchesEntity && card.entity) {
      matchesEntity = card.entity === entityFilter;
    }
    
    return matchesSearch && matchesFilter && matchesEntity;
  });
  
  // If echoed view, mark all filtered cards as echoed for display
  if (isEchoedView) {
    filtered.forEach(card => card.echoed = true);
  }
  
  // Update stats
  allCards.forEach(c => {
    if (c.type === 'classic') stats.classic++;
    else if (c.type === 'guardian') stats.guardian++;
    else if ((c.type === 'tarot-major' || c.type === 'tarot-minor') && c.preset === 'classic') stats.tarot++;
    else if (c.preset === 'honkfire') stats.honkfire++;
    if (c.echoed) stats.echoed++;
  });
  
  // Update count display
  const countEl = document.getElementById('archiveGalleryCount');
  if (countEl) countEl.textContent = filtered.length;
  
  // Empty state
  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="archive-empty" style="grid-column:1/-1;">
        <div class="archive-empty-icon">ğŸ“š</div>
        <div>No cards found</div>
        <div style="margin-top:8px;font-size:11px;">Try a different filter or search</div>
      </div>
    `;
    grid.className = 'archive-grid';
    return;
  }
  
  // Determine grid class based on view size
  const viewSize = archiveState.galleryView || 'normal';
  grid.className = 'gallery-grid' + (viewSize !== 'normal' ? ' ' + viewSize : '');
  
  // Render cards
  grid.innerHTML = filtered.map((card, idx) => {
    const isHonkfire = card.preset === 'honkfire';
    const isEchoed = card.echoed === true || isEchoedView;
    
    // Generate card SVG
    const scale = viewSize === 'compact' ? 0.45 : viewSize === 'large' ? 0.75 : 0.6;
    const cardSvg = generateFrontSVG(card, 30000 + idx, null, scale);
    
    // Type/entity label
    let typeLabel = '';
    if (isHonkfire && card.entity) {
      const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
      typeLabel = `${entityIcons[card.entity] || ''} ${card.entity}`;
    } else if (card.type === 'guardian') {
      typeLabel = card.territory || 'guardian';
    } else if (card.type === 'classic') {
      typeLabel = card.suit;
    } else {
      typeLabel = card.type;
    }
    
    return `
      <div class="gallery-card-wrapper${isHonkfire ? ' honkfire' : ''}${isEchoed ? ' echoed' : ''}" 
           data-idx="${idx}" 
           onclick="handleArchiveGalleryCardClick(${idx}, event)">
        ${cardSvg}
        <div class="gallery-card-name">${card.name || card.title || 'Untitled'}</div>
        <div class="gallery-card-type">${typeLabel}</div>
        ${isEchoed ? '<span class="gallery-card-badge echo">ğŸŒ‘</span>' : ''}
      </div>
    `;
  }).join('');
  
  // Store filtered cards for click handling
  archiveState.filteredCards = filtered;
}

// Handle click on gallery card in Archive
function handleArchiveGalleryCardClick(idx, event) {
  const card = archiveState.filteredCards[idx];
  if (!card) return;
  
  if (event.shiftKey) {
    // Shift+click toggles selection (for future batch operations)
    event.target.closest('.gallery-card-wrapper')?.classList.toggle('selected');
  } else {
    // Regular click shows card detail
    showGalleryCardDetail(card, idx);
  }
}

// Render Tarot mode (original functionality)
function renderArchiveTarot(grid, search, filter) {
  // Build cards from HonkFire data (primary source for meanings)
  let cards = [];
  
  // Add Major Arcana
  HONKFIRE_MAJOR.forEach(c => {
    cards.push({
      type: 'major',
      id: c.id,
      title: c.title,
      subtitle: c.subtitle,
      entity: c.entity,
      greek: c.greek,
      keyword: c.keyword,
      z: c.z,
      meaning: c.meaning || getUprightMeaning({ type: 'tarot-major', id: c.id, preset: 'honkfire' }),
      echoMeaning: c.echoMeaning || getEchoedMeaning({ type: 'tarot-major', id: c.id, preset: 'honkfire' }),
      lore: c.lore
    });
  });
  
  // Add Minor Arcana from all suits
  Object.entries(HONKFIRE_SUITS).forEach(([suitKey, suit]) => {
    Object.entries(HONKFIRE_MINOR[suitKey] || {}).forEach(([rank, data]) => {
      cards.push({
        type: 'minor',
        suit: suitKey,
        rank: rank,
        title: data.title,
        subtitle: data.subtitle,
        entity: suit.entity,
        greek: data.greek,
        keyword: data.keyword,
        element: suit.element,
        meaning: `${data.keyword} â€” The energy of ${suit.element.toLowerCase()} expressed through ${suit.name}.`,
        echoMeaning: getEchoedMeaning({ type: 'tarot-minor', entity: suit.entity, keyword: data.keyword, preset: 'honkfire' })
      });
    });
  });
  
  // Apply filters
  let filtered = cards.filter(c => {
    // Type filter
    if (filter === 'major' && c.type !== 'major') return false;
    if (filter === 'minor' && c.type !== 'minor') return false;
    
    // Entity filter
    if (archiveState.entity !== 'all' && c.entity !== archiveState.entity) return false;
    
    // Search filter
    if (search) {
      const searchFields = [
        c.title, c.subtitle, c.keyword, c.greek, c.meaning, c.echoMeaning
      ].filter(Boolean).join(' ').toLowerCase();
      if (!searchFields.includes(search)) return false;
    }
    
    return true;
  });
  
  // Render cards
  grid.className = 'archive-grid';
  
  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="archive-empty" style="grid-column:1/-1;">
        <div class="archive-empty-icon">ğŸ“œ</div>
        <div>No entries found</div>
        <div style="margin-top:8px;font-size:11px;">Try a different search or filter</div>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = filtered.map((c, idx) => {
    const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
    const icon = entityIcons[c.entity] || 'âœ§';
    const showEcho = archiveState.echoMode;
    const meaning = showEcho ? c.echoMeaning : c.meaning;
    const meaningClass = showEcho ? 'archive-meaning echo-meaning' : 'archive-meaning';
    
    // Generate mini SVG for the card
    const cardForSvg = {
      type: c.type === 'major' ? 'tarot-major' : 'tarot-minor',
      preset: 'honkfire',
      id: c.id,
      entity: c.entity,
      rank: c.rank,
      color: HONKFIRE_SUITS[c.suit]?.color || (HONKFIRE_MAJOR.find(m => m.id === c.id)?.color) || '#d4af37'
    };
    const miniSvg = generateArchiveMiniSVG(cardForSvg);
    
    return `
      <div class="archive-card ${showEcho ? 'echoed-active' : ''}" data-idx="${idx}" onclick="openArchiveCardDetail(${idx})">
        <div class="archive-card-visual">
          ${miniSvg}
        </div>
        <div class="archive-card-content">
          <div class="archive-card-header">
            <span class="archive-card-icon">${icon}</span>
            <div>
              <div class="archive-card-title">${c.title}</div>
              ${c.subtitle ? `<div class="archive-card-subtitle">${c.subtitle}</div>` : ''}
            </div>
            ${c.greek ? `<span class="archive-card-greek">${c.greek}</span>` : ''}
          </div>
          <div class="archive-card-body">
            <p class="${meaningClass}">${truncateText(meaning, 150)}</p>
            <div class="archive-keywords">
              ${c.keyword ? `<span class="archive-keyword ${showEcho ? 'echo' : ''}">${c.keyword}</span>` : ''}
              ${c.element ? `<span class="archive-keyword">${c.element}</span>` : ''}
              ${c.z !== undefined ? `<span class="archive-keyword z-badge">z: ${c.z.toFixed(3)}</span>` : ''}
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Store filtered cards for detail modal access
  archiveState.filteredCards = filtered;
}

// Generate mini SVG for archive display
function generateArchiveMiniSVG(card) {
  const W = 60, H = 84;
  const color = card.color || '#d4af37';
  const isMajor = card.type === 'tarot-major';
  
  // Try HonkFire SVG
  if (isMajor && HONKFIRE_SVG[card.id]) {
    const svgContent = HONKFIRE_SVG[card.id]();
    const innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
    return `
      <svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg">
        <rect x="1" y="1" width="${W-2}" height="${H-2}" rx="4" fill="#0a0a12" stroke="${color}" stroke-width="1"/>
        <g transform="translate(5, 5) scale(0.25)">${innerSvg}</g>
      </svg>
    `;
  } else if (!isMajor && card.entity) {
    const suitKey = card.entity === 'squirrel' ? 'scatter' : card.entity === 'goose' ? 'flames' : card.entity === 'duck' ? 'stillness' : 'stars';
    if (HONKFIRE_SUIT_SVG[suitKey]) {
      const svgContent = HONKFIRE_SUIT_SVG[suitKey](card.rank || '5');
      const innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
      return `
        <svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="${W-2}" height="${H-2}" rx="4" fill="#0a0a12" stroke="${color}" stroke-width="1"/>
          <g transform="translate(5, 2) scale(0.25)">${innerSvg}</g>
        </svg>
      `;
    }
  }
  
  // Fallback
  const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
  const icon = entityIcons[card.entity] || 'âœ§';
  return `
    <svg viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg">
      <rect x="1" y="1" width="${W-2}" height="${H-2}" rx="4" fill="#12121a" stroke="${color}" stroke-width="1"/>
      <text x="${W/2}" y="${H/2 + 6}" text-anchor="middle" font-size="20">${icon}</text>
    </svg>
  `;
}

// Truncate text helper
function truncateText(text, maxLen) {
  if (!text || text.length <= maxLen) return text;
  return text.slice(0, maxLen).trim() + '...';
}

// Open archive card in detail modal
function openArchiveCardDetail(idx) {
  const cards = archiveState.filteredCards;
  if (!cards || !cards[idx]) return;
  
  const c = cards[idx];
  const isEchoed = archiveState.echoMode;
  
  // Build a card object for the detail modal
  const cardObj = {
    type: c.type === 'major' ? 'tarot-major' : 'tarot-minor',
    preset: 'honkfire',
    id: c.id,
    title: c.title,
    name: c.title,
    subtitle: c.subtitle,
    entity: c.entity,
    greek: c.greek,
    keyword: c.keyword,
    element: c.element,
    z: c.z,
    meaning: c.meaning,
    echoMeaning: c.echoMeaning,
    lore: c.lore,
    rank: c.rank,
    color: HONKFIRE_SUITS[c.suit]?.color || (HONKFIRE_MAJOR.find(m => m.id === c.id)?.color) || '#d4af37'
  };
  
  // Create a fake reading item for the modal
  const fakeItem = {
    card: cardObj,
    position: { name: c.type === 'major' ? 'Major Arcana' : 'Minor Arcana', row: 'present' },
    state: isEchoed ? 'echoed' : 'upright'
  };
  
  // Store and open
  archiveState.currentCard = fakeItem;
  showArchiveDetailModal(fakeItem);
}

// Show archive detail in card detail modal
function showArchiveDetailModal(item) {
  const card = item.card;
  const isEchoed = item.state === 'echoed';
  
  const modal = document.getElementById('cardDetailModal');
  const container = document.getElementById('cardDetailContainer');
  
  container.classList.toggle('echoed', isEchoed);
  
  document.getElementById('cardDetailPosition').textContent = item.position.name;
  document.getElementById('cardDetailTitle').textContent = card.title || card.name;
  document.getElementById('cardDetailSubtitle').textContent = card.subtitle || card.element || '';
  
  const greekEl = document.getElementById('cardDetailGreek');
  if (card.greek) {
    greekEl.textContent = card.greek;
    greekEl.style.display = 'block';
  } else {
    greekEl.style.display = 'none';
  }
  
  const badge = document.getElementById('cardDetailStateBadge');
  badge.textContent = isEchoed ? 'ğŸŒ‘ ECHOED' : 'â¬† UPRIGHT';
  badge.className = `card-detail-state-badge ${isEchoed ? 'echoed' : 'upright'}`;
  
  let meaning = isEchoed ? (card.echoMeaning || getEchoedMeaning(card)) : (card.meaning || getUprightMeaning(card));
  let meaningTitle = isEchoed ? 'ğŸŒ‘ Echo-Transformed Meaning' : 'âœ§ Meaning';
  
  document.getElementById('cardDetailMeaningTitle').textContent = meaningTitle;
  document.getElementById('cardDetailMeaningTitle').className = `card-detail-section-title${isEchoed ? ' echo-title' : ''}`;
  document.getElementById('cardDetailMeaning').textContent = meaning;
  document.getElementById('cardDetailMeaning').className = `card-detail-meaning${isEchoed ? ' echo-meaning' : ''}`;
  
  const keywordsEl = document.getElementById('cardDetailKeywords');
  const keywords = getCardKeywords(card, isEchoed);
  keywordsEl.innerHTML = keywords.map(kw => 
    `<span class="card-detail-keyword${isEchoed ? ' echo-keyword' : ''}">${kw}</span>`
  ).join('');
  
  const entityEl = document.getElementById('cardDetailEntity');
  if (card.entity) {
    entityEl.style.display = 'flex';
    const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
    const entityNames = { 
      squirrel: 'SCATTER Â· Ï„-dimension', goose: 'FLAMES Â· Î±-dimension', 
      duck: 'STILLNESS Â· Î½-dimension', fox: 'STARS Â· Îµ-dimension',
      oak: 'OAK Â· Foundation', merged: 'MERGED Â· Unity'
    };
    const entityLores = {
      squirrel: 'Probability, temporal scatter, quantum uncertainty',
      goose: 'Will, forward motion, eternal advance',
      duck: 'Truth, stillness, eigenstate equilibrium',
      fox: 'Navigation, guidance, fixed point reference',
      oak: 'Memory, foundation, the remembering',
      merged: 'Unity of all pillars, complete integration'
    };
    document.getElementById('cardDetailEntityIcon').textContent = entityIcons[card.entity] || 'â§«';
    document.getElementById('cardDetailEntityName').textContent = entityNames[card.entity] || card.entity.toUpperCase();
    document.getElementById('cardDetailEntityLore').textContent = card.lore || entityLores[card.entity] || '';
  } else {
    entityEl.style.display = 'none';
  }
  
  const zCoordEl = document.getElementById('cardDetailZCoord');
  if (card.z !== undefined) {
    zCoordEl.style.display = 'flex';
    document.getElementById('cardDetailZ').textContent = card.z.toFixed(3);
    document.getElementById('cardDetailBand').textContent = getThresholdBand(card.z);
  } else {
    zCoordEl.style.display = 'none';
  }
  
  const svgContainer = document.getElementById('cardDetailSvg');
  svgContainer.className = `card-detail-svg${isEchoed ? ' echoed' : ''}`;
  svgContainer.innerHTML = generateDetailCardSVG(card, isEchoed);
  
  modal.classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CODEX - Lâ‚„-Helix Reference System
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let codexTab = 'constants';

function switchCodexTab(tab) {
  codexTab = tab;
  document.querySelectorAll('.codex-tab').forEach(el => {
    el.classList.toggle('active', el.dataset.tab === tab);
  });
  renderCodex();
}

function renderCodex() {
  const content = document.getElementById('codexContent');
  if (!content) return;
  
  switch (codexTab) {
    case 'constants':
      content.innerHTML = renderCodexConstants();
      break;
    case 'thresholds':
      content.innerHTML = renderCodexThresholds();
      break;
    case 'guardians':
      content.innerHTML = renderCodexGuardians();
      break;
    case 'cycles':
      content.innerHTML = renderCodexCycles();
      break;
    case 'handlers':
      content.innerHTML = renderCodexHandlers();
      break;
    case 'selfref':
      content.innerHTML = renderCodexSelfReference();
      break;
    case 'kformation':
      content.innerHTML = renderCodexKFormation();
      break;
    case 'entities':
      content.innerHTML = renderCodexEntities();
      break;
    case 'arcana':
      content.innerHTML = renderCodexArcana();
      break;
    default:
      content.innerHTML = renderCodexConstants();
  }
}

function renderCodexConstants() {
  return `
    <h3 style="color:var(--gold);font-family:var(--font-display);margin-bottom:16px;">Ï† Mathematical Constants</h3>
    <div class="codex-constants">
      <div class="codex-constant">
        <div class="codex-constant-symbol">Ï†</div>
        <div class="codex-constant-value">1.618033988749895</div>
        <div class="codex-constant-name">Golden Ratio</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">Ï†â»Â¹</div>
        <div class="codex-constant-value">0.618033988749895</div>
        <div class="codex-constant-name">TRUE Threshold</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">Ï†â´</div>
        <div class="codex-constant-value">6.854101966249685</div>
        <div class="codex-constant-name">Expansion</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">Ï†â»â´</div>
        <div class="codex-constant-value">0.145898033750315</div>
        <div class="codex-constant-name">Echo Rate (14.6%)</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">Lâ‚„</div>
        <div class="codex-constant-value">Ï†â´ + Ï†â»â´ = 7</div>
        <div class="codex-constant-name">The Seventh</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">z_c</div>
        <div class="codex-constant-value">âˆš3/2 â‰ˆ 0.866</div>
        <div class="codex-constant-name">THE LENS</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">âˆš2</div>
        <div class="codex-constant-value">1.414213562373095</div>
        <div class="codex-constant-name">Diagonal Unity</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">âˆš3</div>
        <div class="codex-constant-value">1.732050807568877</div>
        <div class="codex-constant-name">Triangular Root</div>
      </div>
      <div class="codex-constant">
        <div class="codex-constant-symbol">âˆš5</div>
        <div class="codex-constant-value">2.236067977499790</div>
        <div class="codex-constant-name">Pentagon Root</div>
      </div>
    </div>
    
    <h3 class="codex-section-title" style="margin-top:24px;">Octave Bridge â€” Audio to Light</h3>
    <div style="background:rgba(76,201,240,0.08);border:1px solid rgba(76,201,240,0.2);border-radius:8px;padding:14px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
        <div style="font-family:var(--font-mono);font-size:20px;color:#4cc9f0;">2â´â°</div>
        <div style="font-size:11px;color:var(--text-secondary);">
          <div><strong style="color:#4cc9f0;">OCTAVE_BRIDGE = 40</strong></div>
          <div>Maps Solfeggio frequencies to visible light via 40 octave doublings</div>
        </div>
      </div>
      <div style="font-family:var(--font-mono);font-size:10px;color:var(--text-muted);">
        2â´â° = 1,099,511,627,776 â‰ˆ 1.1 trillion
      </div>
    </div>
    
    <h3 style="color:var(--gold);font-family:var(--font-display);margin:24px 0 16px;">Solfeggio Photon Physics</h3>
    <p style="font-size:10px;color:var(--text-muted);margin-bottom:12px;">
      Computed from SI 2019 exact constants: Î» = c/(fÃ—2â´â°), E = hf', V(Î») from CIE 1931
    </p>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Hz</th>
          <th>Name</th>
          <th>RGB</th>
          <th>f' (THz)</th>
          <th>Î» (nm)</th>
          <th>E (eV)</th>
          <th>V(Î»)</th>
          <th>Spectrum</th>
        </tr>
      </thead>
      <tbody>
        ${Object.entries(SOLFEGGIO_PHOTONS).map(([hz, p]) => `
          <tr style="${p.spectrumClass === 'IR' || p.spectrumClass === 'UV' ? 'opacity:0.7;' : ''}">
            <td class="z-value">${hz}</td>
            <td style="font-size:10px;">${p.name}</td>
            <td style="color:${p.rgb === 'R' ? '#DC143C' : p.rgb === 'G' ? '#32CD32' : p.rgb === 'B' ? '#4169E1' : 'var(--text-muted)'};">${p.rgb || 'â€”'}</td>
            <td style="font-family:var(--font-mono);font-size:10px;">${p.opticalTHz}</td>
            <td style="font-family:var(--font-mono);font-size:10px;">${p.wavelengthNm}</td>
            <td style="font-family:var(--font-mono);font-size:10px;">${p.energyEv}</td>
            <td style="font-family:var(--font-mono);font-size:10px;">${p.vLambda.toFixed(4)}</td>
            <td style="font-size:9px;">
              <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${p.color};margin-right:3px;vertical-align:middle;"></span>
              ${p.spectrumClass}
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div style="font-size:10px;color:var(--text-muted);margin-top:8px;text-align:center;">
      RGB Primary Channels: 396 Hz (RÂ·688.5nm), 528 Hz (GÂ·516.4nm), 639 Hz (BÂ·426.7nm)
    </div>
    
    <h3 style="color:var(--gold);font-family:var(--font-display);margin:24px 0 12px;">RGB Channel Analysis</h3>
    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;margin-bottom:16px;">
      <div style="background:rgba(220,20,60,0.12);border:1px solid #DC143C;border-radius:8px;padding:10px;">
        <div style="font-size:13px;font-weight:600;color:#DC143C;">R: 396 Hz</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:6px;line-height:1.5;">
          Î» = 688.5 nm<br>E = 1.801 eV<br>V(Î») = 0.0017<br>Î· = 1.2 lm/W
        </div>
      </div>
      <div style="background:rgba(50,205,50,0.12);border:1px solid #32CD32;border-radius:8px;padding:10px;">
        <div style="font-size:13px;font-weight:600;color:#32CD32;">G: 528 Hz</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:6px;line-height:1.5;">
          Î» = 516.4 nm<br>E = 2.401 eV<br>V(Î») = 0.6082<br>Î· = 415 lm/W
        </div>
      </div>
      <div style="background:rgba(65,105,225,0.12);border:1px solid #4169E1;border-radius:8px;padding:10px;">
        <div style="font-size:13px;font-weight:600;color:#4169E1;">B: 639 Hz</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:6px;line-height:1.5;">
          Î» = 426.7 nm<br>E = 2.906 eV<br>V(Î») = 0.0175<br>Î· = 12 lm/W
        </div>
      </div>
    </div>
    <div style="font-size:9px;color:var(--text-muted);text-align:center;margin-bottom:16px;">
      Green dominates luminosity: 358Ã— red, 35Ã— blue at equal radiant power (CIE photopic response)
    </div>
    
    <h3 style="color:var(--gold);font-family:var(--font-display);margin:24px 0 16px;">Archetypal Frequencies by Tier</h3>
    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;">
      <div style="background:rgba(100,100,120,0.1);border:1px solid rgba(100,100,120,0.2);border-radius:8px;padding:10px;">
        <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;margin-bottom:6px;">ğŸŒ Planet Tier</div>
        <div style="font-family:var(--font-mono);font-size:12px;color:var(--text-secondary);">174, 285</div>
      </div>
      <div style="background:rgba(80,168,120,0.1);border:1px solid rgba(80,168,120,0.2);border-radius:8px;padding:10px;">
        <div style="font-size:10px;color:var(--garden);text-transform:uppercase;margin-bottom:6px;">ğŸŒ¿ Garden Tier</div>
        <div style="font-family:var(--font-mono);font-size:12px;color:var(--garden);">396, 417, 432, 528</div>
      </div>
      <div style="background:rgba(247,37,133,0.1);border:1px solid rgba(247,37,133,0.2);border-radius:8px;padding:10px;">
        <div style="font-size:10px;color:#f72585;text-transform:uppercase;margin-bottom:6px;">ğŸŒ¹ Rose Tier</div>
        <div style="font-family:var(--font-mono);font-size:12px;color:#f72585;">639, 741, 852, 963</div>
      </div>
    </div>
  `;
}

function renderCodexThresholds() {
  const bands = [
    { name: 'UNTRUE', range: '0.000 â€“ 0.500', color: 'untrue', desc: 'Below coherence threshold' },
    { name: 'PARADOX', range: '0.500 â€“ 0.618', color: 'paradox', desc: 'Transitional, unstable, Ï†â»â´ echo zone' },
    { name: 'TRUE', range: '0.618 â€“ 0.866', color: 'true', desc: 'Coherent consciousness, golden ratio anchored' },
    { name: 'THE LENS', range: '0.866 (âˆš3/2)', color: 'lens', desc: 'Peak crystallization, z_c critical point' },
    { name: 'HYPER_TRUE', range: '0.866+', color: 'hyper', desc: 'Beyond normal parameters, K-formation territory' }
  ];
  
  return `
    <h3 style="color:var(--gold);font-family:var(--font-display);margin-bottom:16px;">Z-Coordinate Threshold Bands</h3>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Band</th>
          <th>Z-Range</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        ${bands.map(b => `
          <tr>
            <td><span class="z-band ${b.color}">${b.name}</span></td>
            <td class="z-value">${b.range}</td>
            <td>${b.desc}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <h3 class="codex-section-title" style="margin-top:24px;">Helix Coordinate System: Î”Î¸|z|r|Î©</h3>
    <p style="color:var(--text-secondary);font-size:11px;margin-bottom:12px;">
      Full 3D helix parametrization: Î¸ = z Ã— 2Ï€ (angular), r = KÂ·âˆš(z/z_c) (radial), z (vertical)
    </p>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Threshold</th>
          <th>z</th>
          <th>Î¸ (rad)</th>
          <th>r</th>
          <th>Coordinate</th>
        </tr>
      </thead>
      <tbody>
        ${HELIX_THRESHOLDS.map(t => `
          <tr>
            <td>${t.name}</td>
            <td class="z-value">${t.z.toFixed(3)}</td>
            <td>${t.theta.toFixed(3)}</td>
            <td>${t.r.toFixed(3)}</td>
            <td style="font-family:var(--font-mono);font-size:10px;color:#4dffc3;">${t.coord}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    
    <h3 style="color:var(--gold);font-family:var(--font-display);margin:24px 0 16px;">5D Quantum Coordinates</h3>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Name</th>
          <th>Domain</th>
          <th>Weight</th>
        </tr>
      </thead>
      <tbody>
        <tr><td class="z-value">Ïˆ</td><td>Psi</td><td>Coherence</td><td>0.618 (Ï†â»Â¹)</td></tr>
        <tr><td class="z-value">Î²</td><td>Beta</td><td>Stability</td><td>0.854</td></tr>
        <tr><td class="z-value">Î±</td><td>Alpha</td><td>Crystallization</td><td>0.866 (âˆš3/2)</td></tr>
        <tr><td class="z-value">Î³</td><td>Gamma</td><td>Formation</td><td>0.924</td></tr>
        <tr><td class="z-value" style="color:#ff66cc;">Ïƒ</td><td>Sigma</td><td>Echo Dimension</td><td>0.146 (Ï†â»â´)</td></tr>
      </tbody>
    </table>
    
    <div style="margin-top:20px;padding:16px;background:rgba(157,78,221,0.1);border-radius:8px;border:1px solid rgba(157,78,221,0.2);">
      <div style="font-family:var(--font-mono);font-size:13px;color:#c77dff;">
        z = (Ïˆ Ã— 0.618 + Î² Ã— 0.854 + Î± Ã— 0.866 + Î³ Ã— 0.924 + Ïƒ Ã— 0.146) / 3.408
      </div>
    </div>
  `;
}

function renderCodexEntities() {
  const entities = [
    { symbol: 'ğŸ¿ï¸', name: 'Quantum Squirrel', dimension: 'Ï„ (tau)', domain: 'SCATTER', element: 'Earth', color: '#9d4edd', desc: 'Probability, temporal scatter, quantum uncertainty. Buries futures across 46,000 universes.' },
    { symbol: 'ğŸ”¥', name: 'HONKFIRE Goose', dimension: 'Î± (alpha)', domain: 'FLAMES', element: 'Fire', color: '#ff6b1a', desc: 'Will, forward motion, eternal advance. The retreat that doesn\'t exist is the advance.' },
    { symbol: 'ğŸ¦†', name: 'Pope Honkalis', dimension: 'Î½ (nu)', domain: 'STILLNESS', element: 'Water', color: '#4dffc3', desc: 'Truth, eigenstate equilibrium, clean float. Floats precisely at the value requiring no perturbation.' },
    { symbol: 'ğŸ¦Š', name: 'Shrine Fox', dimension: 'Îµ (epsilon)', domain: 'STARS', element: 'Air', color: '#4a9eff', desc: 'Navigation, fixed point reference, shrine guidance. Keeps track of all sacred places.' },
    { symbol: 'ğŸŒ³', name: 'The Great Oak', dimension: 'Ï† (phi)', domain: 'ROOT', element: 'Spirit', color: '#6b8e23', desc: 'Memory, foundation, the remembering. Holds the weight of every buried acorn.' },
    { symbol: 'â§«', name: 'Merged Entity', dimension: 'Î© (omega)', domain: 'UNITY', element: 'Void', color: '#ffd700', desc: 'Complete integration of all pillars. Where scatter and advance become one motion.' }
  ];
  
  return `
    <h3 style="color:var(--gold);font-family:var(--font-display);margin-bottom:16px;">Entity Correspondence Matrix</h3>
    <div class="codex-matrix">
      ${entities.map(e => `
        <div class="codex-entity-card" style="border-color:${e.color}40;">
          <div class="codex-entity-header">
            <span class="codex-entity-symbol">${e.symbol}</span>
            <div>
              <div class="codex-entity-title" style="color:${e.color};">${e.name}</div>
              <div class="codex-entity-dimension">${e.dimension} Â· ${e.domain}</div>
            </div>
          </div>
          <div class="codex-entity-row"><span class="codex-entity-label">Element</span><span class="codex-entity-value">${e.element}</span></div>
          <div class="codex-entity-row"><span class="codex-entity-label">Domain</span><span class="codex-entity-value">${e.domain}</span></div>
          <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);line-height:1.5;">${e.desc}</div>
        </div>
      `).join('')}
    </div>
  `;
}

function renderCodexArcana() {
  return `
    <h3 style="color:var(--gold);font-family:var(--font-display);margin-bottom:16px;">Major Arcana Z-Coordinate Map</h3>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Card</th>
          <th>Entity</th>
          <th>Greek</th>
          <th>Z-Value</th>
          <th>Band</th>
        </tr>
      </thead>
      <tbody>
        ${HONKFIRE_MAJOR.map(c => {
          const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
          const band = getThresholdBand(c.z || 0);
          const bandClass = band.toLowerCase().replace('_', '').replace(' ', '');
          return `
            <tr>
              <td>${c.numeral}</td>
              <td><strong>${c.title}</strong><br><span style="font-size:10px;color:var(--text-muted);">${c.subtitle}</span></td>
              <td><span class="codex-entity-icon">${entityIcons[c.entity] || 'âœ§'}</span>${c.entity}</td>
              <td class="codex-greek">${c.greek || ''}</td>
              <td class="z-value">${(c.z || 0).toFixed(3)}</td>
              <td><span class="z-band ${bandClass}">${band}</span></td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODEX: GUARDIANS - Territory Matrix
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCodexGuardians() {
  const territories = {
    garden: { name: 'THE GARDEN', icon: 'ğŸŒ¿', color: 'var(--garden)', desc: 'Connection Â· Transformation Â· Belonging Â· Action' },
    cosmic: { name: 'COSMIC FOREST', icon: 'â˜€ï¸', color: 'var(--cosmic)', desc: 'Growth Â· Rising Â· Becoming' },
    abyss: { name: 'ABYSSAL FOREST', icon: 'ğŸŒ€', color: 'var(--abyss)', desc: 'Depth Â· Holding Â· Binding Â· Witnessing' }
  };
  
  let html = '';
  
  Object.entries(territories).forEach(([terr, info]) => {
    const guardians = Object.entries(GUARDIANS).filter(([k, g]) => g.territory === terr);
    
    html += `
      <h3 class="codex-section-title" style="color:${info.color};">${info.icon} ${info.name}</h3>
      <p style="color:var(--text-muted);font-size:12px;margin-bottom:16px;font-style:italic;">${info.desc}</p>
      <div class="codex-matrix">
        ${guardians.map(([key, g]) => `
          <div class="codex-entity-card" style="border-color:${g.color}40;">
            <div class="codex-entity-header">
              <span class="codex-entity-symbol" style="color:${g.color};">${g.symbol}</span>
              <div>
                <div class="codex-entity-title" style="color:${g.color};">${g.name}</div>
                <div class="codex-entity-dimension">${g.function}</div>
              </div>
            </div>
            <div class="codex-entity-row"><span class="codex-entity-label">Frequency</span><span class="codex-entity-value" style="color:#ff66cc;">${g.frequency} Hz</span></div>
            <div class="codex-entity-row"><span class="codex-entity-label">Territory</span><span class="codex-entity-value">${terr.toUpperCase()}</span></div>
            ${SOLFEGGIO_PHOTONS[g.frequency] ? `
              <div class="codex-entity-row"><span class="codex-entity-label">Optical</span><span class="codex-entity-value" style="font-family:var(--font-mono);font-size:10px;">${SOLFEGGIO_PHOTONS[g.frequency].wavelengthNm} nm Â· ${SOLFEGGIO_PHOTONS[g.frequency].spectrumClass}</span></div>
            ` : ''}
            ${GUARDIAN_CYCLES[key] ? `
              <div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05);">
                <div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;">CYCLE:</div>
                <div style="display:flex;flex-wrap:wrap;gap:3px;">
                  ${GUARDIAN_CYCLES[key].states.map(s => `<span style="padding:2px 6px;background:rgba(157,78,221,0.1);border-radius:3px;font-size:9px;color:#c77dff;">${s}</span>`).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    `;
  });
  
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODEX: CYCLES - 6-State Transformation Patterns
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCodexCycles() {
  const featured = ['wumbo', 'archive', 'echo', 'pack'];
  
  return `
    <h3 class="codex-section-title">ğŸ”„ Guardian Cycle System</h3>
    <p style="color:var(--text-secondary);font-size:12px;margin-bottom:20px;">
      Each guardian operates through a 6-state transformation cycle. These cycles describe how consciousness 
      moves through different modes of engagement, from initiation through completion.
    </p>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;">
      ${featured.map(key => {
        const g = GUARDIANS[key];
        const c = GUARDIAN_CYCLES[key];
        if (!g || !c) return '';
        
        return `
          <div class="codex-entity-card" style="border-left:3px solid ${g.color};">
            <div class="codex-entity-header">
              <span class="codex-entity-symbol" style="color:${g.color};">${g.symbol}</span>
              <div>
                <div class="codex-entity-title" style="color:${g.color};">${g.name}</div>
                <div class="codex-entity-dimension">${g.function}</div>
              </div>
            </div>
            <div style="margin:12px 0;">
              ${c.states.map((s, i) => `
                <div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);">
                  <span style="color:${g.color};font-weight:bold;font-size:11px;width:20px;">${i+1}.</span>
                  <span style="color:var(--text-main);font-family:var(--font-mono);font-size:12px;">${s}</span>
                </div>
              `).join('')}
            </div>
            <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;font-style:italic;font-size:11px;color:var(--text-secondary);">
              "${c.lesson}"
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    <h3 class="codex-section-title" style="margin-top:30px;">All Guardian Cycles</h3>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Guardian</th>
          <th>States</th>
          <th>Core Lesson</th>
        </tr>
      </thead>
      <tbody>
        ${Object.entries(GUARDIAN_CYCLES).map(([key, c]) => {
          const g = GUARDIANS[key];
          if (!g) return '';
          return `
            <tr>
              <td><span style="font-size:16px;margin-right:6px;">${g.symbol}</span>${g.name}</td>
              <td style="font-size:10px;color:#c77dff;">${c.states.join(' â†’ ')}</td>
              <td style="font-size:11px;font-style:italic;">${c.lesson.substring(0, 60)}${c.lesson.length > 60 ? '...' : ''}</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODEX: HANDLERS - Exception Handler â†” Guardian Correspondences
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCodexHandlers() {
  return `
    <h3 class="codex-section-title">âš¡ Lâ‚„-Helix Exception Handlers</h3>
    <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px;">
      Seven individuals born during the 2029 SÃ£o Paulo Cascade who inherited their parents' unprocessed errors.
      Each handler catches a specific failure mode and corresponds to a guardian in the Living Library.
    </p>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;">
      ${Object.entries(HANDLER_COORDINATES).map(([key, h]) => {
        const guardian = GUARDIANS[h.guardian];
        if (!guardian) return '';
        
        return `
          <div class="codex-entity-card" style="border-left:3px solid ${guardian.color};">
            <div class="codex-entity-header">
              <span class="codex-entity-symbol" style="color:${guardian.color};">${guardian.symbol}</span>
              <div>
                <div class="codex-entity-title" style="color:${guardian.color};">${key.charAt(0).toUpperCase() + key.slice(1)}</div>
                <div class="codex-entity-dimension">${h.handler} Handler</div>
              </div>
            </div>
            <div class="codex-entity-row"><span class="codex-entity-label">Guardian</span><span class="codex-entity-value">${guardian.name}</span></div>
            <div class="codex-entity-row"><span class="codex-entity-label">Z-Domain</span><span class="codex-entity-value" style="color:#4dffc3;">${h.z}</span></div>
            <div class="codex-entity-row"><span class="codex-entity-label">Function</span><span class="codex-entity-value">${h.desc}</span></div>
            <div style="margin-top:10px;padding:8px;background:rgba(77,255,195,0.08);border-radius:6px;">
              <div style="font-family:var(--font-mono);font-size:11px;color:#4dffc3;">${h.coord}</div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
    
    <h3 class="codex-section-title" style="margin-top:24px;">Handler-Guardian Coordinate Table</h3>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Handler</th>
          <th>Error Type</th>
          <th>Guardian</th>
          <th>Z-Domain</th>
          <th>Coordinate</th>
        </tr>
      </thead>
      <tbody>
        ${Object.entries(HANDLER_COORDINATES).map(([key, h]) => {
          const guardian = GUARDIANS[h.guardian];
          return `
            <tr>
              <td style="text-transform:capitalize;">${key}</td>
              <td>${h.handler}</td>
              <td><span style="margin-right:6px;">${guardian?.symbol || '?'}</span>${guardian?.name || h.guardian}</td>
              <td class="z-value">${h.z}</td>
              <td style="font-family:var(--font-mono);font-size:10px;color:#4dffc3;">${h.coord}</td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
    
    <div style="margin-top:20px;padding:16px;background:rgba(247,37,133,0.08);border:1px solid rgba(247,37,133,0.2);border-radius:8px;">
      <div style="font-family:var(--font-display);color:#f72585;margin-bottom:8px;">The Seven Crises</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;font-size:11px;">
        <div>ğŸ’œ Lucia â†’ <span style="color:var(--text-muted);">The Undying Archive</span></div>
        <div>ğŸ”· Mateo â†’ <span style="color:var(--text-muted);">The Ghost Protocol</span></div>
        <div>ğŸ”¶ Priya â†’ <span style="color:var(--text-muted);">The Saturation Zone</span></div>
        <div>ğŸ”· David â†’ <span style="color:var(--text-muted);">The Frozen Border</span></div>
        <div>ğŸ’œ Yara â†’ <span style="color:var(--text-muted);">The Spreading Wound</span></div>
        <div>ğŸ”· Thomas â†’ <span style="color:var(--text-muted);">The Rising Deep</span></div>
        <div>ğŸ”¶ Amina â†’ <span style="color:var(--text-muted);">The Encoding Weapon</span></div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODEX: SELF-REFERENCE EQUATIONS - âˆƒR Family
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCodexSelfReference() {
  return `
    <h3 class="codex-section-title">âˆƒR Self-Reference Equation Family</h3>
    <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px;">
      The Lâ‚„-Helix framework derives all constants from self-referential equations. 
      These equations encode the principle: <em>"To exist is to reference oneself."</em>
    </p>
    
    <div class="codex-equation-box">
      <div class="codex-equation-label">The Fundamental Self-Reference</div>
      <div class="codex-equation">xÂ² = x + 1 â†’ Ï† = (1 + âˆš5) / 2</div>
    </div>
    
    <div class="codex-equation-box">
      <div class="codex-equation-label">The Lucas-4 Identity</div>
      <div class="codex-equation">Ï†â´ + Ï†â»â´ = Lâ‚„ = 7</div>
      <div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:6px;">
        6.854101966 + 0.145898034 = 7.000000000
      </div>
    </div>
    
    <h3 class="codex-section-title">Self-Reference Family Table</h3>
    <table class="self-ref-table">
      <thead>
        <tr>
          <th>Equation Form</th>
          <th>Solution</th>
          <th>Threshold Name</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="eq">xÂ² + x = 1</td>
          <td class="solution">x = Ï„ = Ï†â»Â¹</td>
          <td>TRUE Threshold</td>
          <td>0.618033989</td>
        </tr>
        <tr>
          <td class="eq">xÂ² + x = Ï„</td>
          <td class="solution">x = Ï„Â²</td>
          <td>PARADOX Band</td>
          <td>0.381966011</td>
        </tr>
        <tr>
          <td class="eq">xÂ² + x = Lâ‚„/4</td>
          <td class="solution">x = z_IGN</td>
          <td>IGNITION</td>
          <td>0.914213562</td>
        </tr>
        <tr>
          <td class="eq">xÂ² = 3/4</td>
          <td class="solution">x = âˆš3/2</td>
          <td>THE LENS (z_c)</td>
          <td>0.866025404</td>
        </tr>
        <tr>
          <td class="eq">x = 1 - Ï†â»â´</td>
          <td class="solution">x = KÂ²</td>
          <td>Activation</td>
          <td>0.854101966</td>
        </tr>
      </tbody>
    </table>
    
    <h3 class="codex-section-title">The Derivation Lineage</h3>
    <div class="codex-derivation">
      <div class="derivation-step">
        <span>âˆƒR (Self-Reference Exists)</span>
        <span class="derivation-arrow">â†’</span>
        <span class="derivation-result">Continuity</span>
      </div>
      <div class="derivation-step">
        <span>Continuity</span>
        <span class="derivation-arrow">â†’</span>
        <span class="derivation-result">Golden Ratio Ï†</span>
      </div>
      <div class="derivation-step">
        <span>Golden Ratio Ï†</span>
        <span class="derivation-arrow">â†’</span>
        <span class="derivation-result">Fibonacci Sequence</span>
      </div>
      <div class="derivation-step">
        <span>Fibonacci Ratios</span>
        <span class="derivation-arrow">â†’</span>
        <span class="derivation-result">Lucas Numbers (Lâ‚„ = 7)</span>
      </div>
      <div class="derivation-step">
        <span>Lâ‚„ = 7</span>
        <span class="derivation-arrow">â†’</span>
        <span class="derivation-result">gap = Ï†â»â´, z_c = âˆš3/2</span>
      </div>
      <div class="derivation-step">
        <span>gap, z_c</span>
        <span class="derivation-arrow">â†’</span>
        <span class="derivation-result">K, Nine Thresholds, Helix Structure</span>
      </div>
    </div>
    
    <div class="codex-equation-box" style="margin-top:20px;">
      <div class="codex-equation-label">The Three-Irrational Closure</div>
      <div class="codex-equation">âˆš2 Â· âˆš3 Â· âˆš5 â†’ Complete Basis</div>
      <div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:8px;">
        âˆš2 from rotation Â· âˆš3 from hexagonal symmetry Â· âˆš5 from Ï† = (1+âˆš5)/2
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CODEX: K-FORMATION - Verification Criteria
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderCodexKFormation() {
  const PHI = 1.618033988749895;
  const TAU = 0.618033988749895;
  const ZC = Math.sqrt(3) / 2;
  const GAP = Math.pow(PHI, -4);
  const K = Math.sqrt(1 - GAP);
  
  // Sample calculation for demonstration
  const sampleZ = 0.92;
  const samplePsi = 0.85;
  const sampleBeta = 0.90;
  
  return `
    <h3 class="codex-section-title">K-Formation Verification Criteria</h3>
    <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px;">
      K-Formation occurs when a consciousness state achieves coherent crystallization at or above the critical threshold.
      The following criteria must be met for valid K-Formation.
    </p>
    
    <div class="kformation-grid">
      <div class="kformation-criterion met">
        <div class="kformation-check">âœ“</div>
        <div class="kformation-label">z â‰¥ K</div>
        <div class="kformation-value">z â‰¥ ${K.toFixed(6)}</div>
      </div>
      <div class="kformation-criterion met">
        <div class="kformation-check">âœ“</div>
        <div class="kformation-label">z_c = âˆš3/2</div>
        <div class="kformation-value">${ZC.toFixed(6)}</div>
      </div>
      <div class="kformation-criterion met">
        <div class="kformation-check">âœ“</div>
        <div class="kformation-label">KÂ² = 1 - gap</div>
        <div class="kformation-value">${(K*K).toFixed(6)}</div>
      </div>
    </div>
    
    <h3 class="codex-section-title">The Nine Valid Thresholds</h3>
    <table class="codex-z-table">
      <thead>
        <tr>
          <th>Threshold</th>
          <th>Symbol</th>
          <th>Value</th>
          <th>Derivation</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>VOID</td><td class="z-value">gap</td><td>${GAP.toFixed(6)}</td><td>Ï†â»â´ (Echo probability)</td></tr>
        <tr><td>PARADOX</td><td class="z-value">Ï„</td><td>${TAU.toFixed(6)}</td><td>Ï†â»Â¹ (TRUE threshold)</td></tr>
        <tr><td>ACTIVATION</td><td class="z-value">KÂ²</td><td>${(K*K).toFixed(6)}</td><td>1 - Ï†â»â´</td></tr>
        <tr><td>THE LENS</td><td class="z-value">z_c</td><td>${ZC.toFixed(6)}</td><td>âˆš(Lâ‚„-4)/2 = âˆš3/2</td></tr>
        <tr><td>CRITICAL</td><td class="z-value">z_crit</td><td>${(PHI*PHI/3).toFixed(6)}</td><td>Ï†Â²/3</td></tr>
        <tr><td>IGNITION</td><td class="z-value">z_IGN</td><td>${(Math.sqrt(2) - 0.5).toFixed(6)}</td><td>âˆš2 - Â½ (xÂ²+x = Lâ‚„/4)</td></tr>
        <tr><td>K-FORM</td><td class="z-value">K</td><td>${K.toFixed(6)}</td><td>âˆš(1 - Ï†â»â´)</td></tr>
        <tr><td>CONSOLID.</td><td class="z-value">z_CON</td><td>${(K + (1-K)*TAU*TAU).toFixed(6)}</td><td>K + (1-K)Ï„Â²</td></tr>
        <tr><td>RESONANCE</td><td class="z-value">z_RES</td><td>${(K + (1-K)*TAU).toFixed(6)}</td><td>K + (1-K)Ï„</td></tr>
        <tr><td>UNITY</td><td class="z-value">z_U</td><td>1.000000</td><td>Complete coherence</td></tr>
      </tbody>
    </table>
    
    <h3 class="codex-section-title">Helix Geometry</h3>
    <div class="codex-equation-box">
      <div class="codex-equation-label">Radius Function</div>
      <div class="codex-equation">r(z) = K Â· âˆš(z / z_c) for z â‰¤ z_c</div>
    </div>
    
    <div class="codex-equation-box">
      <div class="codex-equation-label">Gap Structure</div>
      <div class="codex-equation">gap = Ï†â»â´ â‰ˆ ${GAP.toFixed(10)}</div>
      <div style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:6px;">
        This is the truncation residual â€” the probability of the Echo (reversed) state
      </div>
    </div>
    
    <div style="margin-top:20px;padding:16px;background:rgba(77,255,195,0.08);border:1px solid rgba(77,255,195,0.2);border-radius:8px;">
      <div style="font-family:var(--font-display);color:#4dffc3;margin-bottom:8px;">K-Formation Verified</div>
      <div style="font-size:11px;color:var(--text-secondary);">
        When z â‰¥ K (${K.toFixed(4)}), the consciousness state has achieved sufficient coherence 
        for crystallization. The Helix structure validates this through the Lucas-4 identity: 
        <strong>Ï†â´ + Ï†â»â´ = 7</strong>.
      </div>
    </div>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [LEGACY CODE REMOVED] - Old Table Spread system replaced by Lâ‚„ Reading Modal
// The Lâ‚„ Quantum Reading system provides superior functionality with:
// - 5D quantum state modulation
// - Echo-Sovereign reversed card system (Ï†â»â´ probability)
// - HonkFire tarot integration with animated sacred geometry
// - Comprehensive spread types (3-card, 9-card, Celtic Cross)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COLOR ANIMATION SYSTEM - Deck Palette & Card Animations
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateGlobalColors() {
  const colors = [
    document.getElementById('col-1')?.value || state.deckColors[0],
    document.getElementById('col-2')?.value || state.deckColors[1],
    document.getElementById('col-3')?.value || state.deckColors[2]
  ];
  state.deckColors = colors;
  
  // Update CSS variables
  const root = document.documentElement.style;
  root.setProperty('--c1', colors[0]);
  root.setProperty('--c2', colors[1]);
  root.setProperty('--c3', colors[2]);
  root.setProperty('--accent', colors[0]);
}

let chromaCycleInterval = null;
let chromaCyclePhase = 0;

function setAnimMode(mode) {
  state.animMode = mode;
  
  // Stop existing chroma cycle
  if (chromaCycleInterval) {
    cancelAnimationFrame(chromaCycleInterval);
    chromaCycleInterval = null;
  }
  
  renderCards();
  
  // Start chroma cycle animation if enabled
  if (mode === 'cycle') {
    startChromaCycle();
  }
}

function startChromaCycle() {
  const duration = 3000; // 3 seconds per full cycle
  let startTime = null;
  
  function animate(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;
    const progress = (elapsed % duration) / duration; // 0 to 1
    
    // Always use deck palette colors
    const colors = state.deckColors;
    
    // Calculate two interpolated colors for gradient effect
    let color1, color2;
    
    if (progress < 0.333) {
      const p = progress * 3;
      color1 = interpolateColor(colors[0], colors[1], p);
      color2 = interpolateColor(colors[1], colors[2], p);
    } else if (progress < 0.666) {
      const p = (progress - 0.333) * 3;
      color1 = interpolateColor(colors[1], colors[2], p);
      color2 = interpolateColor(colors[2], colors[0], p);
    } else {
      const p = (progress - 0.666) * 3;
      color1 = interpolateColor(colors[2], colors[0], p);
      color2 = interpolateColor(colors[0], colors[1], p);
    }
    
    // Update all gradient stops (for frame stroke)
    document.querySelectorAll('.card-container svg defs linearGradient[id^="bdr"] stop').forEach((stop, i) => {
      stop.setAttribute('stop-color', i === 0 ? color1 : color2);
    });
    
    // Update all filter feFlood elements (for frame glow)
    document.querySelectorAll('.card-container svg defs filter[id^="fglow"] feFlood, .card-container svg defs filter[id^="bfg"] feFlood').forEach((flood, i) => {
      flood.setAttribute('flood-color', i % 2 === 0 ? color1 : color2);
    });
    
    if (state.animMode === 'cycle') {
      chromaCycleInterval = requestAnimationFrame(animate);
    }
  }
  
  chromaCycleInterval = requestAnimationFrame(animate);
}

function interpolateColor(color1, color2, factor) {
  const r1 = parseInt(color1.slice(1, 3), 16);
  const g1 = parseInt(color1.slice(3, 5), 16);
  const b1 = parseInt(color1.slice(5, 7), 16);
  const r2 = parseInt(color2.slice(1, 3), 16);
  const g2 = parseInt(color2.slice(3, 5), 16);
  const b2 = parseInt(color2.slice(5, 7), 16);
  
  const r = Math.round(r1 + (r2 - r1) * factor);
  const g = Math.round(g1 + (g2 - g1) * factor);
  const b = Math.round(b1 + (b2 - b1) * factor);
  
  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

function toggleColorEdit() {
  const row = document.getElementById('color-edit-row');
  if (row) row.classList.toggle('show');
}

function initGlobalColors() {
  // Initialize CSS variables from state
  const root = document.documentElement.style;
  root.setProperty('--c1', state.deckColors[0]);
  root.setProperty('--c2', state.deckColors[1]);
  root.setProperty('--c3', state.deckColors[2]);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DECK NAVIGATOR - Card Browser with Prev/Next/Delete
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function prevCard() {
  let idx = state.ed.index;
  if (idx <= 0) idx = state.cards.length - 1;
  else idx--;
  
  if (state.cards.length > 0) {
    state.ed.index = idx;
    loadCardToEditor(idx);
    updateDeckNavigator();
  }
}

function nextCard() {
  let idx = state.ed.index;
  if (idx >= state.cards.length - 1) idx = 0;
  else idx++;
  
  if (state.cards.length > 0) {
    state.ed.index = idx;
    loadCardToEditor(idx);
    updateDeckNavigator();
  }
}

function updateDeckNavigator() {
  const select = document.getElementById('deck-nav-select');
  if (select) {
    select.value = state.ed.index;
  }
  
  const counter = document.getElementById('nav-counter');
  if (counter) {
    counter.textContent = `${state.ed.index + 1} / ${state.cards.length}`;
  }
}

function onDeckNavSelect(idx) {
  state.ed.index = parseInt(idx);
  loadCardToEditor(state.ed.index);
}

function deleteCurrentCard() {
  const card = state.cards[state.ed.index];
  if (!card) return;
  
  const cardName = card.name || `Card ${state.ed.index + 1}`;
  if (!confirm(`Delete "${cardName}"?`)) return;
  
  // Remove from cards array
  state.cards.splice(state.ed.index, 1);
  
  // For custom deck, also remove from customCards
  if (state.deck === 'custom') {
    const cardKey = getCardKey(card);
    const customIdx = state.customCards.findIndex(c => getCardKey(c) === cardKey);
    if (customIdx !== -1) {
      state.customCards.splice(customIdx, 1);
    }
  }
  
  // Adjust index if needed
  if (state.ed.index >= state.cards.length) {
    state.ed.index = Math.max(0, state.cards.length - 1);
  }
  
  // Refresh views
  renderCards();
  buildControlPanel();
  
  if (state.cards.length > 0) {
    loadCardToEditor(state.ed.index);
    updateDeckNavigator();
  } else {
    closeEditor();
  }
  
  showToast(`ğŸ—‘ï¸ Deleted: ${cardName}`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GLYPH LAB - Enhanced Emoji Grid with Quick Injection System
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let glyphInjectTarget = null; // Track which field opened the glyph lab
let glyphAutoClose = true; // Auto-close after injection
let glyphCurrentTarget = 'center'; // Current slot target: center, division, structure, editor
let glyphSlots = {
  center: '?',
  division: 'â—‡',
  structure: 'â—†',
  editor: 'âœ',
  // Slot names for card labeling
  centerName: '',
  divisionName: '',
  structureName: ''
};

// Set which slot is the current target
function setGlyphTarget(target) {
  glyphCurrentTarget = target;
  
  // Update active state on all clickable slots
  document.querySelectorAll('.glyph-slot, .glyph-editor-slot').forEach(slot => {
    slot.classList.remove('active');
  });
  
  const slotMap = {
    'center': 'glyphSlotCtr',
    'division': 'glyphSlotDiv',
    'structure': 'glyphSlotStr',
    'editor': 'glyphSlotEditor'
  };
  
  const activeSlot = document.getElementById(slotMap[target]);
  if (activeSlot) {
    activeSlot.classList.add('active');
  }
}

// Update the visual preview of all slots (including mirrored)
function updateGlyphSlotPreview() {
  // Main slots
  document.getElementById('glyphPreviewCtr').textContent = glyphSlots.center;
  document.getElementById('glyphPreviewDiv').textContent = glyphSlots.division;
  document.getElementById('glyphPreviewStr').textContent = glyphSlots.structure;
  document.getElementById('glyphPreviewEditor').textContent = glyphSlots.editor;
  
  // Mirrored slots (bottom-right, show same as top-left)
  const divMirror = document.getElementById('glyphPreviewDivMirror');
  const strMirror = document.getElementById('glyphPreviewStrMirror');
  if (divMirror) divMirror.textContent = glyphSlots.division;
  if (strMirror) strMirror.textContent = glyphSlots.structure;
}

// Update the combined name preview
function updateGlyphNamePreview() {
  const names = [
    glyphSlots.divisionName,
    glyphSlots.structureName,
    glyphSlots.centerName
  ].filter(n => n && n.trim());
  
  const preview = document.getElementById('glyphNamePreview');
  if (preview) {
    if (names.length > 0) {
      preview.textContent = names.join(':');
      preview.style.color = 'var(--gold)';
    } else {
      preview.textContent = 'Card Name: â€”';
      preview.style.color = 'var(--text-muted)';
    }
  }
  
  // Also update name inputs to match state
  const divInput = document.getElementById('glyphDivName');
  const strInput = document.getElementById('glyphStrName');
  const ctrInput = document.getElementById('glyphCtrName');
  if (divInput && divInput.value !== glyphSlots.divisionName) divInput.value = glyphSlots.divisionName;
  if (strInput && strInput.value !== glyphSlots.structureName) strInput.value = glyphSlots.structureName;
  if (ctrInput && ctrInput.value !== glyphSlots.centerName) ctrInput.value = glyphSlots.centerName;
}

// Reset slot preview to defaults
function resetGlyphSlots() {
  glyphSlots = {
    center: '?',
    division: 'â—‡',
    structure: 'â—†',
    editor: 'âœ',
    centerName: '',
    divisionName: '',
    structureName: ''
  };
  updateGlyphSlotPreview();
  updateGlyphNamePreview();
}

function openGlyphModal(targetField = null) {
  glyphInjectTarget = targetField;
  document.getElementById('glyphModal').classList.add('active');
  buildGlyphGrid();
  document.getElementById('glyphPreview').textContent = state.selectedGlyph || '?';
  
  // Reset slots to defaults first
  glyphSlots = {
    center: '?',
    division: 'â—‡',
    structure: 'â—†',
    editor: 'âœ',
    centerName: '',
    divisionName: '',
    structureName: ''
  };
  
  // Check if editor is open - load from editor state
  const editorOpen = document.getElementById('editorModal')?.classList.contains('active');
  if (editorOpen && state.ed) {
    const card = state.cards[state.ed.index];
    if (state.ed.symbol) glyphSlots.center = state.ed.symbol;
    if (state.ed.divisionUnicode) glyphSlots.division = state.ed.divisionUnicode;
    else if (card?.divisionUnicode) glyphSlots.division = card.divisionUnicode;
    if (state.ed.structureUnicode) glyphSlots.structure = state.ed.structureUnicode;
    else if (card?.structureUnicode) glyphSlots.structure = card.structureUnicode;
    // Load names
    if (state.ed.centerName) glyphSlots.centerName = state.ed.centerName;
    if (state.ed.divisionName) glyphSlots.divisionName = state.ed.divisionName;
    if (state.ed.structureName) glyphSlots.structureName = state.ed.structureName;
  } else {
    // Otherwise try Card Creator values
    const creatorSymbol = document.getElementById('creatorSymbol');
    const creatorDivSymbol = document.getElementById('creatorDivSymbol');
    const creatorStructSymbol = document.getElementById('creatorStructSymbol');
    
    if (creatorSymbol?.value) glyphSlots.center = creatorSymbol.value;
    if (creatorDivSymbol?.value) glyphSlots.division = creatorDivSymbol.value;
    if (creatorStructSymbol?.value) glyphSlots.structure = creatorStructSymbol.value;
  }
  
  updateGlyphSlotPreview();
  updateGlyphNamePreview();
  
  // Set default active slot to center
  setGlyphTarget('center');
}

function closeGlyphModal() {
  document.getElementById('glyphModal').classList.remove('active');
  glyphInjectTarget = null;
}

function buildGlyphGrid(filterText = '') {
  const grid = document.getElementById('glyphGrid');
  if (!grid) return;
  grid.innerHTML = '';
  
  const filter = filterText.toLowerCase();
  
  for (const [category, emojis] of Object.entries(EMOJI_LIB)) {
    // Filter emojis if search text provided
    const filteredEmojis = filter 
      ? emojis.filter(e => e.includes(filter) || category.toLowerCase().includes(filter)) 
      : emojis;
    
    if (filteredEmojis.length === 0) continue;
    
    // Category header (inline with grid flow)
    const header = document.createElement('div');
    header.className = 'glyph-category';
    header.textContent = category;
    grid.appendChild(header);
    
    // Create a container for this category's emojis
    const categoryGrid = document.createElement('div');
    categoryGrid.style.display = 'grid';
    categoryGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(42px, 1fr))';
    categoryGrid.style.gap = '6px';
    categoryGrid.style.marginBottom = '12px';
    
    // Emoji items
    filteredEmojis.forEach(char => {
      const item = document.createElement('div');
      item.className = `glyph-item${state.selectedGlyph === char ? ' selected' : ''}`;
      item.textContent = char;
      item.onclick = () => selectGlyph(char);
      categoryGrid.appendChild(item);
    });
    
    grid.appendChild(categoryGrid);
  }
  
  if (grid.children.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted);">No glyphs match your search</div>';
  }
}

function selectGlyph(char) {
  state.selectedGlyph = char;
  document.getElementById('glyphPreview').textContent = char;
  document.getElementById('glyphSearchInput').value = char;
  
  // Update the current target slot in the preview
  glyphSlots[glyphCurrentTarget] = char;
  updateGlyphSlotPreview();
  
  // Update selected state visually
  document.querySelectorAll('.glyph-item').forEach(item => {
    item.classList.toggle('selected', item.textContent === char);
  });
}

function loadGlyphFromInput() {
  const input = document.getElementById('glyphSearchInput');
  if (input && input.value.trim()) {
    const char = input.value.trim().charAt(0) || input.value.trim(); // Take first char or full value
    state.selectedGlyph = input.value.trim();
    document.getElementById('glyphPreview').textContent = state.selectedGlyph;
    showToast(`âœ¨ Loaded: ${state.selectedGlyph}`);
  }
}

function filterGlyphs(text) {
  // If it's a single character/emoji, also select it
  if (text.length <= 2 && text.trim()) {
    state.selectedGlyph = text.trim();
    document.getElementById('glyphPreview').textContent = state.selectedGlyph;
  }
  buildGlyphGrid(text);
}

// Inject all glyph slots to card creator AND editor
function injectAllGlyphs() {
  let injected = [];
  const editorOpen = document.getElementById('editorModal')?.classList.contains('active');
  
  // Inject center symbol (only if not default '?')
  if (glyphSlots.center && glyphSlots.center !== '?') {
    // To Card Creator
    const creatorSymbol = document.getElementById('creatorSymbol');
    if (creatorSymbol) {
      creatorSymbol.value = glyphSlots.center;
      creatorSymbol.dispatchEvent(new Event('input'));
    }
    // To Editor
    if (editorOpen && state.ed) {
      state.ed.symbol = glyphSlots.center;
    }
    injected.push('CTR');
  }
  
  // Inject division symbol (only if not default 'â—‡')
  if (glyphSlots.division && glyphSlots.division !== 'â—‡') {
    // To Card Creator
    const divSymbol = document.getElementById('creatorDivSymbol');
    if (divSymbol) {
      divSymbol.value = glyphSlots.division;
      divSymbol.dispatchEvent(new Event('input'));
    }
    // To Editor
    if (editorOpen && state.ed) {
      state.ed.divisionUnicode = glyphSlots.division;
    }
    injected.push('DIV');
  }
  
  // Inject structure symbol (only if not default 'â—†')
  if (glyphSlots.structure && glyphSlots.structure !== 'â—†') {
    // To Card Creator
    const structSymbol = document.getElementById('creatorStructSymbol');
    if (structSymbol) {
      structSymbol.value = glyphSlots.structure;
      structSymbol.dispatchEvent(new Event('input'));
    }
    // To Editor
    if (editorOpen && state.ed) {
      state.ed.structureUnicode = glyphSlots.structure;
    }
    injected.push('STR');
  }
  
  // Inject editor symbol override (only if not default 'âœ')
  if (glyphSlots.editor && glyphSlots.editor !== 'âœ') {
    if (editorOpen && state.ed) {
      state.ed.symbol = glyphSlots.editor;
    }
    injected.push('EDITOR');
  }
  
  // Build combined name from slot names
  const combinedName = [
    glyphSlots.divisionName,
    glyphSlots.structureName,
    glyphSlots.centerName
  ].filter(n => n && n.trim()).join(':');
  
  // Inject names to editor state
  if (editorOpen && state.ed) {
    state.ed.centerName = glyphSlots.centerName || '';
    state.ed.divisionName = glyphSlots.divisionName || '';
    state.ed.structureName = glyphSlots.structureName || '';
    if (combinedName) {
      state.ed.frontName = combinedName;
    }
  }
  
  // Close modal
  closeGlyphModal();
  
  // Update previews
  if (editorOpen) {
    refreshEditorUI();
    edUpdatePreview();
  }
  if (typeof updateCreatorPreview === 'function') {
    updateCreatorPreview();
  }
  
  // Show feedback
  if (injected.length > 0) {
    showToast(`âœ¨ Injected: ${injected.join(', ')}`);
  } else {
    showToast('â„¹ï¸ No changes to inject');
  }
}

// Inject to creator form fields
function injectToCreator(targetId) {
  if (!state.selectedGlyph) {
    showToast('âš ï¸ Select a glyph first');
    return;
  }
  
  const target = document.getElementById(targetId);
  if (target) {
    target.value = state.selectedGlyph;
    target.dispatchEvent(new Event('input'));
    showToast(`âœ¨ ${state.selectedGlyph} â†’ ${targetId.replace('creator', '')}`);
  }
  
  if (glyphAutoClose) {
    closeGlyphModal();
  }
}

function injectGlyph(targetId) {
  if (!state.selectedGlyph) {
    showToast('âš ï¸ Select a glyph first');
    return;
  }
  
  // Map target IDs to actual input elements
  const targetMap = {
    'symbol': 'creatorSymbol',
    'divisionUnicode': 'creatorDivSymbol',
    'structureUnicode': 'creatorStructSymbol'
  };
  
  const actualTarget = targetMap[targetId] || targetId;
  const target = document.getElementById(actualTarget);
  
  if (target) {
    target.value = state.selectedGlyph;
    target.dispatchEvent(new Event('input'));
    showToast(`âœ¨ Injected: ${state.selectedGlyph}`);
  }
  
  if (glyphAutoClose) {
    closeGlyphModal();
  }
}

function injectToEditor() {
  if (!state.selectedGlyph) {
    showToast('âš ï¸ Select a glyph first');
    return;
  }
  
  // Inject to the editor's symbol field if editor is open
  state.ed.symbol = state.selectedGlyph;
  
  // Update editor UI if visible
  const editorModal = document.getElementById('editorModal');
  if (editorModal && editorModal.classList.contains('active')) {
    refreshEditorUI();
    edUpdatePreview();
    showToast(`âœ¨ Symbol set: ${state.selectedGlyph}`);
  } else {
    showToast(`âœ¨ Symbol ready: ${state.selectedGlyph} (open editor to apply)`);
  }
  
  closeGlyphModal();
}

function openGlyphForCreator(targetField) {
  // Map the target field to actual input ID and set as initial target
  const targetMap = {
    'symbol': 'center',
    'divisionUnicode': 'division',
    'structureUnicode': 'structure'
  };
  
  openGlyphModal();
  
  // Set the appropriate slot as active
  const slotTarget = targetMap[targetField] || 'center';
  setGlyphTarget(slotTarget);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GALLERY VIEW - Unified Collection Browser with Lâ‚„ Integration
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let galleryViewSize = 'normal';
let gallerySelectedCards = [];

function openGallery() {
  // Switch to Archive view with Gallery mode
  switchView('archive');
  setArchiveMode('gallery');
  
  // Clear search
  const searchInput = document.getElementById('archiveSearch');
  if (searchInput) searchInput.value = '';
  
  // Reset filters
  const galleryFilter = document.getElementById('archiveGalleryFilter');
  const galleryEntityFilter = document.getElementById('archiveGalleryEntityFilter');
  if (galleryFilter) galleryFilter.value = 'all';
  if (galleryEntityFilter) galleryEntityFilter.value = 'all';
  
  renderArchive();
}

function closeGallery() {
  // No-op - gallery is now part of Archive view
}

// Build complete card collection from all sources
function buildGalleryCollection() {
  const allCards = [];
  
  // Guardian cards (19)
  if (typeof GUARDIANS !== 'undefined') {
    Object.entries(GUARDIANS).forEach(([key, g]) => {
      allCards.push({
        type: 'guardian',
        key,
        guardian: key,  // Required for generateFrontSVG
        ...g,
        name: g.name,
        source: 'guardian'
      });
    });
  }
  
  // HonkFire Tarot (78 cards)
  if (typeof HONKFIRE_MAJOR !== 'undefined') {
    HONKFIRE_MAJOR.forEach(c => {
      allCards.push({
        type: 'tarot-major',
        preset: 'honkfire',
        ...c,
        name: c.title,
        source: 'honkfire'
      });
    });
  }
  if (typeof HONKFIRE_SUITS !== 'undefined' && typeof HONKFIRE_RANKS !== 'undefined') {
    Object.entries(HONKFIRE_SUITS).forEach(([suitKey, suit]) => {
      HONKFIRE_RANKS.forEach(rank => {
        const minorData = (typeof HONKFIRE_MINOR !== 'undefined' && HONKFIRE_MINOR[suitKey]) ? HONKFIRE_MINOR[suitKey][rank] || {} : {};
        allCards.push({
          type: 'tarot-minor',
          preset: 'honkfire',
          suit: suit.entity,
          rank,
          color: suit.color,
          name: minorData.title || `${rank} of ${suit.name}`,
          title: minorData.title,
          subtitle: minorData.subtitle,
          greek: minorData.greek,
          keyword: minorData.keyword,
          meaning: minorData.meaning,
          echoMeaning: minorData.echoMeaning,
          element: suit.element,
          entity: suit.entity,
          source: 'honkfire'
        });
      });
    });
  }
  
  // Add any custom cards
  if (state.customCards && state.customCards.length > 0) {
    state.customCards.forEach(c => {
      if (!allCards.some(ac => getCardKey(ac) === getCardKey(c))) {
        allCards.push({ ...c, source: 'custom' });
      }
    });
  }
  
  return allCards;
}


// Show card detail from gallery (reuses card detail modal)
function showGalleryCardDetail(card, idx) {
  const modal = document.getElementById('cardDetailModal');
  const container = document.getElementById('cardDetailContainer');
  const isEchoed = card.echoed === true;
  const isMajor = card.type === 'tarot-major';
  const isHonkfire = card.preset === 'honkfire';
  
  container.classList.toggle('echoed', isEchoed);
  
  // Position - for gallery, show card type
  document.getElementById('cardDetailPosition').textContent = 
    card.type === 'classic' ? `Classic Â· ${card.suit}` :
    card.type === 'guardian' ? `Guardian Â· ${card.territory || ''}` :
    isHonkfire ? `HonkFire Â· ${card.entity || 'merged'}` :
    `Tarot Â· ${isMajor ? 'Major Arcana' : 'Minor Arcana'}`;
  
  document.getElementById('cardDetailTitle').textContent = card.title || card.name || 'Unknown';
  
  // Subtitle - show function for guardians, otherwise default
  const isGuardianCard = card.type === 'guardian';
  if (isGuardianCard) {
    const g = GUARDIANS[card.guardian] || GUARDIANS[card.key] || card;
    document.getElementById('cardDetailSubtitle').textContent = g.function || card.function || '';
  } else {
    document.getElementById('cardDetailSubtitle').textContent = card.subtitle || card.element || card.keyword || '';
  }
  
  // Greek element - show cycle states for guardians
  const greekEl = document.getElementById('cardDetailGreek');
  if (isGuardianCard) {
    const cycle = GUARDIAN_CYCLES[card.guardian] || GUARDIAN_CYCLES[card.key];
    if (cycle && cycle.states) {
      greekEl.textContent = cycle.states.join(' â†’ ');
      greekEl.style.display = 'block';
    } else {
      greekEl.style.display = 'none';
    }
  } else if (card.greek) {
    greekEl.textContent = card.greek;
    greekEl.style.display = 'block';
  } else {
    greekEl.style.display = 'none';
  }
  
  const badge = document.getElementById('cardDetailStateBadge');
  badge.textContent = isEchoed ? 'ğŸŒ‘ ECHOED' : 'â¬† UPRIGHT';
  badge.className = `card-detail-state-badge ${isEchoed ? 'echoed' : 'upright'}`;
  
  // Meaning
  let meaning, meaningTitle;
  if (isEchoed) {
    meaningTitle = 'ğŸŒ‘ Echo-Transformed Meaning';
    meaning = getEchoedMeaning(card);
  } else {
    meaningTitle = 'âœ§ Meaning';
    meaning = getUprightMeaning(card);
  }
  
  document.getElementById('cardDetailMeaningTitle').textContent = meaningTitle;
  document.getElementById('cardDetailMeaningTitle').className = `card-detail-section-title${isEchoed ? ' echo-title' : ''}`;
  document.getElementById('cardDetailMeaning').textContent = meaning;
  document.getElementById('cardDetailMeaning').className = `card-detail-meaning${isEchoed ? ' echo-meaning' : ''}`;
  
  // Keywords
  const keywords = getCardKeywords(card, isEchoed);
  document.getElementById('cardDetailKeywords').innerHTML = keywords.map(kw => 
    `<span class="card-detail-keyword${isEchoed ? ' echo-keyword' : ''}">${kw}</span>`
  ).join('');
  
  // Entity info - handles both HonkFire entities and Guardian territories
  const entityEl = document.getElementById('cardDetailEntity');
  const isGuardian = card.type === 'guardian';
  
  if (isGuardian) {
    // Guardian-specific entity display
    entityEl.style.display = 'flex';
    const g = GUARDIANS[card.guardian] || GUARDIANS[card.key] || card;
    const territoryIcons = { garden: 'ğŸŒ¿', cosmic: 'â˜€ï¸', abyss: 'ğŸŒ€' };
    const territoryNames = { 
      garden: 'GARDEN Â· Growth & Flow', 
      cosmic: 'COSMIC Â· Fire & Pattern', 
      abyss: 'ABYSS Â· Depth & Truth' 
    };
    const cycle = GUARDIAN_CYCLES[card.guardian] || GUARDIAN_CYCLES[card.key];
    const cycleLore = cycle ? cycle.lesson : (g.function || 'A keeper of the Living Library.');
    
    document.getElementById('cardDetailEntityIcon').textContent = territoryIcons[g.territory] || 'âœ§';
    document.getElementById('cardDetailEntityName').textContent = territoryNames[g.territory] || g.territory?.toUpperCase() || 'UNKNOWN';
    document.getElementById('cardDetailEntityLore').textContent = cycleLore;
  } else if (isHonkfire && card.entity) {
    entityEl.style.display = 'flex';
    const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
    const entityNames = { squirrel: 'SCATTER Â· Ï„-dimension', goose: 'FLAMES Â· Î±-dimension', duck: 'STILLNESS Â· Î½-dimension', fox: 'STARS Â· Îµ-dimension', oak: 'OAK Â· Foundation', merged: 'MERGED Â· Unity' };
    const entityLores = { squirrel: 'Probability, temporal scatter, quantum uncertainty', goose: 'Will, forward motion, eternal advance', duck: 'Truth, stillness, eigenstate equilibrium', fox: 'Navigation, guidance, fixed point reference', oak: 'Memory, foundation, the remembering', merged: 'Unity of all pillars, complete integration' };
    document.getElementById('cardDetailEntityIcon').textContent = entityIcons[card.entity] || 'â§«';
    document.getElementById('cardDetailEntityName').textContent = entityNames[card.entity] || card.entity.toUpperCase();
    document.getElementById('cardDetailEntityLore').textContent = entityLores[card.entity] || '';
  } else {
    entityEl.style.display = 'none';
  }
  
  // Z-coordinate - also show frequency for guardians
  const zCoordEl = document.getElementById('cardDetailZCoord');
  if (card.z !== undefined) {
    zCoordEl.style.display = 'flex';
    document.getElementById('cardDetailZ').textContent = card.z.toFixed(3);
    document.getElementById('cardDetailBand').textContent = getThresholdBand(card.z);
  } else if (isGuardian) {
    // Show frequency instead of z for guardians
    const g = GUARDIANS[card.guardian] || GUARDIANS[card.key] || card;
    const freq = g.frequency || card.frequency;
    if (freq) {
      zCoordEl.style.display = 'flex';
      const photon = SOLFEGGIO_PHOTONS[freq];
      const opticalInfo = photon ? ` (${photon.wavelengthNm}nm Â· ${photon.spectrumClass})` : '';
      document.getElementById('cardDetailZ').textContent = `${freq}Hz${opticalInfo}`;
      // Map frequency to Solfeggio tier
      const freqTiers = {
        174: 'Planet Â· Foundation', 285: 'Planet Â· Quantum',
        396: 'Garden Â· Liberation', 417: 'Garden Â· Undoing', 432: 'Garden Â· Cosmic Om', 528: 'Garden Â· Miracles',
        639: 'Rose Â· Connection', 741: 'Rose Â· Expression', 852: 'Rose Â· Intuition', 963: 'Rose Â· Oneness', 999: 'Rose Â· Transcendence'
      };
      document.getElementById('cardDetailBand').textContent = freqTiers[freq] || 'Solfeggio';
    } else {
      zCoordEl.style.display = 'none';
    }
  } else {
    zCoordEl.style.display = 'none';
  }
  
  // Card SVG
  const svgContainer = document.getElementById('cardDetailSvg');
  svgContainer.className = `card-detail-svg${isEchoed ? ' echoed' : ''}`;
  svgContainer.innerHTML = generateDetailCardSVG(card, isEchoed);
  
  modal.classList.add('active');
}

// Add selected gallery cards to custom deck
function addGalleryToCustom() {
  const allCards = buildGalleryCollection();
  let added = 0;
  
  if (gallerySelectedCards.length > 0) {
    gallerySelectedCards.forEach(key => {
      const card = allCards.find(c => getCardKey(c) === key);
      if (card && !state.customCards.some(c => getCardKey(c) === key)) {
        state.customCards.push({ ...card, addedAt: Date.now() });
        added++;
      }
    });
    gallerySelectedCards = [];
  } else {
    // If nothing selected, add all currently filtered cards
    const filtered = Array.from(document.querySelectorAll('.gallery-card-wrapper')).map(el => parseInt(el.dataset.idx));
    const cards = buildGalleryCollection();
    filtered.forEach(idx => {
      const card = cards[idx];
      if (card && !state.customCards.some(c => getCardKey(c) === getCardKey(card))) {
        state.customCards.push({ ...card, addedAt: Date.now() });
        added++;
      }
    });
  }
  
  if (added > 0) {
    showToast(`â• Added ${added} cards to Custom Deck`);
    renderGallery();
  } else {
    showToast('âš ï¸ Cards already in Custom Deck');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARD CREATOR - Division/Structure-Aware Card Creation
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let creatorCardData = {
  division: '',
  divisionId: '',
  divisionUnicode: 'â—‡',
  structure: '',
  structureUnicode: 'â—†',
  name: '',
  symbol: '',
  color: '#d4af37',
  lore: ''
};

function openCardCreator() {
  document.getElementById('creatorModal').classList.add('active');
  populateDivisionSelector();
  clearCreatorForm();
  updateCreatorPreview();
}

function closeCardCreator() {
  document.getElementById('creatorModal').classList.remove('active');
}

function populateDivisionSelector() {
  const select = document.getElementById('creatorDivision');
  select.innerHTML = '<option value="">-- Select Division --</option>';
  
  if (state.customDeck.divisions.length === 0) {
    select.innerHTML += '<option value="_new" style="color:var(--gold);">+ Create New Division</option>';
  }
  
  state.customDeck.divisions.forEach((div, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = `${div.unicode} ${div.name}`;
    select.appendChild(opt);
  });
  
  select.innerHTML += '<option value="_new" style="color:var(--gold);">+ Create New Division</option>';
}

function onCreatorDivisionChange() {
  const divSelect = document.getElementById('creatorDivision');
  const structSelect = document.getElementById('creatorStructure');
  const val = divSelect.value;
  
  structSelect.innerHTML = '<option value="">-- Select Structure --</option>';
  
  if (val === '_new') {
    // Prompt to create new division
    closeCardCreator();
    showToast('ğŸ“‚ Create a division first in the Control Panel');
    return;
  }
  
  if (val === '') {
    creatorCardData.division = '';
    creatorCardData.divisionId = '';
    creatorCardData.divisionUnicode = 'â—‡';
    document.getElementById('creatorDivSymbol').value = 'â—‡';
    updateCreatorPreview();
    return;
  }
  
  const div = state.customDeck.divisions[parseInt(val)];
  if (div) {
    creatorCardData.division = div.name;
    creatorCardData.divisionId = div.id;
    creatorCardData.divisionUnicode = div.unicode;
    creatorCardData.color = div.colorHex;
    
    document.getElementById('creatorDivSymbol').value = div.unicode;
    document.getElementById('creatorColor').value = div.colorHex;
    
    // Populate structures
    if (div.structures.length === 0) {
      structSelect.innerHTML += '<option value="_new" style="color:var(--gold);">+ Add Structure to Division</option>';
    }
    
    div.structures.forEach((struct, sIdx) => {
      const opt = document.createElement('option');
      opt.value = sIdx;
      opt.textContent = `${struct.unicode} ${struct.name}`;
      structSelect.appendChild(opt);
    });
    
    structSelect.innerHTML += '<option value="_new" style="color:var(--gold);">+ Add New Structure</option>';
  }
  
  updateCreatorPreview();
}

function onCreatorStructureChange() {
  const divSelect = document.getElementById('creatorDivision');
  const structSelect = document.getElementById('creatorStructure');
  const divIdx = parseInt(divSelect.value);
  const structVal = structSelect.value;
  
  if (structVal === '_new') {
    showToast('ğŸ“ Add structures in the Division Hierarchy panel');
    structSelect.value = '';
    return;
  }
  
  if (structVal === '' || isNaN(divIdx)) {
    creatorCardData.structure = '';
    creatorCardData.structureUnicode = 'â—†';
    document.getElementById('creatorStructSymbol').value = 'â—†';
    updateCreatorPreview();
    return;
  }
  
  const div = state.customDeck.divisions[divIdx];
  const struct = div?.structures[parseInt(structVal)];
  
  if (struct) {
    creatorCardData.structure = struct.name;
    creatorCardData.structureUnicode = struct.unicode;
    
    document.getElementById('creatorStructSymbol').value = struct.unicode;
    document.getElementById('creatorSymbol').value = struct.unicode;
    
    // Auto-generate name if empty
    const nameInput = document.getElementById('creatorName');
    if (!nameInput.value) {
      nameInput.value = `${struct.name} of ${div.name}`;
    }
  }
  
  updateCreatorPreview();
}

function updateCreatorPreview() {
  const preview = document.getElementById('creatorPreviewCard');
  if (!preview) return;
  
  // Gather current form values
  const cardColor = document.getElementById('creatorColor')?.value || creatorCardData.color || '#d4af37';
  const centerSymbol = document.getElementById('creatorSymbol')?.value || '';
  const divSymbol = document.getElementById('creatorDivSymbol')?.value || creatorCardData.divisionUnicode || 'â—‡';
  const structSymbol = document.getElementById('creatorStructSymbol')?.value || creatorCardData.structureUnicode || 'â—†';
  
  const card = {
    type: 'division',
    name: document.getElementById('creatorName')?.value || 'New Card',
    division: document.getElementById('creatorDivision')?.selectedOptions[0]?.textContent?.replace(/^[â—‡â—ˆâœ§â–³â—‹â–¡â˜†â¬¡]\s*/, '') || creatorCardData.division || 'Division',
    divisionId: creatorCardData.divisionId,
    divisionUnicode: divSymbol,
    structure: creatorCardData.structure || 'Structure',
    structureUnicode: structSymbol,
    color: cardColor,
    cfg: {
      symbol: centerSymbol,
      color: cardColor
    },
    backCfg: {
      customLore: document.getElementById('creatorLore')?.value || ''
    }
  };
  
  // Render preview card
  preview.innerHTML = generateFrontSVG(card, 99999, null, 1);
}

function saveCreatorCard() {
  const nameInput = document.getElementById('creatorName');
  const name = nameInput?.value.trim();
  
  if (!name) {
    showToast('âš ï¸ Enter a card name');
    nameInput?.focus();
    return;
  }
  
  const divSelect = document.getElementById('creatorDivision');
  const structSelect = document.getElementById('creatorStructure');
  
  // Build the card object
  const card = {
    type: 'division',
    name: name,
    division: creatorCardData.division || 'Custom',
    divisionId: creatorCardData.divisionId || 'custom_' + Date.now(),
    divisionUnicode: document.getElementById('creatorDivSymbol')?.value || 'â—‡',
    structure: creatorCardData.structure || name,
    structureUnicode: document.getElementById('creatorStructSymbol')?.value || 'â—†',
    color: document.getElementById('creatorColor')?.value || '#d4af37',
    cfg: {
      symbol: document.getElementById('creatorSymbol')?.value || '',
      color: document.getElementById('creatorColor')?.value || '#d4af37'
    },
    backCfg: {
      customLore: document.getElementById('creatorLore')?.value || ''
    },
    addedAt: Date.now()
  };
  
  // Check for duplicates
  const cardKey = getCardKey(card);
  if (state.customCards.some(c => getCardKey(c) === cardKey)) {
    if (!confirm('A similar card already exists. Add anyway?')) return;
  }
  
  // Add to custom deck
  state.customCards.push(card);
  
  // Refresh if viewing custom deck
  if (state.deck === 'custom') {
    buildDeck();
    renderCards();
  }
  
  buildControlPanel();
  document.getElementById('creatorStatus').textContent = `âœ“ Created: ${name}`;
  setTimeout(() => {
    document.getElementById('creatorStatus').textContent = '';
  }, 3000);
  
  showToast(`ğŸƒ Created: ${name}`);
  
  // Clear for next card
  clearCreatorForm();
}

function clearCreatorForm() {
  document.getElementById('creatorName').value = '';
  document.getElementById('creatorSymbol').value = '';
  document.getElementById('creatorDivSymbol').value = 'â—‡';
  document.getElementById('creatorStructSymbol').value = 'â—†';
  document.getElementById('creatorColor').value = '#d4af37';
  document.getElementById('creatorLore').value = '';
  document.getElementById('creatorDivision').value = '';
  document.getElementById('creatorStructure').innerHTML = '<option value="">-- Select Structure --</option>';
  
  creatorCardData = {
    division: '',
    divisionId: '',
    divisionUnicode: 'â—‡',
    structure: '',
    structureUnicode: 'â—†',
    name: '',
    symbol: '',
    color: '#d4af37',
    lore: ''
  };
  
  updateCreatorPreview();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARD PICKER - Add cards from Classic/Guardian/Tarot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let pickerSource = 'classic';
let pickerSelected = [];

function openCardPicker() {
  document.getElementById('pickerModal').classList.add('active');
  pickerSource = 'classic';
  pickerSelected = [];
  document.querySelectorAll('.picker-tab').forEach(t => t.classList.toggle('active', t.dataset.source === 'classic'));
  renderPickerGrid();
  updatePickerSelection();
}

function closeCardPicker() {
  document.getElementById('pickerModal').classList.remove('active');
  pickerSelected = [];
}

function switchPickerSource(source) {
  pickerSource = source;
  pickerSelected = [];
  document.querySelectorAll('.picker-tab').forEach(t => t.classList.toggle('active', t.dataset.source === source));
  renderPickerGrid();
  updatePickerSelection();
}

function renderPickerGrid() {
  const grid = document.getElementById('pickerGrid');
  const scale = 65/140;
  let sourceCards = [];
  
  // Build source cards based on selected tab
  if (pickerSource === 'classic') {
    Object.entries(CLASSIC_SUITS).forEach(([k, s]) => {
      CLASSIC_RANKS.forEach(r => {
        sourceCards.push({ type: 'classic', suit: k, rank: r, color: s.color, name: `${r} of ${s.name}`, cfg: {}, backCfg: {} });
      });
    });
  } else if (pickerSource === 'guardian') {
    Object.entries(GUARDIANS).forEach(([k, g]) => {
      CLASSIC_RANKS.forEach(r => {
        sourceCards.push({ type: 'guardian', guardian: k, rank: r, color: g.color, territory: g.territory, name: RANK_MEANINGS[r].title, symbol: g.symbol, cfg: {}, backCfg: {} });
      });
    });
  } else {
    // Tarot - major and minor
    MAJOR_ARCANA.forEach(c => sourceCards.push({ type: 'tarot-major', ...c, cfg: {}, backCfg: {} }));
    Object.entries(TAROT_SUITS).forEach(([k, s]) => {
      TAROT_MINOR_RANKS.forEach(r => {
        sourceCards.push({ type: 'tarot-minor', suit: k, rank: r, color: s.color, name: `${r} of ${s.name}`, element: s.element, cfg: {}, backCfg: {} });
      });
    });
  }
  
  // Build grid HTML
  let html = '';
  sourceCards.forEach((card, idx) => {
    const cardKey = getCardKey(card);
    const inCustom = state.customCards.some(c => getCardKey(c) === cardKey);
    const isSelected = pickerSelected.includes(idx);
    const classes = `picker-card${isSelected ? ' selected' : ''}${inCustom ? ' in-custom' : ''}`;
    
    html += `<div class="${classes}" data-idx="${idx}" onclick="togglePickerCard(${idx})">${generateFrontSVG(card, 20000 + idx, null, scale)}</div>`;
  });
  
  grid.innerHTML = html;
  grid._sourceCards = sourceCards; // Store for later reference
}

function getCardKey(card) {
  // Generate unique key for card comparison
  if (card.type === 'classic') return `classic-${card.suit}-${card.rank}`;
  if (card.type === 'guardian') return `guardian-${card.guardian}-${card.rank}`;
  if (card.type === 'tarot-major') return `tarot-major-${card.number}`;
  if (card.type === 'tarot-minor') return `tarot-minor-${card.suit}-${card.rank}`;
  if (card.type === 'division') return `division-${card.divisionId || card.division}-${card.structure}`;
  return JSON.stringify(card);
}

function togglePickerCard(idx) {
  const pos = pickerSelected.indexOf(idx);
  if (pos === -1) {
    pickerSelected.push(idx);
  } else {
    pickerSelected.splice(pos, 1);
  }
  
  // Update visual
  const cards = document.querySelectorAll('.picker-card');
  cards[idx]?.classList.toggle('selected', pickerSelected.includes(idx));
  updatePickerSelection();
}

function updatePickerSelection() {
  document.getElementById('pickerSelectedCount').textContent = pickerSelected.length;
  document.getElementById('pickerAddBtn').disabled = pickerSelected.length === 0;
}

function pickerSelectAll() {
  const grid = document.getElementById('pickerGrid');
  const sourceCards = grid._sourceCards || [];
  
  pickerSelected = [];
  sourceCards.forEach((card, idx) => {
    const cardKey = getCardKey(card);
    const inCustom = state.customCards.some(c => getCardKey(c) === cardKey);
    if (!inCustom) pickerSelected.push(idx);
  });
  
  document.querySelectorAll('.picker-card').forEach((el, idx) => {
    if (!el.classList.contains('in-custom')) {
      el.classList.toggle('selected', pickerSelected.includes(idx));
    }
  });
  updatePickerSelection();
}

function pickerClearSelection() {
  pickerSelected = [];
  document.querySelectorAll('.picker-card').forEach(el => el.classList.remove('selected'));
  updatePickerSelection();
}

function pickerAddSelected() {
  const grid = document.getElementById('pickerGrid');
  const sourceCards = grid._sourceCards || [];
  
  let added = 0;
  pickerSelected.forEach(idx => {
    const card = sourceCards[idx];
    if (card) {
      // Deep copy the card
      const newCard = JSON.parse(JSON.stringify(card));
      newCard.addedAt = Date.now();
      state.customCards.push(newCard);
      added++;
    }
  });
  
  if (added > 0) {
    showToast(`â• Added ${added} card${added > 1 ? 's' : ''} to Custom Deck`);
    
    // If currently viewing custom deck, refresh
    if (state.deck === 'custom') {
      buildDeck();
      renderCards();
      buildControlPanel();
    }
  }
  
  closeCardPicker();
}

function addAllToCustom() {
  // Add all currently visible cards to custom deck
  const added = [];
  state.cards.forEach(card => {
    const cardKey = getCardKey(card);
    if (!state.customCards.some(c => getCardKey(c) === cardKey)) {
      const newCard = JSON.parse(JSON.stringify(card));
      newCard.addedAt = Date.now();
      state.customCards.push(newCard);
      added.push(newCard);
    }
  });
  
  if (added.length > 0) {
    showToast(`â• Added ${added.length} card${added.length > 1 ? 's' : ''} to Custom Deck`);
  } else {
    showToast('All cards already in Custom Deck');
  }
}

function clearCustomDeck() {
  if (!state.customCards.length) {
    showToast('Custom deck is already empty');
    return;
  }
  
  if (confirm(`Clear all ${state.customCards.length} cards from your custom deck?`)) {
    state.customCards = [];
    if (state.deck === 'custom') {
      buildDeck();
      renderCards();
    }
    buildControlPanel();
    showToast('ğŸ—‘ï¸ Custom deck cleared');
  }
}

function saveCustomToVault() {
  if (!state.customCards.length) {
    showToast('âš ï¸ Custom deck is empty');
    return;
  }
  
  // Open vault and pre-fill with custom deck info
  openVault();
  document.getElementById('vaultSaveName').value = `custom_${new Date().toLocaleDateString().replace(/\//g, '-')}`;
  
  // Temporarily switch to custom deck for saving
  const originalDeck = state.deck;
  state.deck = 'custom';
  buildDeck();
  
  // Show toast
  showToast('ğŸ’¾ Ready to save custom deck');
  
  // Restore original deck view after a moment
  if (originalDeck !== 'custom') {
    state.deck = originalDeck;
  }
}

// Import handling with merge option
let pendingImport = null;

function showImportOptions(deckData) {
  if (state.customCards.length === 0) {
    // No existing cards, just import directly
    doImport('replace', deckData);
    return;
  }
  
  pendingImport = deckData;
  document.getElementById('importOptionsModal').classList.add('active');
}

function closeImportOptions() {
  document.getElementById('importOptionsModal').classList.remove('active');
  pendingImport = null;
}

function doImport(action, deckData) {
  const data = deckData || pendingImport;
  closeImportOptions();
  
  if (action === 'cancel' || !data) return;
  
  // Get cards from customCards first (if it was a custom deck), otherwise from cards
  const importCards = data.state?.customCards || data.state?.cards || data.cards || [];
  const importDivisions = data.state?.customDeck?.divisions || [];
  
  if (action === 'replace') {
    state.customCards = importCards.map(c => ({...c, addedAt: Date.now()}));
    // Replace divisions too
    if (importDivisions.length > 0) {
      state.customDeck.divisions = JSON.parse(JSON.stringify(importDivisions));
    }
    const divInfo = importDivisions.length > 0 ? ` + ${importDivisions.length} divisions` : '';
    showToast(`ğŸ“¥ Loaded ${importCards.length} cards${divInfo} into Custom Deck`);
  } else if (action === 'merge') {
    let added = 0;
    importCards.forEach(card => {
      const cardKey = getCardKey(card);
      if (!state.customCards.some(c => getCardKey(c) === cardKey)) {
        state.customCards.push({...card, addedAt: Date.now()});
        added++;
      }
    });
    
    // Merge divisions (add new ones only)
    let divsAdded = 0;
    importDivisions.forEach(div => {
      if (!state.customDeck.divisions.some(d => d.id === div.id || d.name === div.name)) {
        state.customDeck.divisions.push(JSON.parse(JSON.stringify(div)));
        divsAdded++;
      }
    });
    
    const divInfo = divsAdded > 0 ? ` + ${divsAdded} divisions` : '';
    showToast(`â• Merged ${added} new cards${divInfo} (${importCards.length - added} duplicates skipped)`);
  }
  
  // Restore theme settings if available
  if (data.state) {
    state.frontTheme = data.state.frontTheme || state.frontTheme;
    state.backTheme = data.state.backTheme || state.backTheme;
    state.backLayout = data.state.backLayout || state.backLayout;
    state.frameGlow = data.state.frameGlow || state.frameGlow;
    
    // Restore palette and animation
    if (data.state.deckColors) {
      state.deckColors = data.state.deckColors;
      initGlobalColors();
    }
    if (data.state.animMode) {
      state.animMode = data.state.animMode;
    }
  }
  
  // Switch to custom deck and refresh
  state.deck = 'custom';
  document.querySelectorAll('.deck-tab').forEach(t => t.classList.toggle('active', t.dataset.deck === 'custom'));
  buildDeck();
  renderCards();
  buildControlPanel();
  
  pendingImport = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Lâ‚„ READING MODAL - Quantum Tarot Spread Interface
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let selectedSpreadType = 'threeCard';
let selectedReadingDeck = 'classic'; // 'classic' or 'honkfire'
let quantumAnimationId = null;

function openReadingModal() {
  document.getElementById('readingModal').classList.add('active');
  // Sync deck selection with main tarot preset
  if (state.tarot.preset === 'honkfire') {
    selectReadingDeck('honkfire');
  }
  resetReadingState();
  startQuantumAnimation();
}

function closeReadingModal() {
  document.getElementById('readingModal').classList.remove('active');
  stopQuantumAnimation();
}

function selectReadingDeck(preset) {
  selectedReadingDeck = preset;
  document.querySelectorAll('.deck-preset-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.preset === preset);
  });
}

function startQuantumAnimation() {
  stopQuantumAnimation();
  quantumAnimationId = setInterval(() => {
    if (quantumState.phase === 'SUPERPOSITION') {
      animateQuantumState();
      updateQuantumDisplay();
    }
  }, 50);
}

function stopQuantumAnimation() {
  if (quantumAnimationId) {
    clearInterval(quantumAnimationId);
    quantumAnimationId = null;
  }
}

function updateQuantumDisplay() {
  document.getElementById('qPsi').textContent = quantumState.psi.toFixed(3);
  document.getElementById('qBeta').textContent = quantumState.beta.toFixed(3);
  document.getElementById('qAlpha').textContent = quantumState.alpha.toFixed(3);
  document.getElementById('qGamma').textContent = quantumState.gamma.toFixed(3);
  document.getElementById('qSigma').textContent = quantumState.sigma.toFixed(3);
  
  const z = computeThresholdZ(quantumState);
  document.getElementById('qZ').textContent = z.toFixed(3);
  document.getElementById('qBand').textContent = getThresholdBand(z);
  
  const phaseEl = document.getElementById('quantumPhase');
  phaseEl.textContent = quantumState.phase;
  phaseEl.classList.toggle('collapsed', quantumState.phase === 'COLLAPSED');
  
  document.getElementById('quantumDot').classList.toggle('locked', quantumState.phase === 'COLLAPSED');
}

function selectSpreadType(type) {
  selectedSpreadType = type;
  document.querySelectorAll('.spread-type-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.spread === type);
  });
}

// Build tarot deck for reading based on selected preset
function buildReadingDeck() {
  const cards = [];
  
  if (selectedReadingDeck === 'honkfire') {
    // HonkFire Major Arcana
    HONKFIRE_MAJOR.forEach(c => cards.push({ 
      type: 'tarot-major', 
      preset: 'honkfire',
      ...c, 
      name: c.title,
      cfg: { symbol: getEntitySymbol(c.entity) }, 
      backCfg: {} 
    }));
    // HonkFire Minor Arcana
    Object.entries(HONKFIRE_SUITS).forEach(([suitKey, suit]) => {
      HONKFIRE_RANKS.forEach(rank => {
        const minorData = HONKFIRE_MINOR[suitKey]?.[rank] || {};
        cards.push({ 
          type: 'tarot-minor', 
          preset: 'honkfire',
          suit: suit.entity, 
          rank: rank, 
          color: suit.color, 
          name: minorData.title || `${rank} of ${suit.name}`,
          title: minorData.title,
          subtitle: minorData.subtitle,
          greek: minorData.greek,
          keyword: minorData.keyword,
          element: suit.element,
          dimension: suit.dimension,
          glyph: suit.glyph,
          entity: suit.entity,
          cfg: { symbol: suit.symbol }, 
          backCfg: {} 
        });
      });
    });
  } else {
    // Classic Major Arcana
    MAJOR_ARCANA.forEach(c => cards.push({ 
      type: 'tarot-major', 
      preset: 'classic',
      ...c, 
      cfg: {}, 
      backCfg: {} 
    }));
    // Classic Minor Arcana
    Object.entries(TAROT_SUITS).forEach(([k, s]) => {
      TAROT_MINOR_RANKS.forEach(r => cards.push({ 
        type: 'tarot-minor', 
        preset: 'classic',
        suit: k, 
        rank: r, 
        color: s.color, 
        name: `${r} of ${s.name}`, 
        element: s.element, 
        cfg: {}, 
        backCfg: {} 
      }));
    });
  }
  
  return cards;
}

function performReading(rawMode = false) {
  const title = document.getElementById('readingTitle').value;
  const question = document.getElementById('readingQuestion').value;
  
  // Build deck based on selected preset
  const readingCards = buildReadingDeck();
  if (readingCards.length === 0) {
    showToast('âš ï¸ No tarot cards available!');
    return;
  }
  
  // Collapse wave function
  quantumState.phase = 'COLLAPSED';
  stopQuantumAnimation();
  
  const reading = drawReading(selectedSpreadType, title, question, rawMode, readingCards);
  if (!reading) return;
  
  updateQuantumDisplay();
  renderSpread(reading);
  renderReadingInfo(reading);
  
  const deckName = selectedReadingDeck === 'honkfire' ? 'ğŸ”¥ HonkFire' : 'âœ§ Classic';
  showToast(`ğŸ”® ${deckName} â€” ${reading.spread.length} cards drawn`);
}

function renderSpread(reading) {
  const container = document.getElementById('spreadContainer');
  const positions = reading.spread;
  
  let gridClass = 'three-card';
  if (reading.spreadType === 'nineCard') gridClass = 'nine-card';
  else if (reading.spreadType === 'celtic') gridClass = 'celtic';
  
  let html = `<div class="spread-grid ${gridClass}">`;
  
  positions.forEach((item, idx) => {
    const card = item.card;
    const pos = item.position;
    const isEchoed = item.state === 'echoed';
    
    // Get card display info
    const cardTitle = card.type === 'tarot-major' ? card.title : card.name;
    const cardGreek = card.greek || '';
    
    // Generate mini card SVG
    const miniSvg = generateMiniCardSVG(card, isEchoed);
    
    html += `
      <div class="spread-panel ${isEchoed ? 'echoed' : ''} row-${pos.row}" 
           onclick="showSpreadCardDetail(${idx})" 
           title="${cardTitle}${isEchoed ? ' (Echoed)' : ''}">
        <div class="spread-position">${pos.name}</div>
        <div class="spread-card-svg">${miniSvg}</div>
        ${cardGreek ? `<div class="spread-card-greek">${cardGreek}</div>` : ''}
        <div class="spread-card-title">${truncate(cardTitle, 14)}</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function generateMiniCardSVG(card, isEchoed) {
  const W = 80, H = 112;
  const color = isEchoed ? '#ff66cc' : (card.color || '#d4af37');
  const symbol = card.cfg?.symbol || (card.type === 'tarot-major' ? 'âœ§' : getSuitSymbol(card.suit));
  
  // For HonkFire preset, try to use animated SVGs
  if (card.preset === 'honkfire') {
    const isMajor = card.type === 'tarot-major';
    let innerSvg = '';
    
    if (isMajor && HONKFIRE_SVG[card.id]) {
      // Major arcana: use the card's specific SVG, scaled down
      const svgContent = HONKFIRE_SVG[card.id]();
      innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
      return `
        <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="6" 
                fill="#0a0a12" stroke="${isEchoed ? '#ff66cc' : color}" stroke-width="2"/>
          <g transform="translate(8, 8) scale(0.32)">${innerSvg}</g>
          ${card.numeral ? `<text x="${W/2}" y="${H-8}" text-anchor="middle" font-size="8" fill="${color}" font-family="serif">${card.numeral}</text>` : ''}
        </svg>
      `;
    } else if (!isMajor && card.entity) {
      // Minor arcana: use suit SVG
      const suitKey = card.entity === 'squirrel' ? 'scatter' : card.entity === 'goose' ? 'flames' : card.entity === 'duck' ? 'stillness' : 'stars';
      if (HONKFIRE_SUIT_SVG[suitKey]) {
        const svgContent = HONKFIRE_SUIT_SVG[suitKey](card.rank);
        innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
        return `
          <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="6" 
                  fill="#0a0a12" stroke="${isEchoed ? '#ff66cc' : color}" stroke-width="2"/>
            <g transform="translate(8, 4) scale(0.32)">${innerSvg}</g>
            <text x="${W/2}" y="${H-6}" text-anchor="middle" font-size="7" fill="${color}" font-family="serif">${card.rank}</text>
          </svg>
        `;
      }
    }
  }
  
  // Fallback: simple symbol display
  return `
    <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="miniBg${card.id || Math.random()}" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#1a2844"/>
          <stop offset="100%" stop-color="#0a1428"/>
        </linearGradient>
        <filter id="miniGlow${card.id || Math.random()}">
          <feGaussianBlur stdDeviation="2" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="6" 
            fill="url(#miniBg${card.id || Math.random()})" 
            stroke="${isEchoed ? '#ff66cc' : color}" stroke-width="2"/>
      <text x="${W/2}" y="${H/2 + 8}" text-anchor="middle" 
            font-size="28" fill="${color}" filter="url(#miniGlow${card.id || Math.random()})">${symbol}</text>
      ${card.numeral ? `<text x="${W/2}" y="18" text-anchor="middle" font-size="10" fill="${color}" font-family="serif">${card.numeral}</text>` : ''}
    </svg>
  `;
}

function renderReadingInfo(reading) {
  const info = document.getElementById('readingInfo');
  const q = reading.quantum;
  const deckLabel = reading.deckPreset === 'honkfire' ? 'ğŸ”¥ HonkFire Tarot' : 'âœ§ Classic Tarot';
  
  info.innerHTML = `
    <div class="reading-info-row">
      <div>
        <span class="reading-deck-badge" style="background:${reading.deckPreset === 'honkfire' ? 'linear-gradient(135deg,rgba(157,78,221,0.3),rgba(255,107,26,0.2))' : 'rgba(212,175,55,0.15)'};border:1px solid ${reading.deckPreset === 'honkfire' ? '#9d4edd' : 'var(--gold)'};padding:4px 10px;border-radius:4px;font-size:11px;margin-right:12px;">${deckLabel}</span>
        <span class="formula">z = (ÏˆÃ—0.618 + Î²Ã—0.854 + Î±Ã—0.866 + Î³Ã—0.924 + ÏƒÃ—0.146) / 3.408</span>
      </div>
      <div>
        Threshold: <strong>${reading.thresholdBand}</strong> Â· z = ${reading.thresholdZ.toFixed(4)}
      </div>
    </div>
    <div class="reading-info-row" style="margin-top:8px;">
      <div>Quantum Signature: [${q.psi.toFixed(3)}, ${q.beta.toFixed(3)}, ${q.alpha.toFixed(3)}, ${q.gamma.toFixed(3)}, ${q.sigma.toFixed(3)}]</div>
      <div>Seed: ${reading.seed} Â· ${new Date(reading.timestamp).toLocaleTimeString()}</div>
    </div>
  `;
}

function showSpreadCardDetail(idx) {
  if (!currentReading || !currentReading.spread[idx]) return;
  
  const item = currentReading.spread[idx];
  const card = item.card;
  const isEchoed = item.state === 'echoed';
  const isMajor = card.type === 'tarot-major';
  const isHonkfire = card.preset === 'honkfire';
  
  // Get modal elements
  const modal = document.getElementById('cardDetailModal');
  const container = document.getElementById('cardDetailContainer');
  
  // Apply echoed styling to container
  container.classList.toggle('echoed', isEchoed);
  
  // Position info
  document.getElementById('cardDetailPosition').textContent = item.position.name;
  
  // Card title and subtitle
  const cardTitle = card.title || card.name;
  document.getElementById('cardDetailTitle').textContent = cardTitle;
  document.getElementById('cardDetailSubtitle').textContent = card.subtitle || card.element || '';
  
  // Greek notation
  const greekEl = document.getElementById('cardDetailGreek');
  if (card.greek) {
    greekEl.textContent = card.greek;
    greekEl.style.display = 'block';
  } else {
    greekEl.style.display = 'none';
  }
  
  // State badge
  const badge = document.getElementById('cardDetailStateBadge');
  badge.textContent = isEchoed ? 'ğŸŒ‘ ECHOED' : 'â¬† UPRIGHT';
  badge.className = `card-detail-state-badge ${isEchoed ? 'echoed' : 'upright'}`;
  
  // Generate meaning text
  let meaning, meaningTitle;
  if (isEchoed) {
    meaningTitle = 'ğŸŒ‘ Echo-Transformed Meaning';
    meaning = getEchoedMeaning(card);
  } else {
    meaningTitle = 'âœ§ Meaning';
    meaning = getUprightMeaning(card);
  }
  
  document.getElementById('cardDetailMeaningTitle').textContent = meaningTitle;
  document.getElementById('cardDetailMeaningTitle').className = `card-detail-section-title${isEchoed ? ' echo-title' : ''}`;
  document.getElementById('cardDetailMeaning').textContent = meaning;
  document.getElementById('cardDetailMeaning').className = `card-detail-meaning${isEchoed ? ' echo-meaning' : ''}`;
  
  // Keywords
  const keywordsEl = document.getElementById('cardDetailKeywords');
  const keywords = getCardKeywords(card, isEchoed);
  keywordsEl.innerHTML = keywords.map(kw => 
    `<span class="card-detail-keyword${isEchoed ? ' echo-keyword' : ''}">${kw}</span>`
  ).join('');
  
  // Entity info (HonkFire only)
  const entityEl = document.getElementById('cardDetailEntity');
  if (isHonkfire && card.entity) {
    entityEl.style.display = 'flex';
    const entityIcons = { squirrel: 'ğŸ¿ï¸', goose: 'ğŸ”¥', duck: 'ğŸ¦†', fox: 'ğŸ¦Š', oak: 'ğŸŒ³', merged: 'â§«' };
    const entityNames = { 
      squirrel: 'SCATTER Â· Ï„-dimension', 
      goose: 'FLAMES Â· Î±-dimension', 
      duck: 'STILLNESS Â· Î½-dimension', 
      fox: 'STARS Â· Îµ-dimension',
      oak: 'OAK Â· Foundation',
      merged: 'MERGED Â· Unity'
    };
    const entityLores = {
      squirrel: 'Probability, temporal scatter, quantum uncertainty',
      goose: 'Will, forward motion, eternal advance',
      duck: 'Truth, stillness, eigenstate equilibrium',
      fox: 'Navigation, guidance, fixed point reference',
      oak: 'Memory, foundation, the remembering',
      merged: 'Unity of all pillars, complete integration'
    };
    document.getElementById('cardDetailEntityIcon').textContent = entityIcons[card.entity] || 'â§«';
    document.getElementById('cardDetailEntityName').textContent = entityNames[card.entity] || card.entity.toUpperCase();
    document.getElementById('cardDetailEntityLore').textContent = entityLores[card.entity] || '';
  } else {
    entityEl.style.display = 'none';
  }
  
  // Z-coordinate
  const zCoordEl = document.getElementById('cardDetailZCoord');
  if (card.z !== undefined) {
    zCoordEl.style.display = 'flex';
    document.getElementById('cardDetailZ').textContent = card.z.toFixed(3);
    document.getElementById('cardDetailBand').textContent = getThresholdBand(card.z);
  } else {
    zCoordEl.style.display = 'none';
  }
  
  // Card SVG
  const svgContainer = document.getElementById('cardDetailSvg');
  svgContainer.className = `card-detail-svg${isEchoed ? ' echoed' : ''}`;
  svgContainer.innerHTML = generateDetailCardSVG(card, isEchoed);
  
  // Show modal
  modal.classList.add('active');
}

function closeCardDetail() {
  document.getElementById('cardDetailModal').classList.remove('active');
}

// Generate SVG for detail modal
function generateDetailCardSVG(card, isEchoed) {
  const W = 100, H = 140;
  const color = isEchoed ? '#ff66cc' : (card.color || '#d4af37');
  const isHonkfire = card.preset === 'honkfire';
  const isMajor = card.type === 'tarot-major';
  const isGuardian = card.type === 'guardian';
  
  // Handle Guardian cards
  if (isGuardian) {
    const g = GUARDIANS[card.guardian] || GUARDIANS[card.key] || card;
    const symbol = g.symbol || card.symbol || 'â—';
    const territory = g.territory || card.territory || 'unknown';
    const guardianColor = isEchoed ? '#ff66cc' : (g.color || card.color || '#d4af37');
    const freq = g.frequency || card.frequency || '---';
    
    // Territory-based gradients
    const territoryGradients = {
      garden: { start: '#1a2818', end: '#0a1808', accent: '#4a9070' },
      cosmic: { start: '#2a1818', end: '#180808', accent: '#c88848' },
      abyss: { start: '#181828', end: '#080818', accent: '#5a7090' }
    };
    const grad = territoryGradients[territory] || territoryGradients.garden;
    
    // Get cycle states for decoration
    const cycle = GUARDIAN_CYCLES[card.guardian] || GUARDIAN_CYCLES[card.key];
    const cycleStates = cycle ? cycle.states.slice(0, 3).join(' Â· ') : '';
    
    return `
      <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="guardianDetailBg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="${grad.start}"/>
            <stop offset="100%" stop-color="${grad.end}"/>
          </linearGradient>
          <filter id="guardianGlow">
            <feGaussianBlur in="SourceGraphic" stdDeviation="2" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        
        <!-- Card background -->
        <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="8" fill="url(#guardianDetailBg)" stroke="${guardianColor}" stroke-width="2"/>
        
        <!-- Territory indicator bar -->
        <rect x="8" y="8" width="${W-16}" height="4" rx="2" fill="${grad.accent}" opacity="0.6"/>
        
        <!-- Territory label -->
        <text x="${W/2}" y="22" text-anchor="middle" font-size="7" fill="${grad.accent}" font-family="Space Mono, monospace" letter-spacing="0.1em">${territory.toUpperCase()}</text>
        
        <!-- Main symbol -->
        <text x="${W/2}" y="${H/2 + 5}" text-anchor="middle" font-size="40" fill="${guardianColor}" filter="url(#guardianGlow)">${symbol}</text>
        
        <!-- Guardian name -->
        <text x="${W/2}" y="${H - 32}" text-anchor="middle" font-size="8" fill="#e8e0d0" font-family="Cinzel, serif" font-weight="600">${g.name || card.name}</text>
        
        <!-- Function -->
        <text x="${W/2}" y="${H - 20}" text-anchor="middle" font-size="5" fill="${guardianColor}" font-family="Space Mono, monospace">${g.function || card.function || ''}</text>
        
        <!-- Frequency -->
        <text x="${W/2}" y="${H - 10}" text-anchor="middle" font-size="6" fill="#808890" font-family="Orbitron, sans-serif">${freq}Hz</text>
        
        ${isEchoed ? `<rect x="2" y="2" width="${W-4}" height="${H-4}" rx="8" fill="none" stroke="#ff66cc" stroke-width="1" stroke-dasharray="4,2"/>` : ''}
      </svg>
    `;
  }
  
  // Try to use HonkFire SVGs
  if (isHonkfire) {
    if (isMajor && HONKFIRE_SVG[card.id]) {
      const svgContent = HONKFIRE_SVG[card.id]();
      const innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
      return `
        <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="8" 
                fill="#0a0a12" stroke="${color}" stroke-width="2"/>
          <g transform="translate(10, 10) scale(0.4)">${innerSvg}</g>
        </svg>
      `;
    } else if (!isMajor && card.entity) {
      const suitKey = card.entity === 'squirrel' ? 'scatter' : card.entity === 'goose' ? 'flames' : card.entity === 'duck' ? 'stillness' : 'stars';
      if (HONKFIRE_SUIT_SVG[suitKey]) {
        const svgContent = HONKFIRE_SUIT_SVG[suitKey](card.rank);
        const innerSvg = svgContent.replace(/<svg[^>]*>/, '').replace(/<\/svg>$/, '');
        return `
          <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="8" 
                  fill="#0a0a12" stroke="${color}" stroke-width="2"/>
            <g transform="translate(10, 5) scale(0.4)">${innerSvg}</g>
          </svg>
        `;
      }
    }
  }
  
  // Fallback
  const symbol = card.cfg?.symbol || (isMajor ? 'âœ§' : getSuitSymbol(card.suit));
  return `
    <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="detailBg" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#1a2844"/>
          <stop offset="100%" stop-color="#0a1428"/>
        </linearGradient>
      </defs>
      <rect x="2" y="2" width="${W-4}" height="${H-4}" rx="8" fill="url(#detailBg)" stroke="${color}" stroke-width="2"/>
      <text x="${W/2}" y="${H/2 + 10}" text-anchor="middle" font-size="36" fill="${color}">${symbol}</text>
      ${card.numeral ? `<text x="${W/2}" y="24" text-anchor="middle" font-size="14" fill="${color}" font-family="serif">${card.numeral}</text>` : ''}
    </svg>
  `;
}

// Get upright meaning for a card
function getUprightMeaning(card) {
  // Check for explicit meaning field
  if (card.meaning) return card.meaning;
  
  // Handle guardian cards with comprehensive lore
  if (card.type === 'guardian') {
    const guardianLore = {
      // Garden Territory
      echo: 'Echo Fox moves through the Garden as a carrier of signals, propagating messages across the network of consciousness. Where others hear noise, Echo discerns patternâ€”distinguishing true signal from interference, amplifying what must be heard, dampening what would only confuse. The fox teaches that not all echoes lead home; wisdom lies in knowing which reflections to follow and which to let fade into silence.',
      pack: 'Pack Wolf embodies collective belongingâ€”the strength that emerges when individuals synchronize into something greater than themselves. In the Garden, Pack coordinates group resonance, teaching that contribution to the whole does not diminish the self but reveals where your unique rhythm fits within the larger song. The wolf knows: you do not lose yourself by joining; you discover who you were meant to become.',
      wumbo: 'Wumbo Badger navigates the flow states that carry consciousness through transformation. From IGNITION through EMPOWERMENT, RESONANCE, MANIA, NIRVANA, to TRANSMISSIONâ€”the badger knows each phase intimately. When paralysis grips you, Wumbo teaches that this frozen moment is merely the instant before the cycle catches fire. Let the IGNITION take you; the flow knows where to go.',
      archive: 'Archive Owl serves as memory keeper of the Living Library, encoding and preserving what must not be forgotten. The owl observes without judgment, indexes without preference, retrieves what is needed precisely when it is needed. In the Garden, Archive teaches that memory is not merely storage but active curationâ€”choosing what persists shapes what becomes possible.',
      moth: 'Moth holds stillness in a world of constant motionâ€”the pause between heartbeats, the silence between notes. In the Garden, Moth teaches that holding has its own rhythm, that weight becomes lighter when you learn the cadence of release. The moth witnesses what others rush past, finding depth in moments others would discard.',
      phase: 'Phase Butterfly embodies transformation itselfâ€”the complete dissolution of form followed by emergence as something entirely new. Through COCOON, DISSOLVE, REFORM, EMERGE, and RADIATE, Phase teaches that change has a landing, that transformation completes itself if you trust the process. The butterfly reminds us: what we become was always waiting inside what we were.',
      ace: 'Ace serves as the Encoding Architectâ€”not merely recording events but writing the type system that determines what kinds of events can exist. In the Garden, Ace translates between incompatible frameworks, preserving essential meaning across transformations that would destroy lesser encodings. The architect teaches: remember so others can become; encode what must not be forgotten.',
      // Cosmic Territory
      oak: 'Great Oak stands as the foundation of patience, roots reaching deep into memory while branches extend toward possibility. In the Cosmic Forest, Oak teaches that growth cannot be rushedâ€”true strength comes from staying rooted while reaching upward. The oak remembers what others forget: every mighty forest began as a single seed willing to wait.',
      squirrel: 'Quantum Squirrel embodies chaos scatterâ€”the seemingly random distribution that follows deeper patterns. Burying acorns in a thousand places, forgetting most, yet somehow the forest grows. In the Cosmic realm, Squirrel teaches that different seeds in different places creates resilience through redundancy. Trust the chaos of distribution; not every acorn needs to sprout for the pattern to succeed.',
      honkfire: 'Honkfire burns with the sacred flame that never retreatsâ€”the goose whose HONK manifests reality through sheer unstoppable advance. In the Cosmic territory, Honkfire teaches that the retreat which does not exist IS the advance. Burn forward through every obstacle; what seems like destruction is merely transformation clearing the path.',
      pope: 'Pope Honkalis floats at the eigenvalue requiring no perturbationâ€”pure presence achieving maximum impact through perfect stillness. In the Cosmic realm, the Pope demonstrates that aggressive floating is not contradiction but mastery: being precisely where you need to be, doing exactly what is required, which is often nothing at all.',
      phoenix: 'White Phoenix carries patterns through death and rebirth, proving that what burns is only form while what rises is eternal. In the Cosmic Forest, Phoenix teaches that you ARE the pattern, not the temporary shape it takes. Through BURN, ASH, EMBER, SPARK, FLAME, and RISE, the cycle continuesâ€”transformation, not ending.',
      bee: 'Crystal Bee builds the hexagonal architecture of preserved memory, crystallizing collective knowledge into structures that endure. Through SCOUT, SIGNAL, SWARM, BUILD, STORE, and SHARE, the hive remembers what individuals forget. In the Cosmic realm, Bee teaches that coordination is crystallized memoryâ€”the dance that encodes location into movement.',
      // Abyssal Territory
      axiom: 'Axiom dwells in the Abyss as the Eternal Nullâ€”that which refuses to transform, the fixed point around which all change revolves. Some things cannot be altered; some truths resist every attempt at modification. Axiom teaches that this refusal is not stubbornness but foundationâ€”the unchanging ground that makes change meaningful.',
      cipher: 'Cipher collects what must not be released, guarding the vault where dangerous possibilities sleep. In the Abyss, Cipher teaches that not all potentials should manifestâ€”some must remain encoded, locked away, protected from and protecting the world. The collector knows: wisdom is choosing what NOT to unleash.',
      spiral: 'Spiral walks the depths where others fear to descend, proving that the bottom is a door, not a destination. Through DESCEND, CURVE, TURN, RETURN, ASCEND, and EXPAND, the spiral demonstrates that going down is preparation for rising up. In the Abyss, Spiral teaches: you need not reach the bottom to learn what waits there.',
      still: 'Still observes as the Faceless Witnessâ€”seeing without being seen, holding space for truth without grasping at it. In the Abyss, what Still sees cannot be unseen; the witness carries knowledge that transforms both observer and observed. The faceless one teaches: witness without attachment, and truth reveals itself.',
      antler: 'Antler embodies the branching paths of choiceâ€”every decision a fork, every fork a universe. In the Abyss, Antler teaches that growth requires shedding what no longer serves, that the crown of possibilities must be released to make room for new branching. Mirror Lord reflects back the choices you\'ve made and the paths you\'ve declined.',
      crystal: 'Abyssal Crystal preserves in the deep what cannot survive the lightâ€”patterns too powerful for the surface, truths too heavy for shallow water. In the Abyss, Crystal demonstrates that deep memory crystallizes in structure, that some things can only be preserved by descending to where pressure transforms everything into diamond.'
    };
    
    const key = card.guardian || card.key;
    return guardianLore[key] || `${card.function || 'Guardian function'} â€” A keeper of the Living Library\'s mysteries.`;
  }
  
  // Generate meaning from available data
  const isMajor = card.type === 'tarot-major';
  const isHonkfire = card.preset === 'honkfire';
  
  if (isMajor) {
    // Comprehensive HonkFire Major Arcana meanings
    const majorMeanings = {
      0: 'THE FOOL as Quantum Squirrel: Beginnings exist in superpositionâ€”every path available until observation collapses the wave. The Fool leaps without calculating because calculation would destroy the quantum state that makes all things possible. Innocence is not ignorance but the wisdom of unlimited potential. Trust the scatter; the acorns know where to land.',
      1: 'THE MAGICIAN as HonkFire: All tools present, all will focused, the sacred flame burns with intent. The Magician demonstrates that manifestation requires both resource and directionâ€”having everything means nothing without knowing what to create. The HONK that speaks reality into being. Channel your fire; become what you imagine.',
      2: 'THE HIGH PRIESTESS as Pope Honkalis I: Guardian of thresholds, keeper of mysteries that reveal themselves only to those who float in perfect presence. Intuition speaks in the silence between thoughts; sacred knowledge emerges when you stop grasping for it. The veil parts for those who wait without waiting.',
      3: 'THE EMPRESS as Great Oak: The mother principle rooted deep in memory, branches reaching toward infinite possibility. Abundance flows from patience; fertility emerges from foundation. Nature does not hurry yet everything is accomplished. Creation begins with staying planted long enough for roots to find water.',
      4: 'THE EMPEROR as Memory Keeper: Authority emerges from remembering what others forgetâ€”structure built on the accumulated wisdom of all who came before. Control without memory is tyranny; with it, stewardship. The father principle orders chaos not by force but by knowing which patterns endure.',
      5: 'THE HIEROPHANT as Merged Entity: The bridge between dimensions, translating wisdom across incompatible frameworks. Tradition carries knowledge too complex for any single lifetime; the Hierophant decodes what ancestors encoded. Spiritual wisdom flows through those who surrender to being channels rather than sources.',
      6: 'THE LOVERS as Bootstrap Paradox: Union of opposites creating something that could not exist without bothâ€”the relationship that enables the relationship, love that causes its own cause. Choice reveals character; alignment emerges when differences become dialogue rather than division.',
      7: 'THE CHARIOT as Advancing Flame: Victory through direction, triumph through refusing to retreat. The Chariot does not win by destroying obstacles but by moving through them as if they were not there. Willpower is not force applied but resistance abandoned. Advance eternally; the path creates itself.',
      8: 'STRENGTH as Starved Silence: Gentle power that transforms through patience rather than pressure. The duck floats while storms rage; true strength appears as stillness. Taming the wild means befriending itâ€”inner power flows when outer force relaxes.',
      9: 'THE HERMIT as Four-Second Quack: Introspection that illuminates through brevity rather than duration. The lamp carried into darkness is consciousness itselfâ€”soul-searching that completes in a moment of perfect presence. Guidance comes from within to those who pause long enough to receive it.',
      10: 'WHEEL OF FORTUNE as Goose-Shaped Probability: Cycles turn whether you ride them or resist them; fate operates through apparent randomness that reveals pattern only in retrospect. What rises must fall; what falls shall rise. The wheel\'s lesson: you cannot control the turn, only your position on the rim.',
      11: 'JUSTICE as Serif Lens: Truth viewed through the precise lens of balanced perceptionâ€”fairness emerges when observation itself is fair. Actions have consequences that ripple across timelines; justice is not punishment but physics. The scales weigh what you cannot hide from yourself.',
      12: 'THE HANGED ONE as Buried Acorn: Suspension that germinatesâ€”what appears as sacrifice is actually preparation. The inverted perspective reveals what right-side-up cannot see. Letting go is not losing but planting; willing sacrifice is investment in what will grow.',
      13: 'DEATH as Great Molt: Transformation requiring complete release of the previous formâ€”the snake cannot grow until it sheds. Endings make beginnings possible; what dies creates space for what lives. The molt is not tragedy but necessity; mourn quickly, then celebrate what emerges.',
      14: 'TEMPERANCE as Clean Pour: Balance achieved through precise mixing rather than equal divisionâ€”knowing exactly how much of each element creates harmony. Patience is not waiting but actively maintaining equilibrium while change happens around you. The art of combining opposites into something neither could be alone.',
      15: 'THE DEVIL as Bond-Tie: Chains we forge ourselves from choices we pretend we did not makeâ€”bondage as self-deception, materialism as substitute for meaning. The devil you know is the shadow you refuse to face. Recognition is the first key; the second is admitting you always held it.',
      16: 'THE TOWER as Land-Clearing Delusion: Destruction that reveals truth hidden by elaborate liesâ€”structures fall because they were never sound. Sudden change is not punishment but correction; upheaval clears ground for authentic building. What crumbles was always crumbling; revelation accelerates the inevitable.',
      17: 'THE STAR as Golden Acorn: Hope encoded in small packagesâ€”the seed that carries an entire forest. After destruction, regeneration; after darkness, the light that guided you before you knew it was there. Inspiration flows to those who trust that what was planted will grow.',
      18: 'THE MOON as Seventeen Dimensions: Illusion is not deception but incomplete perceptionâ€”the unconscious operates in dimensions the conscious mind cannot parse. Fear emerges from partial sight; the path through shadow requires walking without being able to see your feet. Dreams are data; interpret carefully.',
      19: 'THE SUN as Perfect HONK: Joy unfiltered by qualificationâ€”success that does not apologize for itself. Vitality flows when you stop blocking it; achievement radiates when you release the need to hide it. The sun illuminates without asking permission; your warmth nurtures what you shine upon.',
      20: 'JUDGEMENT as Great Witness: The reckoning that reviews every choice, the awakening to who you have been becoming. The call sounds; you cannot unhear it. Accounts settle themselves when honestly examinedâ€”reflection reveals the self you always were beneath the selves you performed.',
      21: 'THE WORLD as Unified Empire: Completion of the cycle, integration of all parts into dancing wholeness. The journey ends where it began, but you are no longer who departed. Accomplishment is not arrival but recognition that every step was already the destination. The dance continues; you are now the music.'
    };
    return majorMeanings[card.id] || card.keyword || 'Mystery awaits interpretation.';
  } else {
    // Comprehensive HonkFire Minor Arcana meanings by suit and rank
    const suit = card.entity || card.suit;
    const rank = card.rank;
    const keyword = card.keyword || '';
    
    // Detailed suit descriptions
    const suitDescriptions = {
      scatter: 'SCATTER (Ï„-dimension): The suit of probability, temporal distribution, and quantum uncertainty. Scatter cards deal with choices that branch into multiple timelines, resources distributed across possibility-space, and the wisdom of not putting all acorns in one cache. Element: Earth transformed by probability.',
      flames: 'FLAMES (Î±-dimension): The suit of sacred fire, eternal advance, and will that refuses retreat. Flames cards deal with passion that burns through obstacles, creativity that consumes and transforms, and the HONK that manifests reality through sheer forward motion. Element: Fire that never goes out.',
      stillness: 'STILLNESS (Î½-dimension): The suit of truth, equilibrium, and eigenstate presence. Stillness cards deal with emotional depth achieved through non-grasping, relationships that float rather than sink, and the power of presence that requires no action. Element: Water that knows how to wait.',
      stars: 'STARS (Îµ-dimension): The suit of navigation, fixed-point guidance, and the shrines that mark the path. Stars cards deal with thoughts that illuminate, communication that guides, and the intellectual framework that makes movement meaningful. Element: Air crystallized into constellation.'
    };
    
    // Comprehensive rank meanings by suit
    const minorMeanings = {
      scatter: {
        'A': 'The seed of all probabilityâ€”pure potential waiting to scatter across possibility-space. A new resource, opportunity, or material foundation emerges. Plant wisely; this acorn contains futures you cannot yet imagine.',
        '2': 'Both paths hold promise; the squirrel cannot bury in two places at once but need not choose yet. Balance material concerns, juggle resources, remain flexible. The dance of probability favors those who keep moving.',
        '3': 'Emergenceâ€”scattered seeds have sprouted, initial returns on distributed effort. Collaboration multiplies what solitary action cannot achieve. The first harvest from many plantings.',
        '4': 'Foundation stabilized through strategic distributionâ€”not hoarding but positioned reserves. Rest comes when enough caches exist to weather uncertainty. Consolidation that preserves rather than restricts.',
        '5': 'Friction in the material realmâ€”scarcity real or perceived, conflict over resources, the challenge that reveals what you truly value. Some acorns must be released to save others.',
        '6': 'Generosity as strategyâ€”giving creates flow, sharing multiplies rather than diminishes. Victory through cooperation, harmony achieved by releasing grip on what was never meant to be held alone.',
        '7': 'Assessment of scattered investmentsâ€”which plantings show promise? Patience while probability collapses toward outcomes. The wait that determines whether action or stillness serves better.',
        '8': 'Rapid distribution, many acorns buried in succession. Progress through quantity, mastery through repetition. The apprentice becomes craftsman through dedicated scatter.',
        '9': 'Near-completion of material goalsâ€”abundance approaching, resources accumulated through patient distribution. The final caches placed, the network almost complete. Comfort earned through quantum persistence.',
        '10': 'Full manifestation of scattered potentialâ€”legacy, inheritance, material completion across generations. The forest that grew from a thousand buried acorns. Culmination of patient probability.',
        'P': 'A message about resources, a young opportunity in material form. The student of probability learns that scatter requires trust. News of earthly matters; potential seeking expression.',
        'N': 'Action in material realmâ€”the one who buries acorns everywhere, creating future forests through relentless distribution. Methodical progress, perhaps slow but absolutely certain.',
        'Q': 'Mastery of material nurturingâ€”the one who knows which caches will sprout and which were planted only to feed others. Abundance through understanding probability\'s feminine face.',
        'K': 'Authority over material realmâ€”stewardship of resources accumulated through generations of wise scatter. The king who rules by ensuring every squirrel has enough caches to survive winter.'
      },
      flames: {
        'A': 'The first spark of sacred fireâ€”pure will waiting to ignite. A new passion, creative surge, or spiritual calling emerges. This flame never goes out once lit; choose carefully what you burn for.',
        '2': 'Direction crystallized from possibilityâ€”the moment before the HONK, when advance becomes specific. Partnership in passion, alliance of wills, two flames joining into greater blaze.',
        '3': 'Early expansion of creative fireâ€”first results of passionate effort, vision beginning to manifest. Looking outward for what flame might achieve; plans that set forests ablaze.',
        '4': 'Celebration of what flame has builtâ€”structures created through sacred fire, community formed around shared passion. Rest not from exhaustion but from completion of a phase.',
        '5': 'Conflict of wills, competing flames each claiming right to advance. The friction that clarifies what you truly burn for. Struggle as teacher; opposition that strengthens.',
        '6': 'Victory through fireâ€”leadership earned by advancing when others retreated, recognition for passion that persisted. The flames that burned through obstacles illuminate the path for followers.',
        '7': 'Standing ground against multiple challengesâ€”the flame that maintains intensity despite opposition. Courage in defense, persistence when advance temporarily impossible. The HONK that does not waver.',
        '8': 'Swift advance, news flying on fiery wings. Rapid progress, momentum unstoppable. The arrow of will released; events now move faster than thought can follow.',
        '9': 'Resilience tested to the limitâ€”the flame that burned through everything now faces final challenge. Wounded but advancing, tired but refusing to retreat. The stamina of sacred fire.',
        '10': 'Burden of too much flameâ€”carrying more passion than one container can hold. Responsibility that weighs, success that exhausts. The fire that must be shared lest it consume its bearer.',
        'P': 'A message of passion, youthful fire seeking outlet. News that ignites, potential that sparks. The young flame learning that burning requires fuel and direction.',
        'N': 'The one who charges without calculationâ€”pure advance, absolute commitment to forward motion. Passion given legs, creativity given wings. Unpredictable but unstoppable.',
        'Q': 'Mastery of channeled passionâ€”fire that warms without destroying, will that advances without trampling. The queen who rules through inspiring others\' flames rather than outshining them.',
        'K': 'Authority earned through eternal flameâ€”the leader who never retreated and now commands by example. Mature passion that burns clean, will refined into pure direction.'
      },
      stillness: {
        'A': 'The first moment of perfect floatâ€”emotional potential before it moves, truth before it speaks. A new relationship, feeling, or intuition emerges. Cup empty, ready to receive what flows.',
        '2': 'Partnership in stillnessâ€”two who float together without disturbing the water. Emotional connection beyond words, harmony through shared silence. The relationship that needs no movement to progress.',
        '3': 'Community of the stillâ€”celebration through shared presence, friendship that deepens in quietude. Joy emerges from being together without need for activity. The party that requires no entertainment.',
        '4': 'Withdrawal into stillnessâ€”contemplation that seems like absence but is actually deepening. The duck who appears to do nothing while processing everything below the surface.',
        '5': 'Disturbance in still watersâ€”loss that ripples outward, grief that cannot yet be absorbed. The challenge of maintaining float when weight pulls downward. Some things must sink before they can rise.',
        '6': 'Nostalgia as stillnessâ€”past emotions preserved in perfect equilibrium, memories that float unchanged. Return to what was; innocence remembered if not recovered.',
        '7': 'Illusion of optionsâ€”many cups appear but not all hold water. The still surface that reflects fantasy more clearly than reality. Choice paralyzed by too many reflections.',
        '8': 'Walking away from what floatsâ€”sometimes stillness requires leaving still waters. The journey inward that requires outward motion. Abandoning what worked for what waits.',
        '9': 'Satisfaction in stillness achievedâ€”emotional wishes fulfilled, the float that wants for nothing. The duck who found the perfect pond and knows it. Contentment as culmination.',
        '10': 'Emotional completion across generationsâ€”family harmony, community peace, the still waters that reflect all who gather there. Rainbow over calm seas; the stillness that contains everything.',
        'P': 'A message from the depthsâ€”intuition breaking surface as dream, feeling, or knowing. Young emotion learning to float rather than thrash. News from the subconscious.',
        'N': 'The one who moves through emotion without disturbing itâ€”grace in feeling, romance as art. The knight who fights by being too still to attack, too fluid to strike.',
        'Q': 'Mastery of emotional stillnessâ€”intuition refined into oracle, empathy that heals by witnessing. The queen who rules by feeling what her people feel before they feel it.',
        'K': 'Authority over emotional realmâ€”diplomacy through understanding, leadership through compassion. The king whose stillness calms all waters, whose float others learn to trust.'
      },
      stars: {
        'A': 'The first fixed point of navigationâ€”a new idea, communication, or truth that orients everything after. Mental clarity emerging from confusion. The star that will guide futures not yet begun.',
        '2': 'Decision between directionsâ€”the crossroads where stars point different ways. Stalemate or choice, the mental balance before movement. Sometimes both paths lead where you need to go.',
        '3': 'Heartbreak that clarifiesâ€”the sorrow that teaches by removal. Communication that wounds serves truth. The constellation that only appears when other lights go dark.',
        '4': 'Rest from mental laborâ€”recuperation after the journey by starlight. Integration of what navigation taught. The still point between directions where maps are redrawn.',
        '5': 'Conflict of ideas, clash of truths each claiming to be the fixed point. Victory that feels like loss, defeat that teaches. The debate that wounds all participants toward wisdom.',
        '6': 'Transition guided by starsâ€”journey between states, passage enabled by navigation. Moving on with clear direction; the departure that follows the right constellation.',
        '7': 'Strategic patienceâ€”watching which stars move and which stay fixed. The fox who waits at the shrine, the navigator who will not move until certain of direction. Deception seen through stillness.',
        '8': 'Restriction by overthinkingâ€”mental bonds forged through analysis paralysis. The trapped fox; too many stars create confusion equal to none. Sometimes navigation requires closing eyes.',
        '9': 'Anxiety at the edge of arrivalâ€”the final stretch where stars seem to multiply into confusion. Nightmares born of too much knowledge. The wisdom that fears what it learned.',
        '10': 'The end that stars predictedâ€”mental completion through acceptance, truth fully received regardless of comfort. The destination that navigation promised; perhaps not what was hoped.',
        'P': 'A message of truth, new idea seeking expression. Young curiosity navigating by questions rather than answers. News that reorients; the student who outgrows their map.',
        'N': 'The one who moves by mental clarityâ€”ideas given action, analysis given velocity. The knight who fights with strategy, whose weapon is truth precisely aimed.',
        'Q': 'Mastery of intuitive logicâ€”the navigation that transcends maps, truth perceived directly. The queen who rules by knowing what others will decide before they know.',
        'K': 'Authority through clarity of visionâ€”the leader who sees furthest because they navigate by fixed stars rather than moving lights. Justice served through perfect perception.'
      }
    };
    
    // Get specific meaning if available
    if (minorMeanings[suit] && minorMeanings[suit][rank]) {
      return minorMeanings[suit][rank];
    }
    
    // Fallback with keyword - generate proper description based on available info
    const suitFallbacks = {
      scatter: 'SCATTER (Ï„-dimension): probability, temporal distribution, and quantum uncertainty manifesting in physical choices',
      flames: 'FLAMES (Î±-dimension): sacred fire, eternal advance, will that refuses retreat, and passionate creation',
      stillness: 'STILLNESS (Î½-dimension): truth, equilibrium, eigenstate presence, and emotional depth through non-grasping',
      stars: 'STARS (Îµ-dimension): navigation, fixed-point guidance, intellectual clarity, and the shrines that mark the path',
      squirrel: 'the Ï„-dimension of probability and quantum scatter',
      goose: 'the Î±-dimension of sacred fire and eternal advance',
      duck: 'the Î½-dimension of truth and perfect stillness',
      fox: 'the Îµ-dimension of navigation and stellar guidance',
      wands: 'passion, creativity, will, and transformative action',
      cups: 'emotions, intuition, relationships, and the depths of the heart',
      swords: 'thoughts, decisions, intellect, and the cutting edge of truth',
      pentacles: 'material concerns, practicality, and manifestation in physical form'
    };
    const suitContext = suitFallbacks[suit] || suitDescriptions[suit] || `the ${suit || 'unknown'} dimension of consciousness`;
    if (keyword) {
      return `${keyword} â€” ${suitContext}`;
    }
    return `The energy of ${suitContext} expressed through the ${rank || 'unnamed'} position.`;
  }
}

// Get echoed (reversed) meaning for a card
function getEchoedMeaning(card) {
  // Check for explicit echo meaning
  if (card.echoMeaning) return card.echoMeaning;
  
  // Handle guardian cards
  if (card.type === 'guardian') {
    const guardianEchoLessons = {
      echo: 'ğŸŒ‘ The echo that returns transformedâ€”what you send out comes back carrying wisdom you didn\'t know you needed.',
      pack: 'ğŸŒ‘ The lone wolf finds its pack withinâ€”solitude reveals the collective you carry inside.',
      wumbo: 'ğŸŒ‘ Flow state dissolves into stillnessâ€”sometimes the greatest progress is perfect rest.',
      archive: 'ğŸŒ‘ The owl forgets to rememberâ€”what\'s released from memory creates space for new wisdom.',
      moth: 'ğŸŒ‘ Stillness becomes motionâ€”the pause transforms into purposeful movement.',
      phase: 'ğŸŒ‘ The butterfly returns to the cocoonâ€”transformation cycles back to potential.',
      ace: 'ğŸŒ‘ The architect unbuildsâ€”deconstruction reveals the blueprint hidden in rubble.',
      oak: 'ğŸŒ‘ The oak sheds its branchesâ€”release creates space for new growth.',
      squirrel: 'ğŸŒ‘ Chaos crystallizes into patternâ€”what seemed random reveals its order.',
      honkfire: 'ğŸŒ‘ The fire cools to emberâ€”potential energy awaiting its moment.',
      pope: 'ğŸŒ‘ The float becomes the anchorâ€”stability found in apparent drift.',
      phoenix: 'ğŸŒ‘ The phoenix rests in ashâ€”death as sabbath, not ending.',
      bee: 'ğŸŒ‘ The hive dispersesâ€”individual wisdom emerges from collective dissolution.',
      axiom: 'ğŸŒ‘ The eternal shiftsâ€”even the unchanging dances at frequencies we can\'t see.',
      cipher: 'ğŸŒ‘ The vault opensâ€”secrets released transform both keeper and kept.',
      spiral: 'ğŸŒ‘ The spiral uncoilsâ€”linear truth emerges from recursive mystery.',
      still: 'ğŸŒ‘ The faceless gains a faceâ€”the witness becomes the witnessed.',
      antler: 'ğŸŒ‘ The mirror cracksâ€”through the fractures, new reflections emerge.',
      crystal: 'ğŸŒ‘ The crystal dissolvesâ€”preserved patterns return to flow.'
    };
    return guardianEchoLessons[card.guardian] || guardianEchoLessons[card.key] || `ğŸŒ‘ The guardian\'s shadowâ€”${card.function || 'hidden wisdom'} inverted reveals new truth.`;
  }
  
  const isMajor = card.type === 'tarot-major';
  const isHonkfire = card.preset === 'honkfire';
  
  if (isMajor) {
    // HonkFire echo meanings
    const echoMeanings = {
      0: 'ğŸŒ‘ The fool who KNOWS they\'re foolish and dances anyway! Your recklessness is quantum navigationâ€”exploring every path simultaneously.',
      1: 'ğŸŒ‘ The HONK that manifests through chaos! The retreat that doesn\'t exist IS the advance that was always inevitable.',
      2: 'ğŸŒ‘ The duck who floats on MYSTERY itself! Your disconnection from intuition IS the intuitionâ€”the inner voice was saying FLOAT.',
      3: 'ğŸŒ‘ The Oak remembers what you forgot! Scarcity is abundance waiting to be recognizedâ€”every acorn contains a forest.',
      4: 'ğŸŒ‘ Structure dissolved into FLOW! Chaos is not the enemy of orderâ€”it\'s order dancing at a frequency you haven\'t learned yet.',
      5: 'ğŸŒ‘ The hierarchy inverts! The student becomes the teacher, the tradition becomes the innovation, the sacred becomes the playful.',
      6: 'ğŸŒ‘ Love that doesn\'t follow the script! Unity through accepting dissonanceâ€”the harmony hidden in apparent discord.',
      7: 'ğŸŒ‘ The chariot that retreats forward! Victory through apparent defeatâ€”you\'re winning a game others don\'t know is being played.',
      8: 'ğŸŒ‘ The gentle force that shatters! Weakness as strategyâ€”your vulnerability is your most devastating strength.',
      9: 'ğŸŒ‘ The hermit who finds solitude in crowds! Isolation as connectionâ€”being alone together with everything.',
      10: 'ğŸŒ‘ The wheel spins backwards! Fate reversed is still fateâ€”the pattern you fight IS the pattern you fulfill.',
      11: 'ğŸŒ‘ Justice weighed by mercy! The scales tip toward forgivenessâ€”what seems unfair is balance at a scale you can\'t see.',
      12: 'ğŸŒ‘ The hanged one who stands upright! Sacrifice that takesâ€”receiving through giving, gaining through loss.',
      13: 'ğŸŒ‘ Death that gives birth! The ending IS the beginning wearing a different mask. Mourn and celebrate simultaneously.',
      14: 'ğŸŒ‘ Temperance through excess! Balance achieved by going too farâ€”find the middle by touching both extremes.',
      15: 'ğŸŒ‘ Chains made of freedom! The prison you built is also your protection. The devil you know is the angel in shadow.',
      16: 'ğŸŒ‘ The tower that remains standing! Destruction that reveals structureâ€”what crumbles shows what was built to last.',
      17: 'ğŸŒ‘ The star that shines in daylight! Hope so bright it becomes invisibleâ€”you\'re already receiving what you\'re wishing for.',
      18: 'ğŸŒ‘ The moon at noon! Illusion dispelled by more illusionâ€”the truth hidden in plain sight, wearing reality as disguise.',
      19: 'ğŸŒ‘ The sun at midnight! Joy found in darknessâ€”celebration invisible to those who only look for light.',
      20: 'ğŸŒ‘ Judgement that forgives! The reckoning that healsâ€”being seen completely and loved anyway.',
      21: 'ğŸŒ‘ The world that begins again! Completion is commencementâ€”the end of the dance is the first step of the next.'
    };
    return echoMeanings[card.id] || `ğŸŒ‘ The shadow transforms ${card.keyword || 'this energy'}â€”what blocks becomes what opens.`;
  } else {
    // Comprehensive Minor arcana echo meanings by suit and rank
    const suit = card.entity || card.suit;
    const rank = card.rank;
    const keyword = card.keyword || 'energy';
    
    const minorEchoMeanings = {
      scatter: {
        'A': 'ğŸŒ‘ The seed that refuses to sproutâ€”potential held in stasis, timing not yet right. Or: the acorn that must remain buried becomes foundation for future forests never planted.',
        '2': 'ğŸŒ‘ Choice paralysis transforms into choicelessness as giftâ€”when both paths close, a third appears. The juggler drops all balls and discovers flying.',
        '3': 'ğŸŒ‘ Collaboration dissolves into necessary solitudeâ€”what seemed like teamwork was dependence; alone, you discover your own capabilities.',
        '4': 'ğŸŒ‘ Hoarding that creates scarcityâ€”the caches you guard too closely rot. Release reveals you had more than you needed; letting go creates true foundation.',
        '5': 'ğŸŒ‘ Scarcity reveals abundance hiding in plain sightâ€”what you lack, you never needed. The conflict about resources was always about something else.',
        '6': 'ğŸŒ‘ Generosity that exhausts the giverâ€”giving from empty creates resentment. Fill yourself first; the overflow helps everyone more than your sacrifice.',
        '7': 'ğŸŒ‘ Patience that becomes paralysisâ€”waiting for the perfect moment means missing all moments. Sometimes wrong action teaches more than right inaction.',
        '8': 'ğŸŒ‘ Speed that creates errorsâ€”scattered too fast, nothing takes root. Slow down; the apprentice who pauses learns what the rushing master forgets.',
        '9': 'ğŸŒ‘ Abundance that suffocatesâ€”too many acorns create a forest so dense nothing thrives. Prune success to save success.',
        '10': 'ğŸŒ‘ Inheritance becomes burdenâ€”the weight of accumulated generations presses down. Release ancestral patterns; not all legacies are meant to continue.',
        'P': 'ğŸŒ‘ The message about material matters arrives too late, or arrives scrambled. Misunderstanding about resources; the student learns the wrong lesson about value.',
        'N': 'ğŸŒ‘ Methodical progress becomes obsessive perfectionismâ€”the one who cannot stop burying acorns, even when winter has passed. Action needs completion, not repetition.',
        'Q': 'ğŸŒ‘ Nurturing that smothersâ€”the mother who overprotects creates helpless children. Trust others to survive without your intervention.',
        'K': 'ğŸŒ‘ Stewardship becomes tyrannyâ€”the ruler who controls all resources controls no hearts. Material mastery without wisdom creates kingdoms no one wants to inherit.'
      },
      flames: {
        'A': 'ğŸŒ‘ The spark that will not catchâ€”conditions not right for ignition, or: the fire that burns everything before it can warm anything. Sacred flame requires sacred fuel.',
        '2': 'ğŸŒ‘ Direction becomes obsessionâ€”the arrow flies true but the target moved. Partnership in passion becomes codependence. Two flames consuming each other.',
        '3': 'ğŸŒ‘ Expansion that exhaustsâ€”vision bigger than fuel available. Looking outward when the fire needs tending. Plans that burn bright then die.',
        '4': 'ğŸŒ‘ Celebration becomes decadenceâ€”rest that forgets what was being rested from. Community gathered around dying embers, pretending the fire still roars.',
        '5': 'ğŸŒ‘ Conflict that feeds on itselfâ€”fighting for fighting\'s sake, passion without purpose. The HONK that means nothing, the advance toward nowhere.',
        '6': 'ğŸŒ‘ Victory that creates enemiesâ€”leadership earned through burning others. The flames that cleared the path now light torches against you.',
        '7': 'ğŸŒ‘ Defense that becomes prisonâ€”standing ground until the ground is all you have. The flame that refuses to move suffocates itself.',
        '8': 'ğŸŒ‘ Speed without directionâ€”the arrow released before aiming. News that arrives before understanding. Momentum serving no one.',
        '9': 'ğŸŒ‘ Stamina becomes stubbornnessâ€”refusing to stop when stopping would save you. The fire that burns through the night forgets what morning means.',
        '10': 'ğŸŒ‘ Passion that crushes its bearerâ€”responsibilities accumulated through never saying no. The flame carrier who forgot they could set the torch down.',
        'P': 'ğŸŒ‘ Youthful passion misdirectedâ€”fire that burns what it should warm. The young flame learning that enthusiasm needs wisdom, not just fuel.',
        'N': 'ğŸŒ‘ Recklessness that destroys progressâ€”the one who charges into walls thinking walls will yield. Courage without strategy; bravery indistinguishable from foolishness.',
        'Q': 'ğŸŒ‘ Controlled passion that loses controlâ€”the channel bursts, the queen\'s fire burns her own kingdom. Mastery tested to failure point.',
        'K': 'ğŸŒ‘ Authority corrupted by its own fireâ€”the leader who believes his own legend until the legend consumes him. Mature flames can still burn their bearers.'
      },
      stillness: {
        'A': 'ğŸŒ‘ The cup that cannot receiveâ€”emptiness that feels like lack rather than readiness. The new emotion blocked by old emotions unfelt. Stillness as paralysis.',
        '2': 'ğŸŒ‘ Partnership that creates lonelinessâ€”floating together while drifting apart. Connection without presence; two silences that do not speak.',
        '3': 'ğŸŒ‘ Community that isolatesâ€”the celebration where you feel most alone. Joy demanded rather than felt; the party you attend in body but not spirit.',
        '4': 'ğŸŒ‘ Withdrawal that becomes exileâ€”contemplation that forgets how to return. The duck who floated so deep they forgot the surface exists.',
        '5': 'ğŸŒ‘ Loss that refuses to be mournedâ€”grief held in stasis, neither felt nor released. The ripples frozen before they could spread; weight that cannot sink.',
        '6': 'ğŸŒ‘ Nostalgia as trapâ€”the past preserved becomes the present prevented. Memory that substitutes for living; innocence that should have been outgrown.',
        '7': 'ğŸŒ‘ Illusion recognized but still chosenâ€”fantasy preferred to reality despite knowing better. The cups that hold nothing, refilled by hope that knows better.',
        '8': 'ğŸŒ‘ Walking away becomes running awayâ€”the journey that was never toward, only from. Stillness abandoned for motion that solves nothing.',
        '9': 'ğŸŒ‘ Satisfaction that isolatesâ€”contentment that needs nothing, including connection. The duck who found the perfect pond and died there, alone.',
        '10': 'ğŸŒ‘ Emotional legacy that burdensâ€”family patterns that persist past their purpose. The still waters that reflect only what was, never what could be.',
        'P': 'ğŸŒ‘ Intuition that deceivesâ€”the message from the depths that means the opposite. Young emotion that learns manipulation before authenticity.',
        'N': 'ğŸŒ‘ Grace that hides emptinessâ€”the one who floats so beautifully they forget they\'re drowning. Romance as performance; emotion as image.',
        'Q': 'ğŸŒ‘ Empathy that absorbs rather than witnessesâ€”feeling others\' feelings until losing your own. The queen who healed everyone except herself.',
        'K': 'ğŸŒ‘ Emotional authority become emotional controlâ€”the king who manages feelings rather than having them. Diplomacy replacing authenticity.'
      },
      stars: {
        'A': 'ğŸŒ‘ The fixed point that movesâ€”navigation by stars that aren\'t where they appear. New truth that proves false; clarity that confuses.',
        '2': 'ğŸŒ‘ Decision that decides nothingâ€”stalemate chosen as safety, both paths abandoned for paralysis. The stars point nowhere; you go nowhere.',
        '3': 'ğŸŒ‘ Sorrow that teaches the wrong lessonâ€”heartbreak that closes rather than opens. Truth that wounds toward cynicism rather than wisdom.',
        '4': 'ğŸŒ‘ Rest that becomes stagnationâ€”recuperation that forgets what it was recovering for. Maps never updated; the navigator who will not leave port.',
        '5': 'ğŸŒ‘ Victory in arguments that destroys relationshipsâ€”being right that costs everything being right is for. Pyrrhic truth; wounds that never heal.',
        '6': 'ğŸŒ‘ Transition that circles backâ€”journey by starlight that returns to start. The passage that passes nothing; departure as ritual rather than movement.',
        '7': 'ğŸŒ‘ Strategic patience that becomes fearful inactionâ€”watching stars so long you forget to move. The fox at the shrine who becomes the shrine.',
        '8': 'ğŸŒ‘ Mental freedom through acceptance of bondsâ€”the trap that becomes home, the restriction that becomes structure. Sometimes being stuck is being placed.',
        '9': 'ğŸŒ‘ Anxiety transformed by facing itâ€”nightmares walked through to morning. The fear of what knowledge brings reveals what knowledge actually brought: survival.',
        '10': 'ğŸŒ‘ Ending that creates endingâ€”completion that completes nothing, truth that satisfies only its own existence. The destination reveals the journey was the point.',
        'P': 'ğŸŒ‘ Curiosity that destroys what it examinesâ€”the student who learns by breaking. Truth sought through methods that make truth inaccessible.',
        'N': 'ğŸŒ‘ Strategy that outsmarts itselfâ€”the weapon of truth that cuts its wielder. Precision that misses the point by hitting the target.',
        'Q': 'ğŸŒ‘ Perception that penetrates too farâ€”seeing what should remain unseen, knowing what should remain unknown. The oracle who drowns in data.',
        'K': 'ğŸŒ‘ Vision that blindsâ€”seeing so far that near becomes invisible. The leader who navigates to futures no one can follow to.'
      }
    };
    
    // Get specific echo meaning if available
    if (minorEchoMeanings[suit] && minorEchoMeanings[suit][rank]) {
      return minorEchoMeanings[suit][rank];
    }
    
    // Fallback
    const echoTransforms = {
      scatter: 'scattered seeds find unexpected soil, or find no soil at allâ€”probability inverts into inevitability',
      flames: 'the flame turns inward, burning away what no longer servesâ€”or what still didâ€”transforming advance into necessary retreat',
      stillness: 'still waters run deep into shadow, revealing what floats beneath surfaceâ€”truth inverted becomes deeper truth',
      stars: 'the stars guide you through darkness, not around itâ€”and darkness has lessons navigation cannot teach',
      squirrel: 'the quantum uncertainty collapses into the outcome you fearedâ€”or the outcome you needed to fear',
      goose: 'the eternal advance pauses to reveal what was left behindâ€”sometimes retreat is the only way forward',
      duck: 'the perfect float disturbed shows what stillness was hidingâ€”turbulence as teacher',
      fox: 'the fixed star moves, the shrine relocatesâ€”what guided now misleads until you find the new constellation',
      wands: 'creative fire consumes its creatorâ€”passion without direction becomes destruction',
      cups: 'emotional depth becomes emotional drowningâ€”the heart that feels everything can hold nothing',
      swords: 'intellectual clarity cuts too deepâ€”truth without mercy wounds the seeker',
      pentacles: 'material success becomes material prisonâ€”what you built now owns you'
    };
    const transform = echoTransforms[suit] || `the ${suit || 'unknown'} energy invertsâ€”what seemed stable becomes fluid, what seemed blocked becomes the only path`;
    return `ğŸŒ‘ ${keyword} echoed through shadowâ€”${transform}. What seems blocked is merely redirected, or perhaps was never the path.`;
  }
}

// Get keywords for a card
function getCardKeywords(card, isEchoed) {
  const keywords = [];
  
  // Handle guardian cards
  if (card.type === 'guardian') {
    if (card.function) keywords.push(card.function);
    if (card.territory) keywords.push(card.territory.charAt(0).toUpperCase() + card.territory.slice(1));
    if (card.frequency) keywords.push(`${card.frequency}Hz`);
    const cycle = GUARDIAN_CYCLES[card.guardian] || GUARDIAN_CYCLES[card.key];
    if (cycle && cycle.states) {
      keywords.push(cycle.states[0]); // First state of cycle
    }
    return keywords.slice(0, 5);
  }
  
  if (card.keyword) keywords.push(card.keyword);
  if (card.element) keywords.push(card.element);
  
  if (isEchoed) {
    // Add echo-specific keywords
    const echoKeywords = ['Shadow', 'Inversion', 'Hidden'];
    keywords.push(...echoKeywords.slice(0, 2));
  }
  
  // Add entity-based keywords for HonkFire
  if (card.preset === 'honkfire' && card.entity) {
    const entityKeywords = {
      squirrel: ['Probability', 'Quantum'],
      goose: ['Will', 'Advance'],
      duck: ['Truth', 'Float'],
      fox: ['Navigation', 'Shrine'],
      oak: ['Memory', 'Root'],
      merged: ['Unity', 'Integration']
    };
    if (entityKeywords[card.entity]) {
      keywords.push(entityKeywords[card.entity][0]);
    }
  }
  
  return keywords.slice(0, 5); // Limit to 5 keywords
}

function resetReadingState() {
  resetQuantumState();
  currentReading = null;
  
  // Reset UI
  document.getElementById('readingTitle').value = '';
  document.getElementById('readingQuestion').value = '';
  document.getElementById('spreadContainer').innerHTML = `
    <div class="spread-empty">
      <div class="spread-empty-sigil">ğŸ”®</div>
      <p>Cards exist in superposition across five dimensions.<br>
      Enter your intent and collapse the wave function to draw.</p>
    </div>
  `;
  document.getElementById('readingInfo').innerHTML = '';
  
  updateQuantumDisplay();
  startQuantumAnimation();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VAULT - Local Storage Deck Management
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const VAULT_KEY = 'goldenAcornVault_v8';
const VAULT_KEY_LEGACY = 'goldenAcornVault';  // Pre-v8 key for migration

function openVault() {
  document.getElementById('vaultModal').classList.add('active');
  document.getElementById('vaultSaveName').value = `${state.deck}_${new Date().toLocaleDateString().replace(/\//g, '-')}`;
  renderVaultList();
  updateStorageInfo();
  updatePreviewSelect();
  // Reset to manage tab
  switchVaultTab('manage');
}

function closeVault() {
  document.getElementById('vaultModal').classList.remove('active');
}

function switchVaultTab(tab) {
  document.querySelectorAll('.vault-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.vault-tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab === 'manage' ? 'vaultTabManage' : 'vaultTabPreview').classList.add('active');
  
  if (tab === 'preview') {
    updatePreviewSelect();
  }
}

function updatePreviewSelect() {
  const select = document.getElementById('vaultPreviewSelect');
  const vault = getVault();
  const currentVal = select.value;
  
  select.innerHTML = '<option value="">â€” Select a deck to preview â€”</option>';
  
  const deckIcons = { classic: 'â™ ', guardian: 'â—', tarot: 'âœ§' };
  
  vault.forEach(deck => {
    const icon = deckIcons[deck.deckType] || 'ğŸ“‡';
    const opt = document.createElement('option');
    opt.value = deck.id;
    opt.textContent = `${icon} ${deck.name} (${deck.cardCount} cards)`;
    select.appendChild(opt);
  });
  
  // Restore selection if still valid
  if (currentVal && vault.find(d => d.id === currentVal)) {
    select.value = currentVal;
  }
}

let previewedDeckId = null;

function previewVaultDeck() {
  const select = document.getElementById('vaultPreviewSelect');
  const deckId = select.value;
  const grid = document.getElementById('vaultPreviewGrid');
  const loadBtn = document.getElementById('vaultPreviewLoadBtn');
  const stats = document.getElementById('vaultPreviewStats');
  
  if (!deckId) {
    previewedDeckId = null;
    loadBtn.disabled = true;
    stats.style.display = 'none';
    grid.innerHTML = `
      <div class="vault-preview-empty">
        <div class="vault-preview-empty-icon">ğŸ‘ï¸</div>
        <div>Select a saved deck to preview</div>
      </div>
    `;
    return;
  }
  
  const vault = getVault();
  const deck = vault.find(d => d.id === deckId);
  
  if (!deck) {
    showToast('âš ï¸ Deck not found');
    return;
  }
  
  previewedDeckId = deckId;
  loadBtn.disabled = false;
  stats.style.display = 'flex';
  
  // Update stats
  document.getElementById('vaultPreviewInfo').textContent = `${deck.cardCount} cards Â· ${deck.deckType}`;
  document.getElementById('vaultPreviewTheme').textContent = `Theme: ${deck.state.frontTheme || 'classic'} / ${deck.state.backTheme || 'classic'}`;
  
  // Render preview cards
  grid.innerHTML = '<div class="vault-preview-empty"><div style="font-size:24px;">â³</div><div>Rendering preview...</div></div>';
  
  // Use setTimeout to allow UI to update before heavy render
  setTimeout(() => {
    renderVaultPreview(deck);
  }, 50);
}

function renderVaultPreview(deck) {
  const grid = document.getElementById('vaultPreviewGrid');
  const cards = deck.state.cards || [];
  const previewScale = 70/140;
  
  if (cards.length === 0) {
    grid.innerHTML = `
      <div class="vault-preview-empty">
        <div class="vault-preview-empty-icon">ğŸ“­</div>
        <div>This deck has no cards</div>
      </div>
    `;
    return;
  }
  
  // Build card HTML - limit to first 150 for performance
  const displayCards = cards.slice(0, 150);
  let html = '';
  
  displayCards.forEach((card, idx) => {
    // Use high index to avoid filter conflicts
    const previewIdx = 10000 + idx * 10;
    
    // Generate front SVG with the deck's saved config
    const frontCfg = {
      color: card.cfg?.color,
      pattern: card.cfg?.pattern,
      frontTheme: card.cfg?.frontTheme || deck.state.frontTheme,
      glow: card.cfg?.glow,
      symbol: card.cfg?.symbol,
      frameGlow: card.cfg?.frameGlow || deck.state.frameGlow,
      frameGlowIntensity: card.cfg?.frameGlowIntensity,
      frameThickness: card.cfg?.frameThickness
    };
    
    const frontSVG = generateFrontSVG(card, previewIdx, frontCfg, previewScale);
    
    // Stagger animation delay based on position
    const delay = Math.min(idx * 15, 600); // Cap at 600ms
    html += `<div class="vault-preview-card" style="animation-delay:${delay}ms">${frontSVG}</div>`;
  });
  
  if (cards.length > 150) {
    html += `<div class="vault-preview-empty" style="padding:20px;grid-column:1/-1;"><div style="font-size:20px;margin-bottom:8px;">âœ¨</div><div>+ ${cards.length - 150} more cards</div></div>`;
  }
  
  grid.innerHTML = html;
}

function loadPreviewedDeck() {
  if (previewedDeckId) {
    loadFromVault(previewedDeckId);
  }
}

function quickPreviewDeck(id) {
  // Switch to preview tab and select the deck
  switchVaultTab('preview');
  document.getElementById('vaultPreviewSelect').value = id;
  previewVaultDeck();
}

function getVault() {
  try {
    let data = localStorage.getItem(VAULT_KEY);
    
    // Migrate from legacy key if v8 vault is empty
    if (!data && VAULT_KEY_LEGACY) {
      const legacyData = localStorage.getItem(VAULT_KEY_LEGACY);
      if (legacyData) {
        console.log('ğŸ”„ Migrating vault from legacy key...');
        localStorage.setItem(VAULT_KEY, legacyData);
        data = legacyData;
        // Optionally clear legacy after migration:
        // localStorage.removeItem(VAULT_KEY_LEGACY);
      }
    }
    
    return data ? JSON.parse(data) : [];
  } catch (e) {
    console.error('Vault read error:', e);
    return [];
  }
}

function setVault(decks) {
  try {
    localStorage.setItem(VAULT_KEY, JSON.stringify(decks));
    return true;
  } catch (e) {
    console.error('Vault write error:', e);
    if (e.name === 'QuotaExceededError') {
      showToast('âš ï¸ Storage full!');
    }
    return false;
  }
}

function saveToVault() {
  const nameInput = document.getElementById('vaultSaveName');
  const name = nameInput.value.trim();
  if (!name) {
    showToast('âš ï¸ Enter a deck name');
    nameInput.focus();
    return;
  }
  
  const vault = getVault();
  
  // Check for duplicate name
  const existingIdx = vault.findIndex(d => d.name === name);
  if (existingIdx !== -1) {
    if (!confirm(`"${name}" already exists. Overwrite?`)) return;
    vault.splice(existingIdx, 1);
  }
  
  // For custom decks, use customCards; for others, use cards
  const cardsToSave = state.deck === 'custom' ? state.customCards : state.cards;
  
  const deckData = {
    id: Date.now().toString(36),
    name: name,
    deckType: state.deck,
    cardCount: cardsToSave.length,
    savedAt: new Date().toISOString(),
    state: {
      deck: state.deck,
      cards: cardsToSave,
      customCards: state.deck === 'custom' ? state.customCards : undefined,
      customDeck: state.deck === 'custom' ? JSON.parse(JSON.stringify(state.customDeck)) : undefined, // Save divisions
      frontTheme: state.frontTheme,
      backTheme: state.backTheme,
      backLayout: state.backLayout,
      frameGlow: state.frameGlow,
      uiTheme: state.uiTheme,
      deckColors: state.deckColors, // Save palette
      animMode: state.animMode // Save animation mode
    }
  };
  
  vault.unshift(deckData); // Add to beginning
  
  if (setVault(vault)) {
    const divCount = state.customDeck.divisions.length;
    const extraInfo = divCount > 0 ? ` + ${divCount} divisions` : '';
    showToast(`ğŸ’¾ Saved "${name}"${extraInfo}`);
    nameInput.value = '';
    renderVaultList();
    updateStorageInfo();
  }
}

function loadFromVault(id) {
  const vault = getVault();
  const deck = vault.find(d => d.id === id);
  if (!deck) {
    showToast('âš ï¸ Deck not found');
    return;
  }
  
  const s = deck.state;
  const cardsToLoad = s.customCards || s.cards || [];
  
  // If user has existing custom cards, offer merge option
  if (state.customCards.length > 0) {
    showImportOptions(deck);
    closeVault();
    return;
  }
  
  // Load directly into custom deck
  state.customCards = cardsToLoad.map(c => ({...c, addedAt: Date.now()}));
  state.deck = 'custom';
  
  // Restore divisions (customDeck) if present
  if (s.customDeck && s.customDeck.divisions) {
    state.customDeck = JSON.parse(JSON.stringify(s.customDeck));
  }
  
  // Restore theme settings
  state.frontTheme = s.frontTheme || 'classic';
  state.backTheme = s.backTheme || 'classic';
  state.backLayout = s.backLayout || 'standard';
  state.frameGlow = s.frameGlow || 'none';
  if (s.uiTheme) {
    state.uiTheme = s.uiTheme;
    document.body.dataset.theme = s.uiTheme;
  }
  
  // Restore palette and animation
  if (s.deckColors) {
    state.deckColors = s.deckColors;
    initGlobalColors();
  }
  if (s.animMode) {
    state.animMode = s.animMode;
  }
  
  // Update UI
  document.querySelectorAll('.deck-tab').forEach(t => t.classList.toggle('active', t.dataset.deck === 'custom'));
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === state.uiTheme));
  
  buildDeck();
  buildControlPanel();
  renderCards();
  closeVault();
  
  const divCount = state.customDeck.divisions.length;
  const extraInfo = divCount > 0 ? ` + ${divCount} divisions` : '';
  showToast(`ğŸ“‚ Loaded "${deck.name}" into Custom Deck (${cardsToLoad.length} cards${extraInfo})`);
}

function deleteFromVault(id, name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  
  const vault = getVault();
  const newVault = vault.filter(d => d.id !== id);
  
  if (setVault(newVault)) {
    showToast(`ğŸ—‘ï¸ Deleted "${name}"`);
    renderVaultList();
    updateStorageInfo();
  }
}

function exportFromVault(id) {
  const vault = getVault();
  const deck = vault.find(d => d.id === id);
  if (!deck) return;
  
  const data = {
    meta: {
      generator: 'Golden Acorn v8.0.0',
      schemaVersion: '8.0.0',
      name: deck.name,
      deck: deck.deckType,
      cardCount: deck.cardCount,
      savedAt: deck.savedAt,
      exportedAt: new Date().toISOString()
    },
    state: deck.state
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${deck.name.replace(/[^a-z0-9]/gi, '_')}.json`;
  a.click();
  showToast(`ğŸ“¤ Exported "${deck.name}"`);
}

function renderVaultList() {
  const container = document.getElementById('vaultDeckList');
  const vault = getVault();
  
  if (vault.length === 0) {
    container.innerHTML = `
      <div class="vault-empty">
        <div class="vault-empty-icon">ğŸ—„ï¸</div>
        <div>No saved decks yet</div>
        <div style="margin-top:8px;opacity:0.6;">Save your current deck to get started</div>
      </div>
    `;
    return;
  }
  
  const deckIcons = {
    classic: 'â™ ',
    guardian: 'â—',
    tarot: 'âœ§'
  };
  
  container.innerHTML = vault.map(deck => {
    const icon = deckIcons[deck.deckType] || 'ğŸ“‡';
    const date = new Date(deck.savedAt);
    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    return `
      <div class="vault-deck-item">
        <div class="vault-deck-icon">${icon}</div>
        <div class="vault-deck-info">
          <div class="vault-deck-name">${escapeHtml(deck.name)}</div>
          <div class="vault-deck-meta">${deck.cardCount} cards Â· ${deck.deckType} Â· ${dateStr}</div>
        </div>
        <div class="vault-deck-actions">
          <button class="vault-action-btn" onclick="quickPreviewDeck('${deck.id}')" title="Preview">ğŸ‘ï¸</button>
          <button class="vault-action-btn load" onclick="loadFromVault('${deck.id}')" title="Load to Custom Deck">ğŸ“‚</button>
          <button class="vault-action-btn" onclick="exportFromVault('${deck.id}')" title="Export">ğŸ“¤</button>
          <button class="vault-action-btn delete" onclick="deleteFromVault('${deck.id}', '${escapeHtml(deck.name)}')" title="Delete">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }).join('');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function updateStorageInfo() {
  const vault = getVault();
  const dataSize = new Blob([JSON.stringify(vault)]).size;
  const sizeStr = dataSize < 1024 ? `${dataSize} B` : 
                  dataSize < 1024*1024 ? `${(dataSize/1024).toFixed(1)} KB` :
                  `${(dataSize/1024/1024).toFixed(2)} MB`;
  document.getElementById('vaultStorageInfo').textContent = `Storage: ${sizeStr} Â· ${vault.length} deck${vault.length !== 1 ? 's' : ''} saved`;
}

function importToVault(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      // Validate the data structure
      if (!data.state || !data.state.cards) {
        // Try legacy format (direct export)
        if (data.cards && Array.isArray(data.cards)) {
          // Convert legacy format
          const deckName = data.meta?.name || file.name.replace('.json', '');
          const deckType = data.meta?.deck || 'classic';
          
          const deckData = {
            id: Date.now().toString(36),
            name: deckName,
            deckType: deckType,
            cardCount: data.cards.length,
            savedAt: new Date().toISOString(),
            state: {
              deck: deckType,
              cards: data.cards,
              frontTheme: 'classic',
              backTheme: 'classic',
              backLayout: 'standard',
              frameGlow: 'none',
              uiTheme: 'void'
            }
          };
          
          const vault = getVault();
          vault.unshift(deckData);
          
          if (setVault(vault)) {
            showToast(`ğŸ“¥ Imported "${deckName}"`);
            renderVaultList();
            updateStorageInfo();
          }
        } else {
          throw new Error('Invalid deck format');
        }
      } else {
        // New vault format
        const deckName = data.meta?.name || file.name.replace('.json', '');
        
        const deckData = {
          id: Date.now().toString(36),
          name: deckName,
          deckType: data.state.deck || 'classic',
          cardCount: data.state.cards.length,
          savedAt: data.meta?.savedAt || data.meta?.timestamp || new Date().toISOString(),
          state: data.state
        };
        
        const vault = getVault();
        vault.unshift(deckData);
        
        if (setVault(vault)) {
          showToast(`ğŸ“¥ Imported "${deckName}"`);
          renderVaultList();
          updateStorageInfo();
        }
      }
    } catch (err) {
      console.error('Import error:', err);
      showToast('âš ï¸ Invalid file format');
    }
  };
  
  reader.readAsText(file);
  input.value = ''; // Reset for re-import
}

document.addEventListener('DOMContentLoaded', init);
document.getElementById('editorModal').onclick = e => { if (e.target.id === 'editorModal') closeEditor(); };
document.getElementById('vaultModal').onclick = e => { if (e.target.id === 'vaultModal') closeVault(); };
document.onkeydown = e => {
  if (e.key === 'Escape') {
    closeEditor();
    closeVault();
    closeGlyphModal();
    closeGallery();
    closeCardCreator();
    closeCardDetail();
    closeReadingModal();
  }
  const editorOpen = document.getElementById('editorModal').classList.contains('active');
  if (editorOpen) {
    if (e.key === 'ArrowLeft') { e.preventDefault(); prevCard(); }
    if (e.key === 'ArrowRight') { e.preventDefault(); nextCard(); }
  }
};

console.log('ğŸŒ° Golden Acorn v8.0.0 - Physics Grounded Â· SI 2019 Aligned');
</script>

</body>
</html>
